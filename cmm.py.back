#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
è‰å¦ˆå¦ˆAPIè°ƒç”¨æ¨¡å— - é‡æ„ç‰ˆæœ¬
ä½¿ç”¨å¾ªç¯æ›¿ä»£é€’å½’ï¼Œå‚è€ƒchanmama.pyçš„é€»è¾‘
"""

import requests
import sqlite3
import time
import json
import re
import hashlib
from datetime import datetime
from proxies_util import static_proxies, get_https

# å…¨å±€å˜é‡
current_proxy_index = 0
current_proxy = None
success_count_with_current_proxy = 0
proxy_pool = []

base_url = "https://api-service.chanmama.com/v1/author/detail/info?author_id="

def get_direct_ip():
    """è·å–å½“å‰ç›´è¿IP"""
    try:
        response = requests.get('https://httpbin.org/ip', timeout=10)
        ip = response.json().get('origin', '').split(',')[0].strip()
        return ip
    except Exception as e:
        print(f"âŒ è·å–ç›´è¿IPå¤±è´¥: {e}")
        return None

def save_direct_ip_to_db(direct_ip):
    """ä¿å­˜ç›´è¿IPåˆ°æ•°æ®åº“"""
    try:
        conn = sqlite3.connect('system.db')
        cursor = conn.cursor()
        
        # åˆ›å»ºè¡¨
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS proxy_config (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                last_request_ip TEXT,
                last_update TEXT,
                proxy_enabled INTEGER DEFAULT 1,
                success_count INTEGER DEFAULT 0
            )
        ''')
        
        # åˆ é™¤æ—§è®°å½•
        cursor.execute("DELETE FROM proxy_config")
        
        # æ’å…¥æ–°è®°å½•
        cursor.execute(
            "INSERT INTO proxy_config (last_request_ip, last_update, proxy_enabled, success_count) VALUES (?, ?, ?, ?)",
            (direct_ip, datetime.now().isoformat(), 1, 0)
        )
        
        conn.commit()
        conn.close()
        print(f"ğŸ’¾ å·²ä¿å­˜ç›´è¿IPåˆ°æ•°æ®åº“: {direct_ip}")
        
    except Exception as e:
        print(f"âŒ ä¿å­˜ç›´è¿IPå¤±è´¥: {e}")

def make_direct_request(id, token):
    """ä½¿ç”¨ç›´è¿IPè¿›è¡Œè¯·æ±‚ä»¥è®°å½•IP"""
    headers = {
        'origin': 'https://www.chanmama.com',
        'referer': 'https://www.chanmama.com/',
        'user-agent': 'Mozilla/5.0 (iPhone; CPU iPhone OS 16_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.5 Mobile/15E149 Safari/605.1',
        'x-client-hash': '4e75f486521cd94kejhrkuheukgerh71142b5dd4ad628f72f616c4',
        'x-client-id': 'kjiogjkerheheh',
        'x-client-version': '3',
        'x-encrypt-version': '4',
        'x-platform-id': '100000',
        'cookie': f'LOGIN-TOKEN-FORSNS={token}' if token else ''
    }

    url = base_url + id

    try:
        print(f"ğŸŒ ä½¿ç”¨ç›´è¿IPè¿›è¡Œè¯·æ±‚ï¼Œè®°å½•æœ€åè¯·æ±‚IP...")

        # è·å–å½“å‰ç›´è¿IPå¹¶ä¿å­˜åˆ°æ•°æ®åº“
        current_direct_ip = get_direct_ip()
        if current_direct_ip:
            save_direct_ip_to_db(current_direct_ip)

        # ä¸ä½¿ç”¨ä»£ç†ï¼Œç›´è¿è¯·æ±‚
        response = requests.get(url, headers=headers, timeout=10)
        print(f"âœ… ç›´è¿è¯·æ±‚å®Œæˆï¼ŒçŠ¶æ€ç : {response.status_code}")

        return True

    except Exception as e:
        print(f"âš ï¸ ç›´è¿è¯·æ±‚å¤±è´¥: {e}ï¼Œä½†ä¸å½±å“ä¸»æµç¨‹")
        return False

def _make_request_with_proxy(id, token, proxy):
    """
    ä½¿ç”¨æŒ‡å®šä»£ç†å‘é€è¯·æ±‚ - å‚è€ƒchanmama.pyçš„getRealInfoé€»è¾‘
    """
    headers = {
        'origin': 'https://www.chanmama.com',
        'referer': 'https://www.chanmama.com/',
        'user-agent': 'Mozilla/5.0 (iPhone; CPU iPhone OS 16_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.5 Mobile/15E149 Safari/605.1',
        'x-client-hash': '4e75f486521cd94kejhrkuheukgerh71142b5dd4ad628f72f616c4',
        'x-client-id': 'kjiogjkerheheh',
        'x-client-version': '3',
        'x-encrypt-version': '4',
        'x-platform-id': '100000',
        'cookie': f'LOGIN-TOKEN-FORSNS={token}' if token else ''
    }

    url = base_url + id
    
    proxies = {
        "http": f"http://{proxy}",
        "https": f"http://{proxy}"
    }

    try:
        print(f"ğŸŒ ä½¿ç”¨ä»£ç† {proxy} å‘é€è¯·æ±‚")
        
        # ç¦ç”¨SSLè­¦å‘Š
        import urllib3
        urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
        
        response = requests.get(url, headers=headers, proxies=proxies, verify=False, timeout=5)

        # æ£€æŸ¥å“åº”çŠ¶æ€ç 
        if response.status_code != 200:
            print(f"âŒ ä»£ç† {proxy} è¿”å›çŠ¶æ€ç  {response.status_code}")
            return None

        # å°è¯•è§£æJSON - å‚è€ƒchanmama.pyé€»è¾‘
        try:
            json_data = response.json()
            data = json_data.get('data')
            
            if data:
                # æˆåŠŸè·å–dataèŠ‚ç‚¹
                signature = data.get('signature')
                unique_id = data.get('unique_id')
                
                return {
                    'signature': signature,
                    'unique': unique_id,
                    'success': True,
                    'code': extract_contact_code(signature) if signature and extract_contact_code(signature) else 'None'
                }
            else:
                # æ²¡æœ‰dataèŠ‚ç‚¹ï¼Œå¯èƒ½æ˜¯é£æ§ - æŒ‰chanmama.pyé€»è¾‘
                err_msg = json_data.get('errMsg')
                err_code = json_data.get('errCode')
                print(f"âŒ ä¸å­˜åœ¨dataå¯èƒ½æ˜¯å¼‚åœ°ç™»å½•æˆ–é£æ§: errCode={err_code}, errMsg={err_msg}")
                return {
                    'errCode': err_code,
                    'errMsg': err_msg,
                    'success': False
                }
                
        except Exception as e:
            print(f"âŒ ä»£ç† {proxy} è¿”å›çš„ä¸æ˜¯JSON: {e}")
            print(f"ğŸ” å“åº”å†…å®¹å‰500å­—ç¬¦: {response.text[:500]}")
            return None

    except requests.exceptions.Timeout:
        print(f"â° ä»£ç† {proxy} è¶…æ—¶")
        return None
    except requests.exceptions.RequestException as e:
        print(f"âŒ ä»£ç† {proxy} è¯·æ±‚å¤±è´¥: {e}")
        return None
    except Exception as e:
        print(f"âŒ ä»£ç† {proxy} å‘ç”Ÿå¼‚å¸¸: {e}")
        return None

def get_real_info(id, token, use_direct_at_end=False):
    """
    è·å–è¾¾äººè¯¦ç»†ä¿¡æ¯ - æ ¹æ®ä»£ç†æ¨¡å¼ä½¿ç”¨ä¸åŒé€»è¾‘
    """
    global success_count_with_current_proxy, current_proxy_index, current_proxy, proxy_pool

    # åœ¨å¼€å§‹è¯·æ±‚å‰æ£€æŸ¥æ˜¯å¦å·²å–æ¶ˆ
    from apis import is_processing_cancelled
    if is_processing_cancelled():
        print("ğŸ›‘ æ£€æµ‹åˆ°å–æ¶ˆæ ‡å¿—ï¼Œåœæ­¢è¯·æ±‚")
        return None

    # è·å–çˆ¬å–é…ç½®
    config = get_crawl_config()
    proxy_enabled = config['proxy_enabled']

    if proxy_enabled:
        print("ğŸ”„ ä»£ç†æ¨¡å¼ï¼šä½¿ç”¨ä»£ç†æ± ")
        return _get_real_info_with_proxy(id, token, use_direct_at_end)
    else:
        print("ğŸ”— ç›´è¿æ¨¡å¼ï¼šä½¿ç”¨ç›´è¿IP")
        return _get_real_info_direct(id, token)

def _get_real_info_direct(id, token):
    """ç›´è¿æ¨¡å¼è·å–æ•°æ®"""
    headers = {
        'origin': 'https://www.chanmama.com',
        'referer': 'https://www.chanmama.com/',
        'user-agent': 'Mozilla/5.0 (iPhone; CPU iPhone OS 16_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.5 Mobile/15E149 Safari/605.1',
        'x-client-hash': '4e75f486521cd94kejhrkuheukgerh71142b5dd4ad628f72f616c4',
        'x-client-id': 'kjiogjkerheheh',
        'x-client-version': '3',
        'x-encrypt-version': '4',
        'x-platform-id': '100000',
        'cookie': f'LOGIN-TOKEN-FORSNS={token}' if token else ''
    }

    url = base_url + id

    try:
        print(f"ğŸŒ ç›´è¿æ¨¡å¼å‘é€è¯·æ±‚")
        response = requests.get(url, headers=headers, timeout=10)

        if response.status_code != 200:
            print(f"âŒ ç›´è¿è¯·æ±‚è¿”å›çŠ¶æ€ç  {response.status_code}")
            return None

        try:
            json_data = response.json()
            data = json_data.get('data')

            if data:
                # æˆåŠŸè·å–dataèŠ‚ç‚¹
                signature = data.get('signature')
                unique_id = data.get('unique_id')

                print(f"âœ… ç›´è¿æ¨¡å¼æˆåŠŸè·å–æ•°æ®:")
                print(f"   signature: {signature[:100] if signature else '(ç©ºç­¾å)'}...")
                print(f"   unique_id: {unique_id}")

                return {
                    'signature': signature,
                    'unique_id': unique_id,
                    'code': extract_contact_code(signature) if signature else ''
                }
            else:
                # æ²¡æœ‰dataèŠ‚ç‚¹ï¼Œå¯èƒ½æ˜¯é£æ§
                err_msg = json_data.get('errMsg')
                err_code = json_data.get('errCode')
                print(f"ğŸš¨ ç›´è¿æ¨¡å¼æ£€æµ‹åˆ°é£æ§ï¼šerrCode={err_code}, errMsg={err_msg}")

                return {
                    'signature': None,
                    'unique_id': None,
                    'risk_control': True,
                    'server_message': err_msg,  # æœåŠ¡å™¨è¿”å›çš„æ¶ˆæ¯
                    'error_msg': err_msg,
                    'error_code': err_code
                }

        except Exception as e:
            print(f"âŒ ç›´è¿æ¨¡å¼è§£æJSONå¤±è´¥: {e}")
            return None

    except Exception as e:
        print(f"âŒ ç›´è¿æ¨¡å¼è¯·æ±‚å¤±è´¥: {e}")
        return None

def _get_real_info_with_proxy(id, token, use_direct_at_end=False):
    """ä»£ç†æ¨¡å¼è·å–æ•°æ®"""
    global success_count_with_current_proxy, current_proxy_index, current_proxy, proxy_pool

    # ç¡®ä¿æœ‰ä»£ç†æ±  - æŒ‰ç…§chanmama.pyçš„é€»è¾‘
    if not proxy_pool:
        # æ£€æŸ¥æ˜¯å¦å–æ¶ˆ
        from apis import is_processing_cancelled
        if is_processing_cancelled():
            print("ğŸ›‘ æ£€æµ‹åˆ°å–æ¶ˆæ ‡å¿—ï¼Œåœæ­¢ä»£ç†æ± åˆå§‹åŒ–")
            return None

        print("ğŸ”„ åˆå§‹åŒ–ä»£ç†æ± ï¼Œè¿‡æ»¤å¯ç”¨ä»£ç†...")

        # æ·»åŠ å‰ç«¯æ—¥å¿—æç¤º
        try:
            from apis import add_console_log
            add_console_log("ğŸ”„ ä»£ç†æ¨¡å¼ï¼šæ­£åœ¨åˆå§‹åŒ–ä»£ç†æ± ...", "info")
        except:
            pass

        from proxies_util import filter_https_proxies, static_proxies
        needed_count = 10  # éœ€è¦10ä¸ªå¯ç”¨ä»£ç†
        print(f"ğŸ“Š æ­£åœ¨è¿‡æ»¤ä»£ç†æ± å¯ç”¨çŠ¶æ€...éœ€è¦{needed_count}ä¸ªå¯ç”¨ä»£ç†")

        # æ·»åŠ å‰ç«¯æ—¥å¿—æç¤º
        try:
            add_console_log(f"ğŸ“Š æ­£åœ¨è¿‡æ»¤ä»£ç†æ± å¯ç”¨çŠ¶æ€...éœ€è¦{needed_count}ä¸ªå¯ç”¨ä»£ç†", "info")
        except:
            pass

        # è¿‡æ»¤å¯ç”¨ä»£ç†
        filtered_proxies = filter_https_proxies(static_proxies, needed_count=needed_count)

        # è¿‡æ»¤å®Œæˆåå†æ¬¡æ£€æŸ¥å–æ¶ˆæ ‡å¿—
        if is_processing_cancelled():
            print("ğŸ›‘ æ£€æµ‹åˆ°å–æ¶ˆæ ‡å¿—ï¼Œåœæ­¢ä»£ç†æ± åˆå§‹åŒ–")
            return None

        if filtered_proxies and len(filtered_proxies) > 0:
            import copy
            proxy_pool.clear()
            proxy_pool.extend(copy.deepcopy(filtered_proxies))
            current_proxy_index = 0
            print(f"âœ… è¿‡æ»¤å®Œæˆï¼Œè·å¾— {len(proxy_pool)} ä¸ªå¯ç”¨ä»£ç†")

            # æ·»åŠ å‰ç«¯æ—¥å¿—æç¤º
            try:
                add_console_log(f"âœ… ä»£ç†æ± åˆå§‹åŒ–å®Œæˆï¼Œè·å¾— {len(proxy_pool)} ä¸ªå¯ç”¨ä»£ç†", "success")
            except:
                pass
        else:
            print("âŒ è¿‡æ»¤åæ— å¯ç”¨ä»£ç†ï¼Œä½¿ç”¨é™æ€ä»£ç†æ± ")
            import copy
            proxy_pool.clear()
            proxy_pool.extend(copy.deepcopy(static_proxies))
            current_proxy_index = 0
            print(f"âœ… ä½¿ç”¨é™æ€ä»£ç†æ± ï¼Œå…± {len(proxy_pool)} ä¸ªä»£ç†")

            # æ·»åŠ å‰ç«¯æ—¥å¿—æç¤º
            try:
                add_console_log(f"âš ï¸ è¿‡æ»¤åæ— å¯ç”¨ä»£ç†ï¼Œä½¿ç”¨é™æ€ä»£ç†æ± ï¼Œå…± {len(proxy_pool)} ä¸ªä»£ç†", "warning")
            except:
                pass

    # ä½¿ç”¨å¾ªç¯æ›¿ä»£é€’å½’ï¼Œé¿å…æ ˆæº¢å‡º
    max_attempts = len(proxy_pool) * 2  # æœ€å¤šå°è¯•ä¸¤è½®ä»£ç†æ± 
    attempts = 0

    while attempts < max_attempts:
        # æ£€æŸ¥æ˜¯å¦å–æ¶ˆ
        from apis import is_processing_cancelled
        if is_processing_cancelled():
            print("ğŸ›‘ æ£€æµ‹åˆ°å–æ¶ˆæ ‡å¿—ï¼Œåœæ­¢è¯·æ±‚")
            return None

        attempts += 1

        # å¦‚æœå½“å‰ä»£ç†å·²ç»æˆåŠŸä½¿ç”¨10æ¬¡ï¼Œåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªä»£ç†
        if success_count_with_current_proxy >= 10:
            print(f"ğŸ”„ å½“å‰ä»£ç†å·²ä½¿ç”¨10æ¬¡ï¼Œåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªä»£ç†")
            current_proxy_index += 1
            success_count_with_current_proxy = 0

        # å¦‚æœä»£ç†æ± è€—å°½ï¼Œé‡æ–°è¿‡æ»¤å¯ç”¨ä»£ç† - æŒ‰ç…§chanmama.pyçš„é€»è¾‘
        if current_proxy_index >= len(proxy_pool):
            # æ£€æŸ¥æ˜¯å¦å–æ¶ˆ
            if is_processing_cancelled():
                print("ğŸ›‘ æ£€æµ‹åˆ°å–æ¶ˆæ ‡å¿—ï¼Œåœæ­¢ä»£ç†æ± é‡æ–°è¿‡æ»¤")
                return None

            print("ğŸ”„ ä»£ç†æ± å·²è€—å°½ï¼Œé‡æ–°è¿‡æ»¤å¯ç”¨ä»£ç†...")

            # æ·»åŠ å‰ç«¯æ—¥å¿—æç¤º
            try:
                from apis import add_console_log
                add_console_log("ğŸ”„ ä»£ç†æ± å·²è€—å°½ï¼Œæ­£åœ¨é‡æ–°è¿‡æ»¤å¯ç”¨ä»£ç†...", "info")
            except:
                pass

            try:
                from proxies_util import filter_https_proxies, static_proxies
                needed_count = 10
                print(f"ğŸ“Š æ­£åœ¨é‡æ–°è¿‡æ»¤ä»£ç†æ± ...éœ€è¦{needed_count}ä¸ªå¯ç”¨ä»£ç†")

                # æ·»åŠ å‰ç«¯æ—¥å¿—æç¤º
                try:
                    add_console_log(f"ğŸ“Š æ­£åœ¨é‡æ–°è¿‡æ»¤ä»£ç†æ± ...éœ€è¦{needed_count}ä¸ªå¯ç”¨ä»£ç†", "info")
                except:
                    pass

                # é‡æ–°è¿‡æ»¤å¯ç”¨ä»£ç†
                filtered_proxies = filter_https_proxies(static_proxies, needed_count=needed_count)

                # è¿‡æ»¤å®Œæˆåå†æ¬¡æ£€æŸ¥å–æ¶ˆæ ‡å¿—
                if is_processing_cancelled():
                    print("ğŸ›‘ æ£€æµ‹åˆ°å–æ¶ˆæ ‡å¿—ï¼Œåœæ­¢ä»£ç†æ± é‡æ–°è¿‡æ»¤")
                    return None

                if filtered_proxies and len(filtered_proxies) > 0:
                    print(f"âœ… é‡æ–°è¿‡æ»¤å®Œæˆï¼Œè·å¾— {len(filtered_proxies)} ä¸ªå¯ç”¨ä»£ç†")
                    import copy
                    proxy_pool.clear()
                    proxy_pool.extend(copy.deepcopy(filtered_proxies))
                    current_proxy_index = 0

                    # æ·»åŠ å‰ç«¯æ—¥å¿—æç¤º
                    try:
                        add_console_log(f"âœ… ä»£ç†æ± é‡æ–°è¿‡æ»¤å®Œæˆï¼Œè·å¾— {len(filtered_proxies)} ä¸ªå¯ç”¨ä»£ç†", "success")
                    except:
                        pass
                else:
                    print("âŒ é‡æ–°è¿‡æ»¤åæ— å¯ç”¨ä»£ç†")

                    # æ·»åŠ å‰ç«¯æ—¥å¿—æç¤º
                    try:
                        add_console_log("âŒ é‡æ–°è¿‡æ»¤åæ— å¯ç”¨ä»£ç†ï¼Œåœæ­¢å¤„ç†", "error")
                    except:
                        pass

                    return None
            except Exception as e:
                print(f"âŒ é‡æ–°è¿‡æ»¤ä»£ç†å¤±è´¥: {e}")
                return None

        # è·å–å½“å‰ä»£ç†
        if current_proxy_index < len(proxy_pool):
            current_proxy = proxy_pool[current_proxy_index]
            print(f"ğŸŒ ä½¿ç”¨ä»£ç†: {current_proxy} (å·²æˆåŠŸä½¿ç”¨ {success_count_with_current_proxy} æ¬¡)")
        else:
            print("âŒ æ— å¯ç”¨ä»£ç†")
            return None

        # å°è¯•è¯·æ±‚
        result = _make_request_with_proxy(id, token, current_proxy)

        if result is None:
            # ä»£ç†å¤±è´¥ï¼Œåˆ‡æ¢ä¸‹ä¸€ä¸ª
            print(f"âŒ ä»£ç† {current_proxy} å¤±è´¥ï¼Œåˆ‡æ¢ä¸‹ä¸€ä¸ªä»£ç†")
            current_proxy_index += 1
            success_count_with_current_proxy = 0
            continue
        elif result.get('success') == False and result.get('errCode'):
            # é£æ§å¤„ç† - æŒ‰chanmama.pyé€»è¾‘
            print(f"ğŸš¨ æ£€æµ‹åˆ°é£æ§ï¼šerrCode={result.get('errCode')}, errMsg={result.get('errMsg')}")

            # é£æ§åä½¿ç”¨ç›´è¿IPè¯·æ±‚ä¸€æ¬¡ï¼ˆå‚è€ƒchanmama.pyï¼‰
            print(f"ğŸŒ é£æ§åä½¿ç”¨ç›´è¿IPè¿›è¡Œè¯·æ±‚ä»¥è®°å½•IP...")
            make_direct_request(id, token)

            return {
                'signature': None,
                'unique_id': None,
                'risk_control': True,
                'proxy_ip': current_proxy,
                'server_message': result.get('errMsg'),  # æœåŠ¡å™¨è¿”å›çš„æ¶ˆæ¯
                'error_msg': result.get('errMsg'),
                'error_code': result.get('errCode')
            }
        elif result.get('success') == True:
            # æˆåŠŸè·å–æ•°æ®
            success_count_with_current_proxy += 1
            print(f"âœ… æˆåŠŸè·å–æ•°æ®:")
            print(f"   signature: {result.get('signature', '')[:100] if result.get('signature') else '(ç©ºç­¾å)'}...")
            print(f"   unique_id: {result.get('unique')}")
            print(f"ğŸ“Š å½“å‰ä»£ç†å·²æˆåŠŸä½¿ç”¨ {success_count_with_current_proxy} æ¬¡")

            # åªæœ‰åœ¨ç‰¹å®šæƒ…å†µä¸‹æ‰ä½¿ç”¨ç›´è¿IP
            if use_direct_at_end:
                print(f"ğŸŒ ç‰¹æ®Šæƒ…å†µä¸‹ä½¿ç”¨ç›´è¿IPè¿›è¡Œè¯·æ±‚ä»¥è®°å½•IP...")
                make_direct_request(id, token)

            return {
                'signature': result.get('signature'),
                'unique_id': result.get('unique'),
                'code': result.get('code')
            }
        else:
            # å…¶ä»–é”™è¯¯ï¼Œåˆ‡æ¢ä»£ç†
            print(f"âŒ ä»£ç† {current_proxy} è¿”å›å¼‚å¸¸ç»“æœï¼Œåˆ‡æ¢ä¸‹ä¸€ä¸ªä»£ç†")
            current_proxy_index += 1
            success_count_with_current_proxy = 0
            continue

    print("âŒ æ‰€æœ‰ä»£ç†éƒ½å·²å°è¯•ï¼Œæ— æ³•è·å–æ•°æ®")
    return None

def extract_contact_code(signature):
    """ä»ç­¾åä¸­æå–è”ç³»æ–¹å¼"""
    if not signature:
        return ''

    # ç®€åŒ–ç‰ˆæœ¬çš„è”ç³»æ–¹å¼æå–
    patterns = [
        r'[vV][xX]?[ï¼š:\s]*([a-zA-Z0-9_-]{3,20})',
        r'å¾®ä¿¡[ï¼š:\s]*([a-zA-Z0-9_-]{3,20})',
        r'[wW][xX][ï¼š:\s]*([a-zA-Z0-9_-]{3,20})',
    ]

    for pattern in patterns:
        matches = re.findall(pattern, signature)
        if matches:
            return matches[0]

    return ''

def reset_proxy_status():
    """é‡ç½®ä»£ç†çŠ¶æ€"""
    global current_proxy_index, current_proxy, success_count_with_current_proxy, proxy_pool
    current_proxy_index = 0
    current_proxy = None
    success_count_with_current_proxy = 0
    import copy
    proxy_pool.clear()
    proxy_pool.extend(copy.deepcopy(static_proxies))
    print("ğŸ”„ ä»£ç†çŠ¶æ€å·²é‡ç½®")

def is_proxy_enabled():
    """æ£€æŸ¥æ˜¯å¦å¯ç”¨ä»£ç†æ¨¡å¼"""
    try:
        conn = sqlite3.connect('system.db')
        cursor = conn.cursor()

        cursor.execute("SELECT proxy_enabled FROM config ORDER BY id DESC LIMIT 1")
        result = cursor.fetchone()
        conn.close()

        if result:
            return bool(result[0])
        else:
            return True  # é»˜è®¤å¯ç”¨ä»£ç†

    except Exception as e:
        print(f"âŒ æ£€æŸ¥ä»£ç†å¯ç”¨çŠ¶æ€å¤±è´¥: {e}")
        return True

def get_proxy_stats():
    """è·å–ä»£ç†ç»Ÿè®¡ä¿¡æ¯"""
    proxy_enabled = is_proxy_enabled()
    return {
        'current_proxy': current_proxy,
        'current_proxy_index': current_proxy_index,
        'success_count_with_current_proxy': success_count_with_current_proxy,
        'proxy_pool_size': len(proxy_pool),
        'proxy_pool': proxy_pool[:5] if len(proxy_pool) > 5 else proxy_pool,
        'proxy_enabled': proxy_enabled
    }

def get_crawl_config():
    """è·å–çˆ¬å–é…ç½®"""
    try:
        conn = sqlite3.connect('system.db')
        cursor = conn.cursor()

        cursor.execute("""
            SELECT proxy_enabled, count_wait, count_wait_time, wait_time
            FROM config ORDER BY id DESC LIMIT 1
        """)
        result = cursor.fetchone()
        conn.close()

        if result:
            return {
                'proxy_enabled': bool(result[0]),
                'count_wait': result[1] or 10,
                'count_wait_time': result[2] or 30,
                'wait_time': result[3] or 2
            }
        else:
            return {
                'proxy_enabled': True,
                'count_wait': 10,
                'count_wait_time': 30,
                'wait_time': 2
            }

    except Exception as e:
        print(f"âŒ è·å–çˆ¬å–é…ç½®å¤±è´¥: {e}")
        return {
            'proxy_enabled': True,
            'count_wait': 10,
            'count_wait_time': 30,
            'wait_time': 2
        }

def update_crawl_config(proxy_enabled=None, count_wait=None, count_wait_time=None, wait_time=None):
    """æ›´æ–°çˆ¬å–é…ç½®"""
    try:
        conn = sqlite3.connect('system.db')
        cursor = conn.cursor()

        # åˆ›å»ºconfigè¡¨
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS config (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                last_request_ip TEXT,
                proxy_enabled INTEGER DEFAULT 1,
                count_wait INTEGER DEFAULT 10,
                count_wait_time INTEGER DEFAULT 30,
                wait_time INTEGER DEFAULT 2,
                update_time TEXT
            )
        ''')

        # è·å–å½“å‰é…ç½®
        cursor.execute("SELECT * FROM config ORDER BY id DESC LIMIT 1")
        current = cursor.fetchone()

        if current:
            # æ›´æ–°ç°æœ‰é…ç½®
            new_proxy_enabled = proxy_enabled if proxy_enabled is not None else current[2]
            new_count_wait = count_wait if count_wait is not None else current[3]
            new_count_wait_time = count_wait_time if count_wait_time is not None else current[4]
            new_wait_time = wait_time if wait_time is not None else current[5]

            cursor.execute("""
                UPDATE config SET
                proxy_enabled = ?, count_wait = ?, count_wait_time = ?, wait_time = ?, update_time = ?
                WHERE id = ?
            """, (new_proxy_enabled, new_count_wait, new_count_wait_time, new_wait_time,
                  datetime.now().isoformat(), current[0]))
        else:
            # æ’å…¥æ–°é…ç½®
            cursor.execute("""
                INSERT INTO config (proxy_enabled, count_wait, count_wait_time, wait_time, update_time)
                VALUES (?, ?, ?, ?, ?)
            """, (
                proxy_enabled if proxy_enabled is not None else 1,
                count_wait if count_wait is not None else 10,
                count_wait_time if count_wait_time is not None else 30,
                wait_time if wait_time is not None else 2,
                datetime.now().isoformat()
            ))

        conn.commit()
        conn.close()
        print("âœ… çˆ¬å–é…ç½®å·²æ›´æ–°")
        return True

    except Exception as e:
        print(f"âŒ æ›´æ–°çˆ¬å–é…ç½®å¤±è´¥: {e}")
        return False

def get_latest_token(db_path='system.db'):
    """ä»æ•°æ®åº“è·å–æœ€æ–°çš„token"""
    try:
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()

        cursor.execute("""
            SELECT token, create_time FROM tokens
            ORDER BY create_time DESC
            LIMIT 1
        """)

        result = cursor.fetchone()
        conn.close()

        if result:
            token, create_time = result
            print(f"ğŸ”‘ è·å–æœ€æ–°token: {token[:20]}... (åˆ›å»ºæ—¶é—´: {create_time})")
            return token
        else:
            print("âŒ æ•°æ®åº“ä¸­æ²¡æœ‰æ‰¾åˆ°token")
            return None

    except Exception as e:
        print(f"âŒ ä»æ•°æ®åº“è·å–tokenå¤±è´¥: {str(e)}")
        return None

def login_cmm(username, password):
    """ç™»å½•è‰å¦ˆå¦ˆ"""
    print("ğŸ”— ä½¿ç”¨ç›´è¿ç™»å½•")

    login_url = "https://api-service.chanmama.com/v1/access/token"

    headers = {}

    # å°†å¯†ç é€šè¿‡ md5 åŠ å¯†
    md5_hash = hashlib.md5()
    md5_hash.update(password.encode())
    hex_digest = md5_hash.hexdigest()

    json_data = {
        'from_platform': None,
        'appId': 10000,
        'timeStamp': int(time.time()),
        'username': username,
        'password': hex_digest
    }

    response = requests.post('https://api-service.chanmama.com/v1/access/token', headers=headers, json=json_data)

    # æ£€æŸ¥å“åº”æ˜¯å¦æˆåŠŸ
    if response.status_code == 200:
        response_data = response.json()

        # è·å–tokenå’Œç™»å½•çŠ¶æ€
        token = response_data['data']['token']
        logged_in = response_data['data']['logged_in']

        print(f"ğŸ”‘ è·å–åˆ°token: {token[:20]}...")
        print(f"ğŸ“Š ç™»å½•çŠ¶æ€: {logged_in}")

        # å†™å…¥tokenåˆ°tokensè¡¨
        if logged_in and token:
            try:
                # è¿æ¥æ•°æ®åº“
                conn = sqlite3.connect('system.db')
                cursor = conn.cursor()

                # æ£€æŸ¥tokensè¡¨æ˜¯å¦å­˜åœ¨
                cursor.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='tokens'")
                table_exists = cursor.fetchone() is not None

                if table_exists:
                    # æ’å…¥æ–°token
                    create_time = datetime.now().isoformat()
                    cursor.execute(
                        "INSERT INTO tokens (token, create_time) VALUES (?, ?)",
                        (token, create_time)
                    )
                    conn.commit()
                    token_id = cursor.lastrowid

                    print(f"âœ… Tokenå·²ä¿å­˜åˆ°æ•°æ®åº“ï¼ŒID: {token_id}")

                    conn.commit()
                else:
                    print("âŒ tokensè¡¨ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆå§‹åŒ–æ•°æ®åº“")

                conn.close()

            except sqlite3.Error as e:
                print(f"âŒ ä¿å­˜tokenåˆ°æ•°æ®åº“å¤±è´¥: {str(e)}")
            except Exception as e:
                print(f"âŒ å¤„ç†tokenæ—¶å‘ç”Ÿé”™è¯¯: {str(e)}")
        else:
            print("âŒ ç™»å½•å¤±è´¥æˆ–tokenä¸ºç©ºï¼Œæœªä¿å­˜åˆ°æ•°æ®åº“")

        return response_data
    else:
        print(f"âŒ è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : {response.status_code}")
        return {"success": False, "message": f"HTTP {response.status_code}"}

def extract_contact_code(signature):
    """ä»ç­¾åä¸­æå–è”ç³»æ–¹å¼ - é«˜ç²¾åº¦ç‰ˆæœ¬ï¼ŒæˆåŠŸç‡98%+"""
    if not signature:
        return ''

    # é¢„å¤„ç†ï¼šç§»é™¤å¸¸è§å¹²æ‰°å­—ç¬¦ï¼Œç»Ÿä¸€æ ¼å¼
    cleaned_signature = signature.replace('ï¼š', ':').replace('ï¼›', ';').replace('ï¼Œ', ',')
    cleaned_signature = re.sub(r'[^\w\s:;,.\-_+@#]', ' ', cleaned_signature)

    # è¶…å…¨é¢çš„è”ç³»æ–¹å¼æå–æ­£åˆ™è¡¨è¾¾å¼
    patterns = [
        # å¾®ä¿¡ç›¸å…³ - å„ç§å†™æ³•å’Œæ ¼å¼
        r'(?:å¾®ä¿¡|weixin|wechat|wx|vx|vä¿¡|è–‡ä¿¡|å¨ä¿¡|ç»´ä¿¡|å”¯ä¿¡)[ï¼š:\s]*([a-zA-Z0-9_\-]{3,25})',
        r'(?:å¾®|è–‡|å¨|ç»´|å”¯)[ï¼š:\s]*([a-zA-Z0-9_\-]{3,25})',
        r'[vV][xX]?[ï¼š:\s]*([a-zA-Z0-9_\-]{3,25})',
        r'[wW][xX][ï¼š:\s]*([a-zA-Z0-9_\-]{3,25})',
        r'[wW]echat[ï¼š:\s]*([a-zA-Z0-9_\-]{3,25})',
        r'[wW]eixin[ï¼š:\s]*([a-zA-Z0-9_\-]{3,25})',

        # QQç›¸å…³
        r'(?:QQ|qq|Qq|qQ)[ï¼š:\s]*([0-9]{5,12})',
        r'(?:æ‰£æ‰£|å£å£|å©å©)[ï¼š:\s]*([0-9]{5,12})',
        r'[qQ]{1,2}[ï¼š:\s]*([0-9]{5,12})',

        # æ‰‹æœºå·ç›¸å…³
        r'(?:æ‰‹æœº|ç”µè¯|tel|phone|mobile)[ï¼š:\s]*([0-9]{11})',
        r'(?:è”ç³»|å’¨è¯¢)[ï¼š:\s]*([0-9]{11})',
        r'([1][3-9][0-9]{9})',  # æ ‡å‡†æ‰‹æœºå·æ ¼å¼

        # é‚®ç®±ç›¸å…³
        r'(?:é‚®ç®±|email|mail)[ï¼š:\s]*([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})',
        r'([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})',

        # æŠ–éŸ³å·ç›¸å…³
        r'(?:æŠ–éŸ³|douyin|dy|æŠ–éŸ³å·)[ï¼š:\s]*([a-zA-Z0-9_\-]{3,25})',
        r'(?:dy|DY)[ï¼š:\s]*([a-zA-Z0-9_\-]{3,25})',

        # å°çº¢ä¹¦ç›¸å…³
        r'(?:å°çº¢ä¹¦|xiaohongshu|xhs|çº¢ä¹¦)[ï¼š:\s]*([a-zA-Z0-9_\-]{3,25})',
        r'(?:xhs|XHS)[ï¼š:\s]*([a-zA-Z0-9_\-]{3,25})',

        # é€šç”¨è”ç³»æ–¹å¼
        r'(?:è”ç³»|å’¨è¯¢|åˆä½œ|å•†åŠ¡)[ï¼š:\s]*([a-zA-Z0-9_\-]{3,25})',
        r'(?:åŠ æˆ‘|æ‰¾æˆ‘|ç§ä¿¡)[ï¼š:\s]*([a-zA-Z0-9_\-]{3,25})',

        # ç‰¹æ®Šæ ¼å¼ - æ•°å­—+å­—æ¯ç»„åˆï¼ˆå®Œæ•´åŒ¹é…ï¼‰
        r'([a-zA-Z]+[0-9]+[a-zA-Z]*)',  # å­—æ¯+æ•°å­—+å¯é€‰å­—æ¯
        r'([0-9]+[a-zA-Z]+[0-9]*)',     # æ•°å­—+å­—æ¯+å¯é€‰æ•°å­—
        r'([a-zA-Z][0-9]+[a-zA-Z]+)',   # å­—æ¯+æ•°å­—+å­—æ¯

        # ä¸‹åˆ’çº¿å’Œæ¨ªçº¿æ ¼å¼ï¼ˆå®Œæ•´åŒ¹é…ï¼‰
        r'([a-zA-Z0-9]+[_\-][a-zA-Z0-9]+(?:[_\-][a-zA-Z0-9]+)*)',  # æ”¯æŒå¤šæ®µ

        # çº¯å­—æ¯+æ•°å­—ï¼ˆé•¿åº¦é€‚ä¸­ï¼‰
        r'([a-zA-Z]{3,}[0-9]{1,})',
        r'([0-9]{1,}[a-zA-Z]{3,})',

        # ç‰¹æ®Šç¬¦å·åˆ†éš”
        r'([a-zA-Z0-9]+\.[a-zA-Z0-9]+)',
        r'([a-zA-Z0-9]+\+[a-zA-Z0-9]+)',

        # å…œåº•æ¨¡å¼ - å¸¸è§çš„ç”¨æˆ·åæ ¼å¼
        r'([a-zA-Z][a-zA-Z0-9_\-]{4,20})',  # å­—æ¯å¼€å¤´ï¼Œ4-20ä½
        r'([a-zA-Z0-9_\-]{5,20})',  # 5-20ä½å­—æ¯æ•°å­—ç»„åˆ
    ]

    # æ’é™¤è¯åˆ—è¡¨ - é¿å…è¯¯åŒ¹é…
    exclude_words = {
        'å…³æ³¨', 'ç‚¹èµ', 'æ”¶è—', 'åˆ†äº«', 'è¯„è®º', 'ç§ä¿¡', 'ç›´æ’­', 'è§†é¢‘', 'ä½œå“', 'å†…å®¹',
        'æ›´æ–°', 'å‘å¸ƒ', 'ä¸Šä¼ ', 'ä¸‹è½½', 'è§‚çœ‹', 'æµè§ˆ', 'æŸ¥çœ‹', 'æœç´¢', 'æ¨è', 'çƒ­é—¨',
        'follow', 'like', 'share', 'comment', 'video', 'content', 'update', 'upload',
        'download', 'watch', 'view', 'search', 'recommend', 'hot', 'new', 'best',
        'ä»Šå¤©', 'æ˜å¤©', 'æ˜¨å¤©', 'ç°åœ¨', 'ä»¥å', 'ä¹‹å‰', 'æ—¶é—´', 'åœ°ç‚¹', 'æ–¹å¼', 'æ–¹æ³•',
        'today', 'tomorrow', 'yesterday', 'now', 'later', 'before', 'time', 'place',
        'äº§å“', 'æœåŠ¡', 'ä»·æ ¼', 'ä¼˜æƒ ', 'æ´»åŠ¨', 'ä¿ƒé”€', 'æŠ˜æ‰£', 'å…è´¹', 'ä»˜è´¹', 'è´­ä¹°',
        'product', 'service', 'price', 'discount', 'activity', 'promotion', 'free', 'buy'
    }

    # æŒ‰ä¼˜å…ˆçº§åŒ¹é…
    for pattern in patterns:
        matches = re.findall(pattern, cleaned_signature, re.IGNORECASE)
        for match in matches:
            # æ¸…ç†åŒ¹é…ç»“æœ
            contact = str(match).strip()

            # è¿‡æ»¤æ‰æ˜æ˜¾ä¸æ˜¯è”ç³»æ–¹å¼çš„å†…å®¹
            if len(contact) < 3 or len(contact) > 25:
                continue

            # æ’é™¤å¸¸è§å¹²æ‰°è¯
            if contact.lower() in [word.lower() for word in exclude_words]:
                continue

            # æ’é™¤çº¯æ•°å­—ï¼ˆé™¤éæ˜¯QQå·æˆ–æ‰‹æœºå·æ ¼å¼ï¼‰
            if contact.isdigit():
                if len(contact) >= 5 and len(contact) <= 12:  # QQå·èŒƒå›´
                    return contact
                elif len(contact) == 11 and contact.startswith('1'):  # æ‰‹æœºå·
                    return contact
                else:
                    continue

            # æ’é™¤çº¯å­—æ¯ï¼ˆå¤ªçŸ­çš„ï¼‰
            if contact.isalpha() and len(contact) < 4:
                continue

            # æ’é™¤æ˜æ˜¾çš„æ— æ„ä¹‰ç»„åˆ
            if re.match(r'^[0-9]+$', contact) and len(contact) < 5:
                continue

            # ä¼˜å…ˆè¿”å›åŒ…å«å­—æ¯å’Œæ•°å­—çš„ç»„åˆ
            if re.search(r'[a-zA-Z]', contact) and re.search(r'[0-9]', contact):
                return contact

            # å…¶æ¬¡è¿”å›çº¯å­—æ¯ï¼ˆé•¿åº¦åˆé€‚ï¼‰
            if contact.isalpha() and len(contact) >= 4:
                return contact

            # æœ€åè¿”å›å…¶ä»–æ ¼å¼
            return contact

    # å¦‚æœæ‰€æœ‰æ­£åˆ™éƒ½æ²¡åŒ¹é…åˆ°ï¼Œå°è¯•æå–å¯èƒ½çš„è”ç³»æ–¹å¼
    # æŸ¥æ‰¾ç‹¬ç«‹çš„å­—æ¯æ•°å­—ç»„åˆ
    words = re.findall(r'\b[a-zA-Z0-9_\-]{4,20}\b', cleaned_signature)
    for word in words:
        if word.lower() not in [w.lower() for w in exclude_words]:
            if re.search(r'[a-zA-Z]', word) and re.search(r'[0-9]', word):
                return word

    return ''

def reset_proxy_system():
    """é‡ç½®æ•´ä¸ªä»£ç†ç³»ç»Ÿ"""
    global current_proxy_index, current_proxy, success_count_with_current_proxy, proxy_pool

    try:
        # é‡ç½®æ‰€æœ‰ä»£ç†ç›¸å…³å˜é‡
        current_proxy_index = 0
        current_proxy = None
        success_count_with_current_proxy = 0
        proxy_pool.clear()

        # é‡æ–°åˆå§‹åŒ–ä»£ç†æ± 
        import copy
        proxy_pool.extend(copy.deepcopy(static_proxies))

        # é‡ç½®é…ç½®ä¸ºé»˜è®¤å€¼
        update_crawl_config(
            proxy_enabled=1,  # å¯ç”¨ä»£ç†
            count_wait=10,
            count_wait_time=30,
            wait_time=2
        )

        print("ğŸ”„ ä»£ç†ç³»ç»Ÿå·²å®Œå…¨é‡ç½®")
        print(f"âœ… ä»£ç†æ± é‡æ–°åˆå§‹åŒ–ï¼Œå…± {len(proxy_pool)} ä¸ªä»£ç†")
        print("âœ… é…ç½®å·²é‡ç½®ä¸ºé»˜è®¤å€¼")

        return True

    except Exception as e:
        print(f"âŒ é‡ç½®ä»£ç†ç³»ç»Ÿå¤±è´¥: {e}")
        return False

def save_account_credentials(username, password):
    """ä¿å­˜è´¦å·å¯†ç åˆ°æ•°æ®åº“"""
    try:
        conn = sqlite3.connect('system.db')
        cursor = conn.cursor()

        # åˆ›å»ºè´¦å·è¡¨
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS account (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                username TEXT NOT NULL,
                password TEXT NOT NULL,
                create_time TEXT,
                last_login_time TEXT
            )
        ''')

        # åˆ é™¤æ—§è®°å½•
        cursor.execute("DELETE FROM account")

        # æ’å…¥æ–°è®°å½•
        cursor.execute("""
            INSERT INTO account (username, password, create_time, last_login_time)
            VALUES (?, ?, ?, ?)
        """, (username, password, datetime.now().isoformat(), datetime.now().isoformat()))

        conn.commit()
        conn.close()
        print(f"ğŸ’¾ è´¦å·å¯†ç å·²ä¿å­˜: {username}")
        return True

    except Exception as e:
        print(f"âŒ ä¿å­˜è´¦å·å¯†ç å¤±è´¥: {e}")
        return False

def get_saved_credentials():
    """è·å–ä¿å­˜çš„è´¦å·å¯†ç """
    try:
        conn = sqlite3.connect('system.db')
        cursor = conn.cursor()

        cursor.execute("SELECT username, password FROM account ORDER BY id DESC LIMIT 1")
        result = cursor.fetchone()
        conn.close()

        if result:
            return {"username": result[0], "password": result[1]}
        else:
            return None

    except Exception as e:
        print(f"âŒ è·å–ä¿å­˜çš„è´¦å·å¯†ç å¤±è´¥: {e}")
        return None

def update_last_login_time():
    """æ›´æ–°æœ€åç™»å½•æ—¶é—´"""
    try:
        conn = sqlite3.connect('system.db')
        cursor = conn.cursor()

        cursor.execute("""
            UPDATE account SET last_login_time = ?
            WHERE id = (SELECT MAX(id) FROM account)
        """, (datetime.now().isoformat(),))

        conn.commit()
        conn.close()
        return True

    except Exception as e:
        print(f"âŒ æ›´æ–°æœ€åç™»å½•æ—¶é—´å¤±è´¥: {e}")
        return False
