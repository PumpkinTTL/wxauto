<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»»åŠ¡ä¸æ—¥å¿—ç®¡ç†</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/element-plus@2/dist/index.full.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus@2/dist/index.css">
    <script src="https://unpkg.com/@element-plus/icons-vue@2/dist/index.iife.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 16px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            min-height: 100vh;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            height: 100%;
        }
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
            flex-shrink: 0;
        }
        .card-body {
            padding: 20px;
        }
        .card-title {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
            color: #1f2937;
            font-size: 16px;
            font-weight: 600;
        }
        .card-subtitle {
            margin: 4px 0 0 0;
            color: #6b7280;
            font-size: 12px;
        }
        /* åˆ é™¤äº†å…¨é«˜åº¦è¡¨æ ¼ç›¸å…³æ ·å¼ */
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <!-- APIè¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ -->
            <div v-if="!apiReady" style="background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 12px 16px; border-radius: 6px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                <el-icon class="is-loading">
                    <Loading />
                </el-icon>
                <span>æ­£åœ¨è¿æ¥åç«¯API...</span>
            </div>
            
            <!-- ä»»åŠ¡ç®¡ç†å¡ç‰‡ -->
            <div class="card">
                <div class="card-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 class="card-title">
                                <el-icon color="#409eff"><List /></el-icon>
                                è·Ÿæ’­ä»»åŠ¡åˆ—è¡¨
                            </h3>
                            <p class="card-subtitle">ç®¡ç†æ‰€æœ‰è·Ÿæ’­ä»»åŠ¡ï¼Œæ”¯æŒæ‰‹åŠ¨å–æ¶ˆ</p>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <el-button size="small" @click="refreshTasks">
                                <el-icon style="margin-right: 4px;"><Refresh /></el-icon>
                                åˆ·æ–°
                            </el-button>
                            <el-select v-model="taskTypeFilter" placeholder="ä»»åŠ¡ç±»å‹" size="small" style="width: 140px;">
                                <el-option label="å…¨éƒ¨" value=""></el-option>
                                <el-option label="ç›´æ’­æé†’" value="live_reminder"></el-option>
                                <el-option label="è·Ÿæ’­ä»»åŠ¡" value="follow_task"></el-option>
                                <el-option label="æµ‹è¯•è·Ÿæ’­" value="test_follow_task"></el-option>
                                <el-option label="å›¾åƒè¯†åˆ«" value="image_recognition"></el-option>
                                <el-option label="å¼¹å¹•ä»»åŠ¡" value="danmu_task"></el-option>
                            </el-select>
                            <el-select v-model="taskStatusFilter" placeholder="ä»»åŠ¡çŠ¶æ€" size="small" style="width: 120px;">
                                <el-option label="å…¨éƒ¨" value=""></el-option>
                                <el-option label="ç­‰å¾…è§¦å‘" value="0"></el-option>
                                <el-option label="å·²è§¦å‘" value="1"></el-option>
                            </el-select>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <el-table :data="paginatedTasks" v-loading="tasksLoading" size="small" style="width: 100%;">
                        <el-table-column prop="task_id" label="ä»»åŠ¡ID" width="180" show-overflow-tooltip>
                            <template #default="scope">
                                <el-text type="primary" style="font-family: monospace; font-size: 11px;">{{ scope.row.task_id }}</el-text>
                            </template>
                        </el-table-column>
                        <el-table-column label="ä»»åŠ¡ç±»å‹" width="100" align="center">
                            <template #default="scope">
                                <el-tag :type="getTaskTypeTagType(scope.row.task_type)" size="small">{{ scope.row.type_text }}</el-tag>
                            </template>
                        </el-table-column>
                        <el-table-column label="ç›´æ’­é—´" show-overflow-tooltip>
                            <template #default="scope">
                                <div v-if="scope.row.room_names">
                                    <span v-for="(name, index) in JSON.parse(scope.row.room_names)" :key="index">
                                        {{ name }}<span v-if="index < JSON.parse(scope.row.room_names).length - 1">, </span>
                                    </span>
                                </div>
                                <div v-else-if="scope.row.room_id">
                                    ID: {{ scope.row.room_id }}
                                </div>
                                <el-text type="info" v-else>æ— </el-text>
                            </template>
                        </el-table-column>
                        <el-table-column prop="run_time" label="è®¡åˆ’æ‰§è¡Œæ—¶é—´" width="140" align="center">
                            <template #default="scope">
                                <el-text style="font-size: 11px;">{{ formatTime(scope.row.run_time) }}</el-text>
                            </template>
                        </el-table-column>
                        <el-table-column label="çŠ¶æ€" width="80" align="center">
                            <template #default="scope">
                                <el-tag :type="scope.row.status === 0 ? 'warning' : 'info'" size="small">
                                    {{ scope.row.status_text }}
                                </el-tag>
                            </template>
                        </el-table-column>
                        <el-table-column label="æ‰§è¡ŒçŠ¶æ€" width="100" align="center">
                            <template #default="scope">
                                <el-tag v-if="scope.row.execution_status === 'completed'" type="success" size="small">å·²å®Œæˆ</el-tag>
                                <el-tag v-else-if="scope.row.execution_status === 'failed'" type="danger" size="small">å·²å¤±è´¥</el-tag>
                                <el-tag v-else-if="scope.row.execution_status === 'executing'" type="warning" size="small">æ‰§è¡Œä¸­</el-tag>
                                <el-tag v-else type="info" size="small">æœªæ‰§è¡Œ</el-tag>
                            </template>
                        </el-table-column>
                        <el-table-column label="æ“ä½œ" width="120" align="center">
                            <template #default="scope">
                                <el-button v-if="scope.row.status === 0" type="danger" size="small" plain @click="cancelTask(scope.row.task_id)">
                                    <el-icon style="margin-right: 2px;"><Close /></el-icon>
                                    å–æ¶ˆä»»åŠ¡
                                </el-button>
                                <el-text v-else type="info" size="small">å·²å¤±æ•ˆ</el-text>
                            </template>
                        </el-table-column>
                    </el-table>
                    
                    <!-- ä»»åŠ¡åˆ—è¡¨åˆ†é¡µ -->
                    <div style="margin-top: 16px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 12px; color: #666;">
                            å…± {{ filteredTasks.length }} æ¡è®°å½•ï¼Œæ˜¾ç¤º {{ (taskCurrentPage - 1) * taskPageSize + 1 }} - {{ Math.min(taskCurrentPage * taskPageSize, filteredTasks.length) }} æ¡
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 12px; color: #666;">æ¯é¡µæ˜¾ç¤º</span>
                                <el-select v-model="taskPageSize" size="small" style="width: 80px;" @change="taskCurrentPage = 1">
                                    <el-option label="5" :value="5"></el-option>
                                    <el-option label="10" :value="10"></el-option>
                                </el-select>
                                <span style="font-size: 12px; color: #666;">æ¡</span>
                            </div>
                            <el-pagination
                                v-model:current-page="taskCurrentPage"
                                :page-size="taskPageSize"
                                :total="filteredTasks.length"
                                layout="prev, pager, next"
                                size="small"
                                hide-on-single-page>
                            </el-pagination>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä»»åŠ¡æ—¥å¿—å¡ç‰‡ -->
            <div class="card">
                <div class="card-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 class="card-title">
                                <el-icon color="#67c23a"><Document /></el-icon>
                                ä»»åŠ¡æ‰§è¡Œæ—¥å¿—
                            </h3>
                            <p class="card-subtitle">æŸ¥çœ‹ä»»åŠ¡æ‰§è¡Œè¯¦æƒ…å’Œç»“æœ</p>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <el-button size="small" @click="refreshTaskLogs">
                                <el-icon style="margin-right: 4px;"><Refresh /></el-icon>
                                åˆ·æ–°
                            </el-button>
                            <el-select v-model="logStatusFilter" placeholder="æ‰§è¡ŒçŠ¶æ€" size="small" style="width: 120px;">
                                <el-option label="å…¨éƒ¨" value=""></el-option>
                                <el-option label="æˆåŠŸ" value="1"></el-option>
                                <el-option label="å¤±è´¥" value="2"></el-option>
                            </el-select>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <el-table :data="paginatedTaskLogs" v-loading="logsLoading" size="small" style="width: 100%;">
                        <el-table-column prop="task_id" label="ä»»åŠ¡ID" width="180" show-overflow-tooltip>
                            <template #default="scope">
                                <el-text type="primary" style="font-family: monospace; font-size: 11px;">{{ scope.row.task_id }}</el-text>
                            </template>
                        </el-table-column>
                        <el-table-column label="æ‰§è¡ŒçŠ¶æ€" width="80" align="center">
                            <template #default="scope">
                                <el-tag :type="scope.row.status === 1 ? 'success' : 'danger'" size="small">
                                    {{ scope.row.status_text }}
                                </el-tag>
                            </template>
                        </el-table-column>
                        <el-table-column label="ç›´æ’­é—´" width="120">
                            <template #default="scope">
                                <div v-if="scope.row.room_name">
                                    <el-text>{{ scope.row.room_name }}</el-text>
                                </div>
                                <div v-else-if="scope.row.room_id">
                                    <el-text type="info">ID: {{ scope.row.room_id }}</el-text>
                                </div>
                                <el-text type="info" v-else>-</el-text>
                            </template>
                        </el-table-column>
                        <el-table-column prop="message" label="çŠ¶æ€è¯¦æƒ…" show-overflow-tooltip>
                            <template #default="scope">
                                <el-text :type="scope.row.status === 1 ? 'success' : 'danger'" style="font-size: 12px;">
                                    {{ scope.row.message }}
                                </el-text>
                            </template>
                        </el-table-column>
                        <el-table-column prop="execution_time" label="æ‰§è¡Œæ—¶é—´" width="140" align="center">
                            <template #default="scope">
                                <el-text style="font-size: 11px;">{{ formatTime(scope.row.execution_time) }}</el-text>
                            </template>
                        </el-table-column>
                    </el-table>
                    
                    <!-- ä»»åŠ¡æ—¥å¿—åˆ†é¡µ -->
                    <div style="margin-top: 16px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 12px; color: #666;">
                            å…± {{ filteredTaskLogs.length }} æ¡è®°å½•ï¼Œæ˜¾ç¤º {{ (logCurrentPage - 1) * logPageSize + 1 }} - {{ Math.min(logCurrentPage * logPageSize, filteredTaskLogs.length) }} æ¡
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 12px; color: #666;">æ¯é¡µæ˜¾ç¤º</span>
                                <el-select v-model="logPageSize" size="small" style="width: 80px;" @change="logCurrentPage = 1">
                                    <el-option label="5" :value="5"></el-option>
                                    <el-option label="10" :value="10"></el-option>
                                </el-select>
                                <span style="font-size: 12px; color: #666;">æ¡</span>
                            </div>
                            <el-pagination
                                v-model:current-page="logCurrentPage"
                                :page-size="logPageSize"
                                :total="filteredTaskLogs.length"
                                layout="prev, pager, next"
                                size="small"
                                hide-on-single-page>
                            </el-pagination>
                        </div>
                    </div>
                </div>
            </div>


        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, nextTick } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;

        // ç­‰å¾…pywebview APIå°±ç»ª - æ”¯æŒå¤šå±‚iframeåµŒå¥—
        const waitForApi = () => {
            return new Promise((resolve, reject) => {
                const maxAttempts = 50; // æœ€å¤šå°è¯•5ç§’
                let attempts = 0;
                
                const checkApi = () => {
                    attempts++;
                    
                    // æ£€æŸ¥å½“å‰çª—å£
                    if (window.pywebview && window.pywebview.api) {
                        console.log('âœ… åœ¨å½“å‰çª—å£æ‰¾åˆ°API');
                        resolve(window.pywebview.api);
                        return;
                    }
                    
                    // æ£€æŸ¥çˆ¶çª—å£ (follow_wechat.html)
                    try {
                        if (window.parent && window.parent !== window && window.parent.pywebview && window.parent.pywebview.api) {
                            console.log('âœ… åœ¨çˆ¶çª—å£æ‰¾åˆ°API');
                            resolve(window.parent.pywebview.api);
                            return;
                        }
                    } catch (e) {
                        console.warn('æ— æ³•è®¿é—®çˆ¶çª—å£API:', e.message);
                    }
                    
                    // æ£€æŸ¥é¡¶å±‚çª—å£ (index.html)
                    try {
                        if (window.top && window.top !== window && window.top.pywebview && window.top.pywebview.api) {
                            console.log('âœ… åœ¨é¡¶å±‚çª—å£æ‰¾åˆ°API');
                            resolve(window.top.pywebview.api);
                            return;
                        }
                    } catch (e) {
                        console.warn('æ— æ³•è®¿é—®é¡¶å±‚çª—å£API:', e.message);
                    }
                    
                    if (attempts >= maxAttempts) {
                        console.error('âŒ è¶…æ—¶ï¼šæ— æ³•æ‰¾åˆ°pywebview API');
                        reject(new Error('æ— æ³•è¿æ¥åˆ°åç«¯APIï¼Œè¯·ç¡®ä¿åº”ç”¨æ­£å¸¸è¿è¡Œ'));
                        return;
                    }
                    
                    console.log(`ğŸ” å°è¯• ${attempts}/${maxAttempts}: æ­£åœ¨æŸ¥æ‰¾API...`);
                    setTimeout(checkApi, 100);
                };
                
                checkApi();
            });
        };

        const app = createApp({
            setup() {
                const tasks = ref([]);
                const taskLogs = ref([]);
                const tasksLoading = ref(false);
                const logsLoading = ref(false);
                const taskTypeFilter = ref('');
                const taskStatusFilter = ref('');
                const logStatusFilter = ref('');
                const apiReady = ref(false); // APIè¿æ¥çŠ¶æ€
                
                // åˆ†é¡µç›¸å…³çŠ¶æ€
                const taskCurrentPage = ref(1);
                const taskPageSize = ref(5); // é»˜è®¤æ¯é¡µ5æ¡
                const logCurrentPage = ref(1);
                const logPageSize = ref(5); // é»˜è®¤æ¯é¡µ5æ¡

                // è®¡ç®—å±æ€§ï¼šç­›é€‰åçš„ä»»åŠ¡
                const filteredTasks = computed(() => {
                    return tasks.value.filter(task => {
                        if (taskTypeFilter.value && task.task_type !== taskTypeFilter.value) return false;
                        if (taskStatusFilter.value && task.status.toString() !== taskStatusFilter.value) return false;
                        return true;
                    });
                });

                // è®¡ç®—å±æ€§ï¼šç­›é€‰åçš„æ—¥å¿—
                const filteredTaskLogs = computed(() => {
                    return taskLogs.value.filter(log => {
                        if (logStatusFilter.value && log.status.toString() !== logStatusFilter.value) return false;
                        return true;
                    });
                });
                
                // è®¡ç®—å±æ€§ï¼šåˆ†é¡µåçš„ä»»åŠ¡æ•°æ®
                const paginatedTasks = computed(() => {
                    const start = (taskCurrentPage.value - 1) * taskPageSize.value;
                    const end = start + taskPageSize.value;
                    return filteredTasks.value.slice(start, end);
                });
                
                // è®¡ç®—å±æ€§ï¼šåˆ†é¡µåçš„æ—¥å¿—æ•°æ®
                const paginatedTaskLogs = computed(() => {
                    const start = (logCurrentPage.value - 1) * logPageSize.value;
                    const end = start + logPageSize.value;
                    return filteredTaskLogs.value.slice(start, end);
                });

                // åŠ è½½ä»»åŠ¡åˆ—è¡¨
                const loadTasks = async () => {
                    try {
                        console.log('ğŸ”„ å¼€å§‹åŠ è½½ä»»åŠ¡åˆ—è¡¨...');
                        tasksLoading.value = true;
                        
                        const api = await waitForApi();
                        console.log('ğŸ”Œ è°ƒç”¨ get_task_list API...');
                        
                        const result = await api.get_task_list();
                        console.log('ğŸ“Š APIå“åº”ç»“æœ:', result);
                        
                        if (result && result.success) {
                            tasks.value = result.data || [];
                            console.log(`âœ… æˆåŠŸåŠ è½½ ${tasks.value.length} ä¸ªä»»åŠ¡`);
                            
                            // å¤„ç†ä»»åŠ¡æ•°æ®ï¼Œæ·»åŠ æ˜¾ç¤ºæ–‡æœ¬
                            tasks.value.forEach(task => {
                                task.type_text = getTaskTypeText(task.task_type);
                                task.status_text = task.status === 0 ? 'ç­‰å¾…è§¦å‘' : 'å·²å¤±æ•ˆ';
                            });
                        } else {
                            console.error('è·å–ä»»åŠ¡å¤±è´¥:', result?.message);
                            ElementPlus.ElMessage.error('è·å–ä»»åŠ¡å¤±è´¥: ' + (result?.message || 'æœªçŸ¥é”™è¯¯'));
                        }
                    } catch (error) {
                        console.error('åŠ è½½ä»»åŠ¡å¤±è´¥:', error);
                        ElementPlus.ElMessage.error('åŠ è½½ä»»åŠ¡å¤±è´¥: ' + error.message);
                    } finally {
                        tasksLoading.value = false;
                    }
                };

                // åŠ è½½ä»»åŠ¡æ—¥å¿—
                const loadTaskLogs = async () => {
                    try {
                        console.log('ğŸ”„ å¼€å§‹åŠ è½½ä»»åŠ¡æ—¥å¿—...');
                        logsLoading.value = true;
                        
                        const api = await waitForApi();
                        console.log('ğŸ”Œ è°ƒç”¨ get_task_logs API...');
                        
                        const result = await api.get_task_logs();
                        console.log('ğŸ“Š APIå“åº”ç»“æœ:', result);
                        
                        if (result && result.success) {
                            taskLogs.value = result.data || [];
                            console.log(`âœ… æˆåŠŸåŠ è½½ ${taskLogs.value.length} æ¡æ—¥å¿—`);
                            
                            // å¤„ç†æ—¥å¿—æ•°æ®ï¼Œæ·»åŠ æ˜¾ç¤ºæ–‡æœ¬
                            taskLogs.value.forEach(log => {
                                log.status_text = log.status === 1 ? 'æˆåŠŸ' : 'å¤±è´¥';
                            });
                        } else {
                            console.error('è·å–ä»»åŠ¡æ—¥å¿—å¤±è´¥:', result?.message);
                            ElementPlus.ElMessage.error('è·å–ä»»åŠ¡æ—¥å¿—å¤±è´¥: ' + (result?.message || 'æœªçŸ¥é”™è¯¯'));
                        }
                    } catch (error) {
                        console.error('åŠ è½½ä»»åŠ¡æ—¥å¿—å¤±è´¥:', error);
                        ElementPlus.ElMessage.error('åŠ è½½ä»»åŠ¡æ—¥å¿—å¤±è´¥: ' + error.message);
                    } finally {
                        logsLoading.value = false;
                    }
                };

                // åˆ·æ–°ä»»åŠ¡
                const refreshTasks = async () => {
                    await loadTasks();
                    ElementPlus.ElMessage.success('ä»»åŠ¡åˆ—è¡¨å·²åˆ·æ–°');
                };

                // åˆ·æ–°æ—¥å¿—
                const refreshTaskLogs = async () => {
                    await loadTaskLogs();
                    ElementPlus.ElMessage.success('ä»»åŠ¡æ—¥å¿—å·²åˆ·æ–°');
                };

                // å–æ¶ˆä»»åŠ¡ï¼ˆæ›¿æ¢åŸæ¥çš„å¤±æ•ˆä»»åŠ¡åŠŸèƒ½ï¼‰
                const cancelTask = async (taskId) => {
                    try {
                        await ElementPlus.ElMessageBox.confirm('ç¡®å®šè¦å–æ¶ˆè¿™ä¸ªä»»åŠ¡å—ï¼Ÿå–æ¶ˆåä»»åŠ¡å°†è¢«æ ‡è®°ä¸ºå¤±æ•ˆçŠ¶æ€ã€‚', 'ç¡®è®¤å–æ¶ˆ', {
                            confirmButtonText: 'ç¡®å®šå–æ¶ˆ',
                            cancelButtonText: 'ä¿ç•™ä»»åŠ¡',
                            type: 'warning'
                        });

                        const api = await waitForApi();
                        const result = await api.invalidate_task(taskId);
                        
                        if (result && result.success) {
                            ElementPlus.ElMessage.success('ä»»åŠ¡å·²å–æ¶ˆ');
                            await loadTasks();
                        } else {
                            ElementPlus.ElMessage.error(result?.message || 'å–æ¶ˆå¤±è´¥');
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('å–æ¶ˆä»»åŠ¡å¤±è´¥:', error);
                            ElementPlus.ElMessage.error('æ“ä½œå¤±è´¥');
                        }
                    }
                };

                // è·å–ä»»åŠ¡ç±»å‹æ–‡æœ¬
                const getTaskTypeText = (taskType) => {
                    switch (taskType) {
                        case 'live_reminder':
                            return 'ç›´æ’­æé†’';
                        case 'follow_task':
                            return 'è·Ÿæ’­ä»»åŠ¡';
                        case 'test_follow_task':
                            return 'æµ‹è¯•è·Ÿæ’­';
                        case 'image_recognition':
                            return 'å›¾åƒè¯†åˆ«';
                        case 'danmu_task':
                            return 'å¼¹å¹•ä»»åŠ¡';
                        default:
                            return taskType;
                    }
                };

                // è·å–ä»»åŠ¡ç±»å‹æ ‡ç­¾ç±»å‹
                const getTaskTypeTagType = (taskType) => {
                    switch (taskType) {
                        case 'live_reminder':
                            return 'primary';
                        case 'follow_task':
                            return 'success';
                        case 'test_follow_task':
                            return 'warning';
                        case 'image_recognition':
                            return 'info';
                        case 'danmu_task':
                            return '';
                        default:
                            return 'info';
                    }
                };

                // æ ¼å¼åŒ–æ—¶é—´
                const formatTime = (timeStr) => {
                    if (!timeStr) return '-';
                    try {
                        const date = new Date(timeStr);
                        return date.toLocaleString('zh-CN');
                    } catch (error) {
                        return timeStr;
                    }
                };



                // ç»„ä»¶æŒ‚è½½æ—¶åŠ è½½æ•°æ®
                onMounted(async () => {
                    console.log('ğŸ“‹ ä»»åŠ¡ç®¡ç†å™¨æ­£åœ¨å¯åŠ¨...');
                    
                    try {
                        // æµ‹è¯•APIè¿æ¥
                        const api = await waitForApi();
                        console.log('âœ… APIè¿æ¥æˆåŠŸ:', typeof api);
                        apiReady.value = true; // è®¾ç½®APIå°±ç»ªçŠ¶æ€
                        
                        // åŠ è½½æ•°æ®
                        console.log('ğŸ”„ å¼€å§‹åŠ è½½ä»»åŠ¡æ•°æ®...');
                        await loadTasks();
                        console.log('âœ… ä»»åŠ¡æ•°æ®åŠ è½½å®Œæˆ');
                        
                        console.log('ğŸ”„ å¼€å§‹åŠ è½½æ—¥å¿—æ•°æ®...');
                        await loadTaskLogs();
                        console.log('âœ… æ—¥å¿—æ•°æ®åŠ è½½å®Œæˆ');
                        
                        console.log('ğŸ‰ ä»»åŠ¡ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ');
                    } catch (error) {
                        console.error('âŒ ä»»åŠ¡ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:', error);
                        ElementPlus.ElMessage.error('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                    }
                });

                return {
                    tasks,
                    taskLogs,
                    tasksLoading,
                    logsLoading,
                    taskTypeFilter,
                    taskStatusFilter,
                    logStatusFilter,
                    apiReady,
                    // åˆ†é¡µç›¸å…³çŠ¶æ€
                    taskCurrentPage,
                    taskPageSize,
                    logCurrentPage,
                    logPageSize,
                    // è®¡ç®—å±æ€§
                    filteredTasks,
                    filteredTaskLogs,
                    paginatedTasks,
                    paginatedTaskLogs,
                    // æ–¹æ³•
                    loadTasks,
                    loadTaskLogs,
                    refreshTasks,
                    refreshTaskLogs,
                    cancelTask,
                    getTaskTypeTagType,
                    formatTime
                };
            }
        });

        // æ³¨å†Œæ‰€æœ‰å›¾æ ‡
        if (typeof ElementPlusIconsVue !== 'undefined') {
            for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
                app.component(key, component);
            }
        }

        app.use(ElementPlus);
        
        // æŒ‚è½½åº”ç”¨ï¼Œæ·»åŠ é”™è¯¯å¤„ç†
        try {
            app.mount('#app');
            console.log('âœ… Vueåº”ç”¨æŒ‚è½½æˆåŠŸ');
        } catch (error) {
            console.error('âŒ Vueåº”ç”¨æŒ‚è½½å¤±è´¥:', error);
        }
    </script>
</body>
</html>