<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>微信视频号跟播</title>

    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <!-- Element Plus -->
    <script src="https://unpkg.com/element-plus@2/dist/index.full.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus@2/dist/index.css">
    <!-- Element Plus Icons -->
    <script src="https://unpkg.com/@element-plus/icons-vue@2/dist/index.iife.min.js"></script>
    <!-- Element Plus 中文语言包 -->
    <script src="https://cdn.staticfile.org/element-plus/2.1.11/locale/zh-cn.min.js"></script>

    <style>
        body {
            margin: 0;
            padding: 16px;
            background: #f8fafc;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            min-height: 100vh;
        }



        .container {
            max-width: 100%;
            margin: 0 auto;
            height: 100%;
        }

        .page-header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 16px;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
        }

        .content-grid {
            margin-bottom: 16px;
        }

        .content-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .card-header {
            padding: 24px;
            border-bottom: 1px solid #e5e7eb;
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
        }

        .card-body {
            padding: 24px;
        }

        /* 直播间容器 */
        .rooms-container {
            max-height: 350px;
            overflow-y: auto;
            padding: 2px;
        }

        .rooms-container::-webkit-scrollbar {
            width: 4px;
        }

        .rooms-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .rooms-container::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 2px;
        }

        .rooms-container::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        /* 直播间卡片 */
        .room-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            margin-bottom: 6px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            position: relative;
            overflow: hidden;
        }

        .room-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #64748b;
            transition: all 0.15s ease;
        }

        .room-item:hover {
            background: #ffffff;
            border-color: #3b82f6;
            box-shadow: 0 2px 12px rgba(59, 130, 246, 0.08);
            transform: translateY(-1px);
        }

        .room-item:hover::before {
            background: #3b82f6;
        }

        .room-item.active {
            background: #ffffff;
            border-color: #10b981;
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.12);
        }

        .room-item.active::before {
            background: #10b981;
            width: 4px;
        }

        /* 直播间信息 */
        .room-info {
            display: flex;
            align-items: center;
            flex: 1;
            min-width: 0;
        }

        .room-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            flex-shrink: 0;
        }

        .room-icon .el-icon {
            color: #ffffff !important;
            font-size: 16px;
        }

        .room-details {
            flex: 1;
            min-width: 0;
        }

        .room-name {
            font-weight: 600;
            color: #1e293b;
            font-size: 13px;
            line-height: 1.2;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .room-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: #64748b;
        }

        .room-time {
            white-space: nowrap;
        }

        .room-status {
            padding: 1px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 500;
            white-space: nowrap;
        }

        .room-status.active {
            background: #dcfce7;
            color: #166534;
        }

        .room-status.inactive {
            background: #fef2f2;
            color: #991b1b;
        }

        /* 操作按钮 */
        .room-actions {
            display: flex;
            align-items: center;
            gap: 2px;
            opacity: 0.6;
            transition: opacity 0.15s ease;
        }

        .room-item:hover .room-actions {
            opacity: 1;
        }

        .room-action-btn {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: none;
            background: transparent;
            color: #64748b !important;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .room-action-btn:hover {
            background: #f1f5f9 !important;
            color: #3b82f6 !important;
            transform: scale(1.1);
        }

        .room-action-btn.danger:hover {
            background: #fef2f2 !important;
            color: #dc2626 !important;
        }

        .room-action-btn.primary:hover {
            background: #eff6ff !important;
            color: #2563eb !important;
        }



        .speech-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 8px;
            background: #f9fafb;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-running {
            background: #10b981;
        }

        .status-stopped {
            background: #ef4444;
        }

        .status-paused {
            background: #f59e0b;
        }



        .control-panel {
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }



        /* 已绑定话术行样式 */
        .speech-bound-row {
            background-color: #fef3e2;
        }

        .speech-bound-row:hover {
            background-color: #fde68a !important;
        }



        /* 倒计时容器样式 */
        .countdown-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .countdown-time {
            font-size: 12px;
            color: #374151;
            font-weight: 500;
        }

        .countdown-badge {
            display: inline-block;
            white-space: nowrap;
        }

        /* 科技感动画效果 */
        @keyframes techGlow {
            0% {
                text-shadow: 0 0 8px rgba(255, 51, 102, 0.5), 0 0 16px rgba(255, 51, 102, 0.3);
                box-shadow: 0 0 12px rgba(255, 51, 102, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            }

            100% {
                text-shadow: 0 0 12px rgba(255, 51, 102, 0.8), 0 0 24px rgba(255, 51, 102, 0.5);
                box-shadow: 0 0 20px rgba(255, 51, 102, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2);
            }
        }

        @keyframes countdownPulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.05);
                opacity: 0.9;
            }
        }

        /* 科技感边框扫描效果 */
        @keyframes borderScan {
            0% {
                border-image: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.8), transparent) 1;
            }

            50% {
                border-image: linear-gradient(90deg, transparent, rgba(0, 212, 255, 1), transparent) 1;
            }

            100% {
                border-image: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.8), transparent) 1;
            }
        }

        /* 数字字体优化 */
        .tech-countdown {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Courier New', monospace;
            letter-spacing: 0.5px;
            position: relative;
            display: inline-block;
        }

        /* 科技感背景纹理 */
        .tech-countdown::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.1) 1px, transparent 1px),
                radial-gradient(circle at 80% 50%, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
            background-size: 8px 8px;
            border-radius: inherit;
            pointer-events: none;
            opacity: 0.3;
        }

        /* 配置对话框简洁样式 */
        .config-section {
            padding: 16px 0;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0 0 16px 0;
            font-size: 16px;
            font-weight: 600;
            color: #303133;
            padding-bottom: 8px;
            border-bottom: 1px solid #e4e7ed;
        }

        .config-hint {
            font-size: 12px;
            color: #909399;
            margin-top: 4px;
            line-height: 1.4;
        }





        .feature-card {
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .feature-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .feature-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .feature-title {
            font-weight: 600;
            color: #303133;
            font-size: 14px;
        }

        .feature-desc {
            font-size: 12px;
            color: #909399;
            line-height: 1.3;
        }

        .config-preview {
            margin-top: 16px;
        }

        .json-preview {
            font-size: 12px;
            line-height: 1.4;
            margin: 0;
            max-height: 300px;
            overflow: auto;
            color: #606266;
            background: #f5f7fa;
            border-radius: 4px;
            padding: 16px;
        }

        .config-footer {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 0 0 0;
        }
    </style>
</head>

<body>
    <div id="app">
        <div class="container">
            <!-- 页面头部 -->
            <div class="page-header">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <h1 style="margin: 0 0 6px 0; font-size: 22px; font-weight: 600;">
                            <el-icon style="margin-right: 8px;">
                                <VideoPlay />
                            </el-icon>
                            微信视频号跟播
                        </h1>
                        <p style="margin: 0; opacity: 0.9; font-size: 14px;">
                            智能微信视频号直播跟播系统，自动发送弹幕话术
                        </p>
                    </div>

                    <!-- 配置面板按钮 -->
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <el-badge :value="configBadge" :hidden="!configBadge" type="warning">
                            <el-button @click="configVisible = true" type="primary" size="small"
                                style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white;">
                                <el-icon style="margin-right: 4px;">
                                    <Setting />
                                </el-icon>
                                系统配置
                            </el-button>
                        </el-badge>

                        <!-- 配置状态指示器 -->
                        <div style="display: flex; gap: 4px; font-size: 11px; opacity: 0.8;">
                            <span :style="getConfigStatusStyle('screenshot')">
                                {{ systemConfig.features?.enable_screenshot ? '截图开启' : '截图关闭' }}
                            </span>
                            <span :style="getConfigStatusStyle('logs')">
                                {{ systemConfig.features?.enable_detailed_logs ? '详细日志' : '简单日志' }}
                            </span>
                            <span style="color: rgba(255,255,255,0.7);">
                                弹幕: {{ systemConfig.intervals?.bullet_screen_send || 500 }}s
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 主内容区 -->
            <div class="content-card">
                <div class="card-header">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <h2 style="margin: 0; font-size: 16px; font-weight: 600; color: #1f2937;">微信直播间管理</h2>
                            <p style="margin: 2px 0 0 0; color: #6b7280; font-size: 12px;">管理直播间和绑定话术</p>
                            <!-- 商品绑定统计 -->
                            <div v-if="wechatRooms.length > 0"
                                style="margin-top: 6px; display: flex; gap: 12px; font-size: 11px;">
                                <span style="color: #059669;">
                                    <el-icon size="10" style="margin-right: 2px;">
                                        <ShoppingBag />
                                    </el-icon>
                                    已绑定: {{ boundProductCount }}
                                </span>
                                <span style="color: #6b7280;">
                                    <el-icon size="10" style="margin-right: 2px;">
                                        <Box />
                                    </el-icon>
                                    未绑定: {{ unboundProductCount }}
                                </span>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                            <el-input v-model="searchKeyword" placeholder="搜索直播间..." size="small" style="width: 200px;"
                                clearable>
                                <template #prefix>
                                    <el-icon>
                                        <Search />
                                    </el-icon>
                                </template>
                            </el-input>
                            <el-button size="small" @click="showAddRoomDialog">
                                <el-icon style="margin-right: 4px;">
                                    <Plus />
                                </el-icon>
                                添加直播间
                            </el-button>

                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- 批量操作区域 -->
                    <div v-if="selectedRooms.length > 0"
                        style="margin-bottom: 16px; padding: 12px; background: rgba(64, 158, 255, 0.1); border: 1px solid rgba(64, 158, 255, 0.3); border-radius: 6px;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <span style="color: #409eff; font-size: 14px;">
                                <el-icon style="margin-right: 4px;">
                                    <InfoFilled />
                                </el-icon>
                                已选择 {{ selectedRooms.length }} 个直播间
                            </span>
                            <div style="display: flex; gap: 8px;">
                                <el-button type="primary" size="small" @click="startBatchFollow">
                                    <el-icon style="margin-right: 4px;">
                                        <VideoPlay />
                                    </el-icon>
                                    开始跟播
                                </el-button>

                                <el-button size="small" @click="batchBindProduct" type="warning" plain>
                                    <el-icon style="margin-right: 4px;">
                                        <ShoppingBag />
                                    </el-icon>
                                    批量绑定商品
                                </el-button>
                                <el-button size="small" @click="clearSelection">
                                    <el-icon style="margin-right: 4px;">
                                        <Close />
                                    </el-icon>
                                    取消选择
                                </el-button>
                            </div>
                        </div>
                    </div>

                    <div v-if="wechatRooms.length === 0" style="text-align: center; color: #9ca3af; padding: 40px 0;">
                        <el-icon size="48" style="margin-bottom: 16px;">
                            <Monitor />
                        </el-icon>
                        <p>暂无微信直播间</p>
                        <el-button type="primary" @click="showAddRoomDialog">添加第一个直播间</el-button>
                    </div>
                    <div v-else>
                        <el-table :data="filteredWechatRooms" style="width: 100%;" size="small"
                            @selection-change="handleSelectionChange" ref="roomTableRef">
                            <el-table-column type="selection" width="55" align="center"></el-table-column>
                            <el-table-column prop="id" label="ID" width="60" align="center">
                            </el-table-column>
                            <el-table-column prop="name" label="直播间名称" show-overflow-tooltip>
                                <template #default="scope">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span>{{ scope.row.name }}</span>
                                        <el-tag v-if="scope.row.status === 0" type="danger" size="small">
                                            禁用 - 不会自动跟播
                                        </el-tag>
                                    </div>
                                </template>
                            </el-table-column>
                            <el-table-column label="下次直播时间" align="center">
                                <template #default="scope">
                                    <div v-if="scope.row.next_live_time" class="countdown-container">
                                        <div class="countdown-time">{{ scope.row.next_live_time }}</div>
                                        <!-- 倒计时 - 使用计算属性 -->
                                        <div class="countdown-badge tech-countdown"
                                            :style="roomCountdowns[scope.row.id]?.style || {}">
                                            {{ roomCountdowns[scope.row.id]?.text || '' }}
                                        </div>
                                    </div>
                                    <span v-else style="color: #9ca3af; font-size: 12px;">未设置</span>
                                </template>
                            </el-table-column>
                            <el-table-column label="绑定话术" show-overflow-tooltip>
                                <template #default="scope">
                                    <div v-if="getRoomSpeech(scope.row.id).length === 0"
                                        style="color: #9ca3af; font-size: 12px;">
                                        暂无绑定话术
                                    </div>
                                    <div v-else style="font-size: 12px; line-height: 1.4;">
                                        <div
                                            style="padding: 2px 6px; background: #f0f9ff; border-radius: 4px; border-left: 2px solid #3b82f6;">
                                            {{ getRoomSpeech(scope.row.id)[0].content.length > 50 ?
                                            getRoomSpeech(scope.row.id)[0].content.substring(0, 50) + '...' :
                                            getRoomSpeech(scope.row.id)[0].content }}
                                        </div>
                                        <div v-if="getRoomSpeech(scope.row.id).length > 1"
                                            style="font-size: 11px; color: #6b7280; margin-top: 2px;">
                                            还有 {{ getRoomSpeech(scope.row.id).length - 1 }} 条话术
                                        </div>
                                    </div>
                                </template>
                            </el-table-column>
                            <el-table-column label="绑定商品" width="180" align="center">
                                <template #default="scope">
                                    <div v-if="!scope.row.product_name"
                                        style="color: #9ca3af; font-size: 12px; text-align: center;">
                                        <div style="padding: 8px;">
                                            <el-icon size="16" style="margin-bottom: 4px;">
                                                <Box />
                                            </el-icon>
                                            <div>暂无绑定</div>
                                        </div>
                                    </div>
                                    <div v-else style="display: flex; align-items: center; gap: 8px; padding: 4px;">
                                        <div
                                            style="width: 32px; height: 32px; border-radius: 4px; overflow: hidden; flex-shrink: 0;">
                                            <img v-if="scope.row.productCoverObjectUrl"
                                                :src="scope.row.productCoverObjectUrl"
                                                style="width: 100%; height: 100%; object-fit: cover;"
                                                @error="handleImageError" />
                                            <div v-else
                                                style="width: 100%; height: 100%; background: #f3f4f6; display: flex; align-items: center; justify-content: center;">
                                                <el-icon size="16" color="#9ca3af">
                                                    <Picture />
                                                </el-icon>
                                            </div>
                                        </div>
                                        <div style="flex: 1; min-width: 0;">
                                            <div
                                                style="font-size: 12px; font-weight: 500; color: #1f2937; line-height: 1.2; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                {{ scope.row.product_name }}
                                            </div>
                                            <div v-if="scope.row.product_price"
                                                style="font-size: 11px; color: #ef4444; margin-top: 2px;">
                                                ¥{{ scope.row.product_price }}
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </el-table-column>
                            <el-table-column prop="status" label="状态" align="center">
                                <template #default="scope">
                                    <el-tag :type="scope.row.status === 1 ? 'success' : 'danger'" size="small">
                                        {{ scope.row.status === 1 ? '启用' : '禁用' }}
                                    </el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column prop="create_time" label="创建时间" align="center">
                                <template #default="scope">
                                    <span style="font-size: 12px;">{{ scope.row.create_time }}</span>
                                </template>
                            </el-table-column>
                            <el-table-column label="操作" align="center" width="280" fixed="right">
                                <template #default="scope">
                                    <div
                                        style="display: flex; gap: 6px; justify-content: center; align-items: center; flex-wrap: nowrap;">
                                        <el-button size="small" type="text" @click="manageLiveTime(scope.row)">
                                            <el-icon style="margin-right: 2px;">
                                                <Clock />
                                            </el-icon>
                                            安排
                                        </el-button>
                                        <el-button size="small" type="text" @click="editRoom(scope.row)">
                                            <el-icon style="margin-right: 2px;">
                                                <Edit />
                                            </el-icon>
                                            编辑
                                        </el-button>
                                        <el-dropdown @command="handleDropdownCommand" trigger="click">
                                            <el-button size="small" type="text">
                                                更多
                                                <el-icon style="margin-left: 2px;">
                                                    <ArrowDown />
                                                </el-icon>
                                            </el-button>
                                            <template #dropdown>
                                                <el-dropdown-menu>
                                                    <el-dropdown-item
                                                        :command="{action: 'viewSpeech', room: scope.row}">
                                                        <el-icon style="margin-right: 6px;">
                                                            <Document />
                                                        </el-icon>
                                                        查看话术
                                                    </el-dropdown-item>
                                                    <el-dropdown-item
                                                        :command="{action: 'bindProduct', room: scope.row}">
                                                        <el-icon style="margin-right: 6px;">
                                                            <ShoppingBag />
                                                        </el-icon>
                                                        商品绑定
                                                    </el-dropdown-item>
                                                    <el-dropdown-item :command="{action: 'deleteRoom', room: scope.row}"
                                                        divided>
                                                        <el-icon style="margin-right: 6px; color: #f56565;">
                                                            <Delete />
                                                        </el-icon>
                                                        <span style="color: #f56565;">删除直播间</span>
                                                    </el-dropdown-item>
                                                </el-dropdown-menu>
                                            </template>
                                        </el-dropdown>
                                    </div>
                                </template>
                            </el-table-column>
                        </el-table>

                        <!-- 🔥 新增：分页组件 -->
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-top: 16px; padding: 0 16px;">
                            <div style="font-size: 14px; color: #6b7280;">
                                共 {{ totalRooms }} 个直播间，当前显示第 {{ (currentPage - 1) * pageSize + 1 }} - {{
                                Math.min(currentPage * pageSize, totalRooms) }} 个
                            </div>
                            <el-pagination v-model:current-page="currentPage" v-model:page-size="pageSize"
                                :page-sizes="[10, 20, 50, 100]" :total="totalRooms"
                                layout="sizes, prev, pager, next, jumper" @size-change="handleSizeChange"
                                @current-change="handleCurrentChange" small />
                        </div>
                    </div>
                </div>
            </div>

            <!-- 任务与日志管理 -->
            <div class="content-card" style="margin-top: 20px;">
                <div class="card-header">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <h2 style="margin: 0; font-size: 18px; font-weight: 600; color: #1f2937;">📋 任务与日志管理</h2>
                            <p style="margin: 4px 0 0 0; color: #6b7280; font-size: 14px;">跟播任务、执行日志和实时运行状态</p>
                        </div>
                    </div>
                </div>
                <div class="card-body" style="padding: 0;">
                    <iframe src="tasks.html"
                        style="width: 100%; height: 600px; border: none; border-radius: 0 0 8px 8px;" frameborder="0">
                    </iframe>
                </div>
            </div>
        </div>

        <!-- 添加/编辑直播间对话框 -->
        <el-dialog v-model="roomDialogVisible" :title="roomDialogTitle" width="600px">
            <el-form :model="roomForm" :rules="roomRules" ref="roomFormRef" label-width="120px">
                <el-form-item label="直播间名称" prop="name">
                    <el-input v-model="roomForm.name" placeholder="请输入直播间名称"></el-input>
                </el-form-item>



                <el-form-item label="状态" prop="status">
                    <el-radio-group v-model="roomForm.status">
                        <el-radio :label="1">启用</el-radio>
                        <el-radio :label="0">禁用</el-radio>
                    </el-radio-group>
                </el-form-item>
            </el-form>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="roomDialogVisible = false">取消</el-button>
                    <el-button type="primary" @click="saveRoom" :loading="saving">
                        {{ isEditRoom ? '更新' : '添加' }}
                    </el-button>
                </span>
            </template>
        </el-dialog>

        <!-- 查看绑定话术对话框 -->
        <el-dialog v-model="speechViewDialogVisible" :title="`${currentViewRoom?.name || ''} - 绑定话术`" width="700px">
            <div v-if="currentRoomSpeech.length === 0" style="text-align: center; color: #9ca3af; padding: 40px 0;">
                <el-icon size="48" style="margin-bottom: 16px;">
                    <Document />
                </el-icon>
                <p>该直播间暂无绑定话术</p>
            </div>
            <div v-else>
                <el-table :data="currentRoomSpeech" style="width: 100%;" size="small">
                    <el-table-column prop="content" label="话术内容" show-overflow-tooltip>
                        <template #default="scope">
                            <div style="font-size: 13px;">{{ scope.row.content }}</div>
                        </template>
                    </el-table-column>
                    <el-table-column prop="bind_time" label="绑定时间" width="140" align="center">
                        <template #default="scope">
                            <span style="font-size: 12px;">{{ scope.row.bind_time }}</span>
                        </template>
                    </el-table-column>
                    <el-table-column label="操作" width="80" align="center">
                        <template #default="scope">
                            <el-button size="small" type="text" @click="unbindSpeechFromRoom(scope.row)">解绑</el-button>
                        </template>
                    </el-table-column>
                </el-table>
            </div>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="speechViewDialogVisible = false">关闭</el-button>
                    <el-button type="primary" @click="bindSpeech(currentViewRoom)">绑定更多话术</el-button>
                </span>
            </template>
        </el-dialog>

        <!-- 绑定话术对话框 -->
        <el-dialog v-model="speechBindDialogVisible" title="绑定话术" width="800px">
            <div style="margin-bottom: 16px;">
                <el-input v-model="speechSearchKeyword" placeholder="搜索话术内容..." clearable
                    style="width: 300px; margin-right: 12px;">
                    <template #prefix>
                        <el-icon>
                            <Search />
                        </el-icon>
                    </template>
                </el-input>
                <el-button @click="loadAllSpeech">
                    <el-icon style="margin-right: 4px;">
                        <Refresh />
                    </el-icon>
                    刷新
                </el-button>
            </div>
            <el-table :data="filteredAllSpeech" style="width: 100%;" size="small"
                @selection-change="handleSpeechSelection" :row-class-name="getSpeechRowClassName">
                <el-table-column type="selection" width="55" :selectable="isSpeechSelectable"></el-table-column>
                <el-table-column prop="content" label="话术内容" min-width="300">
                    <template #default="scope">
                        <div style="font-size: 13px;">{{ scope.row.content }}</div>
                    </template>
                </el-table-column>
                <el-table-column label="绑定状态" width="120">
                    <template #default="scope">
                        <el-tag v-if="isSpeechBoundToCurrentRoom(scope.row)" type="warning" size="small">
                            已绑定
                        </el-tag>
                        <span v-else style="font-size: 12px; color: #9ca3af;">未绑定</span>
                    </template>
                </el-table-column>
                <el-table-column prop="status" label="状态" width="80" align="center">
                    <template #default="scope">
                        <el-tag :type="scope.row.status === 1 ? 'success' : 'danger'" size="small">
                            {{ scope.row.status === 1 ? '启用' : '禁用' }}
                        </el-tag>
                    </template>
                </el-table-column>
            </el-table>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="speechBindDialogVisible = false">取消</el-button>
                    <el-button type="primary" @click="confirmBindSpeech" :loading="binding">
                        绑定选中话术 ({{ selectedSpeechList.length }})
                    </el-button>
                </span>
            </template>
        </el-dialog>

        <!-- 商品绑定对话框 -->
        <el-dialog v-model="productBindDialogVisible" width="800px" :close-on-click-modal="false">
            <template #header>
                <div style="display: flex; align-items: center; gap: 12px; padding: 4px 0;">
                    <div
                        style="width: 36px; height: 36px; background: #6366f1; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        <el-icon size="18" color="white">
                            <Link />
                        </el-icon>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-size: 16px; font-weight: 600; color: #1f2937; margin-bottom: 2px;">商品绑定管理</div>
                        <div style="font-size: 13px; color: #6b7280; display: flex; align-items: center; gap: 4px;">
                            <el-icon size="12">
                                <VideoCamera />
                            </el-icon>
                            {{ currentBindRoom?.name || '' }}
                        </div>
                    </div>
                    <div v-if="currentBindRoom?.product_name"
                        style="padding: 4px 10px; background: #10b981; border-radius: 12px; color: white; font-size: 11px; font-weight: 500;">
                        已绑定商品
                    </div>
                </div>
            </template>

            <div style="padding: 16px 20px;">
                <!-- 当前绑定状态 -->
                <div style="margin-bottom: 24px;">
                    <div
                        style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 12px; display: flex; align-items: center; gap: 6px;">
                        <div style="width: 3px; height: 16px; background: #6366f1; border-radius: 2px;"></div>
                        当前绑定状态
                    </div>
                    <div v-if="!currentBindRoom?.product_name"
                        style="padding: 16px; background: #f9fafb; border: 1px dashed #d1d5db; border-radius: 8px; text-align: center;">
                        <div
                            style="width: 48px; height: 48px; background: #e5e7eb; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px;">
                            <el-icon size="20" color="#9ca3af">
                                <Box />
                            </el-icon>
                        </div>
                        <div style="color: #6b7280; font-size: 14px; font-weight: 500; margin-bottom: 4px;">暂无绑定商品</div>
                        <div style="color: #9ca3af; font-size: 12px;">请在下方选择要绑定的商品</div>
                    </div>
                    <div v-else
                        style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                        <!-- 商品基本信息 -->
                        <div style="padding: 16px; display: flex; align-items: center; gap: 12px;">
                            <div v-if="currentBindRoom.productCoverObjectUrl"
                                style="width: 48px; height: 48px; border-radius: 6px; overflow: hidden; flex-shrink: 0;">
                                <img :src="currentBindRoom.productCoverObjectUrl"
                                    style="width: 100%; height: 100%; object-fit: cover;" @error="handleImageError" />
                            </div>
                            <div v-else
                                style="width: 48px; height: 48px; background: #f59e0b; border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                                <el-icon size="20" color="white">
                                    <ShoppingBag />
                                </el-icon>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 15px; font-weight: 600; color: #1f2937; margin-bottom: 2px;">{{
                                    currentBindRoom.product_name }}</div>
                                <div v-if="currentBindRoom.product_price"
                                    style="font-size: 14px; color: #dc2626; font-weight: 500;">¥{{
                                    currentBindRoom.product_price }}</div>
                                <div v-else style="font-size: 12px; color: #6b7280;">价格待定</div>
                            </div>
                            <div
                                style="padding: 4px 8px; background: #10b981; border-radius: 12px; color: white; font-size: 11px; font-weight: 500;">
                                已绑定商品
                            </div>
                        </div>


                        <!-- 绑定图片区域 -->
                        <div v-if="currentBindRoom.boundImages && currentBindRoom.boundImages.length > 0"
                            style="border-top: 1px solid #f3f4f6; padding: 16px; background: #fafbfc;">
                            <div
                                style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                                <div
                                    style="font-size: 13px; color: #374151; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                                    <el-icon size="14" color="#6366f1">
                                        <Picture />
                                    </el-icon>
                                    绑定图片
                                </div>
                                <div
                                    style="font-size: 11px; color: #6b7280; background: #e5e7eb; padding: 2px 6px; border-radius: 10px;">
                                    {{ currentBindRoom.boundImages.length }}张
                                </div>
                            </div>

                            <!-- 图片网格 -->
                            <div
                                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 8px; max-width: 280px;">
                                <div v-for="(image, index) in currentBindRoom.boundImages.slice(0, 6)" :key="image.id"
                                    style="position: relative; width: 40px; height: 40px; border-radius: 6px; overflow: hidden; border: 1px solid #e5e7eb; cursor: pointer;">
                                    <img v-if="image.objectUrl" :src="image.objectUrl"
                                        style="width: 100%; height: 100%; object-fit: cover;" />
                                    <div v-else
                                        style="width: 100%; height: 100%; background: #f9fafb; display: flex; align-items: center; justify-content: center;">
                                        <el-icon size="16" color="#9ca3af">
                                            <Picture />
                                        </el-icon>
                                    </div>
                                    <!-- 图片序号 -->
                                    <div
                                        style="position: absolute; top: 2px; right: 2px; width: 16px; height: 16px; background: rgba(0,0,0,0.6); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 500;">
                                        {{ index + 1 }}
                                    </div>
                                </div>

                                <!-- 更多图片提示 -->
                                <div v-if="currentBindRoom.boundImages.length > 6"
                                    style="width: 40px; height: 40px; border-radius: 6px; background: #f3f4f6; border: 1px solid #d1d5db; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 9px; color: #6b7280; font-weight: 600;">
                                    <div style="font-size: 10px;">+{{ currentBindRoom.boundImages.length - 6 }}</div>
                                    <div>更多</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 商品选择 -->
                <div style="margin-bottom: 24px;">
                    <div
                        style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 12px; display: flex; align-items: center; gap: 6px;">
                        <div style="width: 3px; height: 16px; background: #6366f1; border-radius: 2px;"></div>
                        选择商品
                    </div>
                    <el-select v-model="productBindForm.product_id" placeholder="请选择要绑定的商品" clearable filterable
                        style="width: 100%;" size="default" @change="onProductSelectionChange">
                        <el-option v-for="product in productOptions" :key="product.id" :label="product.name"
                            :value="product.id">
                        </el-option>
                    </el-select>
                    <div
                        style="margin-top: 8px; padding: 8px 12px; background: #f0f9ff; border: 1px solid #e0f2fe; border-radius: 6px;">
                        <div style="font-size: 12px; color: #0369a1; display: flex; align-items: center; gap: 4px;">
                            <el-icon size="12">
                                <InfoFilled />
                            </el-icon>
                            <span style="font-weight: 500;">操作提示：</span>
                            清空选择可解除当前商品绑定
                        </div>
                    </div>
                </div>
            </div>

            <template #footer>
                <div style="padding: 12px 0; border-top: 1px solid #f1f5f9;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1; margin-right: 16px;">
                            <div style="font-size: 12px; color: #64748b; line-height: 1.4;">
                                {{ getBindingActionHint }}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <el-button @click="productBindDialogVisible = false" size="default"
                                style="min-width: 70px;">
                                取消
                            </el-button>
                            <el-button :type="getBindingButtonType" @click="saveProductBinding" :loading="binding"
                                size="default" style="min-width: 100px; font-weight: 500;">
                                <el-icon style="margin-right: 4px;">
                                    <component :is="getBindingButtonIcon"></component>
                                </el-icon>
                                {{ getBindingButtonText }}
                            </el-button>
                        </div>
                    </div>
                </div>
            </template>
        </el-dialog>

        <!-- 批量商品绑定对话框 -->
        <el-dialog v-model="batchBindDialogVisible" width="600px" :close-on-click-modal="false">
            <template #header>
                <div style="display: flex; align-items: center; gap: 12px; padding: 4px 0;">
                    <div
                        style="width: 36px; height: 36px; background: #f59e0b; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        <el-icon size="18" color="white">
                            <Operation />
                        </el-icon>
                    </div>
                    <div>
                        <div style="font-size: 16px; font-weight: 600; color: #1f2937;">批量商品绑定</div>
                        <div style="font-size: 13px; color: #6b7280; margin-top: 2px;">为 {{ selectedRooms.length }}
                            个直播间绑定商品</div>
                    </div>
                </div>
            </template>

            <div style="padding: 16px 20px;">
                <!-- 选中的直播间 -->
                <div style="margin-bottom: 20px;">
                    <div
                        style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                        <div style="width: 3px; height: 14px; background: #f59e0b; border-radius: 2px;"></div>
                        选中的直播间
                    </div>
                    <div
                        style="max-height: 100px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; padding: 6px;">
                        <div v-for="room in selectedRooms" :key="room.id"
                            style="display: flex; align-items: center; justify-content: space-between; padding: 6px 8px; margin-bottom: 4px; background: #f9fafb; border-radius: 4px;">
                            <span style="font-size: 13px;">{{ room.name }}</span>
                            <el-tag v-if="room.product_name" size="small" type="warning" effect="plain">
                                已绑定
                            </el-tag>
                            <el-tag v-else size="small" type="info" effect="plain">
                                未绑定
                            </el-tag>
                        </div>
                    </div>
                </div>

                <!-- 商品选择 -->
                <div style="margin-bottom: 20px;">
                    <div
                        style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                        <div style="width: 3px; height: 14px; background: #f59e0b; border-radius: 2px;"></div>
                        选择商品
                    </div>
                    <el-select v-model="batchBindForm.product_id" placeholder="请选择要绑定的商品" clearable filterable
                        style="width: 100%;" size="default">
                        <el-option v-for="product in productOptions" :key="product.id" :label="product.name"
                            :value="product.id">
                        </el-option>
                    </el-select>
                    <div
                        style="font-size: 11px; color: #6b7280; margin-top: 6px; padding: 6px 8px; background: #f0f9ff; border-radius: 4px;">
                        💡 提示：清空选择可解除所有选中直播间的商品绑定
                    </div>
                </div>
            </div>

            <template #footer>
                <div style="padding: 12px 0; border-top: 1px solid #f1f5f9;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 12px; color: #6b7280;">
                            将为 {{ selectedRooms.length }} 个直播间{{ batchBindForm.product_id ? '绑定商品' : '解除绑定' }}
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <el-button @click="batchBindDialogVisible = false" size="default">
                                取消
                            </el-button>
                            <el-button :type="batchBindForm.product_id ? 'warning' : 'danger'" @click="saveBatchBinding"
                                :loading="batchBinding" size="default">
                                <el-icon style="margin-right: 4px;">
                                    <component :is="batchBindForm.product_id ? 'Link' : 'Unlock'"></component>
                                </el-icon>
                                {{ batchBindForm.product_id ? '批量绑定' : '批量解绑' }}
                            </el-button>
                        </div>
                    </div>
            </template>
        </el-dialog>

        <!-- 直播时间管理对话框 -->
        <el-dialog v-model="liveTimeDialogVisible" :title="`${currentManageRoom?.name || ''} - 直播时间安排`" width="700px">
            <div style="margin-bottom: 16px;">
                <el-button plain type="primary" size="small" @click="showAddLiveTimeDialog">
                    <el-icon style="margin-right: 4px;">
                        <Plus />
                    </el-icon>
                    添加直播时间
                </el-button>
            </div>
            <div v-if="roomLiveTimes.length === 0" style="text-align: center; color: #9ca3af; padding: 40px 0;">
                <el-icon size="48" style="margin-bottom: 16px;">
                    <Clock />
                </el-icon>
                <p>该直播间暂无直播时间安排</p>
            </div>
            <div v-else>
                <el-table :data="roomLiveTimes" style="width: 100%;" size="small">
                    <el-table-column prop="live_time" label="直播时间" align="center">
                        <template #default="scope">
                            <span style="font-size: 13px;">{{ scope.row.live_time }}</span>
                        </template>
                    </el-table-column>
                    <el-table-column prop="status" label="状态" width="100" align="center">
                        <template #default="scope">
                            <el-tag :type="scope.row.status === 0 ? 'warning' : 'success'" size="small">
                                {{ scope.row.status === 0 ? '等待开播' : '已开播' }}
                            </el-tag>
                        </template>
                    </el-table-column>
                    <el-table-column prop="remark" label="备注" show-overflow-tooltip>
                        <template #default="scope">
                            <span style="font-size: 12px;">{{ scope.row.remark || '无' }}</span>
                        </template>
                    </el-table-column>
                    <el-table-column prop="create_time" label="创建时间" width="140" align="center">
                        <template #default="scope">
                            <span style="font-size: 12px;">{{ scope.row.create_time }}</span>
                        </template>
                    </el-table-column>
                    <el-table-column label="操作" width="180" align="center">
                        <template #default="scope">
                            <div style="display: flex; gap: 8px; justify-content: center; align-items: center;">
                                <el-button v-if="scope.row.status === 0" size="small" type="text"
                                    @click="markAsExpired(scope.row)" style="padding: 6px 12px;">
                                    <el-icon style="margin-right: 4px;">
                                        <Clock />
                                    </el-icon>
                                    标记过期
                                </el-button>
                                <el-button size="small" type="text" @click="deleteLiveTime(scope.row)"
                                    style="padding: 6px 12px;">
                                    <el-icon style="margin-right: 4px;">
                                        <Remove />
                                    </el-icon>
                                    删除
                                </el-button>
                            </div>
                        </template>
                    </el-table-column>
                </el-table>
            </div>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="liveTimeDialogVisible = false">关闭</el-button>
                </span>
            </template>
        </el-dialog>

        <!-- 添加直播时间对话框 -->
        <el-dialog v-model="addLiveTimeDialogVisible" title="添加直播时间" width="500px">
            <el-form :model="liveTimeForm" :rules="liveTimeRules" ref="liveTimeFormRef" label-width="100px">
                <el-form-item label="直播时间" prop="live_time">
                    <el-date-picker v-model="liveTimeForm.live_time" type="datetime" placeholder="选择直播时间"
                        format="YYYY-MM-DD HH:mm" value-format="YYYY-MM-DD HH:mm" style="width: 100%;"
                        :disabled-date="(time) => time.getTime() < Date.now() - 24 * 60 * 60 * 1000" :disabled-hours="() => {
                            const now = new Date();
                            const selected = new Date(liveTimeForm.live_time);
                            if (selected.toDateString() === now.toDateString()) {
                                return Array.from({length: now.getHours()}, (_, i) => i);
                            }
                            return [];
                        }" :disabled-minutes="(hour) => {
                            const now = new Date();
                            const selected = new Date(liveTimeForm.live_time);
                            if (selected.toDateString() === now.toDateString() && hour === now.getHours()) {
                                return Array.from({length: now.getMinutes() + 1}, (_, i) => i);
                            }
                            return [];
                        }">
                    </el-date-picker>
                </el-form-item>
                <el-form-item label="备注" prop="remark">
                    <el-input v-model="liveTimeForm.remark" type="textarea" :rows="3" placeholder="请输入备注信息（可选）">
                    </el-input>
                </el-form-item>
            </el-form>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="addLiveTimeDialogVisible = false">取消</el-button>
                    <el-button type="primary" @click="saveLiveTime" :loading="saving">确定</el-button>
                </span>
            </template>
        </el-dialog>

        <!-- 系统配置对话框 -->
        <el-dialog v-model="configVisible" title="系统配置" width="900px" :close-on-click-modal="false">
            <div v-loading="configLoading">
                <el-tabs type="border-card">

                    <!-- 时间间隔配置 -->
                    <el-tab-pane label="时间间隔">
                        <div class="config-section">
                            <h3 class="section-title">
                                <el-icon>
                                    <Timer />
                                </el-icon>
                                任务执行间隔设置
                            </h3>
                            <el-form :model="systemConfig.intervals" label-width="140px" size="small">
                                <el-row :gutter="16">
                                    <el-col :span="12">
                                        <el-form-item label="弹幕发送间隔">
                                            <el-input-number v-model="systemConfig.intervals.bullet_screen_send"
                                                :min="5" :max="3600" :step="5" style="width: 100%;">
                                                <template #append>秒</template>
                                            </el-input-number>
                                            <div class="config-hint">推荐：测试 5-60秒，生产 120-600秒</div>
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="12">
                                        <el-form-item label="弹幕重试间隔">
                                            <el-input-number v-model="systemConfig.intervals.bullet_screen_retry"
                                                :min="3" :max="60" :step="1" style="width: 100%;">
                                                <template #append>秒</template>
                                            </el-input-number>
                                            <div class="config-hint">弹幕发送失败后重试间隔</div>
                                        </el-form-item>
                                    </el-col>
                                </el-row>

                                <el-row :gutter="16">
                                    <el-col :span="12">
                                        <el-form-item label="跟播任务重试间隔">
                                            <el-input-number v-model="systemConfig.intervals.follow_task_retry"
                                                :min="10" :max="600" :step="10" style="width: 100%;">
                                                <template #append>秒</template>
                                            </el-input-number>
                                            <div class="config-hint">跟播任务执行失败后重试间隔</div>
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="12">
                                        <el-form-item label="图像识别重试间隔">
                                            <el-input-number v-model="systemConfig.intervals.image_recognition_retry"
                                                :min="5" :max="300" :step="5" style="width: 100%;">
                                                <template #append>秒</template>
                                            </el-input-number>
                                            <div class="config-hint">图像识别失败后重试间隔</div>
                                        </el-form-item>
                                    </el-col>
                                </el-row>

                                <el-row :gutter="16">
                                    <el-col :span="12">
                                        <el-form-item label="直播间检查间隔">
                                            <el-input-number v-model="systemConfig.intervals.live_room_check" :min="60"
                                                :max="1800" :step="30" style="width: 100%;">
                                                <template #append>秒</template>
                                            </el-input-number>
                                            <div class="config-hint">定期检查直播间状态的间隔</div>
                                        </el-form-item>
                                    </el-col>
                                </el-row>
                            </el-form>
                        </div>
                    </el-tab-pane>

                    <!-- 重试策略配置 -->
                    <el-tab-pane label="重试策略">
                        <div class="config-section">
                            <h3 class="section-title">
                                <el-icon>
                                    <Refresh />
                                </el-icon>
                                重试次数与策略设置
                            </h3>
                            <el-form :model="systemConfig.retry_config" label-width="140px" size="small">
                                <el-row :gutter="16">
                                    <el-col :span="12">
                                        <el-form-item label="弹幕重试次数">
                                            <el-input-number v-model="systemConfig.retry_config.max_bullet_retry"
                                                :min="1" :max="10" style="width: 100%;">
                                                <template #append>次</template>
                                            </el-input-number>
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="12">
                                        <el-form-item label="图像识别重试次数">
                                            <el-input-number v-model="systemConfig.retry_config.max_image_retry"
                                                :min="1" :max="20" style="width: 100%;">
                                                <template #append>次</template>
                                            </el-input-number>
                                        </el-form-item>
                                    </el-col>
                                </el-row>

                                <el-row :gutter="16">
                                    <el-col :span="12">
                                        <el-form-item label="跟播任务重试次数">
                                            <el-input-number v-model="systemConfig.retry_config.max_follow_retry"
                                                :min="1" :max="50" style="width: 100%;">
                                                <template #append>次</template>
                                            </el-input-number>
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="12">
                                        <el-form-item label="自动重试">
                                            <el-switch v-model="systemConfig.retry_config.enable_auto_retry"
                                                active-text="启用" inactive-text="禁用" />
                                            <div class="config-hint">关闭后需要手动重试失败的任务</div>
                                        </el-form-item>
                                    </el-col>
                                </el-row>
                            </el-form>
                        </div>
                    </el-tab-pane>

                    <!-- 功能开关 -->
                    <el-tab-pane label="功能开关">
                        <div class="config-section">
                            <h3 class="section-title">
                                <el-icon>
                                    <Operation />
                                </el-icon>
                                系统功能开关设置
                            </h3>
                            <el-form :model="systemConfig.features" label-width="140px" size="small">
                                <el-row :gutter="16">
                                    <el-col :span="6">
                                        <el-form-item label="截图功能">
                                            <el-switch v-model="systemConfig.features.enable_screenshot"
                                                @change="handleScreenshotChange" />
                                            <div class="config-hint">
                                                <span v-if="systemConfig.features.enable_screenshot"
                                                    style="color: #67c23a;">
                                                    已开启：自动截图保存识别结果
                                                </span>
                                                <span v-else style="color: #909399;">
                                                    已关闭：不进行截图保存
                                                </span>
                                            </div>
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="6">
                                        <el-form-item label="系统通知">
                                            <el-switch v-model="systemConfig.features.enable_notifications"
                                                @change="handleNotificationsChange" />
                                            <div class="config-hint">
                                                <span v-if="systemConfig.features.enable_notifications"
                                                    style="color: #67c23a;">
                                                    已开启：显示任务执行通知
                                                </span>
                                                <span v-else style="color: #909399;">
                                                    已关闭：不显示系统通知
                                                </span>
                                            </div>
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="6">
                                        <el-form-item label="详细日志">
                                            <el-switch v-model="systemConfig.features.enable_detailed_logs"
                                                @change="handleDetailedLogsChange" />
                                            <div class="config-hint">
                                                <span v-if="systemConfig.features.enable_detailed_logs"
                                                    style="color: #67c23a;">
                                                    已开启：记录详细操作信息
                                                </span>
                                                <span v-else style="color: #909399;">
                                                    已关闭：仅记录基本日志
                                                </span>
                                            </div>
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="6">
                                        <el-form-item label="真实发送弹幕">
                                            <el-switch v-model="systemConfig.features.enable_real_danmu_send"
                                                @change="handleRealDanmuSendChange" :loading="realDanmuSendLoading" />
                                            <div class="config-hint">
                                                <span v-if="systemConfig.features.enable_real_danmu_send"
                                                    style="color: #67c23a;">
                                                    已开启：OCR点击发送按钮
                                                </span>
                                                <span v-else style="color: #909399;">
                                                    已关闭：回车键模拟发送
                                                </span>
                                            </div>
                                        </el-form-item>
                                    </el-col>
                                </el-row>
                            </el-form>
                        </div>
                    </el-tab-pane>

                    <!-- 质量与性能 -->
                    <el-tab-pane label="质量与性能">
                        <div class="config-section">
                            <h3 class="section-title">
                                <el-icon>
                                    <Medal />
                                </el-icon>
                                图像识别与系统性能设置
                            </h3>
                            <el-form :model="systemConfig.quality" label-width="140px" size="small">
                                <el-row :gutter="16">
                                    <el-col :span="12">
                                        <el-form-item label="截图质量">
                                            <el-slider v-model="systemConfig.quality.screenshot_quality" :min="50"
                                                :max="100" :step="10" show-stops show-tooltip
                                                :format-tooltip="(val) => `${val}%`" />
                                            <div class="config-hint">较高质量会增加文件大小，但识别更准确</div>
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="12">
                                        <el-form-item label="图像匹配置信度">
                                            <el-slider v-model="systemConfig.quality.image_match_confidence" :min="0.5"
                                                :max="1.0" :step="0.05" show-stops show-tooltip
                                                :format-tooltip="(val) => `${(val * 100).toFixed(0)}%`" />
                                            <div class="config-hint">置信度越高识别越严格，但可能漏检</div>
                                        </el-form-item>
                                    </el-col>
                                </el-row>

                                <el-row :gutter="16">
                                    <el-col :span="12">
                                        <el-form-item label="日志级别">
                                            <el-select v-model="systemConfig.quality.log_level" style="width: 100%;">
                                                <el-option label="调试 (Debug)" value="debug" />
                                                <el-option label="信息 (Info)" value="info" />
                                                <el-option label="警告 (Warning)" value="warning" />
                                                <el-option label="错误 (Error)" value="error" />
                                            </el-select>
                                            <div class="config-hint">控制系统输出的日志详细程度</div>
                                        </el-form-item>
                                    </el-col>
                                </el-row>
                            </el-form>
                        </div>
                    </el-tab-pane>

                    <!-- 界面配置 -->
                    <el-tab-pane label="界面设置">
                        <div class="config-section">
                            <h3 class="section-title">
                                <el-icon>
                                    <Monitor />
                                </el-icon>
                                用户界面个性化设置
                            </h3>
                            <el-form :model="uiConfig" label-width="100px" size="small">
                                <el-row :gutter="16">
                                    <el-col :span="12">
                                        <el-form-item label="界面主题">
                                            <el-radio-group v-model="uiConfig.theme">
                                                <el-radio-button label="default">默认主题</el-radio-button>
                                                <el-radio-button label="dark">深色主题</el-radio-button>
                                            </el-radio-group>
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="12">
                                        <el-form-item label="动画效果">
                                            <el-switch v-model="uiConfig.animation_enabled" active-text="启用"
                                                inactive-text="禁用" />
                                        </el-form-item>
                                    </el-col>
                                </el-row>

                                <el-row :gutter="16">
                                    <el-col :span="12">
                                        <el-form-item label="自动滚动日志">
                                            <el-switch v-model="uiConfig.auto_scroll" />
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="12">
                                        <el-form-item label="显示系统通知">
                                            <el-switch v-model="uiConfig.show_notifications" />
                                        </el-form-item>
                                    </el-col>
                                </el-row>
                            </el-form>
                        </div>
                    </el-tab-pane>

                    <!-- 配置预览 -->
                    <el-tab-pane label="配置预览">
                        <div class="config-section">
                            <h3 class="section-title">
                                <el-icon>
                                    <Document />
                                </el-icon>
                                当前配置JSON预览
                            </h3>
                            <div class="config-preview">
                                <pre class="json-preview">{{ JSON.stringify({
    system_config: systemConfig,
    ui_config: uiConfig
}, null, 2) }}</pre>
                            </div>
                        </div>
                    </el-tab-pane>
                </el-tabs>
            </div>

            <template #footer>
                <div class="config-footer">
                    <el-button @click="resetConfig" :loading="configSaving" type="warning" plain>
                        重置默认
                    </el-button>
                    <div style="flex: 1;"></div>
                    <el-button @click="configVisible = false">取消</el-button>
                    <el-button type="primary" @click="saveConfig" :loading="configSaving">
                        保存配置
                    </el-button>
                </div>
            </template>
        </el-dialog>


    </div>



    <script>
        const { createApp, ref, computed, onMounted, nextTick } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;

        const app = createApp({
            setup() {
                // 响应式数据
                const loading = ref(false);
                const saving = ref(false);
                const searchKeyword = ref('');
                const wechatRooms = ref([]);

                // 🔥 新增：分页相关数据
                const currentPage = ref(1);
                const pageSize = ref(20);
                const totalRooms = ref(0);

                // 批量跟播相关
                const selectedRooms = ref([]);
                const roomTableRef = ref(null);
                const roomSpeech = ref([]);
                const roomSpeeches = ref({}); // 存储所有直播间的话术数据

                const roomDialogVisible = ref(false);
                const isEditRoom = ref(false);
                const roomFormRef = ref(null);

                // 表单数据
                const roomForm = ref({
                    id: null,
                    name: '',
                    status: 1,
                    product_id: null
                });

                // 商品绑定相关
                const productBindDialogVisible = ref(false);
                const currentBindRoom = ref(null);
                const productOptions = ref([]);
                const productBindForm = ref({
                    product_id: null
                });

                // 批量商品绑定相关
                const batchBindDialogVisible = ref(false);
                const batchBindForm = ref({
                    product_id: null
                });
                const batchBinding = ref(false);

                // 直播时间管理相关
                const liveTimeDialogVisible = ref(false);
                const addLiveTimeDialogVisible = ref(false);
                const currentManageRoom = ref(null);
                const roomLiveTimes = ref([]);
                const liveTimeForm = ref({
                    live_time: '',
                    remark: ''
                });
                const liveTimeFormRef = ref(null);

                // 话术相关
                const speechViewDialogVisible = ref(false);
                const speechBindDialogVisible = ref(false);
                const currentRoomSpeech = ref([]);
                const currentViewRoom = ref(null);
                const allSpeech = ref([]);

                // 系统配置相关
                const configVisible = ref(false);
                const configLoading = ref(false);
                const configSaving = ref(false);
                const configBadge = ref('');
                const realDanmuSendLoading = ref(false);

                const systemConfig = ref({
                    intervals: {
                        bullet_screen_send: 500,
                        bullet_screen_retry: 10,
                        follow_task_retry: 60,
                        image_recognition_retry: 20,
                        live_room_check: 300
                    },
                    retry_config: {
                        max_bullet_retry: 3,
                        max_image_retry: 5,
                        max_follow_retry: 10,
                        enable_auto_retry: true
                    },
                    features: {
                        enable_screenshot: true,
                        enable_notifications: true,
                        enable_detailed_logs: true,
                        enable_real_danmu_send: false
                    },
                    quality: {
                        screenshot_quality: 80,
                        image_match_confidence: 0.8,
                        log_level: 'info'
                    }
                });

                const uiConfig = ref({
                    theme: 'default',
                    auto_scroll: true,
                    show_notifications: true,
                    animation_enabled: true
                });

                const speechSearchKeyword = ref('');
                const selectedSpeechList = ref([]);
                const binding = ref(false);
                const currentRoomBoundSpeechIds = ref([]);

                // 表单验证规则
                const roomRules = {
                    name: [
                        { required: true, message: '请输入直播间名称', trigger: 'blur' },
                        {
                            validator: (rule, value, callback) => {
                                if (!value) {
                                    callback();
                                    return;
                                }

                                // 检查名称是否重复
                                const existingRoom = wechatRooms.value.find(room =>
                                    room.name === value && room.id !== roomForm.value.id
                                );

                                if (existingRoom) {
                                    callback(new Error('直播间名称已存在'));
                                } else {
                                    callback();
                                }
                            },
                            trigger: 'blur'
                        }
                    ]
                };

                const liveTimeRules = {
                    live_time: [
                        { required: true, message: '请选择直播时间', trigger: 'change' },
                        {
                            validator: (rule, value, callback) => {
                                if (!value) {
                                    callback(new Error('请选择直播时间'));
                                    return;
                                }

                                const selectedTime = new Date(value);
                                const now = new Date();

                                if (selectedTime <= now) {
                                    callback(new Error('直播时间不能早于或等于当前时间'));
                                    return;
                                }

                                callback();
                            },
                            trigger: 'change'
                        }
                    ]
                };

                // 计算属性
                const roomDialogTitle = computed(() => isEditRoom.value ? '编辑直播间' : '添加直播间');

                // 配置相关计算属性
                const getConfigStatusStyle = (type) => {
                    if (type === 'screenshot') {
                        return systemConfig.value.features?.enable_screenshot ?
                            'background: rgba(103, 194, 58, 0.3); color: rgba(255,255,255,0.9); padding: 2px 6px; border-radius: 3px; font-size: 10px;' :
                            'background: rgba(160, 160, 160, 0.3); color: rgba(255,255,255,0.7); padding: 2px 6px; border-radius: 3px; font-size: 10px;';
                    } else if (type === 'logs') {
                        return systemConfig.value.features?.enable_detailed_logs ?
                            'background: rgba(64, 158, 255, 0.3); color: rgba(255,255,255,0.9); padding: 2px 6px; border-radius: 3px; font-size: 10px;' :
                            'background: rgba(160, 160, 160, 0.3); color: rgba(255,255,255,0.7); padding: 2px 6px; border-radius: 3px; font-size: 10px;';
                    }
                    return '';
                };

                // 🔥 修改：过滤和分页后的直播间列表
                const filteredWechatRooms = computed(() => {
                    // 先过滤
                    let filtered = wechatRooms.value;
                    if (searchKeyword.value) {
                        filtered = wechatRooms.value.filter(room =>
                            room.name.toLowerCase().includes(searchKeyword.value.toLowerCase()) ||
                            room.id.toString().includes(searchKeyword.value)
                        );
                    }

                    // 更新总数
                    totalRooms.value = filtered.length;

                    // 再分页
                    const start = (currentPage.value - 1) * pageSize.value;
                    const end = start + pageSize.value;
                    return filtered.slice(start, end);
                });

                // 商品绑定统计
                const boundProductCount = computed(() => {
                    return wechatRooms.value.filter(room => room.product_id).length;
                });

                const unboundProductCount = computed(() => {
                    return wechatRooms.value.filter(room => !room.product_id).length;
                });

                // 商品绑定按钮相关计算属性
                const getBindingButtonText = computed(() => {
                    if (!productBindForm.value.product_id) {
                        return '解除绑定';
                    }

                    if (currentBindRoom.value?.product_id === productBindForm.value.product_id) {
                        return '解除绑定';
                    }

                    if (currentBindRoom.value?.product_id && productBindForm.value.product_id) {
                        return '更换绑定';
                    }

                    return '确认绑定';
                });

                const getBindingButtonType = computed(() => {
                    if (!productBindForm.value.product_id) {
                        return 'danger';
                    }

                    if (currentBindRoom.value?.product_id === productBindForm.value.product_id) {
                        return 'danger';
                    }

                    if (currentBindRoom.value?.product_id && productBindForm.value.product_id) {
                        return 'warning';
                    }

                    return 'primary';
                });

                const getBindingButtonIcon = computed(() => {
                    if (!productBindForm.value.product_id) {
                        return 'Unlock';
                    }

                    if (currentBindRoom.value?.product_id === productBindForm.value.product_id) {
                        return 'Unlock';
                    }

                    if (currentBindRoom.value?.product_id && productBindForm.value.product_id) {
                        return 'Refresh';
                    }

                    return 'Link';
                });

                const getBindingActionHint = computed(() => {
                    if (!productBindForm.value.product_id) {
                        return '💡 将解除当前商品绑定，直播间将不再关联任何商品';
                    }

                    if (currentBindRoom.value?.product_id === productBindForm.value.product_id) {
                        return '⚠️ 选择的是当前绑定的商品，点击将解除绑定';
                    }

                    if (currentBindRoom.value?.product_id && productBindForm.value.product_id) {
                        const currentProduct = productOptions.value.find(p => p.id === currentBindRoom.value.product_id);
                        const newProduct = productOptions.value.find(p => p.id === productBindForm.value.product_id);
                        return `🔄 将商品从"${currentProduct?.name || '未知商品'}"更换为"${newProduct?.name || '未知商品'}"`;
                    }

                    const newProduct = productOptions.value.find(p => p.id === productBindForm.value.product_id);
                    return `✨ 将为直播间绑定商品"${newProduct?.name || '未知商品'}"`;
                });

                // 过滤话术列表
                const filteredAllSpeech = computed(() => {
                    if (!speechSearchKeyword.value) {
                        return allSpeech.value;
                    }
                    return allSpeech.value.filter(speech =>
                        speech.content.toLowerCase().includes(speechSearchKeyword.value.toLowerCase())
                    );
                });



                // 获取直播间绑定的话术
                const getRoomSpeech = (roomId) => {
                    return roomSpeeches.value[roomId] || [];
                };

                // 批量跟播相关函数
                const handleSelectionChange = (selection) => {
                    selectedRooms.value = selection;
                };

                const clearSelection = () => {
                    if (roomTableRef.value) {
                        roomTableRef.value.clearSelection();
                    }
                    selectedRooms.value = [];
                };

                // 🔥 新增：分页处理函数
                const handleSizeChange = (newSize) => {
                    pageSize.value = newSize;
                    currentPage.value = 1; // 重置到第一页
                    console.log(`分页大小改变: ${newSize}`);
                };

                const handleCurrentChange = (newPage) => {
                    currentPage.value = newPage;
                    console.log(`当前页改变: ${newPage}`);
                };

                // 🔥 测试 el-message 显示功能




                const startBatchFollow = async () => {
                    console.log('🚀 startBatchFollow 函数被调用');
                    console.log('选中的直播间:', selectedRooms.value);

                    if (selectedRooms.value.length === 0) {
                        ElMessage.warning('请先选择要跟播的直播间');
                        return;
                    }

                    // 🔥 新增：检查商品绑定状态
                    console.log('🔍 开始检查商品绑定状态...');
                    const unboundRooms = selectedRooms.value.filter(room => !room.product_id);
                    console.log('未绑定商品的直播间:', unboundRooms);

                    if (unboundRooms.length > 0) {
                        const unboundNames = unboundRooms.map(room => room.name).join('、');
                        console.log('未绑定商品的直播间名称:', unboundNames);

                        try {
                            console.log('🔔 准备显示确认对话框...');
                            await ElMessageBox.confirm(
                                `以下直播间未绑定任何商品，将无法识别数据进行跟播：\n\n${unboundNames}\n\n确定设置跟播任务吗？`,
                                '商品绑定检查',
                                {
                                    confirmButtonText: '确定跟播',
                                    cancelButtonText: '取消',
                                    type: 'warning',
                                    dangerouslyUseHTMLString: false
                                }
                            );
                            console.log('✅ 用户确认继续跟播');
                        } catch (error) {
                            // 用户点击取消
                            console.log('❌ 用户取消跟播任务');
                            ElMessage.info('已取消跟播任务');
                            return;
                        }
                    } else {
                        console.log('✅ 所有直播间都已绑定商品');
                    }

                    try {
                        // 准备跟播数据
                        const followData = selectedRooms.value.map(room => ({
                            id: room.id,
                            name: room.name,
                            platform: room.platform
                        }));

                        console.log(`🚀 开始批量跟播 ${followData.length} 个直播间...`);

                        // 调用后端API
                        const api = await waitForApi();
                        const result = await api.start_batch_follow(followData);

                        if (result && result.success) {
                            ElMessage.success(`成功启动 ${followData.length} 个直播间的跟播`);
                            console.log(`✅ 批量跟播启动成功: ${result.message}`);

                            // 显示跟播的直播间列表
                            followData.forEach(room => {
                                console.log(`🎯 跟播直播间: ${room.name} (ID: ${room.id})`);
                            });

                            // 清空选择
                            clearSelection();
                        } else {
                            ElMessage.error(result?.message || '批量跟播启动失败');
                            console.error(`❌ 批量跟播失败: ${result?.message}`);
                        }
                    } catch (error) {
                        console.error('批量跟播失败:', error);
                        ElMessage.error('批量跟播失败: ' + error.message);
                    }
                };



                // 获取pywebview API - 借鉴其他模块的实现
                const getPywebviewApi = () => {
                    if (window.pywebview && window.pywebview.api) {
                        return window.pywebview.api;
                    } else if (window.parent && window.parent.pywebview && window.parent.pywebview.api) {
                        return window.parent.pywebview.api;
                    } else if (window.top && window.top.pywebview && window.top.pywebview.api) {
                        return window.top.pywebview.api;
                    }
                    return null;
                };

                // 等待API就绪的通用方法
                const waitForApi = async () => {
                    let api = getPywebviewApi();
                    if (!api) {
                        for (let i = 0; i < 5; i++) {
                            await new Promise(resolve => setTimeout(resolve, 300));
                            api = getPywebviewApi();
                            if (api) break;
                        }
                        if (!api) {
                            throw new Error('无法连接到后端API，请确保应用正常运行');
                        }
                    }
                    return api;
                };



                // 加载微信直播间
                const loadWechatRooms = async () => {
                    try {
                        const api = await waitForApi();
                        // 获取所有直播间，不过滤状态
                        const result = await api.get_rooms_list('wechat', null);

                        if (result && result.success) {
                            const rooms = result.data || [];

                            // 为每个直播间加载下次直播时间
                            for (const room of rooms) {
                                const liveTimeResult = await api.get_room_next_live_time(room.id);
                                if (liveTimeResult && liveTimeResult.success && liveTimeResult.data.live_time) {
                                    room.next_live_time = liveTimeResult.data.live_time;
                                } else {
                                    room.next_live_time = null;
                                }
                            }

                            wechatRooms.value = rooms;
                            // 加载每个直播间的话术
                            await loadAllRoomSpeeches();

                            // 异步加载商品封面
                            nextTick(() => {
                                loadProductCovers();
                            });
                        }
                    } catch (error) {
                        console.error('加载直播间失败:', error);
                        ElMessage.error('加载直播间失败');
                    }
                };

                // 加载所有直播间的话术
                const loadAllRoomSpeeches = async () => {
                    try {
                        const api = await waitForApi();
                        const speeches = {};
                        for (const room of wechatRooms.value) {
                            const result = await api.get_room_speeches(room.id);
                            if (result && result.success) {
                                speeches[room.id] = result.data || [];
                            }
                        }
                        roomSpeeches.value = speeches;
                    } catch (error) {
                        console.error('加载直播间话术失败:', error);
                    }
                };

                // 加载商品封面图片
                const loadProductCovers = async () => {
                    console.log('🖼️ 开始加载商品封面图片...');

                    for (const room of wechatRooms.value) {
                        if (room.product_cover && !room.productCoverObjectUrl) {
                            try {
                                const objectUrl = await getProductCoverUrl(room.product_cover);
                                if (objectUrl) {
                                    room.productCoverObjectUrl = objectUrl;
                                    console.log(`✅ 加载商品封面成功: ${room.product_name}`);
                                }
                            } catch (error) {
                                console.error('加载商品封面失败:', room.product_cover, error);
                            }
                        }
                    }
                };

                // 直播间管理
                const showAddRoomDialog = () => {
                    isEditRoom.value = false;
                    roomForm.value = {
                        id: null,
                        name: '',
                        status: 1,
                        product_id: null
                    };
                    roomDialogVisible.value = true;
                };

                const editRoom = (room) => {
                    isEditRoom.value = true;
                    roomForm.value = {
                        id: room.id,
                        name: room.name,
                        status: room.status,
                        product_id: room.product_id
                    };
                    roomDialogVisible.value = true;
                };

                // 查看绑定话术
                const viewBoundSpeech = async (room) => {
                    try {
                        currentViewRoom.value = room;
                        const api = await waitForApi();
                        const result = await api.get_room_speeches(room.id);

                        if (result && result.success) {
                            currentRoomSpeech.value = result.data || [];
                            speechViewDialogVisible.value = true;
                        } else {
                            ElMessage.error(result?.message || '获取话术失败');
                        }
                    } catch (error) {
                        console.error('获取话术失败:', error);
                        ElMessage.error('获取话术失败');
                    }
                };

                // 绑定话术
                const bindSpeech = async (room) => {
                    try {
                        currentViewRoom.value = room;
                        await loadAllSpeech();
                        // 加载当前直播间已绑定的话术ID
                        await loadCurrentRoomBoundSpeeches();
                        speechBindDialogVisible.value = true;
                    } catch (error) {
                        console.error('加载话术失败:', error);
                        ElMessage.error('加载话术失败');
                    }
                };



                // 解绑话术
                const unbindSpeechFromRoom = async (speech) => {
                    try {
                        await ElMessageBox.confirm(
                            `确定要解绑话术"${speech.content.substring(0, 20)}..."吗？`,
                            '确认解绑',
                            {
                                confirmButtonText: '确定',
                                cancelButtonText: '取消',
                                type: 'warning'
                            }
                        );

                        const api = await waitForApi();
                        const result = await api.unbind_speech_from_room(
                            currentViewRoom.value.id,
                            speech.id
                        );

                        if (result && result.success) {
                            ElMessage.success('话术解绑成功');
                            // 刷新弹窗数据
                            await viewBoundSpeech(currentViewRoom.value);
                            // 刷新主表格数据
                            await loadAllRoomSpeeches();
                        } else {
                            ElMessage.error(result?.message || '解绑失败');
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('解绑话术失败:', error);
                            ElMessage.error('解绑失败');
                        }
                    }
                };

                // 加载当前直播间已绑定的话术ID
                const loadCurrentRoomBoundSpeeches = async () => {
                    try {
                        if (!currentViewRoom.value) return;

                        const api = await waitForApi();
                        const result = await api.get_room_speeches(currentViewRoom.value.id);

                        if (result && result.success) {
                            currentRoomBoundSpeechIds.value = result.data.map(speech => speech.id);
                        } else {
                            currentRoomBoundSpeechIds.value = [];
                        }
                    } catch (error) {
                        console.error('加载已绑定话术失败:', error);
                        currentRoomBoundSpeechIds.value = [];
                    }
                };

                // 判断话术是否已绑定到当前直播间
                const isSpeechBoundToCurrentRoom = (speech) => {
                    return currentRoomBoundSpeechIds.value.includes(speech.id);
                };

                // 判断话术是否可选择（未绑定的可选择）
                const isSpeechSelectable = (row) => {
                    return !isSpeechBoundToCurrentRoom(row);
                };

                // 获取话术行的样式类名
                const getSpeechRowClassName = ({ row }) => {
                    return isSpeechBoundToCurrentRoom(row) ? 'speech-bound-row' : '';
                };

                // ==================== 直播时间管理 ====================

                // 管理直播时间
                const manageLiveTime = async (room) => {
                    try {
                        currentManageRoom.value = room;
                        await loadRoomLiveTimes(room.id);
                        liveTimeDialogVisible.value = true;
                    } catch (error) {
                        console.error('加载直播时间失败:', error);
                        ElMessage.error('加载直播时间失败');
                    }
                };

                // 加载直播间的直播时间
                const loadRoomLiveTimes = async (roomId) => {
                    try {
                        const api = await waitForApi();
                        const result = await api.get_room_live_times(roomId);

                        if (result && result.success) {
                            roomLiveTimes.value = result.data || [];
                        } else {
                            roomLiveTimes.value = [];
                            ElMessage.error(result?.message || '获取直播时间失败');
                        }
                    } catch (error) {
                        console.error('加载直播时间失败:', error);
                        roomLiveTimes.value = [];
                        ElMessage.error('加载直播时间失败');
                    }
                };

                // 显示添加直播时间对话框
                const showAddLiveTimeDialog = () => {
                    // 检查当前直播间是否已有待开播记录
                    const pendingLiveTimes = roomLiveTimes.value.filter(item => item.status === 0);

                    if (pendingLiveTimes.length > 0) {
                        const roomName = currentManageRoom.value?.name || '当前直播间';
                        const pendingTime = pendingLiveTimes[0].live_time;

                        ElMessageBox.alert(
                            `${roomName} 已经存在待开播时间：${pendingTime}，请先处理现有的直播时间安排。`,
                            '提示',
                            {
                                confirmButtonText: '知道了',
                                type: 'warning'
                            }
                        );
                        return;
                    }

                    liveTimeForm.value = {
                        live_time: '',
                        remark: ''
                    };
                    addLiveTimeDialogVisible.value = true;
                };

                // 保存直播时间
                const saveLiveTime = async () => {
                    if (!liveTimeFormRef.value) {
                        ElMessage.error('表单引用错误');
                        return;
                    }

                    try {
                        await liveTimeFormRef.value.validate();

                        // 🔥 新增：检查当前直播间是否绑定了商品
                        if (!currentManageRoom.value.product_id) {
                            try {
                                await ElMessageBox.confirm(
                                    `当前直播间"${currentManageRoom.value.name}"没有绑定商品，将无法进行图像识别和自动跟播。\n\n确定安排直播时间吗？`,
                                    '商品绑定检查',
                                    {
                                        confirmButtonText: '确定安排',
                                        cancelButtonText: '取消',
                                        type: 'warning'
                                    }
                                );
                            } catch (error) {
                                if (error === 'cancel') {
                                    return; // 用户选择取消
                                }
                                throw error;
                            }
                        }

                        // 检查时间是否在30分钟内
                        const selectedTime = new Date(liveTimeForm.value.live_time);
                        const now = new Date();
                        const timeDiff = selectedTime.getTime() - now.getTime();
                        const minutesDiff = Math.floor(timeDiff / (1000 * 60));

                        if (minutesDiff < 30) {
                            try {
                                await ElMessageBox.confirm(
                                    `下次开播时间距离当前不到30分钟（${minutesDiff}分钟），确认添加吗？`,
                                    '时间提醒',
                                    {
                                        confirmButtonText: '确认添加',
                                        cancelButtonText: '重新选择',
                                        type: 'warning'
                                    }
                                );
                            } catch (error) {
                                if (error === 'cancel') {
                                    return; // 用户选择重新选择时间
                                }
                                throw error;
                            }
                        }

                        saving.value = true;

                        const api = await waitForApi();
                        const result = await api.add_live_time(
                            currentManageRoom.value.id,
                            liveTimeForm.value.live_time,
                            liveTimeForm.value.remark
                        );

                        if (result && result.success) {
                            ElMessage.success(result.message || '添加直播时间成功');
                            addLiveTimeDialogVisible.value = false;
                            await loadRoomLiveTimes(currentManageRoom.value.id);
                            await loadWechatRooms(); // 刷新主表格
                        } else {
                            ElMessage.error(result?.message || '添加直播时间失败');
                        }

                    } catch (error) {
                        console.error('保存直播时间失败:', error);
                        ElMessage.error(error.message || '保存直播时间失败');
                    } finally {
                        saving.value = false;
                    }
                };

                // 标记为过期
                const markAsExpired = async (liveTime) => {
                    try {
                        await ElMessageBox.confirm(
                            `确定要标记"${liveTime.live_time}"为过期吗？`,
                            '确认标记',
                            {
                                confirmButtonText: '确定',
                                cancelButtonText: '取消',
                                type: 'warning'
                            }
                        );

                        const api = await waitForApi();
                        const result = await api.update_live_time_status(liveTime.id, 1);

                        if (result && result.success) {
                            // 标记成功后，删除对应的自动化任务
                            try {
                                const taskResult = await api.remove_task_by_live_time(liveTime.room_id, liveTime.live_time);
                                if (taskResult && taskResult.success) {
                                    console.log('自动化任务已删除:', taskResult.message);
                                } else {
                                    console.warn('删除自动化任务失败:', taskResult?.message);
                                }
                            } catch (taskError) {
                                console.warn('删除自动化任务时出错:', taskError);
                            }

                            ElMessage.success('标记成功');
                            await loadRoomLiveTimes(currentManageRoom.value.id);
                            await loadWechatRooms(); // 刷新主表格
                        } else {
                            ElMessage.error(result?.message || '标记失败');
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('标记失败:', error);
                            ElMessage.error('标记失败');
                        }
                    }
                };

                // 删除直播时间
                const deleteLiveTime = async (liveTime) => {
                    try {
                        await ElMessageBox.confirm(
                            `确定要删除"${liveTime.live_time}"这个直播时间吗？`,
                            '确认删除',
                            {
                                confirmButtonText: '确定',
                                cancelButtonText: '取消',
                                type: 'warning'
                            }
                        );

                        const api = await waitForApi();

                        // 先删除对应的自动化任务
                        try {
                            const taskResult = await api.remove_task_by_live_time(liveTime.room_id, liveTime.live_time);
                            if (taskResult && taskResult.success) {
                                console.log('自动化任务已删除:', taskResult.message);
                            } else {
                                console.warn('删除自动化任务失败:', taskResult?.message);
                            }
                        } catch (taskError) {
                            console.warn('删除自动化任务时出错:', taskError);
                        }

                        // 删除直播时间记录
                        const result = await api.delete_live_time(liveTime.id);

                        if (result && result.success) {
                            ElMessage.success('删除成功');
                            await loadRoomLiveTimes(currentManageRoom.value.id);
                            await loadWechatRooms(); // 刷新主表格
                        } else {
                            ElMessage.error(result?.message || '删除失败');
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('删除失败:', error);
                            ElMessage.error('删除失败');
                        }
                    }
                };

                // 加载所有话术
                const loadAllSpeech = async () => {
                    try {
                        const api = await waitForApi();
                        const result = await api.get_speech_list();

                        if (result && result.success) {
                            allSpeech.value = result.data || [];
                        } else {
                            ElMessage.error(result?.message || '获取话术失败');
                        }
                    } catch (error) {
                        console.error('获取话术失败:', error);
                        ElMessage.error('获取话术失败');
                    }
                };

                // 处理话术选择
                const handleSpeechSelection = (selection) => {
                    selectedSpeechList.value = selection;
                };

                // 确认绑定话术
                const confirmBindSpeech = async () => {
                    if (selectedSpeechList.value.length === 0) {
                        ElMessage.warning('请选择要绑定的话术');
                        return;
                    }

                    binding.value = true;
                    try {
                        const api = await waitForApi();
                        let successCount = 0;

                        for (const speech of selectedSpeechList.value) {
                            // 使用新的绑定API而不是更新话术
                            const result = await api.bind_speech_to_room(
                                currentViewRoom.value.id,
                                speech.id,
                                speech.status
                            );
                            if (result && result.success) {
                                successCount++;
                            }
                        }

                        if (successCount > 0) {
                            ElMessage.success(`成功绑定 ${successCount} 条话术`);
                            speechBindDialogVisible.value = false;
                            selectedSpeechList.value = [];
                            // 刷新主表格数据
                            await loadAllRoomSpeeches();
                            // 如果查看话术弹窗是打开的，也要刷新弹窗数据
                            if (speechViewDialogVisible.value && currentViewRoom.value) {
                                await viewBoundSpeech(currentViewRoom.value);
                            }
                        } else {
                            ElMessage.error('绑定失败');
                        }
                    } catch (error) {
                        console.error('绑定话术失败:', error);
                        ElMessage.error('绑定话术失败');
                    } finally {
                        binding.value = false;
                    }
                };

                // 删除直播间
                const deleteRoom = async (room) => {
                    try {
                        await ElMessageBox.confirm(
                            `确定要删除直播间"${room.name}"吗？删除后将同时删除绑定的话术。`,
                            '确认删除',
                            {
                                confirmButtonText: '确定',
                                cancelButtonText: '取消',
                                type: 'warning',
                            }
                        );

                        const api = await waitForApi();
                        const result = await api.delete_room(room.id);

                        if (result && result.success) {
                            ElMessage.success('删除成功');
                            loadWechatRooms();
                        } else {
                            ElMessage.error(result?.message || '删除失败');
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('删除直播间失败:', error);
                            ElMessage.error('删除失败');
                        }
                    }
                };

                const saveRoom = async () => {
                    if (!roomFormRef.value) {
                        ElMessage.error('表单引用错误');
                        return;
                    }

                    try {
                        await roomFormRef.value.validate();
                        saving.value = true;

                        const api = await waitForApi();
                        let result;

                        if (isEditRoom.value) {
                            result = await api.update_room(
                                roomForm.value.id,
                                roomForm.value.name,
                                'wechat',
                                roomForm.value.status,
                                roomForm.value.product_id
                            );
                        } else {
                            result = await api.add_room(
                                roomForm.value.name,
                                'wechat',
                                roomForm.value.status,
                                roomForm.value.product_id
                            );
                        }

                        if (result && result.success) {
                            ElMessage.success(result.message);
                            roomDialogVisible.value = false;
                            await loadWechatRooms(); // 重新加载数据
                            console.log(`${isEditRoom.value ? '更新' : '添加'}直播间: ${roomForm.value.name}`);
                        } else {
                            ElMessage.error(result?.message || '操作失败');
                        }

                    } catch (error) {
                        console.error('保存失败:', error);
                        ElMessage.error('保存失败');
                    } finally {
                        saving.value = false;
                    }
                };

                // 下拉菜单命令处理
                const handleDropdownCommand = (command) => {
                    const { action, room } = command;
                    switch (action) {
                        case 'viewSpeech':
                            viewBoundSpeech(room);
                            break;
                        case 'bindProduct':
                            bindProduct(room);
                            break;
                        case 'deleteRoom':
                            deleteRoom(room);
                            break;
                    }
                };

                // 图片处理函数
                const productCoverUrlCache = new Map();

                const getProductCoverUrl = async (coverPath) => {
                    if (!coverPath) return '';

                    // 如果是网络图片，直接返回
                    if (coverPath.startsWith('http://') || coverPath.startsWith('https://')) {
                        return coverPath;
                    }

                    // 检查缓存
                    if (productCoverUrlCache.has(coverPath)) {
                        return productCoverUrlCache.get(coverPath);
                    }

                    // 通过API获取文件Blob
                    const api = await waitForApi();
                    if (!api) return '';

                    try {
                        const result = await api.get_image_blob(coverPath);
                        if (result.success && result.blob_data) {
                            // 将base64转换为Blob
                            const byteCharacters = atob(result.blob_data);
                            const byteNumbers = new Array(byteCharacters.length);
                            for (let i = 0; i < byteCharacters.length; i++) {
                                byteNumbers[i] = byteCharacters.charCodeAt(i);
                            }
                            const byteArray = new Uint8Array(byteNumbers);
                            const blob = new Blob([byteArray], { type: result.mime_type || 'image/jpeg' });

                            // 创建Object URL
                            const objectUrl = URL.createObjectURL(blob);
                            productCoverUrlCache.set(coverPath, objectUrl);
                            return objectUrl;
                        }
                    } catch (error) {
                        console.error('获取商品封面失败:', error);
                    }

                    return '';
                };

                const handleImageError = (event) => {
                    // 图片加载失败时的处理
                    event.target.style.display = 'none';
                    const parent = event.target.parentElement;
                    if (parent) {
                        parent.innerHTML = '<div style="width: 100%; height: 100%; background: #f3f4f6; display: flex; align-items: center; justify-content: center;"><i class="el-icon-picture" style="font-size: 16px; color: #9ca3af;"></i></div>';
                    }
                };

                // 商品选择变化处理
                const onProductSelectionChange = (value) => {
                    console.log('商品选择变化:', value);
                    // 这里可以添加额外的逻辑，比如预览商品信息等
                };

                // 商品绑定相关函数
                const loadProductOptions = async () => {
                    try {
                        const api = await waitForApi();
                        const result = await api.get_products_for_room_binding();

                        if (result && result.success) {
                            productOptions.value = result.data || [];
                            console.log('✅ 商品选项加载成功:', productOptions.value.length);

                            // 异步加载商品封面
                            loadProductOptionCovers();
                        } else {
                            console.error('❌ 商品选项加载失败:', result?.message);
                            ElMessage.error(result?.message || '加载商品选项失败');
                        }
                    } catch (error) {
                        console.error('加载商品选项失败:', error);
                        ElMessage.error('加载商品选项失败');
                    }
                };

                // 加载商品选项的封面图片
                const loadProductOptionCovers = async () => {
                    for (const product of productOptions.value) {
                        if (product.cover && !product.coverObjectUrl) {
                            try {
                                const objectUrl = await getProductCoverUrl(product.cover);
                                if (objectUrl) {
                                    product.coverObjectUrl = objectUrl;
                                }
                            } catch (error) {
                                console.error('加载商品选项封面失败:', error);
                            }
                        }
                    }
                };

                const bindProduct = async (room) => {
                    currentBindRoom.value = room;
                    productBindForm.value.product_id = room.product_id;

                    // 如果有绑定商品，加载该商品绑定的图片
                    if (room.product_id) {
                        try {
                            const api = await waitForApi();
                            // 查询该商品绑定的图片列表
                            const result = await api.query_images_api({
                                page: 1,
                                page_size: 50,
                                product_id: room.product_id,
                                status: 1
                            });
                            if (result && result.success) {
                                currentBindRoom.value.boundImages = result.data || [];
                                console.log(`✅ 加载商品绑定图片成功: ${currentBindRoom.value.boundImages.length} 张`);
                                // 异步加载图片URL
                                loadBoundImages();
                            } else {
                                console.log('该商品暂无绑定图片');
                                currentBindRoom.value.boundImages = [];
                            }
                        } catch (error) {
                            console.error('加载商品绑定图片失败:', error);
                            currentBindRoom.value.boundImages = [];
                        }
                    } else {
                        currentBindRoom.value.boundImages = [];
                    }

                    productBindDialogVisible.value = true;
                };

                // 加载绑定图片的URL
                const loadBoundImages = async () => {
                    if (!currentBindRoom.value.boundImages) return;

                    for (const image of currentBindRoom.value.boundImages) {
                        if (image.path && !image.objectUrl) {
                            try {
                                const objectUrl = await getProductCoverUrl(image.path);
                                if (objectUrl) {
                                    image.objectUrl = objectUrl;
                                }
                            } catch (error) {
                                console.error('加载绑定图片URL失败:', error);
                            }
                        }
                    }
                };

                const saveProductBinding = async () => {
                    try {
                        binding.value = true;
                        const api = await waitForApi();

                        // 正确处理解绑操作：空选择或选择当前商品都是解绑
                        let productId = productBindForm.value.product_id;

                        // 如果选择的是当前绑定的商品，则执行解绑操作
                        if (productId === currentBindRoom.value?.product_id) {
                            productId = null;
                        }

                        // 确保解除绑定时传递 null
                        if (!productId) {
                            productId = null;
                        }

                        console.log('🔄 执行商品绑定操作:', {
                            roomId: currentBindRoom.value.id,
                            originalProductId: productBindForm.value.product_id,
                            finalProductId: productId,
                            currentBoundProductId: currentBindRoom.value?.product_id,
                            operation: productId ? '绑定/更换' : '解除绑定'
                        });

                        const result = await api.update_room(
                            currentBindRoom.value.id,
                            null, // name
                            null, // platform
                            null, // status
                            productId  // 明确传递 null 来解除绑定
                        );

                        if (result && result.success) {
                            const operation = productId ? '商品绑定成功' : '商品解绑成功';
                            ElMessage.success(operation);
                            productBindDialogVisible.value = false;

                            // 重新加载所有数据，确保界面同步
                            console.log('🔄 重新加载数据...');
                            await loadWechatRooms();
                            await loadProductOptions();

                            console.log(`${productId ? '绑定' : '解绑'}商品: ${currentBindRoom.value.name}`);
                        } else {
                            console.error('❌ 商品绑定操作失败:', result);
                            ElMessage.error(result?.message || '操作失败');
                        }
                    } catch (error) {
                        console.error('商品绑定操作失败:', error);
                        ElMessage.error('操作失败');
                    } finally {
                        binding.value = false;
                    }
                };

                // 封装图片URL刷新函数
                const refreshImageUrl = async (imagePath) => {
                    if (!imagePath) return null;
                    try {
                        // 清除缓存
                        if (productCoverUrlCache.has(imagePath)) {
                            const oldUrl = productCoverUrlCache.get(imagePath);
                            if (oldUrl && oldUrl.startsWith('blob:')) {
                                URL.revokeObjectURL(oldUrl);
                            }
                            productCoverUrlCache.delete(imagePath);
                        }
                        // 重新获取URL
                        const newUrl = await getProductCoverUrl(imagePath);
                        console.log(`🔄 刷新图片URL: ${imagePath} -> ${newUrl ? '成功' : '失败'}`);
                        return newUrl;
                    } catch (error) {
                        console.error('刷新图片URL失败:', error);
                        return null;
                    }
                };

                // 实时更新直播间商品信息
                const updateRoomProductInfo = async (roomId, productId) => {
                    try {
                        // 找到对应的直播间
                        const room = wechatRooms.value.find(r => r.id === roomId);
                        if (!room) return;

                        if (productId) {
                            // 绑定商品：从商品选项中找到商品信息
                            const product = productOptions.value.find(p => p.id === productId);
                            if (product) {
                                room.product_id = productId;
                                room.product_name = product.name;
                                room.product_price = product.price;
                                room.product_cover = product.cover;

                                // 重新加载商品封面URL，确保显示最新图片
                                if (product.cover) {
                                    room.productCoverObjectUrl = await refreshImageUrl(product.cover);
                                } else {
                                    room.productCoverObjectUrl = null;
                                }

                                console.log(`✅ 实时更新商品绑定: ${room.name} -> ${product.name}`);
                            }
                        } else {
                            // 解绑商品：清空商品信息
                            room.product_id = null;
                            room.product_name = null;
                            room.product_price = null;
                            room.product_cover = null;
                            room.productCoverObjectUrl = null;

                            console.log(`✅ 实时解绑商品: ${room.name}`);
                        }
                    } catch (error) {
                        console.error('更新直播间商品信息失败:', error);
                    }
                };

                // 批量商品绑定功能
                const batchBindProduct = () => {
                    if (selectedRooms.value.length === 0) {
                        ElMessage.warning('请先选择要绑定商品的直播间');
                        return;
                    }

                    batchBindForm.value.product_id = null;
                    batchBindDialogVisible.value = true;
                };

                const saveBatchBinding = async () => {
                    try {
                        batchBinding.value = true;
                        const api = await waitForApi();

                        // 确保解绑时传递 null
                        const productId = batchBindForm.value.product_id || null;

                        console.log('🔄 执行批量商品绑定操作:', {
                            selectedRoomsCount: selectedRooms.value.length,
                            productId: productId,
                            operation: productId ? '批量绑定' : '批量解绑'
                        });

                        let successCount = 0;
                        let failCount = 0;

                        for (const room of selectedRooms.value) {
                            try {
                                const result = await api.update_room(
                                    room.id,
                                    null, // name
                                    null, // platform
                                    null, // status
                                    productId  // 明确传递 null 来解除绑定
                                );

                                if (result && result.success) {
                                    successCount++;
                                    // 实时更新直播间商品信息
                                    await updateRoomProductInfo(room.id, productId);
                                } else {
                                    failCount++;
                                }
                            } catch (error) {
                                failCount++;
                                console.error(`批量绑定失败 - ${room.name}:`, error);
                            }
                        }

                        if (successCount > 0) {
                            ElMessage.success(`批量操作完成：成功 ${successCount} 个${failCount > 0 ? `，失败 ${failCount} 个` : ''}`);
                            console.log(`批量${batchBindForm.value.product_id ? '绑定' : '解绑'}商品：成功 ${successCount} 个`);

                            // 重新加载所有数据，确保界面同步
                            console.log('🔄 批量操作后重新加载数据...');
                            await loadWechatRooms();
                            await loadProductOptions();
                        }

                        if (failCount > 0 && successCount === 0) {
                            ElMessage.error(`批量操作失败：${failCount} 个直播间操作失败`);
                        }

                        batchBindDialogVisible.value = false;
                        clearSelection(); // 清空选择

                    } catch (error) {
                        console.error('批量商品绑定失败:', error);
                        ElMessage.error('批量操作失败');
                    } finally {
                        batchBinding.value = false;
                    }
                };

                // 其他功能
                const goToSpeechManage = () => {
                    // 这里可以跳转到话术管理页面
                    ElMessage.info('请在话术管理页面添加话术并绑定到此直播间');
                };



                // 当前时间，每秒更新
                const currentTime = ref(Date.now());
                // 记录已通知的直播间，避免重复通知
                const notifiedRooms = ref(new Set());

                // 启动时间更新器（仅用于显示倒计时，不再处理通知）
                const startTimeUpdater = () => {
                    setInterval(() => {
                        currentTime.value = Date.now();
                    }, 1000);
                };

                // 计算属性：房间倒计时信息
                const roomCountdowns = computed(() => {
                    const now = currentTime.value;
                    const result = {};

                    wechatRooms.value.forEach(room => {
                        if (room.next_live_time) {
                            const liveTime = new Date(room.next_live_time);
                            const diff = liveTime.getTime() - now;

                            if (diff <= 0) {
                                // 🔥 修复：使用全局标记避免重复调用
                                const markKey = `${room.id}_${room.next_live_time}`;
                                if (!window.autoMarkedTasks) {
                                    window.autoMarkedTasks = new Set();
                                }

                                if (!window.autoMarkedTasks.has(markKey)) {
                                    window.autoMarkedTasks.add(markKey);
                                    console.log(`🔄 标记过期任务: ${markKey}`);
                                    // 异步调用后端API标记过期
                                    nextTick(() => {
                                        autoMarkLiveTimeExpired(room.id, room.next_live_time);
                                    });
                                }

                                result[room.id] = {
                                    text: '已开播',
                                    style: {
                                        color: '#059669',
                                        fontWeight: '600',
                                        background: '#d1fae5',
                                        padding: '2px 6px',
                                        borderRadius: '4px',
                                        fontSize: '11px',
                                        border: '1px solid #a7f3d0'
                                    }
                                };
                            } else {
                                // 计算总小时数（包含天数转换为小时）
                                const totalHours = Math.floor(diff / (1000 * 60 * 60));
                                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                                const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                                let text = '';
                                if (totalHours > 0) {
                                    text = `倒计时 ${String(totalHours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                                } else if (minutes > 0) {
                                    text = `倒计时 ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                                } else {
                                    text = `倒计时 ${String(seconds).padStart(2, '0')}秒`;
                                }

                                const hoursFloat = diff / (1000 * 60 * 60);
                                const minutesFloat = diff / (1000 * 60);

                                let style = {};
                                if (minutesFloat <= 30) {
                                    // 紧急状态 - 红色
                                    style = {
                                        color: '#ff3366',
                                        fontWeight: '600',
                                        background: 'rgba(255,51,102,0.1)',
                                        border: '1px solid rgba(255,51,102,0.3)',
                                        padding: '2px 6px',
                                        borderRadius: '4px',
                                        fontSize: '11px'
                                    };
                                } else if (hoursFloat <= 1) {
                                    // 警告状态 - 橙色
                                    style = {
                                        color: '#ff8c00',
                                        fontWeight: '600',
                                        background: 'rgba(255,140,0,0.1)',
                                        border: '1px solid rgba(255,140,0,0.3)',
                                        padding: '2px 6px',
                                        borderRadius: '4px',
                                        fontSize: '11px'
                                    };
                                } else if (hoursFloat <= 24) {
                                    // 正常状态 - 蓝色
                                    style = {
                                        color: '#00d4ff',
                                        fontWeight: '500',
                                        background: 'rgba(0,212,255,0.1)',
                                        border: '1px solid rgba(0,212,255,0.3)',
                                        padding: '2px 6px',
                                        borderRadius: '4px',
                                        fontSize: '11px'
                                    };
                                } else {
                                    // 远期状态 - 紫色
                                    style = {
                                        color: '#8b5cf6',
                                        fontWeight: '500',
                                        background: 'rgba(139,92,246,0.1)',
                                        border: '1px solid rgba(139,92,246,0.3)',
                                        padding: '2px 6px',
                                        borderRadius: '4px',
                                        fontSize: '11px'
                                    };
                                }

                                result[room.id] = { text, style };
                            }
                        }
                    });

                    return result;
                });



                // ===== 配置管理相关方法 =====

                // 加载系统配置
                const loadSystemConfig = async () => {
                    try {
                        configLoading.value = true;
                        const api = await waitForApi();
                        const result = await api.get_system_config();

                        if (result.success) {
                            const config = result.config;

                            // 更新系统配置
                            if (config.system_config) {
                                // 深度合并新的配置结构
                                if (config.system_config.intervals) {
                                    Object.assign(systemConfig.value.intervals, config.system_config.intervals);
                                }
                                if (config.system_config.retry_config) {
                                    Object.assign(systemConfig.value.retry_config, config.system_config.retry_config);
                                }
                                if (config.system_config.features) {
                                    Object.assign(systemConfig.value.features, config.system_config.features);
                                }
                                if (config.system_config.quality) {
                                    Object.assign(systemConfig.value.quality, config.system_config.quality);
                                }

                                // 兼容旧配置格式
                                if (config.system_config.bullet_screen_interval) {
                                    systemConfig.value.intervals.bullet_screen_send = config.system_config.bullet_screen_interval;
                                }
                                if (config.system_config.is_screenshot !== undefined) {
                                    systemConfig.value.features.enable_screenshot = config.system_config.is_screenshot;
                                }
                            }

                            // 更新界面配置
                            if (config.ui_config) {
                                Object.assign(uiConfig.value, config.ui_config);
                            }

                            console.log('✅ 系统配置加载成功');
                        } else {
                            console.warn('⚠️ 配置加载返回失败，使用默认配置:', result.message);
                        }
                    } catch (error) {
                        console.error('❌ 配置加载异常:', error);
                        // 不显示错误提示，静默使用默认配置
                    } finally {
                        configLoading.value = false;
                    }
                };

                // 保存系统配置
                const saveConfig = async () => {
                    try {
                        configSaving.value = true;

                        const api = await waitForApi();
                        const result = await api.update_system_config({
                            system_config: systemConfig.value,
                            ui_config: uiConfig.value
                        });

                        if (result.success) {
                            ElMessage.success('配置保存成功');
                            configVisible.value = false;
                            configBadge.value = ''; // 清除配置提醒
                        } else {
                            ElMessage.error(result.message || '保存配置失败');
                        }
                    } catch (error) {
                        console.error('❌ 保存配置失败:', error);
                        ElMessage.error('保存配置失败');
                    } finally {
                        configSaving.value = false;
                    }
                };

                // 重置系统配置
                const resetConfig = async () => {
                    try {
                        await ElMessageBox.confirm(
                            '确定要重置所有配置为默认值吗？此操作不可恢复。',
                            '重置配置',
                            {
                                confirmButtonText: '确定',
                                cancelButtonText: '取消',
                                type: 'warning',
                            }
                        );

                        configSaving.value = true;
                        const api = await waitForApi();
                        const result = await api.reset_system_config();

                        if (result.success) {
                            ElMessage.success('配置重置成功');
                            await loadSystemConfig(); // 重新加载配置
                        } else {
                            ElMessage.error(result.message || '重置配置失败');
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('❌ 重置配置失败:', error);
                            ElMessage.error('重置配置失败');
                        }
                    } finally {
                        configSaving.value = false;
                    }
                };

                // 处理截图功能开关变化
                const handleScreenshotChange = (value) => {
                    const statusText = value ? '已开启' : '已关闭';
                    const actionText = value ? '自动截图保存识别结果' : '不进行截图保存';
                    ElMessage.success(`截图功能${statusText}：${actionText}`);
                };

                // 处理系统通知开关变化
                const handleNotificationsChange = (value) => {
                    const statusText = value ? '已开启' : '已关闭';
                    const actionText = value ? '显示任务执行通知' : '不显示系统通知';
                    ElMessage.success(`系统通知${statusText}：${actionText}`);
                };

                // 处理详细日志开关变化
                const handleDetailedLogsChange = (value) => {
                    const statusText = value ? '已开启' : '已关闭';
                    const actionText = value ? '记录详细操作信息' : '仅记录基本日志';
                    ElMessage.success(`详细日志${statusText}：${actionText}`);
                };

                // 处理真实发送弹幕开关变化
                const handleRealDanmuSendChange = async (value) => {
                    try {
                        realDanmuSendLoading.value = true;
                        const api = await waitForApi();

                        const result = await api.toggle_real_danmu_send(value);

                        if (result && result.success) {
                            const modeText = value ? '真实发送(OCR点击)' : '测试模式(回车键)';
                            ElMessage.success(`弹幕发送模式已切换为: ${modeText}`);
                        } else {
                            // 如果失败，恢复开关状态
                            systemConfig.value.features.enable_real_danmu_send = !value;
                            ElMessage.error(result?.message || '切换弹幕发送模式失败');
                        }
                    } catch (error) {
                        console.error('切换弹幕发送模式失败:', error);
                        // 如果失败，恢复开关状态
                        systemConfig.value.features.enable_real_danmu_send = !value;
                        ElMessage.error('切换弹幕发送模式失败');
                    } finally {
                        realDanmuSendLoading.value = false;
                    }
                };

                // 🔥 修复：自动标记直播状态为已开播
                const autoMarkLiveTimeExpired = async (roomId, liveTime) => {
                    try {
                        console.log(`🔄 自动标记直播间 ${roomId} 的时间 ${liveTime} 为已开播`);
                        const api = await waitForApi();

                        // 标记直播时间记录为已开播状态
                        const result = await api.mark_live_time_as_started(roomId, liveTime);
                        if (result && result.success) {
                            console.log(`✅ 自动标记已开播成功: ${result.message}`);
                            // 重新加载直播间数据以更新界面
                            await loadWechatRooms();
                        } else {
                            console.warn(`⚠️ 自动标记已开播失败: ${result?.message}`);
                        }
                    } catch (error) {
                        console.error('❌ 自动标记已开播异常:', error);
                    }
                };

                // 组件挂载时加载数据
                onMounted(() => {
                    loadWechatRooms();
                    loadAllSpeech();
                    loadProductOptions(); // 加载商品选项
                    loadSystemConfig(); // 加载系统配置
                    console.log('微信视频号跟播系统已启动');

                    // 启动时间更新器
                    startTimeUpdater();
                });

                return {
                    loading,
                    saving,
                    searchKeyword,
                    wechatRooms,
                    filteredWechatRooms,
                    boundProductCount,
                    unboundProductCount,
                    // 商品绑定UI相关
                    getBindingButtonText,
                    getBindingButtonType,
                    getBindingButtonIcon,
                    getBindingActionHint,
                    onProductSelectionChange,
                    // 批量跟播相关
                    selectedRooms,
                    roomTableRef,
                    handleSelectionChange,
                    clearSelection,
                    startBatchFollow,
                    // 🔥 新增：分页相关
                    currentPage,
                    pageSize,
                    totalRooms,
                    handleSizeChange,
                    handleCurrentChange,

                    roomSpeech,
                    roomSpeeches,
                    roomDialogVisible,
                    isEditRoom,
                    roomForm,
                    roomRules,
                    roomFormRef,
                    roomDialogTitle,
                    loadWechatRooms,
                    showAddRoomDialog,
                    editRoom,
                    saveRoom,
                    goToSpeechManage,
                    // 直播时间管理相关
                    liveTimeDialogVisible,
                    addLiveTimeDialogVisible,
                    currentManageRoom,
                    roomLiveTimes,
                    liveTimeForm,
                    liveTimeFormRef,
                    liveTimeRules,
                    manageLiveTime,
                    loadRoomLiveTimes,
                    showAddLiveTimeDialog,
                    saveLiveTime,
                    markAsExpired,
                    deleteLiveTime,
                    // 话术相关数据
                    speechViewDialogVisible,
                    speechBindDialogVisible,
                    currentRoomSpeech,
                    currentViewRoom,
                    allSpeech,
                    speechSearchKeyword,
                    selectedSpeechList,
                    binding,
                    filteredAllSpeech,
                    currentRoomBoundSpeechIds,
                    // 话术相关方法
                    viewBoundSpeech,
                    bindSpeech,
                    loadAllSpeech,
                    handleSpeechSelection,
                    confirmBindSpeech,
                    deleteRoom,
                    // 弹窗话术管理方法
                    unbindSpeechFromRoom,
                    loadCurrentRoomBoundSpeeches,
                    isSpeechBoundToCurrentRoom,
                    isSpeechSelectable,
                    getSpeechRowClassName,
                    // 表格方法
                    getRoomSpeech,

                    // 商品绑定相关
                    productBindDialogVisible,
                    currentBindRoom,
                    productOptions,
                    productBindForm,
                    bindProduct,
                    saveProductBinding,
                    loadProductOptions,
                    handleDropdownCommand,
                    getProductCoverUrl,
                    refreshImageUrl,
                    handleImageError,
                    loadProductCovers,
                    loadBoundImages,
                    loadProductOptionCovers,
                    updateRoomProductInfo,
                    // 批量绑定相关
                    batchBindDialogVisible,
                    batchBindForm,
                    batchBinding,
                    batchBindProduct,
                    saveBatchBinding,
                    // 倒计时相关
                    currentTime,
                    roomCountdowns,
                    startTimeUpdater,

                    // 配置管理相关
                    configVisible,
                    configLoading,
                    configSaving,
                    configBadge,
                    systemConfig,
                    uiConfig,
                    getConfigStatusStyle,
                    loadSystemConfig,
                    saveConfig,
                    resetConfig,
                    // 功能开关处理函数
                    handleScreenshotChange,
                    handleNotificationsChange,
                    handleDetailedLogsChange,
                    // 真实发送弹幕相关
                    realDanmuSendLoading,
                    handleRealDanmuSendChange
                };
            }
        });

        // 注册所有图标
        if (typeof ElementPlusIconsVue !== 'undefined') {
            for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
                app.component(key, component);
            }
        }

        // 获取中文语言包并配置Element Plus
        const zhCn = ElementPlusLocaleZhCn;
        app.use(ElementPlus, {
            locale: zhCn
        });

        // 挂载应用，添加错误处理
        try {
            app.mount('#app');
            console.log('✅ Vue应用挂载成功');
        } catch (error) {
            console.error('❌ Vue应用挂载失败:', error);
        }
    </script>
</body>

</html>