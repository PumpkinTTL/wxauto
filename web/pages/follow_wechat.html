<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾®ä¿¡è§†é¢‘å·è·Ÿæ’­</title>

    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <!-- Element Plus -->
    <script src="https://unpkg.com/element-plus@2/dist/index.full.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus@2/dist/index.css">
    <!-- Element Plus Icons -->
    <script src="https://unpkg.com/@element-plus/icons-vue@2/dist/index.iife.min.js"></script>
    <!-- Element Plus ä¸­æ–‡è¯­è¨€åŒ… -->
    <script src="https://cdn.staticfile.org/element-plus/2.1.11/locale/zh-cn.min.js"></script>

    <style>
        body {
            margin: 0;
            padding: 16px;
            background: #f8fafc;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            min-height: 100vh;
        }



        .container {
            max-width: 100%;
            margin: 0 auto;
            height: 100%;
        }

        .page-header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 16px;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
        }

        .content-grid {
            margin-bottom: 16px;
        }

        .content-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .card-header {
            padding: 24px;
            border-bottom: 1px solid #e5e7eb;
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
        }

        .card-body {
            padding: 24px;
        }

        /* ç›´æ’­é—´å®¹å™¨ */
        .rooms-container {
            max-height: 350px;
            overflow-y: auto;
            padding: 2px;
        }

        .rooms-container::-webkit-scrollbar {
            width: 4px;
        }

        .rooms-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .rooms-container::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 2px;
        }

        .rooms-container::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        /* ç›´æ’­é—´å¡ç‰‡ */
        .room-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            margin-bottom: 6px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            position: relative;
            overflow: hidden;
        }

        .room-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #64748b;
            transition: all 0.15s ease;
        }

        .room-item:hover {
            background: #ffffff;
            border-color: #3b82f6;
            box-shadow: 0 2px 12px rgba(59, 130, 246, 0.08);
            transform: translateY(-1px);
        }

        .room-item:hover::before {
            background: #3b82f6;
        }

        .room-item.active {
            background: #ffffff;
            border-color: #10b981;
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.12);
        }

        .room-item.active::before {
            background: #10b981;
            width: 4px;
        }

        /* ç›´æ’­é—´ä¿¡æ¯ */
        .room-info {
            display: flex;
            align-items: center;
            flex: 1;
            min-width: 0;
        }

        .room-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            flex-shrink: 0;
        }

        .room-icon .el-icon {
            color: #ffffff !important;
            font-size: 16px;
        }

        .room-details {
            flex: 1;
            min-width: 0;
        }

        .room-name {
            font-weight: 600;
            color: #1e293b;
            font-size: 13px;
            line-height: 1.2;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .room-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: #64748b;
        }

        .room-time {
            white-space: nowrap;
        }

        .room-status {
            padding: 1px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 500;
            white-space: nowrap;
        }

        .room-status.active {
            background: #dcfce7;
            color: #166534;
        }

        .room-status.inactive {
            background: #fef2f2;
            color: #991b1b;
        }

        /* æ“ä½œæŒ‰é’® */
        .room-actions {
            display: flex;
            align-items: center;
            gap: 2px;
            opacity: 0.6;
            transition: opacity 0.15s ease;
        }

        .room-item:hover .room-actions {
            opacity: 1;
        }

        .room-action-btn {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: none;
            background: transparent;
            color: #64748b !important;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .room-action-btn:hover {
            background: #f1f5f9 !important;
            color: #3b82f6 !important;
            transform: scale(1.1);
        }

        .room-action-btn.danger:hover {
            background: #fef2f2 !important;
            color: #dc2626 !important;
        }

        .room-action-btn.primary:hover {
            background: #eff6ff !important;
            color: #2563eb !important;
        }



        .speech-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 8px;
            background: #f9fafb;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-running {
            background: #10b981;
        }

        .status-stopped {
            background: #ef4444;
        }

        .status-paused {
            background: #f59e0b;
        }



        .control-panel {
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }



        /* å·²ç»‘å®šè¯æœ¯è¡Œæ ·å¼ */
        .speech-bound-row {
            background-color: #fef3e2;
        }

        .speech-bound-row:hover {
            background-color: #fde68a !important;
        }



        /* å€’è®¡æ—¶å®¹å™¨æ ·å¼ */
        .countdown-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .countdown-time {
            font-size: 12px;
            color: #374151;
            font-weight: 500;
        }

        .countdown-badge {
            display: inline-block;
            white-space: nowrap;
        }

        /* ç§‘æŠ€æ„ŸåŠ¨ç”»æ•ˆæœ */
        @keyframes techGlow {
            0% {
                text-shadow: 0 0 8px rgba(255, 51, 102, 0.5), 0 0 16px rgba(255, 51, 102, 0.3);
                box-shadow: 0 0 12px rgba(255, 51, 102, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            }

            100% {
                text-shadow: 0 0 12px rgba(255, 51, 102, 0.8), 0 0 24px rgba(255, 51, 102, 0.5);
                box-shadow: 0 0 20px rgba(255, 51, 102, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2);
            }
        }

        @keyframes countdownPulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.05);
                opacity: 0.9;
            }
        }

        /* ç§‘æŠ€æ„Ÿè¾¹æ¡†æ‰«ææ•ˆæœ */
        @keyframes borderScan {
            0% {
                border-image: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.8), transparent) 1;
            }

            50% {
                border-image: linear-gradient(90deg, transparent, rgba(0, 212, 255, 1), transparent) 1;
            }

            100% {
                border-image: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.8), transparent) 1;
            }
        }

        /* æ•°å­—å­—ä½“ä¼˜åŒ– */
        .tech-countdown {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Courier New', monospace;
            letter-spacing: 0.5px;
            position: relative;
            display: inline-block;
        }

        /* ç§‘æŠ€æ„ŸèƒŒæ™¯çº¹ç† */
        .tech-countdown::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.1) 1px, transparent 1px),
                radial-gradient(circle at 80% 50%, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
            background-size: 8px 8px;
            border-radius: inherit;
            pointer-events: none;
            opacity: 0.3;
        }

        /* é…ç½®å¯¹è¯æ¡†ç®€æ´æ ·å¼ */
        .config-section {
            padding: 16px 0;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0 0 16px 0;
            font-size: 16px;
            font-weight: 600;
            color: #303133;
            padding-bottom: 8px;
            border-bottom: 1px solid #e4e7ed;
        }

        .config-hint {
            font-size: 12px;
            color: #909399;
            margin-top: 4px;
            line-height: 1.4;
        }





        .feature-card {
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .feature-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .feature-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .feature-title {
            font-weight: 600;
            color: #303133;
            font-size: 14px;
        }

        .feature-desc {
            font-size: 12px;
            color: #909399;
            line-height: 1.3;
        }

        .config-preview {
            margin-top: 16px;
        }

        .json-preview {
            font-size: 12px;
            line-height: 1.4;
            margin: 0;
            max-height: 300px;
            overflow: auto;
            color: #606266;
            background: #f5f7fa;
            border-radius: 4px;
            padding: 16px;
        }

        .config-footer {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 0 0 0;
        }
    </style>
</head>

<body>
    <div id="app">
        <div class="container">
            <!-- é¡µé¢å¤´éƒ¨ -->
            <div class="page-header">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <h1 style="margin: 0 0 6px 0; font-size: 22px; font-weight: 600;">
                            <el-icon style="margin-right: 8px;">
                                <VideoPlay />
                            </el-icon>
                            å¾®ä¿¡è§†é¢‘å·è·Ÿæ’­
                        </h1>
                        <p style="margin: 0; opacity: 0.9; font-size: 14px;">
                            æ™ºèƒ½å¾®ä¿¡è§†é¢‘å·ç›´æ’­è·Ÿæ’­ç³»ç»Ÿï¼Œè‡ªåŠ¨å‘é€å¼¹å¹•è¯æœ¯
                        </p>
                    </div>

                    <!-- é…ç½®é¢æ¿æŒ‰é’® -->
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <el-badge :value="configBadge" :hidden="!configBadge" type="warning">
                            <el-button @click="configVisible = true" type="primary" size="small"
                                style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white;">
                                <el-icon style="margin-right: 4px;">
                                    <Setting />
                                </el-icon>
                                ç³»ç»Ÿé…ç½®
                            </el-button>
                        </el-badge>

                        <!-- é…ç½®çŠ¶æ€æŒ‡ç¤ºå™¨ -->
                        <div style="display: flex; gap: 4px; font-size: 11px; opacity: 0.8;">
                            <span :style="getConfigStatusStyle('screenshot')">
                                {{ systemConfig.features?.enable_screenshot ? 'æˆªå›¾å¼€å¯' : 'æˆªå›¾å…³é—­' }}
                            </span>
                            <span :style="getConfigStatusStyle('logs')">
                                {{ systemConfig.features?.enable_detailed_logs ? 'è¯¦ç»†æ—¥å¿—' : 'ç®€å•æ—¥å¿—' }}
                            </span>
                            <span style="color: rgba(255,255,255,0.7);">
                                å¼¹å¹•: {{ systemConfig.intervals?.bullet_screen_send || 500 }}s
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¸»å†…å®¹åŒº -->
            <div class="content-card">
                <div class="card-header">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <h2 style="margin: 0; font-size: 16px; font-weight: 600; color: #1f2937;">å¾®ä¿¡ç›´æ’­é—´ç®¡ç†</h2>
                            <p style="margin: 2px 0 0 0; color: #6b7280; font-size: 12px;">ç®¡ç†ç›´æ’­é—´å’Œç»‘å®šè¯æœ¯</p>
                            <!-- å•†å“ç»‘å®šç»Ÿè®¡ -->
                            <div v-if="wechatRooms.length > 0"
                                style="margin-top: 6px; display: flex; gap: 12px; font-size: 11px;">
                                <span style="color: #059669;">
                                    <el-icon size="10" style="margin-right: 2px;">
                                        <ShoppingBag />
                                    </el-icon>
                                    å·²ç»‘å®š: {{ boundProductCount }}
                                </span>
                                <span style="color: #6b7280;">
                                    <el-icon size="10" style="margin-right: 2px;">
                                        <Box />
                                    </el-icon>
                                    æœªç»‘å®š: {{ unboundProductCount }}
                                </span>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                            <el-input v-model="searchKeyword" placeholder="æœç´¢ç›´æ’­é—´..." size="small" style="width: 200px;"
                                clearable>
                                <template #prefix>
                                    <el-icon>
                                        <Search />
                                    </el-icon>
                                </template>
                            </el-input>
                            <el-button size="small" @click="showAddRoomDialog">
                                <el-icon style="margin-right: 4px;">
                                    <Plus />
                                </el-icon>
                                æ·»åŠ ç›´æ’­é—´
                            </el-button>

                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- æ‰¹é‡æ“ä½œåŒºåŸŸ -->
                    <div v-if="selectedRooms.length > 0"
                        style="margin-bottom: 16px; padding: 12px; background: rgba(64, 158, 255, 0.1); border: 1px solid rgba(64, 158, 255, 0.3); border-radius: 6px;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <span style="color: #409eff; font-size: 14px;">
                                <el-icon style="margin-right: 4px;">
                                    <InfoFilled />
                                </el-icon>
                                å·²é€‰æ‹© {{ selectedRooms.length }} ä¸ªç›´æ’­é—´
                            </span>
                            <div style="display: flex; gap: 8px;">
                                <el-button type="primary" size="small" @click="startBatchFollow">
                                    <el-icon style="margin-right: 4px;">
                                        <VideoPlay />
                                    </el-icon>
                                    å¼€å§‹è·Ÿæ’­
                                </el-button>

                                <el-button size="small" @click="batchBindProduct" type="warning" plain>
                                    <el-icon style="margin-right: 4px;">
                                        <ShoppingBag />
                                    </el-icon>
                                    æ‰¹é‡ç»‘å®šå•†å“
                                </el-button>
                                <el-button size="small" @click="clearSelection">
                                    <el-icon style="margin-right: 4px;">
                                        <Close />
                                    </el-icon>
                                    å–æ¶ˆé€‰æ‹©
                                </el-button>
                            </div>
                        </div>
                    </div>

                    <div v-if="wechatRooms.length === 0" style="text-align: center; color: #9ca3af; padding: 40px 0;">
                        <el-icon size="48" style="margin-bottom: 16px;">
                            <Monitor />
                        </el-icon>
                        <p>æš‚æ— å¾®ä¿¡ç›´æ’­é—´</p>
                        <el-button type="primary" @click="showAddRoomDialog">æ·»åŠ ç¬¬ä¸€ä¸ªç›´æ’­é—´</el-button>
                    </div>
                    <div v-else>
                        <el-table :data="filteredWechatRooms" style="width: 100%;" size="small"
                            @selection-change="handleSelectionChange" ref="roomTableRef">
                            <el-table-column type="selection" width="55" align="center"></el-table-column>
                            <el-table-column prop="id" label="ID" width="60" align="center">
                            </el-table-column>
                            <el-table-column prop="name" label="ç›´æ’­é—´åç§°" show-overflow-tooltip>
                                <template #default="scope">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span>{{ scope.row.name }}</span>
                                        <el-tag v-if="scope.row.status === 0" type="danger" size="small">
                                            ç¦ç”¨ - ä¸ä¼šè‡ªåŠ¨è·Ÿæ’­
                                        </el-tag>
                                    </div>
                                </template>
                            </el-table-column>
                            <el-table-column label="ä¸‹æ¬¡ç›´æ’­æ—¶é—´" align="center">
                                <template #default="scope">
                                    <div v-if="scope.row.next_live_time" class="countdown-container">
                                        <div class="countdown-time">{{ scope.row.next_live_time }}</div>
                                        <!-- å€’è®¡æ—¶ - ä½¿ç”¨è®¡ç®—å±æ€§ -->
                                        <div class="countdown-badge tech-countdown"
                                            :style="roomCountdowns[scope.row.id]?.style || {}">
                                            {{ roomCountdowns[scope.row.id]?.text || '' }}
                                        </div>
                                    </div>
                                    <span v-else style="color: #9ca3af; font-size: 12px;">æœªè®¾ç½®</span>
                                </template>
                            </el-table-column>
                            <el-table-column label="ç»‘å®šè¯æœ¯" show-overflow-tooltip>
                                <template #default="scope">
                                    <div v-if="getRoomSpeech(scope.row.id).length === 0"
                                        style="color: #9ca3af; font-size: 12px;">
                                        æš‚æ— ç»‘å®šè¯æœ¯
                                    </div>
                                    <div v-else style="font-size: 12px; line-height: 1.4;">
                                        <div
                                            style="padding: 2px 6px; background: #f0f9ff; border-radius: 4px; border-left: 2px solid #3b82f6;">
                                            {{ getRoomSpeech(scope.row.id)[0].content.length > 50 ?
                                            getRoomSpeech(scope.row.id)[0].content.substring(0, 50) + '...' :
                                            getRoomSpeech(scope.row.id)[0].content }}
                                        </div>
                                        <div v-if="getRoomSpeech(scope.row.id).length > 1"
                                            style="font-size: 11px; color: #6b7280; margin-top: 2px;">
                                            è¿˜æœ‰ {{ getRoomSpeech(scope.row.id).length - 1 }} æ¡è¯æœ¯
                                        </div>
                                    </div>
                                </template>
                            </el-table-column>
                            <el-table-column label="ç»‘å®šå•†å“" width="180" align="center">
                                <template #default="scope">
                                    <div v-if="!scope.row.product_name"
                                        style="color: #9ca3af; font-size: 12px; text-align: center;">
                                        <div style="padding: 8px;">
                                            <el-icon size="16" style="margin-bottom: 4px;">
                                                <Box />
                                            </el-icon>
                                            <div>æš‚æ— ç»‘å®š</div>
                                        </div>
                                    </div>
                                    <div v-else style="display: flex; align-items: center; gap: 8px; padding: 4px;">
                                        <div
                                            style="width: 32px; height: 32px; border-radius: 4px; overflow: hidden; flex-shrink: 0;">
                                            <img v-if="scope.row.productCoverObjectUrl"
                                                :src="scope.row.productCoverObjectUrl"
                                                style="width: 100%; height: 100%; object-fit: cover;"
                                                @error="handleImageError" />
                                            <div v-else
                                                style="width: 100%; height: 100%; background: #f3f4f6; display: flex; align-items: center; justify-content: center;">
                                                <el-icon size="16" color="#9ca3af">
                                                    <Picture />
                                                </el-icon>
                                            </div>
                                        </div>
                                        <div style="flex: 1; min-width: 0;">
                                            <div
                                                style="font-size: 12px; font-weight: 500; color: #1f2937; line-height: 1.2; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                {{ scope.row.product_name }}
                                            </div>
                                            <div v-if="scope.row.product_price"
                                                style="font-size: 11px; color: #ef4444; margin-top: 2px;">
                                                Â¥{{ scope.row.product_price }}
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </el-table-column>
                            <el-table-column prop="status" label="çŠ¶æ€" align="center">
                                <template #default="scope">
                                    <el-tag :type="scope.row.status === 1 ? 'success' : 'danger'" size="small">
                                        {{ scope.row.status === 1 ? 'å¯ç”¨' : 'ç¦ç”¨' }}
                                    </el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column prop="create_time" label="åˆ›å»ºæ—¶é—´" align="center">
                                <template #default="scope">
                                    <span style="font-size: 12px;">{{ scope.row.create_time }}</span>
                                </template>
                            </el-table-column>
                            <el-table-column label="æ“ä½œ" align="center" width="280" fixed="right">
                                <template #default="scope">
                                    <div
                                        style="display: flex; gap: 6px; justify-content: center; align-items: center; flex-wrap: nowrap;">
                                        <el-button size="small" type="text" @click="manageLiveTime(scope.row)">
                                            <el-icon style="margin-right: 2px;">
                                                <Clock />
                                            </el-icon>
                                            å®‰æ’
                                        </el-button>
                                        <el-button size="small" type="text" @click="editRoom(scope.row)">
                                            <el-icon style="margin-right: 2px;">
                                                <Edit />
                                            </el-icon>
                                            ç¼–è¾‘
                                        </el-button>
                                        <el-dropdown @command="handleDropdownCommand" trigger="click">
                                            <el-button size="small" type="text">
                                                æ›´å¤š
                                                <el-icon style="margin-left: 2px;">
                                                    <ArrowDown />
                                                </el-icon>
                                            </el-button>
                                            <template #dropdown>
                                                <el-dropdown-menu>
                                                    <el-dropdown-item
                                                        :command="{action: 'viewSpeech', room: scope.row}">
                                                        <el-icon style="margin-right: 6px;">
                                                            <Document />
                                                        </el-icon>
                                                        æŸ¥çœ‹è¯æœ¯
                                                    </el-dropdown-item>
                                                    <el-dropdown-item
                                                        :command="{action: 'bindProduct', room: scope.row}">
                                                        <el-icon style="margin-right: 6px;">
                                                            <ShoppingBag />
                                                        </el-icon>
                                                        å•†å“ç»‘å®š
                                                    </el-dropdown-item>
                                                    <el-dropdown-item :command="{action: 'deleteRoom', room: scope.row}"
                                                        divided>
                                                        <el-icon style="margin-right: 6px; color: #f56565;">
                                                            <Delete />
                                                        </el-icon>
                                                        <span style="color: #f56565;">åˆ é™¤ç›´æ’­é—´</span>
                                                    </el-dropdown-item>
                                                </el-dropdown-menu>
                                            </template>
                                        </el-dropdown>
                                    </div>
                                </template>
                            </el-table-column>
                        </el-table>

                        <!-- ğŸ”¥ æ–°å¢ï¼šåˆ†é¡µç»„ä»¶ -->
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-top: 16px; padding: 0 16px;">
                            <div style="font-size: 14px; color: #6b7280;">
                                å…± {{ totalRooms }} ä¸ªç›´æ’­é—´ï¼Œå½“å‰æ˜¾ç¤ºç¬¬ {{ (currentPage - 1) * pageSize + 1 }} - {{
                                Math.min(currentPage * pageSize, totalRooms) }} ä¸ª
                            </div>
                            <el-pagination v-model:current-page="currentPage" v-model:page-size="pageSize"
                                :page-sizes="[10, 20, 50, 100]" :total="totalRooms"
                                layout="sizes, prev, pager, next, jumper" @size-change="handleSizeChange"
                                @current-change="handleCurrentChange" small />
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä»»åŠ¡ä¸æ—¥å¿—ç®¡ç† -->
            <div class="content-card" style="margin-top: 20px;">
                <div class="card-header">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <h2 style="margin: 0; font-size: 18px; font-weight: 600; color: #1f2937;">ğŸ“‹ ä»»åŠ¡ä¸æ—¥å¿—ç®¡ç†</h2>
                            <p style="margin: 4px 0 0 0; color: #6b7280; font-size: 14px;">è·Ÿæ’­ä»»åŠ¡ã€æ‰§è¡Œæ—¥å¿—å’Œå®æ—¶è¿è¡ŒçŠ¶æ€</p>
                        </div>
                    </div>
                </div>
                <div class="card-body" style="padding: 0;">
                    <iframe src="tasks.html"
                        style="width: 100%; height: 600px; border: none; border-radius: 0 0 8px 8px;" frameborder="0">
                    </iframe>
                </div>
            </div>
        </div>

        <!-- æ·»åŠ /ç¼–è¾‘ç›´æ’­é—´å¯¹è¯æ¡† -->
        <el-dialog v-model="roomDialogVisible" :title="roomDialogTitle" width="600px">
            <el-form :model="roomForm" :rules="roomRules" ref="roomFormRef" label-width="120px">
                <el-form-item label="ç›´æ’­é—´åç§°" prop="name">
                    <el-input v-model="roomForm.name" placeholder="è¯·è¾“å…¥ç›´æ’­é—´åç§°"></el-input>
                </el-form-item>



                <el-form-item label="çŠ¶æ€" prop="status">
                    <el-radio-group v-model="roomForm.status">
                        <el-radio :label="1">å¯ç”¨</el-radio>
                        <el-radio :label="0">ç¦ç”¨</el-radio>
                    </el-radio-group>
                </el-form-item>
            </el-form>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="roomDialogVisible = false">å–æ¶ˆ</el-button>
                    <el-button type="primary" @click="saveRoom" :loading="saving">
                        {{ isEditRoom ? 'æ›´æ–°' : 'æ·»åŠ ' }}
                    </el-button>
                </span>
            </template>
        </el-dialog>

        <!-- æŸ¥çœ‹ç»‘å®šè¯æœ¯å¯¹è¯æ¡† -->
        <el-dialog v-model="speechViewDialogVisible" :title="`${currentViewRoom?.name || ''} - ç»‘å®šè¯æœ¯`" width="700px">
            <div v-if="currentRoomSpeech.length === 0" style="text-align: center; color: #9ca3af; padding: 40px 0;">
                <el-icon size="48" style="margin-bottom: 16px;">
                    <Document />
                </el-icon>
                <p>è¯¥ç›´æ’­é—´æš‚æ— ç»‘å®šè¯æœ¯</p>
            </div>
            <div v-else>
                <el-table :data="currentRoomSpeech" style="width: 100%;" size="small">
                    <el-table-column prop="content" label="è¯æœ¯å†…å®¹" show-overflow-tooltip>
                        <template #default="scope">
                            <div style="font-size: 13px;">{{ scope.row.content }}</div>
                        </template>
                    </el-table-column>
                    <el-table-column prop="bind_time" label="ç»‘å®šæ—¶é—´" width="140" align="center">
                        <template #default="scope">
                            <span style="font-size: 12px;">{{ scope.row.bind_time }}</span>
                        </template>
                    </el-table-column>
                    <el-table-column label="æ“ä½œ" width="80" align="center">
                        <template #default="scope">
                            <el-button size="small" type="text" @click="unbindSpeechFromRoom(scope.row)">è§£ç»‘</el-button>
                        </template>
                    </el-table-column>
                </el-table>
            </div>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="speechViewDialogVisible = false">å…³é—­</el-button>
                    <el-button type="primary" @click="bindSpeech(currentViewRoom)">ç»‘å®šæ›´å¤šè¯æœ¯</el-button>
                </span>
            </template>
        </el-dialog>

        <!-- ç»‘å®šè¯æœ¯å¯¹è¯æ¡† -->
        <el-dialog v-model="speechBindDialogVisible" title="ç»‘å®šè¯æœ¯" width="800px">
            <div style="margin-bottom: 16px;">
                <el-input v-model="speechSearchKeyword" placeholder="æœç´¢è¯æœ¯å†…å®¹..." clearable
                    style="width: 300px; margin-right: 12px;">
                    <template #prefix>
                        <el-icon>
                            <Search />
                        </el-icon>
                    </template>
                </el-input>
                <el-button @click="loadAllSpeech">
                    <el-icon style="margin-right: 4px;">
                        <Refresh />
                    </el-icon>
                    åˆ·æ–°
                </el-button>
            </div>
            <el-table :data="filteredAllSpeech" style="width: 100%;" size="small"
                @selection-change="handleSpeechSelection" :row-class-name="getSpeechRowClassName">
                <el-table-column type="selection" width="55" :selectable="isSpeechSelectable"></el-table-column>
                <el-table-column prop="content" label="è¯æœ¯å†…å®¹" min-width="300">
                    <template #default="scope">
                        <div style="font-size: 13px;">{{ scope.row.content }}</div>
                    </template>
                </el-table-column>
                <el-table-column label="ç»‘å®šçŠ¶æ€" width="120">
                    <template #default="scope">
                        <el-tag v-if="isSpeechBoundToCurrentRoom(scope.row)" type="warning" size="small">
                            å·²ç»‘å®š
                        </el-tag>
                        <span v-else style="font-size: 12px; color: #9ca3af;">æœªç»‘å®š</span>
                    </template>
                </el-table-column>
                <el-table-column prop="status" label="çŠ¶æ€" width="80" align="center">
                    <template #default="scope">
                        <el-tag :type="scope.row.status === 1 ? 'success' : 'danger'" size="small">
                            {{ scope.row.status === 1 ? 'å¯ç”¨' : 'ç¦ç”¨' }}
                        </el-tag>
                    </template>
                </el-table-column>
            </el-table>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="speechBindDialogVisible = false">å–æ¶ˆ</el-button>
                    <el-button type="primary" @click="confirmBindSpeech" :loading="binding">
                        ç»‘å®šé€‰ä¸­è¯æœ¯ ({{ selectedSpeechList.length }})
                    </el-button>
                </span>
            </template>
        </el-dialog>

        <!-- å•†å“ç»‘å®šå¯¹è¯æ¡† -->
        <el-dialog v-model="productBindDialogVisible" width="800px" :close-on-click-modal="false">
            <template #header>
                <div style="display: flex; align-items: center; gap: 12px; padding: 4px 0;">
                    <div
                        style="width: 36px; height: 36px; background: #6366f1; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        <el-icon size="18" color="white">
                            <Link />
                        </el-icon>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-size: 16px; font-weight: 600; color: #1f2937; margin-bottom: 2px;">å•†å“ç»‘å®šç®¡ç†</div>
                        <div style="font-size: 13px; color: #6b7280; display: flex; align-items: center; gap: 4px;">
                            <el-icon size="12">
                                <VideoCamera />
                            </el-icon>
                            {{ currentBindRoom?.name || '' }}
                        </div>
                    </div>
                    <div v-if="currentBindRoom?.product_name"
                        style="padding: 4px 10px; background: #10b981; border-radius: 12px; color: white; font-size: 11px; font-weight: 500;">
                        å·²ç»‘å®šå•†å“
                    </div>
                </div>
            </template>

            <div style="padding: 16px 20px;">
                <!-- å½“å‰ç»‘å®šçŠ¶æ€ -->
                <div style="margin-bottom: 24px;">
                    <div
                        style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 12px; display: flex; align-items: center; gap: 6px;">
                        <div style="width: 3px; height: 16px; background: #6366f1; border-radius: 2px;"></div>
                        å½“å‰ç»‘å®šçŠ¶æ€
                    </div>
                    <div v-if="!currentBindRoom?.product_name"
                        style="padding: 16px; background: #f9fafb; border: 1px dashed #d1d5db; border-radius: 8px; text-align: center;">
                        <div
                            style="width: 48px; height: 48px; background: #e5e7eb; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px;">
                            <el-icon size="20" color="#9ca3af">
                                <Box />
                            </el-icon>
                        </div>
                        <div style="color: #6b7280; font-size: 14px; font-weight: 500; margin-bottom: 4px;">æš‚æ— ç»‘å®šå•†å“</div>
                        <div style="color: #9ca3af; font-size: 12px;">è¯·åœ¨ä¸‹æ–¹é€‰æ‹©è¦ç»‘å®šçš„å•†å“</div>
                    </div>
                    <div v-else
                        style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                        <!-- å•†å“åŸºæœ¬ä¿¡æ¯ -->
                        <div style="padding: 16px; display: flex; align-items: center; gap: 12px;">
                            <div v-if="currentBindRoom.productCoverObjectUrl"
                                style="width: 48px; height: 48px; border-radius: 6px; overflow: hidden; flex-shrink: 0;">
                                <img :src="currentBindRoom.productCoverObjectUrl"
                                    style="width: 100%; height: 100%; object-fit: cover;" @error="handleImageError" />
                            </div>
                            <div v-else
                                style="width: 48px; height: 48px; background: #f59e0b; border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                                <el-icon size="20" color="white">
                                    <ShoppingBag />
                                </el-icon>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 15px; font-weight: 600; color: #1f2937; margin-bottom: 2px;">{{
                                    currentBindRoom.product_name }}</div>
                                <div v-if="currentBindRoom.product_price"
                                    style="font-size: 14px; color: #dc2626; font-weight: 500;">Â¥{{
                                    currentBindRoom.product_price }}</div>
                                <div v-else style="font-size: 12px; color: #6b7280;">ä»·æ ¼å¾…å®š</div>
                            </div>
                            <div
                                style="padding: 4px 8px; background: #10b981; border-radius: 12px; color: white; font-size: 11px; font-weight: 500;">
                                å·²ç»‘å®šå•†å“
                            </div>
                        </div>


                        <!-- ç»‘å®šå›¾ç‰‡åŒºåŸŸ -->
                        <div v-if="currentBindRoom.boundImages && currentBindRoom.boundImages.length > 0"
                            style="border-top: 1px solid #f3f4f6; padding: 16px; background: #fafbfc;">
                            <div
                                style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                                <div
                                    style="font-size: 13px; color: #374151; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                                    <el-icon size="14" color="#6366f1">
                                        <Picture />
                                    </el-icon>
                                    ç»‘å®šå›¾ç‰‡
                                </div>
                                <div
                                    style="font-size: 11px; color: #6b7280; background: #e5e7eb; padding: 2px 6px; border-radius: 10px;">
                                    {{ currentBindRoom.boundImages.length }}å¼ 
                                </div>
                            </div>

                            <!-- å›¾ç‰‡ç½‘æ ¼ -->
                            <div
                                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 8px; max-width: 280px;">
                                <div v-for="(image, index) in currentBindRoom.boundImages.slice(0, 6)" :key="image.id"
                                    style="position: relative; width: 40px; height: 40px; border-radius: 6px; overflow: hidden; border: 1px solid #e5e7eb; cursor: pointer;">
                                    <img v-if="image.objectUrl" :src="image.objectUrl"
                                        style="width: 100%; height: 100%; object-fit: cover;" />
                                    <div v-else
                                        style="width: 100%; height: 100%; background: #f9fafb; display: flex; align-items: center; justify-content: center;">
                                        <el-icon size="16" color="#9ca3af">
                                            <Picture />
                                        </el-icon>
                                    </div>
                                    <!-- å›¾ç‰‡åºå· -->
                                    <div
                                        style="position: absolute; top: 2px; right: 2px; width: 16px; height: 16px; background: rgba(0,0,0,0.6); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 500;">
                                        {{ index + 1 }}
                                    </div>
                                </div>

                                <!-- æ›´å¤šå›¾ç‰‡æç¤º -->
                                <div v-if="currentBindRoom.boundImages.length > 6"
                                    style="width: 40px; height: 40px; border-radius: 6px; background: #f3f4f6; border: 1px solid #d1d5db; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 9px; color: #6b7280; font-weight: 600;">
                                    <div style="font-size: 10px;">+{{ currentBindRoom.boundImages.length - 6 }}</div>
                                    <div>æ›´å¤š</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å•†å“é€‰æ‹© -->
                <div style="margin-bottom: 24px;">
                    <div
                        style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 12px; display: flex; align-items: center; gap: 6px;">
                        <div style="width: 3px; height: 16px; background: #6366f1; border-radius: 2px;"></div>
                        é€‰æ‹©å•†å“
                    </div>
                    <el-select v-model="productBindForm.product_id" placeholder="è¯·é€‰æ‹©è¦ç»‘å®šçš„å•†å“" clearable filterable
                        style="width: 100%;" size="default" @change="onProductSelectionChange">
                        <el-option v-for="product in productOptions" :key="product.id" :label="product.name"
                            :value="product.id">
                        </el-option>
                    </el-select>
                    <div
                        style="margin-top: 8px; padding: 8px 12px; background: #f0f9ff; border: 1px solid #e0f2fe; border-radius: 6px;">
                        <div style="font-size: 12px; color: #0369a1; display: flex; align-items: center; gap: 4px;">
                            <el-icon size="12">
                                <InfoFilled />
                            </el-icon>
                            <span style="font-weight: 500;">æ“ä½œæç¤ºï¼š</span>
                            æ¸…ç©ºé€‰æ‹©å¯è§£é™¤å½“å‰å•†å“ç»‘å®š
                        </div>
                    </div>
                </div>
            </div>

            <template #footer>
                <div style="padding: 12px 0; border-top: 1px solid #f1f5f9;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1; margin-right: 16px;">
                            <div style="font-size: 12px; color: #64748b; line-height: 1.4;">
                                {{ getBindingActionHint }}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <el-button @click="productBindDialogVisible = false" size="default"
                                style="min-width: 70px;">
                                å–æ¶ˆ
                            </el-button>
                            <el-button :type="getBindingButtonType" @click="saveProductBinding" :loading="binding"
                                size="default" style="min-width: 100px; font-weight: 500;">
                                <el-icon style="margin-right: 4px;">
                                    <component :is="getBindingButtonIcon"></component>
                                </el-icon>
                                {{ getBindingButtonText }}
                            </el-button>
                        </div>
                    </div>
                </div>
            </template>
        </el-dialog>

        <!-- æ‰¹é‡å•†å“ç»‘å®šå¯¹è¯æ¡† -->
        <el-dialog v-model="batchBindDialogVisible" width="600px" :close-on-click-modal="false">
            <template #header>
                <div style="display: flex; align-items: center; gap: 12px; padding: 4px 0;">
                    <div
                        style="width: 36px; height: 36px; background: #f59e0b; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        <el-icon size="18" color="white">
                            <Operation />
                        </el-icon>
                    </div>
                    <div>
                        <div style="font-size: 16px; font-weight: 600; color: #1f2937;">æ‰¹é‡å•†å“ç»‘å®š</div>
                        <div style="font-size: 13px; color: #6b7280; margin-top: 2px;">ä¸º {{ selectedRooms.length }}
                            ä¸ªç›´æ’­é—´ç»‘å®šå•†å“</div>
                    </div>
                </div>
            </template>

            <div style="padding: 16px 20px;">
                <!-- é€‰ä¸­çš„ç›´æ’­é—´ -->
                <div style="margin-bottom: 20px;">
                    <div
                        style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                        <div style="width: 3px; height: 14px; background: #f59e0b; border-radius: 2px;"></div>
                        é€‰ä¸­çš„ç›´æ’­é—´
                    </div>
                    <div
                        style="max-height: 100px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; padding: 6px;">
                        <div v-for="room in selectedRooms" :key="room.id"
                            style="display: flex; align-items: center; justify-content: space-between; padding: 6px 8px; margin-bottom: 4px; background: #f9fafb; border-radius: 4px;">
                            <span style="font-size: 13px;">{{ room.name }}</span>
                            <el-tag v-if="room.product_name" size="small" type="warning" effect="plain">
                                å·²ç»‘å®š
                            </el-tag>
                            <el-tag v-else size="small" type="info" effect="plain">
                                æœªç»‘å®š
                            </el-tag>
                        </div>
                    </div>
                </div>

                <!-- å•†å“é€‰æ‹© -->
                <div style="margin-bottom: 20px;">
                    <div
                        style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                        <div style="width: 3px; height: 14px; background: #f59e0b; border-radius: 2px;"></div>
                        é€‰æ‹©å•†å“
                    </div>
                    <el-select v-model="batchBindForm.product_id" placeholder="è¯·é€‰æ‹©è¦ç»‘å®šçš„å•†å“" clearable filterable
                        style="width: 100%;" size="default">
                        <el-option v-for="product in productOptions" :key="product.id" :label="product.name"
                            :value="product.id">
                        </el-option>
                    </el-select>
                    <div
                        style="font-size: 11px; color: #6b7280; margin-top: 6px; padding: 6px 8px; background: #f0f9ff; border-radius: 4px;">
                        ğŸ’¡ æç¤ºï¼šæ¸…ç©ºé€‰æ‹©å¯è§£é™¤æ‰€æœ‰é€‰ä¸­ç›´æ’­é—´çš„å•†å“ç»‘å®š
                    </div>
                </div>
            </div>

            <template #footer>
                <div style="padding: 12px 0; border-top: 1px solid #f1f5f9;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 12px; color: #6b7280;">
                            å°†ä¸º {{ selectedRooms.length }} ä¸ªç›´æ’­é—´{{ batchBindForm.product_id ? 'ç»‘å®šå•†å“' : 'è§£é™¤ç»‘å®š' }}
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <el-button @click="batchBindDialogVisible = false" size="default">
                                å–æ¶ˆ
                            </el-button>
                            <el-button :type="batchBindForm.product_id ? 'warning' : 'danger'" @click="saveBatchBinding"
                                :loading="batchBinding" size="default">
                                <el-icon style="margin-right: 4px;">
                                    <component :is="batchBindForm.product_id ? 'Link' : 'Unlock'"></component>
                                </el-icon>
                                {{ batchBindForm.product_id ? 'æ‰¹é‡ç»‘å®š' : 'æ‰¹é‡è§£ç»‘' }}
                            </el-button>
                        </div>
                    </div>
            </template>
        </el-dialog>

        <!-- ç›´æ’­æ—¶é—´ç®¡ç†å¯¹è¯æ¡† -->
        <el-dialog v-model="liveTimeDialogVisible" :title="`${currentManageRoom?.name || ''} - ç›´æ’­æ—¶é—´å®‰æ’`" width="700px">
            <div style="margin-bottom: 16px;">
                <el-button plain type="primary" size="small" @click="showAddLiveTimeDialog">
                    <el-icon style="margin-right: 4px;">
                        <Plus />
                    </el-icon>
                    æ·»åŠ ç›´æ’­æ—¶é—´
                </el-button>
            </div>
            <div v-if="roomLiveTimes.length === 0" style="text-align: center; color: #9ca3af; padding: 40px 0;">
                <el-icon size="48" style="margin-bottom: 16px;">
                    <Clock />
                </el-icon>
                <p>è¯¥ç›´æ’­é—´æš‚æ— ç›´æ’­æ—¶é—´å®‰æ’</p>
            </div>
            <div v-else>
                <el-table :data="roomLiveTimes" style="width: 100%;" size="small">
                    <el-table-column prop="live_time" label="ç›´æ’­æ—¶é—´" align="center">
                        <template #default="scope">
                            <span style="font-size: 13px;">{{ scope.row.live_time }}</span>
                        </template>
                    </el-table-column>
                    <el-table-column prop="status" label="çŠ¶æ€" width="100" align="center">
                        <template #default="scope">
                            <el-tag :type="scope.row.status === 0 ? 'warning' : 'success'" size="small">
                                {{ scope.row.status === 0 ? 'ç­‰å¾…å¼€æ’­' : 'å·²å¼€æ’­' }}
                            </el-tag>
                        </template>
                    </el-table-column>
                    <el-table-column prop="remark" label="å¤‡æ³¨" show-overflow-tooltip>
                        <template #default="scope">
                            <span style="font-size: 12px;">{{ scope.row.remark || 'æ— ' }}</span>
                        </template>
                    </el-table-column>
                    <el-table-column prop="create_time" label="åˆ›å»ºæ—¶é—´" width="140" align="center">
                        <template #default="scope">
                            <span style="font-size: 12px;">{{ scope.row.create_time }}</span>
                        </template>
                    </el-table-column>
                    <el-table-column label="æ“ä½œ" width="180" align="center">
                        <template #default="scope">
                            <div style="display: flex; gap: 8px; justify-content: center; align-items: center;">
                                <el-button v-if="scope.row.status === 0" size="small" type="text"
                                    @click="markAsExpired(scope.row)" style="padding: 6px 12px;">
                                    <el-icon style="margin-right: 4px;">
                                        <Clock />
                                    </el-icon>
                                    æ ‡è®°è¿‡æœŸ
                                </el-button>
                                <el-button size="small" type="text" @click="deleteLiveTime(scope.row)"
                                    style="padding: 6px 12px;">
                                    <el-icon style="margin-right: 4px;">
                                        <Remove />
                                    </el-icon>
                                    åˆ é™¤
                                </el-button>
                            </div>
                        </template>
                    </el-table-column>
                </el-table>
            </div>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="liveTimeDialogVisible = false">å…³é—­</el-button>
                </span>
            </template>
        </el-dialog>

        <!-- æ·»åŠ ç›´æ’­æ—¶é—´å¯¹è¯æ¡† -->
        <el-dialog v-model="addLiveTimeDialogVisible" title="æ·»åŠ ç›´æ’­æ—¶é—´" width="500px">
            <el-form :model="liveTimeForm" :rules="liveTimeRules" ref="liveTimeFormRef" label-width="100px">
                <el-form-item label="ç›´æ’­æ—¶é—´" prop="live_time">
                    <el-date-picker v-model="liveTimeForm.live_time" type="datetime" placeholder="é€‰æ‹©ç›´æ’­æ—¶é—´"
                        format="YYYY-MM-DD HH:mm" value-format="YYYY-MM-DD HH:mm" style="width: 100%;"
                        :disabled-date="(time) => time.getTime() < Date.now() - 24 * 60 * 60 * 1000" :disabled-hours="() => {
                            const now = new Date();
                            const selected = new Date(liveTimeForm.live_time);
                            if (selected.toDateString() === now.toDateString()) {
                                return Array.from({length: now.getHours()}, (_, i) => i);
                            }
                            return [];
                        }" :disabled-minutes="(hour) => {
                            const now = new Date();
                            const selected = new Date(liveTimeForm.live_time);
                            if (selected.toDateString() === now.toDateString() && hour === now.getHours()) {
                                return Array.from({length: now.getMinutes() + 1}, (_, i) => i);
                            }
                            return [];
                        }">
                    </el-date-picker>
                </el-form-item>
                <el-form-item label="å¤‡æ³¨" prop="remark">
                    <el-input v-model="liveTimeForm.remark" type="textarea" :rows="3" placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰">
                    </el-input>
                </el-form-item>
            </el-form>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="addLiveTimeDialogVisible = false">å–æ¶ˆ</el-button>
                    <el-button type="primary" @click="saveLiveTime" :loading="saving">ç¡®å®š</el-button>
                </span>
            </template>
        </el-dialog>

        <!-- ç³»ç»Ÿé…ç½®å¯¹è¯æ¡† -->
        <el-dialog v-model="configVisible" title="ç³»ç»Ÿé…ç½®" width="900px" :close-on-click-modal="false">
            <div v-loading="configLoading">
                <el-tabs type="border-card">

                    <!-- æ—¶é—´é—´éš”é…ç½® -->
                    <el-tab-pane label="æ—¶é—´é—´éš”">
                        <div class="config-section">
                            <h3 class="section-title">
                                <el-icon>
                                    <Timer />
                                </el-icon>
                                ä»»åŠ¡æ‰§è¡Œé—´éš”è®¾ç½®
                            </h3>
                            <el-form :model="systemConfig.intervals" label-width="140px" size="small">
                                <el-row :gutter="16">
                                    <el-col :span="12">
                                        <el-form-item label="å¼¹å¹•å‘é€é—´éš”">
                                            <el-input-number v-model="systemConfig.intervals.bullet_screen_send"
                                                :min="5" :max="3600" :step="5" style="width: 100%;">
                                                <template #append>ç§’</template>
                                            </el-input-number>
                                            <div class="config-hint">æ¨èï¼šæµ‹è¯• 5-60ç§’ï¼Œç”Ÿäº§ 120-600ç§’</div>
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="12">
                                        <el-form-item label="å¼¹å¹•é‡è¯•é—´éš”">
                                            <el-input-number v-model="systemConfig.intervals.bullet_screen_retry"
                                                :min="3" :max="60" :step="1" style="width: 100%;">
                                                <template #append>ç§’</template>
                                            </el-input-number>
                                            <div class="config-hint">å¼¹å¹•å‘é€å¤±è´¥åé‡è¯•é—´éš”</div>
                                        </el-form-item>
                                    </el-col>
                                </el-row>

                                <el-row :gutter="16">
                                    <el-col :span="12">
                                        <el-form-item label="è·Ÿæ’­ä»»åŠ¡é‡è¯•é—´éš”">
                                            <el-input-number v-model="systemConfig.intervals.follow_task_retry"
                                                :min="10" :max="600" :step="10" style="width: 100%;">
                                                <template #append>ç§’</template>
                                            </el-input-number>
                                            <div class="config-hint">è·Ÿæ’­ä»»åŠ¡æ‰§è¡Œå¤±è´¥åé‡è¯•é—´éš”</div>
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="12">
                                        <el-form-item label="å›¾åƒè¯†åˆ«é‡è¯•é—´éš”">
                                            <el-input-number v-model="systemConfig.intervals.image_recognition_retry"
                                                :min="5" :max="300" :step="5" style="width: 100%;">
                                                <template #append>ç§’</template>
                                            </el-input-number>
                                            <div class="config-hint">å›¾åƒè¯†åˆ«å¤±è´¥åé‡è¯•é—´éš”</div>
                                        </el-form-item>
                                    </el-col>
                                </el-row>

                                <el-row :gutter="16">
                                    <el-col :span="12">
                                        <el-form-item label="ç›´æ’­é—´æ£€æŸ¥é—´éš”">
                                            <el-input-number v-model="systemConfig.intervals.live_room_check" :min="60"
                                                :max="1800" :step="30" style="width: 100%;">
                                                <template #append>ç§’</template>
                                            </el-input-number>
                                            <div class="config-hint">å®šæœŸæ£€æŸ¥ç›´æ’­é—´çŠ¶æ€çš„é—´éš”</div>
                                        </el-form-item>
                                    </el-col>
                                </el-row>
                            </el-form>
                        </div>
                    </el-tab-pane>

                    <!-- é‡è¯•ç­–ç•¥é…ç½® -->
                    <el-tab-pane label="é‡è¯•ç­–ç•¥">
                        <div class="config-section">
                            <h3 class="section-title">
                                <el-icon>
                                    <Refresh />
                                </el-icon>
                                é‡è¯•æ¬¡æ•°ä¸ç­–ç•¥è®¾ç½®
                            </h3>
                            <el-form :model="systemConfig.retry_config" label-width="140px" size="small">
                                <el-row :gutter="16">
                                    <el-col :span="12">
                                        <el-form-item label="å¼¹å¹•é‡è¯•æ¬¡æ•°">
                                            <el-input-number v-model="systemConfig.retry_config.max_bullet_retry"
                                                :min="1" :max="10" style="width: 100%;">
                                                <template #append>æ¬¡</template>
                                            </el-input-number>
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="12">
                                        <el-form-item label="å›¾åƒè¯†åˆ«é‡è¯•æ¬¡æ•°">
                                            <el-input-number v-model="systemConfig.retry_config.max_image_retry"
                                                :min="1" :max="20" style="width: 100%;">
                                                <template #append>æ¬¡</template>
                                            </el-input-number>
                                        </el-form-item>
                                    </el-col>
                                </el-row>

                                <el-row :gutter="16">
                                    <el-col :span="12">
                                        <el-form-item label="è·Ÿæ’­ä»»åŠ¡é‡è¯•æ¬¡æ•°">
                                            <el-input-number v-model="systemConfig.retry_config.max_follow_retry"
                                                :min="1" :max="50" style="width: 100%;">
                                                <template #append>æ¬¡</template>
                                            </el-input-number>
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="12">
                                        <el-form-item label="è‡ªåŠ¨é‡è¯•">
                                            <el-switch v-model="systemConfig.retry_config.enable_auto_retry"
                                                active-text="å¯ç”¨" inactive-text="ç¦ç”¨" />
                                            <div class="config-hint">å…³é—­åéœ€è¦æ‰‹åŠ¨é‡è¯•å¤±è´¥çš„ä»»åŠ¡</div>
                                        </el-form-item>
                                    </el-col>
                                </el-row>
                            </el-form>
                        </div>
                    </el-tab-pane>

                    <!-- åŠŸèƒ½å¼€å…³ -->
                    <el-tab-pane label="åŠŸèƒ½å¼€å…³">
                        <div class="config-section">
                            <h3 class="section-title">
                                <el-icon>
                                    <Operation />
                                </el-icon>
                                ç³»ç»ŸåŠŸèƒ½å¼€å…³è®¾ç½®
                            </h3>
                            <el-form :model="systemConfig.features" label-width="140px" size="small">
                                <el-row :gutter="16">
                                    <el-col :span="6">
                                        <el-form-item label="æˆªå›¾åŠŸèƒ½">
                                            <el-switch v-model="systemConfig.features.enable_screenshot"
                                                @change="handleScreenshotChange" />
                                            <div class="config-hint">
                                                <span v-if="systemConfig.features.enable_screenshot"
                                                    style="color: #67c23a;">
                                                    å·²å¼€å¯ï¼šè‡ªåŠ¨æˆªå›¾ä¿å­˜è¯†åˆ«ç»“æœ
                                                </span>
                                                <span v-else style="color: #909399;">
                                                    å·²å…³é—­ï¼šä¸è¿›è¡Œæˆªå›¾ä¿å­˜
                                                </span>
                                            </div>
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="6">
                                        <el-form-item label="ç³»ç»Ÿé€šçŸ¥">
                                            <el-switch v-model="systemConfig.features.enable_notifications"
                                                @change="handleNotificationsChange" />
                                            <div class="config-hint">
                                                <span v-if="systemConfig.features.enable_notifications"
                                                    style="color: #67c23a;">
                                                    å·²å¼€å¯ï¼šæ˜¾ç¤ºä»»åŠ¡æ‰§è¡Œé€šçŸ¥
                                                </span>
                                                <span v-else style="color: #909399;">
                                                    å·²å…³é—­ï¼šä¸æ˜¾ç¤ºç³»ç»Ÿé€šçŸ¥
                                                </span>
                                            </div>
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="6">
                                        <el-form-item label="è¯¦ç»†æ—¥å¿—">
                                            <el-switch v-model="systemConfig.features.enable_detailed_logs"
                                                @change="handleDetailedLogsChange" />
                                            <div class="config-hint">
                                                <span v-if="systemConfig.features.enable_detailed_logs"
                                                    style="color: #67c23a;">
                                                    å·²å¼€å¯ï¼šè®°å½•è¯¦ç»†æ“ä½œä¿¡æ¯
                                                </span>
                                                <span v-else style="color: #909399;">
                                                    å·²å…³é—­ï¼šä»…è®°å½•åŸºæœ¬æ—¥å¿—
                                                </span>
                                            </div>
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="6">
                                        <el-form-item label="çœŸå®å‘é€å¼¹å¹•">
                                            <el-switch v-model="systemConfig.features.enable_real_danmu_send"
                                                @change="handleRealDanmuSendChange" :loading="realDanmuSendLoading" />
                                            <div class="config-hint">
                                                <span v-if="systemConfig.features.enable_real_danmu_send"
                                                    style="color: #67c23a;">
                                                    å·²å¼€å¯ï¼šOCRç‚¹å‡»å‘é€æŒ‰é’®
                                                </span>
                                                <span v-else style="color: #909399;">
                                                    å·²å…³é—­ï¼šå›è½¦é”®æ¨¡æ‹Ÿå‘é€
                                                </span>
                                            </div>
                                        </el-form-item>
                                    </el-col>
                                </el-row>
                            </el-form>
                        </div>
                    </el-tab-pane>

                    <!-- è´¨é‡ä¸æ€§èƒ½ -->
                    <el-tab-pane label="è´¨é‡ä¸æ€§èƒ½">
                        <div class="config-section">
                            <h3 class="section-title">
                                <el-icon>
                                    <Medal />
                                </el-icon>
                                å›¾åƒè¯†åˆ«ä¸ç³»ç»Ÿæ€§èƒ½è®¾ç½®
                            </h3>
                            <el-form :model="systemConfig.quality" label-width="140px" size="small">
                                <el-row :gutter="16">
                                    <el-col :span="12">
                                        <el-form-item label="æˆªå›¾è´¨é‡">
                                            <el-slider v-model="systemConfig.quality.screenshot_quality" :min="50"
                                                :max="100" :step="10" show-stops show-tooltip
                                                :format-tooltip="(val) => `${val}%`" />
                                            <div class="config-hint">è¾ƒé«˜è´¨é‡ä¼šå¢åŠ æ–‡ä»¶å¤§å°ï¼Œä½†è¯†åˆ«æ›´å‡†ç¡®</div>
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="12">
                                        <el-form-item label="å›¾åƒåŒ¹é…ç½®ä¿¡åº¦">
                                            <el-slider v-model="systemConfig.quality.image_match_confidence" :min="0.5"
                                                :max="1.0" :step="0.05" show-stops show-tooltip
                                                :format-tooltip="(val) => `${(val * 100).toFixed(0)}%`" />
                                            <div class="config-hint">ç½®ä¿¡åº¦è¶Šé«˜è¯†åˆ«è¶Šä¸¥æ ¼ï¼Œä½†å¯èƒ½æ¼æ£€</div>
                                        </el-form-item>
                                    </el-col>
                                </el-row>

                                <el-row :gutter="16">
                                    <el-col :span="12">
                                        <el-form-item label="æ—¥å¿—çº§åˆ«">
                                            <el-select v-model="systemConfig.quality.log_level" style="width: 100%;">
                                                <el-option label="è°ƒè¯• (Debug)" value="debug" />
                                                <el-option label="ä¿¡æ¯ (Info)" value="info" />
                                                <el-option label="è­¦å‘Š (Warning)" value="warning" />
                                                <el-option label="é”™è¯¯ (Error)" value="error" />
                                            </el-select>
                                            <div class="config-hint">æ§åˆ¶ç³»ç»Ÿè¾“å‡ºçš„æ—¥å¿—è¯¦ç»†ç¨‹åº¦</div>
                                        </el-form-item>
                                    </el-col>
                                </el-row>
                            </el-form>
                        </div>
                    </el-tab-pane>

                    <!-- ç•Œé¢é…ç½® -->
                    <el-tab-pane label="ç•Œé¢è®¾ç½®">
                        <div class="config-section">
                            <h3 class="section-title">
                                <el-icon>
                                    <Monitor />
                                </el-icon>
                                ç”¨æˆ·ç•Œé¢ä¸ªæ€§åŒ–è®¾ç½®
                            </h3>
                            <el-form :model="uiConfig" label-width="100px" size="small">
                                <el-row :gutter="16">
                                    <el-col :span="12">
                                        <el-form-item label="ç•Œé¢ä¸»é¢˜">
                                            <el-radio-group v-model="uiConfig.theme">
                                                <el-radio-button label="default">é»˜è®¤ä¸»é¢˜</el-radio-button>
                                                <el-radio-button label="dark">æ·±è‰²ä¸»é¢˜</el-radio-button>
                                            </el-radio-group>
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="12">
                                        <el-form-item label="åŠ¨ç”»æ•ˆæœ">
                                            <el-switch v-model="uiConfig.animation_enabled" active-text="å¯ç”¨"
                                                inactive-text="ç¦ç”¨" />
                                        </el-form-item>
                                    </el-col>
                                </el-row>

                                <el-row :gutter="16">
                                    <el-col :span="12">
                                        <el-form-item label="è‡ªåŠ¨æ»šåŠ¨æ—¥å¿—">
                                            <el-switch v-model="uiConfig.auto_scroll" />
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="12">
                                        <el-form-item label="æ˜¾ç¤ºç³»ç»Ÿé€šçŸ¥">
                                            <el-switch v-model="uiConfig.show_notifications" />
                                        </el-form-item>
                                    </el-col>
                                </el-row>
                            </el-form>
                        </div>
                    </el-tab-pane>

                    <!-- é…ç½®é¢„è§ˆ -->
                    <el-tab-pane label="é…ç½®é¢„è§ˆ">
                        <div class="config-section">
                            <h3 class="section-title">
                                <el-icon>
                                    <Document />
                                </el-icon>
                                å½“å‰é…ç½®JSONé¢„è§ˆ
                            </h3>
                            <div class="config-preview">
                                <pre class="json-preview">{{ JSON.stringify({
    system_config: systemConfig,
    ui_config: uiConfig
}, null, 2) }}</pre>
                            </div>
                        </div>
                    </el-tab-pane>
                </el-tabs>
            </div>

            <template #footer>
                <div class="config-footer">
                    <el-button @click="resetConfig" :loading="configSaving" type="warning" plain>
                        é‡ç½®é»˜è®¤
                    </el-button>
                    <div style="flex: 1;"></div>
                    <el-button @click="configVisible = false">å–æ¶ˆ</el-button>
                    <el-button type="primary" @click="saveConfig" :loading="configSaving">
                        ä¿å­˜é…ç½®
                    </el-button>
                </div>
            </template>
        </el-dialog>


    </div>



    <script>
        const { createApp, ref, computed, onMounted, nextTick } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;

        const app = createApp({
            setup() {
                // å“åº”å¼æ•°æ®
                const loading = ref(false);
                const saving = ref(false);
                const searchKeyword = ref('');
                const wechatRooms = ref([]);

                // ğŸ”¥ æ–°å¢ï¼šåˆ†é¡µç›¸å…³æ•°æ®
                const currentPage = ref(1);
                const pageSize = ref(20);
                const totalRooms = ref(0);

                // æ‰¹é‡è·Ÿæ’­ç›¸å…³
                const selectedRooms = ref([]);
                const roomTableRef = ref(null);
                const roomSpeech = ref([]);
                const roomSpeeches = ref({}); // å­˜å‚¨æ‰€æœ‰ç›´æ’­é—´çš„è¯æœ¯æ•°æ®

                const roomDialogVisible = ref(false);
                const isEditRoom = ref(false);
                const roomFormRef = ref(null);

                // è¡¨å•æ•°æ®
                const roomForm = ref({
                    id: null,
                    name: '',
                    status: 1,
                    product_id: null
                });

                // å•†å“ç»‘å®šç›¸å…³
                const productBindDialogVisible = ref(false);
                const currentBindRoom = ref(null);
                const productOptions = ref([]);
                const productBindForm = ref({
                    product_id: null
                });

                // æ‰¹é‡å•†å“ç»‘å®šç›¸å…³
                const batchBindDialogVisible = ref(false);
                const batchBindForm = ref({
                    product_id: null
                });
                const batchBinding = ref(false);

                // ç›´æ’­æ—¶é—´ç®¡ç†ç›¸å…³
                const liveTimeDialogVisible = ref(false);
                const addLiveTimeDialogVisible = ref(false);
                const currentManageRoom = ref(null);
                const roomLiveTimes = ref([]);
                const liveTimeForm = ref({
                    live_time: '',
                    remark: ''
                });
                const liveTimeFormRef = ref(null);

                // è¯æœ¯ç›¸å…³
                const speechViewDialogVisible = ref(false);
                const speechBindDialogVisible = ref(false);
                const currentRoomSpeech = ref([]);
                const currentViewRoom = ref(null);
                const allSpeech = ref([]);

                // ç³»ç»Ÿé…ç½®ç›¸å…³
                const configVisible = ref(false);
                const configLoading = ref(false);
                const configSaving = ref(false);
                const configBadge = ref('');
                const realDanmuSendLoading = ref(false);

                const systemConfig = ref({
                    intervals: {
                        bullet_screen_send: 500,
                        bullet_screen_retry: 10,
                        follow_task_retry: 60,
                        image_recognition_retry: 20,
                        live_room_check: 300
                    },
                    retry_config: {
                        max_bullet_retry: 3,
                        max_image_retry: 5,
                        max_follow_retry: 10,
                        enable_auto_retry: true
                    },
                    features: {
                        enable_screenshot: true,
                        enable_notifications: true,
                        enable_detailed_logs: true,
                        enable_real_danmu_send: false
                    },
                    quality: {
                        screenshot_quality: 80,
                        image_match_confidence: 0.8,
                        log_level: 'info'
                    }
                });

                const uiConfig = ref({
                    theme: 'default',
                    auto_scroll: true,
                    show_notifications: true,
                    animation_enabled: true
                });

                const speechSearchKeyword = ref('');
                const selectedSpeechList = ref([]);
                const binding = ref(false);
                const currentRoomBoundSpeechIds = ref([]);

                // è¡¨å•éªŒè¯è§„åˆ™
                const roomRules = {
                    name: [
                        { required: true, message: 'è¯·è¾“å…¥ç›´æ’­é—´åç§°', trigger: 'blur' },
                        {
                            validator: (rule, value, callback) => {
                                if (!value) {
                                    callback();
                                    return;
                                }

                                // æ£€æŸ¥åç§°æ˜¯å¦é‡å¤
                                const existingRoom = wechatRooms.value.find(room =>
                                    room.name === value && room.id !== roomForm.value.id
                                );

                                if (existingRoom) {
                                    callback(new Error('ç›´æ’­é—´åç§°å·²å­˜åœ¨'));
                                } else {
                                    callback();
                                }
                            },
                            trigger: 'blur'
                        }
                    ]
                };

                const liveTimeRules = {
                    live_time: [
                        { required: true, message: 'è¯·é€‰æ‹©ç›´æ’­æ—¶é—´', trigger: 'change' },
                        {
                            validator: (rule, value, callback) => {
                                if (!value) {
                                    callback(new Error('è¯·é€‰æ‹©ç›´æ’­æ—¶é—´'));
                                    return;
                                }

                                const selectedTime = new Date(value);
                                const now = new Date();

                                if (selectedTime <= now) {
                                    callback(new Error('ç›´æ’­æ—¶é—´ä¸èƒ½æ—©äºæˆ–ç­‰äºå½“å‰æ—¶é—´'));
                                    return;
                                }

                                callback();
                            },
                            trigger: 'change'
                        }
                    ]
                };

                // è®¡ç®—å±æ€§
                const roomDialogTitle = computed(() => isEditRoom.value ? 'ç¼–è¾‘ç›´æ’­é—´' : 'æ·»åŠ ç›´æ’­é—´');

                // é…ç½®ç›¸å…³è®¡ç®—å±æ€§
                const getConfigStatusStyle = (type) => {
                    if (type === 'screenshot') {
                        return systemConfig.value.features?.enable_screenshot ?
                            'background: rgba(103, 194, 58, 0.3); color: rgba(255,255,255,0.9); padding: 2px 6px; border-radius: 3px; font-size: 10px;' :
                            'background: rgba(160, 160, 160, 0.3); color: rgba(255,255,255,0.7); padding: 2px 6px; border-radius: 3px; font-size: 10px;';
                    } else if (type === 'logs') {
                        return systemConfig.value.features?.enable_detailed_logs ?
                            'background: rgba(64, 158, 255, 0.3); color: rgba(255,255,255,0.9); padding: 2px 6px; border-radius: 3px; font-size: 10px;' :
                            'background: rgba(160, 160, 160, 0.3); color: rgba(255,255,255,0.7); padding: 2px 6px; border-radius: 3px; font-size: 10px;';
                    }
                    return '';
                };

                // ğŸ”¥ ä¿®æ”¹ï¼šè¿‡æ»¤å’Œåˆ†é¡µåçš„ç›´æ’­é—´åˆ—è¡¨
                const filteredWechatRooms = computed(() => {
                    // å…ˆè¿‡æ»¤
                    let filtered = wechatRooms.value;
                    if (searchKeyword.value) {
                        filtered = wechatRooms.value.filter(room =>
                            room.name.toLowerCase().includes(searchKeyword.value.toLowerCase()) ||
                            room.id.toString().includes(searchKeyword.value)
                        );
                    }

                    // æ›´æ–°æ€»æ•°
                    totalRooms.value = filtered.length;

                    // å†åˆ†é¡µ
                    const start = (currentPage.value - 1) * pageSize.value;
                    const end = start + pageSize.value;
                    return filtered.slice(start, end);
                });

                // å•†å“ç»‘å®šç»Ÿè®¡
                const boundProductCount = computed(() => {
                    return wechatRooms.value.filter(room => room.product_id).length;
                });

                const unboundProductCount = computed(() => {
                    return wechatRooms.value.filter(room => !room.product_id).length;
                });

                // å•†å“ç»‘å®šæŒ‰é’®ç›¸å…³è®¡ç®—å±æ€§
                const getBindingButtonText = computed(() => {
                    if (!productBindForm.value.product_id) {
                        return 'è§£é™¤ç»‘å®š';
                    }

                    if (currentBindRoom.value?.product_id === productBindForm.value.product_id) {
                        return 'è§£é™¤ç»‘å®š';
                    }

                    if (currentBindRoom.value?.product_id && productBindForm.value.product_id) {
                        return 'æ›´æ¢ç»‘å®š';
                    }

                    return 'ç¡®è®¤ç»‘å®š';
                });

                const getBindingButtonType = computed(() => {
                    if (!productBindForm.value.product_id) {
                        return 'danger';
                    }

                    if (currentBindRoom.value?.product_id === productBindForm.value.product_id) {
                        return 'danger';
                    }

                    if (currentBindRoom.value?.product_id && productBindForm.value.product_id) {
                        return 'warning';
                    }

                    return 'primary';
                });

                const getBindingButtonIcon = computed(() => {
                    if (!productBindForm.value.product_id) {
                        return 'Unlock';
                    }

                    if (currentBindRoom.value?.product_id === productBindForm.value.product_id) {
                        return 'Unlock';
                    }

                    if (currentBindRoom.value?.product_id && productBindForm.value.product_id) {
                        return 'Refresh';
                    }

                    return 'Link';
                });

                const getBindingActionHint = computed(() => {
                    if (!productBindForm.value.product_id) {
                        return 'ğŸ’¡ å°†è§£é™¤å½“å‰å•†å“ç»‘å®šï¼Œç›´æ’­é—´å°†ä¸å†å…³è”ä»»ä½•å•†å“';
                    }

                    if (currentBindRoom.value?.product_id === productBindForm.value.product_id) {
                        return 'âš ï¸ é€‰æ‹©çš„æ˜¯å½“å‰ç»‘å®šçš„å•†å“ï¼Œç‚¹å‡»å°†è§£é™¤ç»‘å®š';
                    }

                    if (currentBindRoom.value?.product_id && productBindForm.value.product_id) {
                        const currentProduct = productOptions.value.find(p => p.id === currentBindRoom.value.product_id);
                        const newProduct = productOptions.value.find(p => p.id === productBindForm.value.product_id);
                        return `ğŸ”„ å°†å•†å“ä»"${currentProduct?.name || 'æœªçŸ¥å•†å“'}"æ›´æ¢ä¸º"${newProduct?.name || 'æœªçŸ¥å•†å“'}"`;
                    }

                    const newProduct = productOptions.value.find(p => p.id === productBindForm.value.product_id);
                    return `âœ¨ å°†ä¸ºç›´æ’­é—´ç»‘å®šå•†å“"${newProduct?.name || 'æœªçŸ¥å•†å“'}"`;
                });

                // è¿‡æ»¤è¯æœ¯åˆ—è¡¨
                const filteredAllSpeech = computed(() => {
                    if (!speechSearchKeyword.value) {
                        return allSpeech.value;
                    }
                    return allSpeech.value.filter(speech =>
                        speech.content.toLowerCase().includes(speechSearchKeyword.value.toLowerCase())
                    );
                });



                // è·å–ç›´æ’­é—´ç»‘å®šçš„è¯æœ¯
                const getRoomSpeech = (roomId) => {
                    return roomSpeeches.value[roomId] || [];
                };

                // æ‰¹é‡è·Ÿæ’­ç›¸å…³å‡½æ•°
                const handleSelectionChange = (selection) => {
                    selectedRooms.value = selection;
                };

                const clearSelection = () => {
                    if (roomTableRef.value) {
                        roomTableRef.value.clearSelection();
                    }
                    selectedRooms.value = [];
                };

                // ğŸ”¥ æ–°å¢ï¼šåˆ†é¡µå¤„ç†å‡½æ•°
                const handleSizeChange = (newSize) => {
                    pageSize.value = newSize;
                    currentPage.value = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
                    console.log(`åˆ†é¡µå¤§å°æ”¹å˜: ${newSize}`);
                };

                const handleCurrentChange = (newPage) => {
                    currentPage.value = newPage;
                    console.log(`å½“å‰é¡µæ”¹å˜: ${newPage}`);
                };

                // ğŸ”¥ æµ‹è¯• el-message æ˜¾ç¤ºåŠŸèƒ½




                const startBatchFollow = async () => {
                    console.log('ğŸš€ startBatchFollow å‡½æ•°è¢«è°ƒç”¨');
                    console.log('é€‰ä¸­çš„ç›´æ’­é—´:', selectedRooms.value);

                    if (selectedRooms.value.length === 0) {
                        ElMessage.warning('è¯·å…ˆé€‰æ‹©è¦è·Ÿæ’­çš„ç›´æ’­é—´');
                        return;
                    }

                    // ğŸ”¥ æ–°å¢ï¼šæ£€æŸ¥å•†å“ç»‘å®šçŠ¶æ€
                    console.log('ğŸ” å¼€å§‹æ£€æŸ¥å•†å“ç»‘å®šçŠ¶æ€...');
                    const unboundRooms = selectedRooms.value.filter(room => !room.product_id);
                    console.log('æœªç»‘å®šå•†å“çš„ç›´æ’­é—´:', unboundRooms);

                    if (unboundRooms.length > 0) {
                        const unboundNames = unboundRooms.map(room => room.name).join('ã€');
                        console.log('æœªç»‘å®šå•†å“çš„ç›´æ’­é—´åç§°:', unboundNames);

                        try {
                            console.log('ğŸ”” å‡†å¤‡æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†...');
                            await ElMessageBox.confirm(
                                `ä»¥ä¸‹ç›´æ’­é—´æœªç»‘å®šä»»ä½•å•†å“ï¼Œå°†æ— æ³•è¯†åˆ«æ•°æ®è¿›è¡Œè·Ÿæ’­ï¼š\n\n${unboundNames}\n\nç¡®å®šè®¾ç½®è·Ÿæ’­ä»»åŠ¡å—ï¼Ÿ`,
                                'å•†å“ç»‘å®šæ£€æŸ¥',
                                {
                                    confirmButtonText: 'ç¡®å®šè·Ÿæ’­',
                                    cancelButtonText: 'å–æ¶ˆ',
                                    type: 'warning',
                                    dangerouslyUseHTMLString: false
                                }
                            );
                            console.log('âœ… ç”¨æˆ·ç¡®è®¤ç»§ç»­è·Ÿæ’­');
                        } catch (error) {
                            // ç”¨æˆ·ç‚¹å‡»å–æ¶ˆ
                            console.log('âŒ ç”¨æˆ·å–æ¶ˆè·Ÿæ’­ä»»åŠ¡');
                            ElMessage.info('å·²å–æ¶ˆè·Ÿæ’­ä»»åŠ¡');
                            return;
                        }
                    } else {
                        console.log('âœ… æ‰€æœ‰ç›´æ’­é—´éƒ½å·²ç»‘å®šå•†å“');
                    }

                    try {
                        // å‡†å¤‡è·Ÿæ’­æ•°æ®
                        const followData = selectedRooms.value.map(room => ({
                            id: room.id,
                            name: room.name,
                            platform: room.platform
                        }));

                        console.log(`ğŸš€ å¼€å§‹æ‰¹é‡è·Ÿæ’­ ${followData.length} ä¸ªç›´æ’­é—´...`);

                        // è°ƒç”¨åç«¯API
                        const api = await waitForApi();
                        const result = await api.start_batch_follow(followData);

                        if (result && result.success) {
                            ElMessage.success(`æˆåŠŸå¯åŠ¨ ${followData.length} ä¸ªç›´æ’­é—´çš„è·Ÿæ’­`);
                            console.log(`âœ… æ‰¹é‡è·Ÿæ’­å¯åŠ¨æˆåŠŸ: ${result.message}`);

                            // æ˜¾ç¤ºè·Ÿæ’­çš„ç›´æ’­é—´åˆ—è¡¨
                            followData.forEach(room => {
                                console.log(`ğŸ¯ è·Ÿæ’­ç›´æ’­é—´: ${room.name} (ID: ${room.id})`);
                            });

                            // æ¸…ç©ºé€‰æ‹©
                            clearSelection();
                        } else {
                            ElMessage.error(result?.message || 'æ‰¹é‡è·Ÿæ’­å¯åŠ¨å¤±è´¥');
                            console.error(`âŒ æ‰¹é‡è·Ÿæ’­å¤±è´¥: ${result?.message}`);
                        }
                    } catch (error) {
                        console.error('æ‰¹é‡è·Ÿæ’­å¤±è´¥:', error);
                        ElMessage.error('æ‰¹é‡è·Ÿæ’­å¤±è´¥: ' + error.message);
                    }
                };



                // è·å–pywebview API - å€Ÿé‰´å…¶ä»–æ¨¡å—çš„å®ç°
                const getPywebviewApi = () => {
                    if (window.pywebview && window.pywebview.api) {
                        return window.pywebview.api;
                    } else if (window.parent && window.parent.pywebview && window.parent.pywebview.api) {
                        return window.parent.pywebview.api;
                    } else if (window.top && window.top.pywebview && window.top.pywebview.api) {
                        return window.top.pywebview.api;
                    }
                    return null;
                };

                // ç­‰å¾…APIå°±ç»ªçš„é€šç”¨æ–¹æ³•
                const waitForApi = async () => {
                    let api = getPywebviewApi();
                    if (!api) {
                        for (let i = 0; i < 5; i++) {
                            await new Promise(resolve => setTimeout(resolve, 300));
                            api = getPywebviewApi();
                            if (api) break;
                        }
                        if (!api) {
                            throw new Error('æ— æ³•è¿æ¥åˆ°åç«¯APIï¼Œè¯·ç¡®ä¿åº”ç”¨æ­£å¸¸è¿è¡Œ');
                        }
                    }
                    return api;
                };



                // åŠ è½½å¾®ä¿¡ç›´æ’­é—´
                const loadWechatRooms = async () => {
                    try {
                        const api = await waitForApi();
                        // è·å–æ‰€æœ‰ç›´æ’­é—´ï¼Œä¸è¿‡æ»¤çŠ¶æ€
                        const result = await api.get_rooms_list('wechat', null);

                        if (result && result.success) {
                            const rooms = result.data || [];

                            // ä¸ºæ¯ä¸ªç›´æ’­é—´åŠ è½½ä¸‹æ¬¡ç›´æ’­æ—¶é—´
                            for (const room of rooms) {
                                const liveTimeResult = await api.get_room_next_live_time(room.id);
                                if (liveTimeResult && liveTimeResult.success && liveTimeResult.data.live_time) {
                                    room.next_live_time = liveTimeResult.data.live_time;
                                } else {
                                    room.next_live_time = null;
                                }
                            }

                            wechatRooms.value = rooms;
                            // åŠ è½½æ¯ä¸ªç›´æ’­é—´çš„è¯æœ¯
                            await loadAllRoomSpeeches();

                            // å¼‚æ­¥åŠ è½½å•†å“å°é¢
                            nextTick(() => {
                                loadProductCovers();
                            });
                        }
                    } catch (error) {
                        console.error('åŠ è½½ç›´æ’­é—´å¤±è´¥:', error);
                        ElMessage.error('åŠ è½½ç›´æ’­é—´å¤±è´¥');
                    }
                };

                // åŠ è½½æ‰€æœ‰ç›´æ’­é—´çš„è¯æœ¯
                const loadAllRoomSpeeches = async () => {
                    try {
                        const api = await waitForApi();
                        const speeches = {};
                        for (const room of wechatRooms.value) {
                            const result = await api.get_room_speeches(room.id);
                            if (result && result.success) {
                                speeches[room.id] = result.data || [];
                            }
                        }
                        roomSpeeches.value = speeches;
                    } catch (error) {
                        console.error('åŠ è½½ç›´æ’­é—´è¯æœ¯å¤±è´¥:', error);
                    }
                };

                // åŠ è½½å•†å“å°é¢å›¾ç‰‡
                const loadProductCovers = async () => {
                    console.log('ğŸ–¼ï¸ å¼€å§‹åŠ è½½å•†å“å°é¢å›¾ç‰‡...');

                    for (const room of wechatRooms.value) {
                        if (room.product_cover && !room.productCoverObjectUrl) {
                            try {
                                const objectUrl = await getProductCoverUrl(room.product_cover);
                                if (objectUrl) {
                                    room.productCoverObjectUrl = objectUrl;
                                    console.log(`âœ… åŠ è½½å•†å“å°é¢æˆåŠŸ: ${room.product_name}`);
                                }
                            } catch (error) {
                                console.error('åŠ è½½å•†å“å°é¢å¤±è´¥:', room.product_cover, error);
                            }
                        }
                    }
                };

                // ç›´æ’­é—´ç®¡ç†
                const showAddRoomDialog = () => {
                    isEditRoom.value = false;
                    roomForm.value = {
                        id: null,
                        name: '',
                        status: 1,
                        product_id: null
                    };
                    roomDialogVisible.value = true;
                };

                const editRoom = (room) => {
                    isEditRoom.value = true;
                    roomForm.value = {
                        id: room.id,
                        name: room.name,
                        status: room.status,
                        product_id: room.product_id
                    };
                    roomDialogVisible.value = true;
                };

                // æŸ¥çœ‹ç»‘å®šè¯æœ¯
                const viewBoundSpeech = async (room) => {
                    try {
                        currentViewRoom.value = room;
                        const api = await waitForApi();
                        const result = await api.get_room_speeches(room.id);

                        if (result && result.success) {
                            currentRoomSpeech.value = result.data || [];
                            speechViewDialogVisible.value = true;
                        } else {
                            ElMessage.error(result?.message || 'è·å–è¯æœ¯å¤±è´¥');
                        }
                    } catch (error) {
                        console.error('è·å–è¯æœ¯å¤±è´¥:', error);
                        ElMessage.error('è·å–è¯æœ¯å¤±è´¥');
                    }
                };

                // ç»‘å®šè¯æœ¯
                const bindSpeech = async (room) => {
                    try {
                        currentViewRoom.value = room;
                        await loadAllSpeech();
                        // åŠ è½½å½“å‰ç›´æ’­é—´å·²ç»‘å®šçš„è¯æœ¯ID
                        await loadCurrentRoomBoundSpeeches();
                        speechBindDialogVisible.value = true;
                    } catch (error) {
                        console.error('åŠ è½½è¯æœ¯å¤±è´¥:', error);
                        ElMessage.error('åŠ è½½è¯æœ¯å¤±è´¥');
                    }
                };



                // è§£ç»‘è¯æœ¯
                const unbindSpeechFromRoom = async (speech) => {
                    try {
                        await ElMessageBox.confirm(
                            `ç¡®å®šè¦è§£ç»‘è¯æœ¯"${speech.content.substring(0, 20)}..."å—ï¼Ÿ`,
                            'ç¡®è®¤è§£ç»‘',
                            {
                                confirmButtonText: 'ç¡®å®š',
                                cancelButtonText: 'å–æ¶ˆ',
                                type: 'warning'
                            }
                        );

                        const api = await waitForApi();
                        const result = await api.unbind_speech_from_room(
                            currentViewRoom.value.id,
                            speech.id
                        );

                        if (result && result.success) {
                            ElMessage.success('è¯æœ¯è§£ç»‘æˆåŠŸ');
                            // åˆ·æ–°å¼¹çª—æ•°æ®
                            await viewBoundSpeech(currentViewRoom.value);
                            // åˆ·æ–°ä¸»è¡¨æ ¼æ•°æ®
                            await loadAllRoomSpeeches();
                        } else {
                            ElMessage.error(result?.message || 'è§£ç»‘å¤±è´¥');
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('è§£ç»‘è¯æœ¯å¤±è´¥:', error);
                            ElMessage.error('è§£ç»‘å¤±è´¥');
                        }
                    }
                };

                // åŠ è½½å½“å‰ç›´æ’­é—´å·²ç»‘å®šçš„è¯æœ¯ID
                const loadCurrentRoomBoundSpeeches = async () => {
                    try {
                        if (!currentViewRoom.value) return;

                        const api = await waitForApi();
                        const result = await api.get_room_speeches(currentViewRoom.value.id);

                        if (result && result.success) {
                            currentRoomBoundSpeechIds.value = result.data.map(speech => speech.id);
                        } else {
                            currentRoomBoundSpeechIds.value = [];
                        }
                    } catch (error) {
                        console.error('åŠ è½½å·²ç»‘å®šè¯æœ¯å¤±è´¥:', error);
                        currentRoomBoundSpeechIds.value = [];
                    }
                };

                // åˆ¤æ–­è¯æœ¯æ˜¯å¦å·²ç»‘å®šåˆ°å½“å‰ç›´æ’­é—´
                const isSpeechBoundToCurrentRoom = (speech) => {
                    return currentRoomBoundSpeechIds.value.includes(speech.id);
                };

                // åˆ¤æ–­è¯æœ¯æ˜¯å¦å¯é€‰æ‹©ï¼ˆæœªç»‘å®šçš„å¯é€‰æ‹©ï¼‰
                const isSpeechSelectable = (row) => {
                    return !isSpeechBoundToCurrentRoom(row);
                };

                // è·å–è¯æœ¯è¡Œçš„æ ·å¼ç±»å
                const getSpeechRowClassName = ({ row }) => {
                    return isSpeechBoundToCurrentRoom(row) ? 'speech-bound-row' : '';
                };

                // ==================== ç›´æ’­æ—¶é—´ç®¡ç† ====================

                // ç®¡ç†ç›´æ’­æ—¶é—´
                const manageLiveTime = async (room) => {
                    try {
                        currentManageRoom.value = room;
                        await loadRoomLiveTimes(room.id);
                        liveTimeDialogVisible.value = true;
                    } catch (error) {
                        console.error('åŠ è½½ç›´æ’­æ—¶é—´å¤±è´¥:', error);
                        ElMessage.error('åŠ è½½ç›´æ’­æ—¶é—´å¤±è´¥');
                    }
                };

                // åŠ è½½ç›´æ’­é—´çš„ç›´æ’­æ—¶é—´
                const loadRoomLiveTimes = async (roomId) => {
                    try {
                        const api = await waitForApi();
                        const result = await api.get_room_live_times(roomId);

                        if (result && result.success) {
                            roomLiveTimes.value = result.data || [];
                        } else {
                            roomLiveTimes.value = [];
                            ElMessage.error(result?.message || 'è·å–ç›´æ’­æ—¶é—´å¤±è´¥');
                        }
                    } catch (error) {
                        console.error('åŠ è½½ç›´æ’­æ—¶é—´å¤±è´¥:', error);
                        roomLiveTimes.value = [];
                        ElMessage.error('åŠ è½½ç›´æ’­æ—¶é—´å¤±è´¥');
                    }
                };

                // æ˜¾ç¤ºæ·»åŠ ç›´æ’­æ—¶é—´å¯¹è¯æ¡†
                const showAddLiveTimeDialog = () => {
                    // æ£€æŸ¥å½“å‰ç›´æ’­é—´æ˜¯å¦å·²æœ‰å¾…å¼€æ’­è®°å½•
                    const pendingLiveTimes = roomLiveTimes.value.filter(item => item.status === 0);

                    if (pendingLiveTimes.length > 0) {
                        const roomName = currentManageRoom.value?.name || 'å½“å‰ç›´æ’­é—´';
                        const pendingTime = pendingLiveTimes[0].live_time;

                        ElMessageBox.alert(
                            `${roomName} å·²ç»å­˜åœ¨å¾…å¼€æ’­æ—¶é—´ï¼š${pendingTime}ï¼Œè¯·å…ˆå¤„ç†ç°æœ‰çš„ç›´æ’­æ—¶é—´å®‰æ’ã€‚`,
                            'æç¤º',
                            {
                                confirmButtonText: 'çŸ¥é“äº†',
                                type: 'warning'
                            }
                        );
                        return;
                    }

                    liveTimeForm.value = {
                        live_time: '',
                        remark: ''
                    };
                    addLiveTimeDialogVisible.value = true;
                };

                // ä¿å­˜ç›´æ’­æ—¶é—´
                const saveLiveTime = async () => {
                    if (!liveTimeFormRef.value) {
                        ElMessage.error('è¡¨å•å¼•ç”¨é”™è¯¯');
                        return;
                    }

                    try {
                        await liveTimeFormRef.value.validate();

                        // ğŸ”¥ æ–°å¢ï¼šæ£€æŸ¥å½“å‰ç›´æ’­é—´æ˜¯å¦ç»‘å®šäº†å•†å“
                        if (!currentManageRoom.value.product_id) {
                            try {
                                await ElMessageBox.confirm(
                                    `å½“å‰ç›´æ’­é—´"${currentManageRoom.value.name}"æ²¡æœ‰ç»‘å®šå•†å“ï¼Œå°†æ— æ³•è¿›è¡Œå›¾åƒè¯†åˆ«å’Œè‡ªåŠ¨è·Ÿæ’­ã€‚\n\nç¡®å®šå®‰æ’ç›´æ’­æ—¶é—´å—ï¼Ÿ`,
                                    'å•†å“ç»‘å®šæ£€æŸ¥',
                                    {
                                        confirmButtonText: 'ç¡®å®šå®‰æ’',
                                        cancelButtonText: 'å–æ¶ˆ',
                                        type: 'warning'
                                    }
                                );
                            } catch (error) {
                                if (error === 'cancel') {
                                    return; // ç”¨æˆ·é€‰æ‹©å–æ¶ˆ
                                }
                                throw error;
                            }
                        }

                        // æ£€æŸ¥æ—¶é—´æ˜¯å¦åœ¨30åˆ†é’Ÿå†…
                        const selectedTime = new Date(liveTimeForm.value.live_time);
                        const now = new Date();
                        const timeDiff = selectedTime.getTime() - now.getTime();
                        const minutesDiff = Math.floor(timeDiff / (1000 * 60));

                        if (minutesDiff < 30) {
                            try {
                                await ElMessageBox.confirm(
                                    `ä¸‹æ¬¡å¼€æ’­æ—¶é—´è·ç¦»å½“å‰ä¸åˆ°30åˆ†é’Ÿï¼ˆ${minutesDiff}åˆ†é’Ÿï¼‰ï¼Œç¡®è®¤æ·»åŠ å—ï¼Ÿ`,
                                    'æ—¶é—´æé†’',
                                    {
                                        confirmButtonText: 'ç¡®è®¤æ·»åŠ ',
                                        cancelButtonText: 'é‡æ–°é€‰æ‹©',
                                        type: 'warning'
                                    }
                                );
                            } catch (error) {
                                if (error === 'cancel') {
                                    return; // ç”¨æˆ·é€‰æ‹©é‡æ–°é€‰æ‹©æ—¶é—´
                                }
                                throw error;
                            }
                        }

                        saving.value = true;

                        const api = await waitForApi();
                        const result = await api.add_live_time(
                            currentManageRoom.value.id,
                            liveTimeForm.value.live_time,
                            liveTimeForm.value.remark
                        );

                        if (result && result.success) {
                            ElMessage.success(result.message || 'æ·»åŠ ç›´æ’­æ—¶é—´æˆåŠŸ');
                            addLiveTimeDialogVisible.value = false;
                            await loadRoomLiveTimes(currentManageRoom.value.id);
                            await loadWechatRooms(); // åˆ·æ–°ä¸»è¡¨æ ¼
                        } else {
                            ElMessage.error(result?.message || 'æ·»åŠ ç›´æ’­æ—¶é—´å¤±è´¥');
                        }

                    } catch (error) {
                        console.error('ä¿å­˜ç›´æ’­æ—¶é—´å¤±è´¥:', error);
                        ElMessage.error(error.message || 'ä¿å­˜ç›´æ’­æ—¶é—´å¤±è´¥');
                    } finally {
                        saving.value = false;
                    }
                };

                // æ ‡è®°ä¸ºè¿‡æœŸ
                const markAsExpired = async (liveTime) => {
                    try {
                        await ElMessageBox.confirm(
                            `ç¡®å®šè¦æ ‡è®°"${liveTime.live_time}"ä¸ºè¿‡æœŸå—ï¼Ÿ`,
                            'ç¡®è®¤æ ‡è®°',
                            {
                                confirmButtonText: 'ç¡®å®š',
                                cancelButtonText: 'å–æ¶ˆ',
                                type: 'warning'
                            }
                        );

                        const api = await waitForApi();
                        const result = await api.update_live_time_status(liveTime.id, 1);

                        if (result && result.success) {
                            // æ ‡è®°æˆåŠŸåï¼Œåˆ é™¤å¯¹åº”çš„è‡ªåŠ¨åŒ–ä»»åŠ¡
                            try {
                                const taskResult = await api.remove_task_by_live_time(liveTime.room_id, liveTime.live_time);
                                if (taskResult && taskResult.success) {
                                    console.log('è‡ªåŠ¨åŒ–ä»»åŠ¡å·²åˆ é™¤:', taskResult.message);
                                } else {
                                    console.warn('åˆ é™¤è‡ªåŠ¨åŒ–ä»»åŠ¡å¤±è´¥:', taskResult?.message);
                                }
                            } catch (taskError) {
                                console.warn('åˆ é™¤è‡ªåŠ¨åŒ–ä»»åŠ¡æ—¶å‡ºé”™:', taskError);
                            }

                            ElMessage.success('æ ‡è®°æˆåŠŸ');
                            await loadRoomLiveTimes(currentManageRoom.value.id);
                            await loadWechatRooms(); // åˆ·æ–°ä¸»è¡¨æ ¼
                        } else {
                            ElMessage.error(result?.message || 'æ ‡è®°å¤±è´¥');
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('æ ‡è®°å¤±è´¥:', error);
                            ElMessage.error('æ ‡è®°å¤±è´¥');
                        }
                    }
                };

                // åˆ é™¤ç›´æ’­æ—¶é—´
                const deleteLiveTime = async (liveTime) => {
                    try {
                        await ElMessageBox.confirm(
                            `ç¡®å®šè¦åˆ é™¤"${liveTime.live_time}"è¿™ä¸ªç›´æ’­æ—¶é—´å—ï¼Ÿ`,
                            'ç¡®è®¤åˆ é™¤',
                            {
                                confirmButtonText: 'ç¡®å®š',
                                cancelButtonText: 'å–æ¶ˆ',
                                type: 'warning'
                            }
                        );

                        const api = await waitForApi();

                        // å…ˆåˆ é™¤å¯¹åº”çš„è‡ªåŠ¨åŒ–ä»»åŠ¡
                        try {
                            const taskResult = await api.remove_task_by_live_time(liveTime.room_id, liveTime.live_time);
                            if (taskResult && taskResult.success) {
                                console.log('è‡ªåŠ¨åŒ–ä»»åŠ¡å·²åˆ é™¤:', taskResult.message);
                            } else {
                                console.warn('åˆ é™¤è‡ªåŠ¨åŒ–ä»»åŠ¡å¤±è´¥:', taskResult?.message);
                            }
                        } catch (taskError) {
                            console.warn('åˆ é™¤è‡ªåŠ¨åŒ–ä»»åŠ¡æ—¶å‡ºé”™:', taskError);
                        }

                        // åˆ é™¤ç›´æ’­æ—¶é—´è®°å½•
                        const result = await api.delete_live_time(liveTime.id);

                        if (result && result.success) {
                            ElMessage.success('åˆ é™¤æˆåŠŸ');
                            await loadRoomLiveTimes(currentManageRoom.value.id);
                            await loadWechatRooms(); // åˆ·æ–°ä¸»è¡¨æ ¼
                        } else {
                            ElMessage.error(result?.message || 'åˆ é™¤å¤±è´¥');
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('åˆ é™¤å¤±è´¥:', error);
                            ElMessage.error('åˆ é™¤å¤±è´¥');
                        }
                    }
                };

                // åŠ è½½æ‰€æœ‰è¯æœ¯
                const loadAllSpeech = async () => {
                    try {
                        const api = await waitForApi();
                        const result = await api.get_speech_list();

                        if (result && result.success) {
                            allSpeech.value = result.data || [];
                        } else {
                            ElMessage.error(result?.message || 'è·å–è¯æœ¯å¤±è´¥');
                        }
                    } catch (error) {
                        console.error('è·å–è¯æœ¯å¤±è´¥:', error);
                        ElMessage.error('è·å–è¯æœ¯å¤±è´¥');
                    }
                };

                // å¤„ç†è¯æœ¯é€‰æ‹©
                const handleSpeechSelection = (selection) => {
                    selectedSpeechList.value = selection;
                };

                // ç¡®è®¤ç»‘å®šè¯æœ¯
                const confirmBindSpeech = async () => {
                    if (selectedSpeechList.value.length === 0) {
                        ElMessage.warning('è¯·é€‰æ‹©è¦ç»‘å®šçš„è¯æœ¯');
                        return;
                    }

                    binding.value = true;
                    try {
                        const api = await waitForApi();
                        let successCount = 0;

                        for (const speech of selectedSpeechList.value) {
                            // ä½¿ç”¨æ–°çš„ç»‘å®šAPIè€Œä¸æ˜¯æ›´æ–°è¯æœ¯
                            const result = await api.bind_speech_to_room(
                                currentViewRoom.value.id,
                                speech.id,
                                speech.status
                            );
                            if (result && result.success) {
                                successCount++;
                            }
                        }

                        if (successCount > 0) {
                            ElMessage.success(`æˆåŠŸç»‘å®š ${successCount} æ¡è¯æœ¯`);
                            speechBindDialogVisible.value = false;
                            selectedSpeechList.value = [];
                            // åˆ·æ–°ä¸»è¡¨æ ¼æ•°æ®
                            await loadAllRoomSpeeches();
                            // å¦‚æœæŸ¥çœ‹è¯æœ¯å¼¹çª—æ˜¯æ‰“å¼€çš„ï¼Œä¹Ÿè¦åˆ·æ–°å¼¹çª—æ•°æ®
                            if (speechViewDialogVisible.value && currentViewRoom.value) {
                                await viewBoundSpeech(currentViewRoom.value);
                            }
                        } else {
                            ElMessage.error('ç»‘å®šå¤±è´¥');
                        }
                    } catch (error) {
                        console.error('ç»‘å®šè¯æœ¯å¤±è´¥:', error);
                        ElMessage.error('ç»‘å®šè¯æœ¯å¤±è´¥');
                    } finally {
                        binding.value = false;
                    }
                };

                // åˆ é™¤ç›´æ’­é—´
                const deleteRoom = async (room) => {
                    try {
                        await ElMessageBox.confirm(
                            `ç¡®å®šè¦åˆ é™¤ç›´æ’­é—´"${room.name}"å—ï¼Ÿåˆ é™¤åå°†åŒæ—¶åˆ é™¤ç»‘å®šçš„è¯æœ¯ã€‚`,
                            'ç¡®è®¤åˆ é™¤',
                            {
                                confirmButtonText: 'ç¡®å®š',
                                cancelButtonText: 'å–æ¶ˆ',
                                type: 'warning',
                            }
                        );

                        const api = await waitForApi();
                        const result = await api.delete_room(room.id);

                        if (result && result.success) {
                            ElMessage.success('åˆ é™¤æˆåŠŸ');
                            loadWechatRooms();
                        } else {
                            ElMessage.error(result?.message || 'åˆ é™¤å¤±è´¥');
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('åˆ é™¤ç›´æ’­é—´å¤±è´¥:', error);
                            ElMessage.error('åˆ é™¤å¤±è´¥');
                        }
                    }
                };

                const saveRoom = async () => {
                    if (!roomFormRef.value) {
                        ElMessage.error('è¡¨å•å¼•ç”¨é”™è¯¯');
                        return;
                    }

                    try {
                        await roomFormRef.value.validate();
                        saving.value = true;

                        const api = await waitForApi();
                        let result;

                        if (isEditRoom.value) {
                            result = await api.update_room(
                                roomForm.value.id,
                                roomForm.value.name,
                                'wechat',
                                roomForm.value.status,
                                roomForm.value.product_id
                            );
                        } else {
                            result = await api.add_room(
                                roomForm.value.name,
                                'wechat',
                                roomForm.value.status,
                                roomForm.value.product_id
                            );
                        }

                        if (result && result.success) {
                            ElMessage.success(result.message);
                            roomDialogVisible.value = false;
                            await loadWechatRooms(); // é‡æ–°åŠ è½½æ•°æ®
                            console.log(`${isEditRoom.value ? 'æ›´æ–°' : 'æ·»åŠ '}ç›´æ’­é—´: ${roomForm.value.name}`);
                        } else {
                            ElMessage.error(result?.message || 'æ“ä½œå¤±è´¥');
                        }

                    } catch (error) {
                        console.error('ä¿å­˜å¤±è´¥:', error);
                        ElMessage.error('ä¿å­˜å¤±è´¥');
                    } finally {
                        saving.value = false;
                    }
                };

                // ä¸‹æ‹‰èœå•å‘½ä»¤å¤„ç†
                const handleDropdownCommand = (command) => {
                    const { action, room } = command;
                    switch (action) {
                        case 'viewSpeech':
                            viewBoundSpeech(room);
                            break;
                        case 'bindProduct':
                            bindProduct(room);
                            break;
                        case 'deleteRoom':
                            deleteRoom(room);
                            break;
                    }
                };

                // å›¾ç‰‡å¤„ç†å‡½æ•°
                const productCoverUrlCache = new Map();

                const getProductCoverUrl = async (coverPath) => {
                    if (!coverPath) return '';

                    // å¦‚æœæ˜¯ç½‘ç»œå›¾ç‰‡ï¼Œç›´æ¥è¿”å›
                    if (coverPath.startsWith('http://') || coverPath.startsWith('https://')) {
                        return coverPath;
                    }

                    // æ£€æŸ¥ç¼“å­˜
                    if (productCoverUrlCache.has(coverPath)) {
                        return productCoverUrlCache.get(coverPath);
                    }

                    // é€šè¿‡APIè·å–æ–‡ä»¶Blob
                    const api = await waitForApi();
                    if (!api) return '';

                    try {
                        const result = await api.get_image_blob(coverPath);
                        if (result.success && result.blob_data) {
                            // å°†base64è½¬æ¢ä¸ºBlob
                            const byteCharacters = atob(result.blob_data);
                            const byteNumbers = new Array(byteCharacters.length);
                            for (let i = 0; i < byteCharacters.length; i++) {
                                byteNumbers[i] = byteCharacters.charCodeAt(i);
                            }
                            const byteArray = new Uint8Array(byteNumbers);
                            const blob = new Blob([byteArray], { type: result.mime_type || 'image/jpeg' });

                            // åˆ›å»ºObject URL
                            const objectUrl = URL.createObjectURL(blob);
                            productCoverUrlCache.set(coverPath, objectUrl);
                            return objectUrl;
                        }
                    } catch (error) {
                        console.error('è·å–å•†å“å°é¢å¤±è´¥:', error);
                    }

                    return '';
                };

                const handleImageError = (event) => {
                    // å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶çš„å¤„ç†
                    event.target.style.display = 'none';
                    const parent = event.target.parentElement;
                    if (parent) {
                        parent.innerHTML = '<div style="width: 100%; height: 100%; background: #f3f4f6; display: flex; align-items: center; justify-content: center;"><i class="el-icon-picture" style="font-size: 16px; color: #9ca3af;"></i></div>';
                    }
                };

                // å•†å“é€‰æ‹©å˜åŒ–å¤„ç†
                const onProductSelectionChange = (value) => {
                    console.log('å•†å“é€‰æ‹©å˜åŒ–:', value);
                    // è¿™é‡Œå¯ä»¥æ·»åŠ é¢å¤–çš„é€»è¾‘ï¼Œæ¯”å¦‚é¢„è§ˆå•†å“ä¿¡æ¯ç­‰
                };

                // å•†å“ç»‘å®šç›¸å…³å‡½æ•°
                const loadProductOptions = async () => {
                    try {
                        const api = await waitForApi();
                        const result = await api.get_products_for_room_binding();

                        if (result && result.success) {
                            productOptions.value = result.data || [];
                            console.log('âœ… å•†å“é€‰é¡¹åŠ è½½æˆåŠŸ:', productOptions.value.length);

                            // å¼‚æ­¥åŠ è½½å•†å“å°é¢
                            loadProductOptionCovers();
                        } else {
                            console.error('âŒ å•†å“é€‰é¡¹åŠ è½½å¤±è´¥:', result?.message);
                            ElMessage.error(result?.message || 'åŠ è½½å•†å“é€‰é¡¹å¤±è´¥');
                        }
                    } catch (error) {
                        console.error('åŠ è½½å•†å“é€‰é¡¹å¤±è´¥:', error);
                        ElMessage.error('åŠ è½½å•†å“é€‰é¡¹å¤±è´¥');
                    }
                };

                // åŠ è½½å•†å“é€‰é¡¹çš„å°é¢å›¾ç‰‡
                const loadProductOptionCovers = async () => {
                    for (const product of productOptions.value) {
                        if (product.cover && !product.coverObjectUrl) {
                            try {
                                const objectUrl = await getProductCoverUrl(product.cover);
                                if (objectUrl) {
                                    product.coverObjectUrl = objectUrl;
                                }
                            } catch (error) {
                                console.error('åŠ è½½å•†å“é€‰é¡¹å°é¢å¤±è´¥:', error);
                            }
                        }
                    }
                };

                const bindProduct = async (room) => {
                    currentBindRoom.value = room;
                    productBindForm.value.product_id = room.product_id;

                    // å¦‚æœæœ‰ç»‘å®šå•†å“ï¼ŒåŠ è½½è¯¥å•†å“ç»‘å®šçš„å›¾ç‰‡
                    if (room.product_id) {
                        try {
                            const api = await waitForApi();
                            // æŸ¥è¯¢è¯¥å•†å“ç»‘å®šçš„å›¾ç‰‡åˆ—è¡¨
                            const result = await api.query_images_api({
                                page: 1,
                                page_size: 50,
                                product_id: room.product_id,
                                status: 1
                            });
                            if (result && result.success) {
                                currentBindRoom.value.boundImages = result.data || [];
                                console.log(`âœ… åŠ è½½å•†å“ç»‘å®šå›¾ç‰‡æˆåŠŸ: ${currentBindRoom.value.boundImages.length} å¼ `);
                                // å¼‚æ­¥åŠ è½½å›¾ç‰‡URL
                                loadBoundImages();
                            } else {
                                console.log('è¯¥å•†å“æš‚æ— ç»‘å®šå›¾ç‰‡');
                                currentBindRoom.value.boundImages = [];
                            }
                        } catch (error) {
                            console.error('åŠ è½½å•†å“ç»‘å®šå›¾ç‰‡å¤±è´¥:', error);
                            currentBindRoom.value.boundImages = [];
                        }
                    } else {
                        currentBindRoom.value.boundImages = [];
                    }

                    productBindDialogVisible.value = true;
                };

                // åŠ è½½ç»‘å®šå›¾ç‰‡çš„URL
                const loadBoundImages = async () => {
                    if (!currentBindRoom.value.boundImages) return;

                    for (const image of currentBindRoom.value.boundImages) {
                        if (image.path && !image.objectUrl) {
                            try {
                                const objectUrl = await getProductCoverUrl(image.path);
                                if (objectUrl) {
                                    image.objectUrl = objectUrl;
                                }
                            } catch (error) {
                                console.error('åŠ è½½ç»‘å®šå›¾ç‰‡URLå¤±è´¥:', error);
                            }
                        }
                    }
                };

                const saveProductBinding = async () => {
                    try {
                        binding.value = true;
                        const api = await waitForApi();

                        // æ­£ç¡®å¤„ç†è§£ç»‘æ“ä½œï¼šç©ºé€‰æ‹©æˆ–é€‰æ‹©å½“å‰å•†å“éƒ½æ˜¯è§£ç»‘
                        let productId = productBindForm.value.product_id;

                        // å¦‚æœé€‰æ‹©çš„æ˜¯å½“å‰ç»‘å®šçš„å•†å“ï¼Œåˆ™æ‰§è¡Œè§£ç»‘æ“ä½œ
                        if (productId === currentBindRoom.value?.product_id) {
                            productId = null;
                        }

                        // ç¡®ä¿è§£é™¤ç»‘å®šæ—¶ä¼ é€’ null
                        if (!productId) {
                            productId = null;
                        }

                        console.log('ğŸ”„ æ‰§è¡Œå•†å“ç»‘å®šæ“ä½œ:', {
                            roomId: currentBindRoom.value.id,
                            originalProductId: productBindForm.value.product_id,
                            finalProductId: productId,
                            currentBoundProductId: currentBindRoom.value?.product_id,
                            operation: productId ? 'ç»‘å®š/æ›´æ¢' : 'è§£é™¤ç»‘å®š'
                        });

                        const result = await api.update_room(
                            currentBindRoom.value.id,
                            null, // name
                            null, // platform
                            null, // status
                            productId  // æ˜ç¡®ä¼ é€’ null æ¥è§£é™¤ç»‘å®š
                        );

                        if (result && result.success) {
                            const operation = productId ? 'å•†å“ç»‘å®šæˆåŠŸ' : 'å•†å“è§£ç»‘æˆåŠŸ';
                            ElMessage.success(operation);
                            productBindDialogVisible.value = false;

                            // é‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®ï¼Œç¡®ä¿ç•Œé¢åŒæ­¥
                            console.log('ğŸ”„ é‡æ–°åŠ è½½æ•°æ®...');
                            await loadWechatRooms();
                            await loadProductOptions();

                            console.log(`${productId ? 'ç»‘å®š' : 'è§£ç»‘'}å•†å“: ${currentBindRoom.value.name}`);
                        } else {
                            console.error('âŒ å•†å“ç»‘å®šæ“ä½œå¤±è´¥:', result);
                            ElMessage.error(result?.message || 'æ“ä½œå¤±è´¥');
                        }
                    } catch (error) {
                        console.error('å•†å“ç»‘å®šæ“ä½œå¤±è´¥:', error);
                        ElMessage.error('æ“ä½œå¤±è´¥');
                    } finally {
                        binding.value = false;
                    }
                };

                // å°è£…å›¾ç‰‡URLåˆ·æ–°å‡½æ•°
                const refreshImageUrl = async (imagePath) => {
                    if (!imagePath) return null;
                    try {
                        // æ¸…é™¤ç¼“å­˜
                        if (productCoverUrlCache.has(imagePath)) {
                            const oldUrl = productCoverUrlCache.get(imagePath);
                            if (oldUrl && oldUrl.startsWith('blob:')) {
                                URL.revokeObjectURL(oldUrl);
                            }
                            productCoverUrlCache.delete(imagePath);
                        }
                        // é‡æ–°è·å–URL
                        const newUrl = await getProductCoverUrl(imagePath);
                        console.log(`ğŸ”„ åˆ·æ–°å›¾ç‰‡URL: ${imagePath} -> ${newUrl ? 'æˆåŠŸ' : 'å¤±è´¥'}`);
                        return newUrl;
                    } catch (error) {
                        console.error('åˆ·æ–°å›¾ç‰‡URLå¤±è´¥:', error);
                        return null;
                    }
                };

                // å®æ—¶æ›´æ–°ç›´æ’­é—´å•†å“ä¿¡æ¯
                const updateRoomProductInfo = async (roomId, productId) => {
                    try {
                        // æ‰¾åˆ°å¯¹åº”çš„ç›´æ’­é—´
                        const room = wechatRooms.value.find(r => r.id === roomId);
                        if (!room) return;

                        if (productId) {
                            // ç»‘å®šå•†å“ï¼šä»å•†å“é€‰é¡¹ä¸­æ‰¾åˆ°å•†å“ä¿¡æ¯
                            const product = productOptions.value.find(p => p.id === productId);
                            if (product) {
                                room.product_id = productId;
                                room.product_name = product.name;
                                room.product_price = product.price;
                                room.product_cover = product.cover;

                                // é‡æ–°åŠ è½½å•†å“å°é¢URLï¼Œç¡®ä¿æ˜¾ç¤ºæœ€æ–°å›¾ç‰‡
                                if (product.cover) {
                                    room.productCoverObjectUrl = await refreshImageUrl(product.cover);
                                } else {
                                    room.productCoverObjectUrl = null;
                                }

                                console.log(`âœ… å®æ—¶æ›´æ–°å•†å“ç»‘å®š: ${room.name} -> ${product.name}`);
                            }
                        } else {
                            // è§£ç»‘å•†å“ï¼šæ¸…ç©ºå•†å“ä¿¡æ¯
                            room.product_id = null;
                            room.product_name = null;
                            room.product_price = null;
                            room.product_cover = null;
                            room.productCoverObjectUrl = null;

                            console.log(`âœ… å®æ—¶è§£ç»‘å•†å“: ${room.name}`);
                        }
                    } catch (error) {
                        console.error('æ›´æ–°ç›´æ’­é—´å•†å“ä¿¡æ¯å¤±è´¥:', error);
                    }
                };

                // æ‰¹é‡å•†å“ç»‘å®šåŠŸèƒ½
                const batchBindProduct = () => {
                    if (selectedRooms.value.length === 0) {
                        ElMessage.warning('è¯·å…ˆé€‰æ‹©è¦ç»‘å®šå•†å“çš„ç›´æ’­é—´');
                        return;
                    }

                    batchBindForm.value.product_id = null;
                    batchBindDialogVisible.value = true;
                };

                const saveBatchBinding = async () => {
                    try {
                        batchBinding.value = true;
                        const api = await waitForApi();

                        // ç¡®ä¿è§£ç»‘æ—¶ä¼ é€’ null
                        const productId = batchBindForm.value.product_id || null;

                        console.log('ğŸ”„ æ‰§è¡Œæ‰¹é‡å•†å“ç»‘å®šæ“ä½œ:', {
                            selectedRoomsCount: selectedRooms.value.length,
                            productId: productId,
                            operation: productId ? 'æ‰¹é‡ç»‘å®š' : 'æ‰¹é‡è§£ç»‘'
                        });

                        let successCount = 0;
                        let failCount = 0;

                        for (const room of selectedRooms.value) {
                            try {
                                const result = await api.update_room(
                                    room.id,
                                    null, // name
                                    null, // platform
                                    null, // status
                                    productId  // æ˜ç¡®ä¼ é€’ null æ¥è§£é™¤ç»‘å®š
                                );

                                if (result && result.success) {
                                    successCount++;
                                    // å®æ—¶æ›´æ–°ç›´æ’­é—´å•†å“ä¿¡æ¯
                                    await updateRoomProductInfo(room.id, productId);
                                } else {
                                    failCount++;
                                }
                            } catch (error) {
                                failCount++;
                                console.error(`æ‰¹é‡ç»‘å®šå¤±è´¥ - ${room.name}:`, error);
                            }
                        }

                        if (successCount > 0) {
                            ElMessage.success(`æ‰¹é‡æ“ä½œå®Œæˆï¼šæˆåŠŸ ${successCount} ä¸ª${failCount > 0 ? `ï¼Œå¤±è´¥ ${failCount} ä¸ª` : ''}`);
                            console.log(`æ‰¹é‡${batchBindForm.value.product_id ? 'ç»‘å®š' : 'è§£ç»‘'}å•†å“ï¼šæˆåŠŸ ${successCount} ä¸ª`);

                            // é‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®ï¼Œç¡®ä¿ç•Œé¢åŒæ­¥
                            console.log('ğŸ”„ æ‰¹é‡æ“ä½œåé‡æ–°åŠ è½½æ•°æ®...');
                            await loadWechatRooms();
                            await loadProductOptions();
                        }

                        if (failCount > 0 && successCount === 0) {
                            ElMessage.error(`æ‰¹é‡æ“ä½œå¤±è´¥ï¼š${failCount} ä¸ªç›´æ’­é—´æ“ä½œå¤±è´¥`);
                        }

                        batchBindDialogVisible.value = false;
                        clearSelection(); // æ¸…ç©ºé€‰æ‹©

                    } catch (error) {
                        console.error('æ‰¹é‡å•†å“ç»‘å®šå¤±è´¥:', error);
                        ElMessage.error('æ‰¹é‡æ“ä½œå¤±è´¥');
                    } finally {
                        batchBinding.value = false;
                    }
                };

                // å…¶ä»–åŠŸèƒ½
                const goToSpeechManage = () => {
                    // è¿™é‡Œå¯ä»¥è·³è½¬åˆ°è¯æœ¯ç®¡ç†é¡µé¢
                    ElMessage.info('è¯·åœ¨è¯æœ¯ç®¡ç†é¡µé¢æ·»åŠ è¯æœ¯å¹¶ç»‘å®šåˆ°æ­¤ç›´æ’­é—´');
                };



                // å½“å‰æ—¶é—´ï¼Œæ¯ç§’æ›´æ–°
                const currentTime = ref(Date.now());
                // è®°å½•å·²é€šçŸ¥çš„ç›´æ’­é—´ï¼Œé¿å…é‡å¤é€šçŸ¥
                const notifiedRooms = ref(new Set());

                // å¯åŠ¨æ—¶é—´æ›´æ–°å™¨ï¼ˆä»…ç”¨äºæ˜¾ç¤ºå€’è®¡æ—¶ï¼Œä¸å†å¤„ç†é€šçŸ¥ï¼‰
                const startTimeUpdater = () => {
                    setInterval(() => {
                        currentTime.value = Date.now();
                    }, 1000);
                };

                // è®¡ç®—å±æ€§ï¼šæˆ¿é—´å€’è®¡æ—¶ä¿¡æ¯
                const roomCountdowns = computed(() => {
                    const now = currentTime.value;
                    const result = {};

                    wechatRooms.value.forEach(room => {
                        if (room.next_live_time) {
                            const liveTime = new Date(room.next_live_time);
                            const diff = liveTime.getTime() - now;

                            if (diff <= 0) {
                                // ğŸ”¥ ä¿®å¤ï¼šä½¿ç”¨å…¨å±€æ ‡è®°é¿å…é‡å¤è°ƒç”¨
                                const markKey = `${room.id}_${room.next_live_time}`;
                                if (!window.autoMarkedTasks) {
                                    window.autoMarkedTasks = new Set();
                                }

                                if (!window.autoMarkedTasks.has(markKey)) {
                                    window.autoMarkedTasks.add(markKey);
                                    console.log(`ğŸ”„ æ ‡è®°è¿‡æœŸä»»åŠ¡: ${markKey}`);
                                    // å¼‚æ­¥è°ƒç”¨åç«¯APIæ ‡è®°è¿‡æœŸ
                                    nextTick(() => {
                                        autoMarkLiveTimeExpired(room.id, room.next_live_time);
                                    });
                                }

                                result[room.id] = {
                                    text: 'å·²å¼€æ’­',
                                    style: {
                                        color: '#059669',
                                        fontWeight: '600',
                                        background: '#d1fae5',
                                        padding: '2px 6px',
                                        borderRadius: '4px',
                                        fontSize: '11px',
                                        border: '1px solid #a7f3d0'
                                    }
                                };
                            } else {
                                // è®¡ç®—æ€»å°æ—¶æ•°ï¼ˆåŒ…å«å¤©æ•°è½¬æ¢ä¸ºå°æ—¶ï¼‰
                                const totalHours = Math.floor(diff / (1000 * 60 * 60));
                                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                                const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                                let text = '';
                                if (totalHours > 0) {
                                    text = `å€’è®¡æ—¶ ${String(totalHours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                                } else if (minutes > 0) {
                                    text = `å€’è®¡æ—¶ ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                                } else {
                                    text = `å€’è®¡æ—¶ ${String(seconds).padStart(2, '0')}ç§’`;
                                }

                                const hoursFloat = diff / (1000 * 60 * 60);
                                const minutesFloat = diff / (1000 * 60);

                                let style = {};
                                if (minutesFloat <= 30) {
                                    // ç´§æ€¥çŠ¶æ€ - çº¢è‰²
                                    style = {
                                        color: '#ff3366',
                                        fontWeight: '600',
                                        background: 'rgba(255,51,102,0.1)',
                                        border: '1px solid rgba(255,51,102,0.3)',
                                        padding: '2px 6px',
                                        borderRadius: '4px',
                                        fontSize: '11px'
                                    };
                                } else if (hoursFloat <= 1) {
                                    // è­¦å‘ŠçŠ¶æ€ - æ©™è‰²
                                    style = {
                                        color: '#ff8c00',
                                        fontWeight: '600',
                                        background: 'rgba(255,140,0,0.1)',
                                        border: '1px solid rgba(255,140,0,0.3)',
                                        padding: '2px 6px',
                                        borderRadius: '4px',
                                        fontSize: '11px'
                                    };
                                } else if (hoursFloat <= 24) {
                                    // æ­£å¸¸çŠ¶æ€ - è“è‰²
                                    style = {
                                        color: '#00d4ff',
                                        fontWeight: '500',
                                        background: 'rgba(0,212,255,0.1)',
                                        border: '1px solid rgba(0,212,255,0.3)',
                                        padding: '2px 6px',
                                        borderRadius: '4px',
                                        fontSize: '11px'
                                    };
                                } else {
                                    // è¿œæœŸçŠ¶æ€ - ç´«è‰²
                                    style = {
                                        color: '#8b5cf6',
                                        fontWeight: '500',
                                        background: 'rgba(139,92,246,0.1)',
                                        border: '1px solid rgba(139,92,246,0.3)',
                                        padding: '2px 6px',
                                        borderRadius: '4px',
                                        fontSize: '11px'
                                    };
                                }

                                result[room.id] = { text, style };
                            }
                        }
                    });

                    return result;
                });



                // ===== é…ç½®ç®¡ç†ç›¸å…³æ–¹æ³• =====

                // åŠ è½½ç³»ç»Ÿé…ç½®
                const loadSystemConfig = async () => {
                    try {
                        configLoading.value = true;
                        const api = await waitForApi();
                        const result = await api.get_system_config();

                        if (result.success) {
                            const config = result.config;

                            // æ›´æ–°ç³»ç»Ÿé…ç½®
                            if (config.system_config) {
                                // æ·±åº¦åˆå¹¶æ–°çš„é…ç½®ç»“æ„
                                if (config.system_config.intervals) {
                                    Object.assign(systemConfig.value.intervals, config.system_config.intervals);
                                }
                                if (config.system_config.retry_config) {
                                    Object.assign(systemConfig.value.retry_config, config.system_config.retry_config);
                                }
                                if (config.system_config.features) {
                                    Object.assign(systemConfig.value.features, config.system_config.features);
                                }
                                if (config.system_config.quality) {
                                    Object.assign(systemConfig.value.quality, config.system_config.quality);
                                }

                                // å…¼å®¹æ—§é…ç½®æ ¼å¼
                                if (config.system_config.bullet_screen_interval) {
                                    systemConfig.value.intervals.bullet_screen_send = config.system_config.bullet_screen_interval;
                                }
                                if (config.system_config.is_screenshot !== undefined) {
                                    systemConfig.value.features.enable_screenshot = config.system_config.is_screenshot;
                                }
                            }

                            // æ›´æ–°ç•Œé¢é…ç½®
                            if (config.ui_config) {
                                Object.assign(uiConfig.value, config.ui_config);
                            }

                            console.log('âœ… ç³»ç»Ÿé…ç½®åŠ è½½æˆåŠŸ');
                        } else {
                            console.warn('âš ï¸ é…ç½®åŠ è½½è¿”å›å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®:', result.message);
                        }
                    } catch (error) {
                        console.error('âŒ é…ç½®åŠ è½½å¼‚å¸¸:', error);
                        // ä¸æ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œé™é»˜ä½¿ç”¨é»˜è®¤é…ç½®
                    } finally {
                        configLoading.value = false;
                    }
                };

                // ä¿å­˜ç³»ç»Ÿé…ç½®
                const saveConfig = async () => {
                    try {
                        configSaving.value = true;

                        const api = await waitForApi();
                        const result = await api.update_system_config({
                            system_config: systemConfig.value,
                            ui_config: uiConfig.value
                        });

                        if (result.success) {
                            ElMessage.success('é…ç½®ä¿å­˜æˆåŠŸ');
                            configVisible.value = false;
                            configBadge.value = ''; // æ¸…é™¤é…ç½®æé†’
                        } else {
                            ElMessage.error(result.message || 'ä¿å­˜é…ç½®å¤±è´¥');
                        }
                    } catch (error) {
                        console.error('âŒ ä¿å­˜é…ç½®å¤±è´¥:', error);
                        ElMessage.error('ä¿å­˜é…ç½®å¤±è´¥');
                    } finally {
                        configSaving.value = false;
                    }
                };

                // é‡ç½®ç³»ç»Ÿé…ç½®
                const resetConfig = async () => {
                    try {
                        await ElMessageBox.confirm(
                            'ç¡®å®šè¦é‡ç½®æ‰€æœ‰é…ç½®ä¸ºé»˜è®¤å€¼å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚',
                            'é‡ç½®é…ç½®',
                            {
                                confirmButtonText: 'ç¡®å®š',
                                cancelButtonText: 'å–æ¶ˆ',
                                type: 'warning',
                            }
                        );

                        configSaving.value = true;
                        const api = await waitForApi();
                        const result = await api.reset_system_config();

                        if (result.success) {
                            ElMessage.success('é…ç½®é‡ç½®æˆåŠŸ');
                            await loadSystemConfig(); // é‡æ–°åŠ è½½é…ç½®
                        } else {
                            ElMessage.error(result.message || 'é‡ç½®é…ç½®å¤±è´¥');
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('âŒ é‡ç½®é…ç½®å¤±è´¥:', error);
                            ElMessage.error('é‡ç½®é…ç½®å¤±è´¥');
                        }
                    } finally {
                        configSaving.value = false;
                    }
                };

                // å¤„ç†æˆªå›¾åŠŸèƒ½å¼€å…³å˜åŒ–
                const handleScreenshotChange = (value) => {
                    const statusText = value ? 'å·²å¼€å¯' : 'å·²å…³é—­';
                    const actionText = value ? 'è‡ªåŠ¨æˆªå›¾ä¿å­˜è¯†åˆ«ç»“æœ' : 'ä¸è¿›è¡Œæˆªå›¾ä¿å­˜';
                    ElMessage.success(`æˆªå›¾åŠŸèƒ½${statusText}ï¼š${actionText}`);
                };

                // å¤„ç†ç³»ç»Ÿé€šçŸ¥å¼€å…³å˜åŒ–
                const handleNotificationsChange = (value) => {
                    const statusText = value ? 'å·²å¼€å¯' : 'å·²å…³é—­';
                    const actionText = value ? 'æ˜¾ç¤ºä»»åŠ¡æ‰§è¡Œé€šçŸ¥' : 'ä¸æ˜¾ç¤ºç³»ç»Ÿé€šçŸ¥';
                    ElMessage.success(`ç³»ç»Ÿé€šçŸ¥${statusText}ï¼š${actionText}`);
                };

                // å¤„ç†è¯¦ç»†æ—¥å¿—å¼€å…³å˜åŒ–
                const handleDetailedLogsChange = (value) => {
                    const statusText = value ? 'å·²å¼€å¯' : 'å·²å…³é—­';
                    const actionText = value ? 'è®°å½•è¯¦ç»†æ“ä½œä¿¡æ¯' : 'ä»…è®°å½•åŸºæœ¬æ—¥å¿—';
                    ElMessage.success(`è¯¦ç»†æ—¥å¿—${statusText}ï¼š${actionText}`);
                };

                // å¤„ç†çœŸå®å‘é€å¼¹å¹•å¼€å…³å˜åŒ–
                const handleRealDanmuSendChange = async (value) => {
                    try {
                        realDanmuSendLoading.value = true;
                        const api = await waitForApi();

                        const result = await api.toggle_real_danmu_send(value);

                        if (result && result.success) {
                            const modeText = value ? 'çœŸå®å‘é€(OCRç‚¹å‡»)' : 'æµ‹è¯•æ¨¡å¼(å›è½¦é”®)';
                            ElMessage.success(`å¼¹å¹•å‘é€æ¨¡å¼å·²åˆ‡æ¢ä¸º: ${modeText}`);
                        } else {
                            // å¦‚æœå¤±è´¥ï¼Œæ¢å¤å¼€å…³çŠ¶æ€
                            systemConfig.value.features.enable_real_danmu_send = !value;
                            ElMessage.error(result?.message || 'åˆ‡æ¢å¼¹å¹•å‘é€æ¨¡å¼å¤±è´¥');
                        }
                    } catch (error) {
                        console.error('åˆ‡æ¢å¼¹å¹•å‘é€æ¨¡å¼å¤±è´¥:', error);
                        // å¦‚æœå¤±è´¥ï¼Œæ¢å¤å¼€å…³çŠ¶æ€
                        systemConfig.value.features.enable_real_danmu_send = !value;
                        ElMessage.error('åˆ‡æ¢å¼¹å¹•å‘é€æ¨¡å¼å¤±è´¥');
                    } finally {
                        realDanmuSendLoading.value = false;
                    }
                };

                // ğŸ”¥ ä¿®å¤ï¼šè‡ªåŠ¨æ ‡è®°ç›´æ’­çŠ¶æ€ä¸ºå·²å¼€æ’­
                const autoMarkLiveTimeExpired = async (roomId, liveTime) => {
                    try {
                        console.log(`ğŸ”„ è‡ªåŠ¨æ ‡è®°ç›´æ’­é—´ ${roomId} çš„æ—¶é—´ ${liveTime} ä¸ºå·²å¼€æ’­`);
                        const api = await waitForApi();

                        // æ ‡è®°ç›´æ’­æ—¶é—´è®°å½•ä¸ºå·²å¼€æ’­çŠ¶æ€
                        const result = await api.mark_live_time_as_started(roomId, liveTime);
                        if (result && result.success) {
                            console.log(`âœ… è‡ªåŠ¨æ ‡è®°å·²å¼€æ’­æˆåŠŸ: ${result.message}`);
                            // é‡æ–°åŠ è½½ç›´æ’­é—´æ•°æ®ä»¥æ›´æ–°ç•Œé¢
                            await loadWechatRooms();
                        } else {
                            console.warn(`âš ï¸ è‡ªåŠ¨æ ‡è®°å·²å¼€æ’­å¤±è´¥: ${result?.message}`);
                        }
                    } catch (error) {
                        console.error('âŒ è‡ªåŠ¨æ ‡è®°å·²å¼€æ’­å¼‚å¸¸:', error);
                    }
                };

                // ç»„ä»¶æŒ‚è½½æ—¶åŠ è½½æ•°æ®
                onMounted(() => {
                    loadWechatRooms();
                    loadAllSpeech();
                    loadProductOptions(); // åŠ è½½å•†å“é€‰é¡¹
                    loadSystemConfig(); // åŠ è½½ç³»ç»Ÿé…ç½®
                    console.log('å¾®ä¿¡è§†é¢‘å·è·Ÿæ’­ç³»ç»Ÿå·²å¯åŠ¨');

                    // å¯åŠ¨æ—¶é—´æ›´æ–°å™¨
                    startTimeUpdater();
                });

                return {
                    loading,
                    saving,
                    searchKeyword,
                    wechatRooms,
                    filteredWechatRooms,
                    boundProductCount,
                    unboundProductCount,
                    // å•†å“ç»‘å®šUIç›¸å…³
                    getBindingButtonText,
                    getBindingButtonType,
                    getBindingButtonIcon,
                    getBindingActionHint,
                    onProductSelectionChange,
                    // æ‰¹é‡è·Ÿæ’­ç›¸å…³
                    selectedRooms,
                    roomTableRef,
                    handleSelectionChange,
                    clearSelection,
                    startBatchFollow,
                    // ğŸ”¥ æ–°å¢ï¼šåˆ†é¡µç›¸å…³
                    currentPage,
                    pageSize,
                    totalRooms,
                    handleSizeChange,
                    handleCurrentChange,

                    roomSpeech,
                    roomSpeeches,
                    roomDialogVisible,
                    isEditRoom,
                    roomForm,
                    roomRules,
                    roomFormRef,
                    roomDialogTitle,
                    loadWechatRooms,
                    showAddRoomDialog,
                    editRoom,
                    saveRoom,
                    goToSpeechManage,
                    // ç›´æ’­æ—¶é—´ç®¡ç†ç›¸å…³
                    liveTimeDialogVisible,
                    addLiveTimeDialogVisible,
                    currentManageRoom,
                    roomLiveTimes,
                    liveTimeForm,
                    liveTimeFormRef,
                    liveTimeRules,
                    manageLiveTime,
                    loadRoomLiveTimes,
                    showAddLiveTimeDialog,
                    saveLiveTime,
                    markAsExpired,
                    deleteLiveTime,
                    // è¯æœ¯ç›¸å…³æ•°æ®
                    speechViewDialogVisible,
                    speechBindDialogVisible,
                    currentRoomSpeech,
                    currentViewRoom,
                    allSpeech,
                    speechSearchKeyword,
                    selectedSpeechList,
                    binding,
                    filteredAllSpeech,
                    currentRoomBoundSpeechIds,
                    // è¯æœ¯ç›¸å…³æ–¹æ³•
                    viewBoundSpeech,
                    bindSpeech,
                    loadAllSpeech,
                    handleSpeechSelection,
                    confirmBindSpeech,
                    deleteRoom,
                    // å¼¹çª—è¯æœ¯ç®¡ç†æ–¹æ³•
                    unbindSpeechFromRoom,
                    loadCurrentRoomBoundSpeeches,
                    isSpeechBoundToCurrentRoom,
                    isSpeechSelectable,
                    getSpeechRowClassName,
                    // è¡¨æ ¼æ–¹æ³•
                    getRoomSpeech,

                    // å•†å“ç»‘å®šç›¸å…³
                    productBindDialogVisible,
                    currentBindRoom,
                    productOptions,
                    productBindForm,
                    bindProduct,
                    saveProductBinding,
                    loadProductOptions,
                    handleDropdownCommand,
                    getProductCoverUrl,
                    refreshImageUrl,
                    handleImageError,
                    loadProductCovers,
                    loadBoundImages,
                    loadProductOptionCovers,
                    updateRoomProductInfo,
                    // æ‰¹é‡ç»‘å®šç›¸å…³
                    batchBindDialogVisible,
                    batchBindForm,
                    batchBinding,
                    batchBindProduct,
                    saveBatchBinding,
                    // å€’è®¡æ—¶ç›¸å…³
                    currentTime,
                    roomCountdowns,
                    startTimeUpdater,

                    // é…ç½®ç®¡ç†ç›¸å…³
                    configVisible,
                    configLoading,
                    configSaving,
                    configBadge,
                    systemConfig,
                    uiConfig,
                    getConfigStatusStyle,
                    loadSystemConfig,
                    saveConfig,
                    resetConfig,
                    // åŠŸèƒ½å¼€å…³å¤„ç†å‡½æ•°
                    handleScreenshotChange,
                    handleNotificationsChange,
                    handleDetailedLogsChange,
                    // çœŸå®å‘é€å¼¹å¹•ç›¸å…³
                    realDanmuSendLoading,
                    handleRealDanmuSendChange
                };
            }
        });

        // æ³¨å†Œæ‰€æœ‰å›¾æ ‡
        if (typeof ElementPlusIconsVue !== 'undefined') {
            for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
                app.component(key, component);
            }
        }

        // è·å–ä¸­æ–‡è¯­è¨€åŒ…å¹¶é…ç½®Element Plus
        const zhCn = ElementPlusLocaleZhCn;
        app.use(ElementPlus, {
            locale: zhCn
        });

        // æŒ‚è½½åº”ç”¨ï¼Œæ·»åŠ é”™è¯¯å¤„ç†
        try {
            app.mount('#app');
            console.log('âœ… Vueåº”ç”¨æŒ‚è½½æˆåŠŸ');
        } catch (error) {
            console.error('âŒ Vueåº”ç”¨æŒ‚è½½å¤±è´¥:', error);
        }
    </script>
</body>

</html>