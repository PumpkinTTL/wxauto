<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾®ä¿¡è‡ªåŠ¨åŒ–å·¥å…·</title>
    <!-- Element Plus CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <!-- Element Plus Icons -->
    <script src="//cdn.jsdelivr.net/npm/@element-plus/icons-vue"></script>
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 50%, #f1f5f9 100%);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            font-size: 13px;
            overflow: hidden;
        }

        .main-container {
            min-height: 100vh;
            padding: 12px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* åŠŸèƒ½å¡ç‰‡åŒºåŸŸ */
        .cards-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .function-card {
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 16px;
            padding: 20px;
            box-shadow:
                0 4px 20px rgba(0, 0, 0, 0.08),
                0 1px 3px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.8);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            height: fit-content;
            backdrop-filter: blur(10px);
        }

        .function-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899, #f59e0b);
            border-radius: 16px 16px 0 0;
        }

        .function-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.03) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .function-card:hover {
            transform: translateY(-6px) scale(1.02);
            box-shadow:
                0 12px 40px rgba(0, 0, 0, 0.15),
                0 4px 12px rgba(59, 130, 246, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .function-card:hover::after {
            opacity: 1;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .card-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            color: white;
            font-size: 22px;
            box-shadow:
                0 4px 12px rgba(59, 130, 246, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }

        .card-icon::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: rotate(45deg);
            transition: transform 0.6s ease;
        }

        .function-card:hover .card-icon::before {
            transform: rotate(45deg) translate(100%, 100%);
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin: 0;
        }

        .card-subtitle {
            font-size: 12px;
            color: #64748b;
            margin: 2px 0 0 0;
        }

        /* æ§åˆ¶å°åŒºåŸŸ */
        .console-section {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 8px;
            padding: 16px;
            box-shadow:
                0 2px 8px rgba(0, 0, 0, 0.06),
                0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            position: relative;
            min-height: 400px;
            flex: 1;
        }

        .console-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        .console-title {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #1e293b;
            font-size: 16px;
            font-weight: 600;
        }

        .console-title .el-icon {
            font-size: 18px;
            color: #3b82f6;
        }

        .tab-buttons {
            display: flex;
            gap: 4px;
            padding: 2px;
            background: #f1f5f9;
            border-radius: 6px;
        }

        .tab-buttons .el-button {
            margin: 0;
            border: none;
            background: transparent;
            color: #64748b !important;
        }

        .tab-buttons .el-button.el-button--primary {
            background: #ffffff !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            color: #3b82f6 !important;
        }

        .console-controls {
            display: flex;
            gap: 8px;
        }

        .console-btn {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .console-btn.close { background: #ff5f57; }
        .console-btn.minimize { background: #ffbd2e; }
        .console-btn.maximize { background: #28ca42; }

        .console-content {
            height: 350px;
            background: #f8fafc;
            border-radius: 6px;
            padding: 12px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
            border: 1px solid #e2e8f0;
        }

        .console-line {
            margin-bottom: 4px;
            white-space: pre-wrap;
            word-break: break-all;
            padding: 4px 8px;
            border-left: 3px solid transparent;
            border-radius: 4px;
            background: #ffffff;
            transition: all 0.2s ease;
        }

        .console-line:hover {
            background: #f1f5f9;
        }

        .log-info {
            color: #3b82f6;
            border-left-color: #3b82f6;
            background: #eff6ff;
        }
        .log-warning {
            color: #f59e0b;
            border-left-color: #f59e0b;
            background: #fffbeb;
        }
        .log-error {
            color: #ef4444;
            border-left-color: #ef4444;
            background: #fef2f2;
        }
        .log-success {
            color: #10b981;
            border-left-color: #10b981;
            background: #ecfdf5;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        .console-content::-webkit-scrollbar {
            width: 6px;
        }

        .console-content::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        .console-content::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .console-content::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* è¾“å…¥æ¡†æ ·å¼ */
        .el-input__wrapper {
            background: rgba(255, 255, 255, 0.9) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            border-radius: 8px !important;
            transition: all 0.3s ease !important;
        }

        .el-input__wrapper:hover {
            border-color: #667eea !important;
        }

        .el-input__wrapper.is-focus {
            border-color: #667eea !important;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2) !important;
        }

        /* æŒ‰é’®æ ·å¼ */
        .action-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%) !important;
            border: none !important;
            border-radius: 6px !important;
            transition: all 0.3s ease !important;
            font-size: 14px !important;
            height: 36px !important;
        }

        .action-btn:hover {
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3) !important;
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-ready {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .status-processing {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .status-error {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .status-warning {
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
        }

        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* æ§åˆ¶é¢æ¿ */
        .control-panel {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow:
                0 2px 8px rgba(0, 0, 0, 0.06),
                0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            position: relative;
            transition: all 0.3s ease;
        }

        .control-panel:hover {
            box-shadow:
                0 4px 12px rgba(0, 0, 0, 0.1),
                0 2px 6px rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        .panel-title {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #1e293b;
            font-size: 16px;
            font-weight: 600;
        }

        .panel-title .el-icon {
            font-size: 18px;
            color: #3b82f6;
        }

        .status-indicators {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            font-weight: 500;
            color: #64748b;
            padding: 3px 8px;
            background: #f8fafc;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        .status-ready {
            color: #10b981;
            background: #ecfdf5;
            border-color: #d1fae5;
        }

        .status-error {
            color: #ef4444;
            background: #fef2f2;
            border-color: #fecaca;
        }

        .status-warning {
            color: #f59e0b;
            background: #fffbeb;
            border-color: #fed7aa;
        }

        .pulse {
            animation: pulse-dot 1.5s infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
        }

        .panel-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .control-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #ffffff;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }

        .control-group:hover {
            border-color: #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
        }

        .group-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            color: #374151;
            font-size: 13px;
        }

        .group-header .el-icon {
            font-size: 16px;
            color: #3b82f6;
        }

        .group-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-avatar-small {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
        }

        /* å¸¸ç”¨è¯­é€‰æ‹©æ ·å¼ */
        .phrase-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .phrase-item:hover {
            border-color: #3b82f6;
            background-color: #f8fafc;
        }

        .phrase-item.selected {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        .phrase-content {
            flex: 1;
            color: #374151;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .cards-section {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 12px;
                gap: 12px;
            }

            .cards-section {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .function-card {
                padding: 16px;
            }

            .table-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .console-content {
                height: 250px;
            }

            .console-section {
                min-height: 320px;
            }
        }

        @media (max-width: 480px) {
            .main-container {
                padding: 8px;
                gap: 8px;
            }

            .cards-section {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .function-card {
                padding: 12px;
            }

            .card-title {
                font-size: 14px;
            }

            .card-subtitle {
                font-size: 11px;
            }

            .console-content {
                height: 200px;
            }

            .console-section {
                min-height: 270px;
            }

            /* éšè—éƒ¨åˆ†è¡¨æ ¼åˆ— */
            .el-table .hidden-xs {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="main-container">
            <!-- é›†æˆæ§åˆ¶é¢æ¿ -->
            <div class="control-panel animate__animated animate__fadeInUp">
                <div class="panel-header">
                    <div class="panel-title">
                        <el-icon><Setting /></el-icon>
                        <span>å¾®ä¿¡è‡ªåŠ¨åŒ–æ§åˆ¶é¢æ¿</span>
                    </div>
                    <div class="status-indicators">
                        <span class="status-indicator" :class="wechatStatus.class">
                            <div class="status-dot" :class="{ pulse: wechatStatus.connected }"></div>
                            å¾®ä¿¡: {{ wechatStatus.text }}
                        </span>
                        <span class="status-indicator status-ready">
                            <div class="status-dot"></div>
                            å¼•æ“: å°±ç»ª
                        </span>
                        <span class="status-indicator status-ready">
                            <div class="status-dot"></div>
                            æˆªå›¾: æ­£å¸¸
                        </span>
                        <el-button size="small" @click="checkWechatStatus" :loading="statusChecking">
                            <el-icon><Refresh /></el-icon>
                        </el-button>
                    </div>
                </div>

                <div class="panel-content">
                    <!-- ç”¨æˆ·é€‰æ‹©åŒºåŸŸ -->
                    <div class="control-group">
                        <div class="group-header">
                            <el-icon><User /></el-icon>
                            <span>ç”¨æˆ·æ•°æ®</span>
                            <el-tag type="info" size="small">{{ users.length }} äºº</el-tag>
                            <el-tag type="primary" size="small">å·²é€‰ {{ selectedUsers.length }} äºº</el-tag>
                        </div>
                        <div class="group-actions">
                            <el-button size="small" @click="showUserDialog = true" :disabled="users.length === 0">
                                <el-icon><Search /></el-icon>
                                é€‰æ‹©ç”¨æˆ·
                            </el-button>
                            <el-button size="small" @click="loadUsers" :loading="loadingUsers">
                                <el-icon><Refresh /></el-icon>
                                åˆ·æ–°
                            </el-button>
                        </div>
                    </div>

                    <!-- éªŒè¯æ¶ˆæ¯åŒºåŸŸ -->
                    <div class="control-group">
                        <div class="group-header">
                            <el-icon><ChatLineRound /></el-icon>
                            <span>éªŒè¯æ¶ˆæ¯</span>
                            <el-tag type="success" size="small">å·²é€‰ {{ selectedPhrases.length }} æ¡</el-tag>
                        </div>
                        <div class="group-actions">
                            <el-button size="small" @click="showPhraseDialog = true" type="primary">
                                <el-icon><Edit /></el-icon>
                                é€‰æ‹©å¸¸ç”¨è¯­
                            </el-button>
                            <el-input
                                v-model="customMessage"
                                placeholder="æˆ–è¾“å…¥è‡ªå®šä¹‰æ¶ˆæ¯..."
                                size="small"
                                style="width: 200px; margin-left: 8px;"
                                clearable
                            />
                        </div>
                    </div>



                    <!-- æ‰¹é‡æ“ä½œåŒºåŸŸ -->
                    <div class="control-group">
                        <div class="group-header">
                            <el-icon><UserPlus /></el-icon>
                            <span>æ‰¹é‡æ“ä½œ</span>
                        </div>
                        <div class="group-actions">
                            <el-button
                                type="primary"
                                class="action-btn"
                                @click="batchAddFriends"
                                :loading="isProcessing"
                                :disabled="selectedUsers.length === 0 || (selectedPhrases.length === 0 && !customMessage)"
                            >
                                <el-icon><Plus /></el-icon>
                                æ·»åŠ  {{ selectedUsers.length }} ä¸ªå¥½å‹
                            </el-button>
                            <el-button size="small" @click="clearAllSelections">
                                <el-icon><Delete /></el-icon>
                                æ¸…ç©ºé€‰æ‹©
                            </el-button>
                        </div>
                    </div>
                </div>
            </div>



            <!-- æ§åˆ¶å°å’Œæ—¥å¿—åŒºåŸŸ -->
            <div class="console-section animate__animated animate__fadeInUp" style="animation-delay: 0.5s;">
                <div class="console-header">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div class="console-title">
                            <el-icon><Monitor /></el-icon>
                            <span>{{ activeTab === 'console' ? 'å®æ—¶æ§åˆ¶å°' : 'æ“ä½œæ—¥å¿—' }}</span>
                            <span style="font-size: 12px; opacity: 0.7; margin-left: 8px;">
                                {{ activeTab === 'console' ? new Date().toLocaleString() : `å…± ${userLogs.length} æ¡è®°å½•` }}
                            </span>
                        </div>
                        <div class="tab-buttons">
                            <el-button
                                size="small"
                                :type="activeTab === 'console' ? 'primary' : ''"
                                @click="activeTab = 'console'"
                            >
                                <el-icon><Monitor /></el-icon>
                                æ§åˆ¶å°
                            </el-button>
                            <el-button
                                size="small"
                                :type="activeTab === 'logs' ? 'primary' : ''"
                                @click="activeTab = 'logs'"
                            >
                                <el-icon><Document /></el-icon>
                                æ—¥å¿—
                            </el-button>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <el-button
                            v-if="isProcessing && activeTab === 'console'"
                            size="small"
                            type="danger"
                            @click="stopProcessing"
                            :loading="false"
                        >
                            <el-icon><Close /></el-icon>
                            ç»ˆæ­¢æ“ä½œ
                        </el-button>
                        <el-button v-if="activeTab === 'console'" size="small" @click="clearConsole">
                            <el-icon><Delete /></el-icon>
                            æ¸…ç©º
                        </el-button>
                        <el-button v-if="activeTab === 'console'" size="small" @click="scrollToBottom">
                            <el-icon><Bottom /></el-icon>
                            åº•éƒ¨
                        </el-button>
                        <el-button v-if="activeTab === 'logs'" size="small" @click="loadUserLogs" :loading="loadingLogs">
                            <el-icon><Refresh /></el-icon>
                            åˆ·æ–°
                        </el-button>
                        <el-button v-if="activeTab === 'logs'" size="small" @click="clearUserLogs">
                            <el-icon><Delete /></el-icon>
                            æ¸…ç©º
                        </el-button>
                    </div>
                </div>

                <!-- æ§åˆ¶å°å†…å®¹ -->
                <div v-show="activeTab === 'console'" class="console-content" ref="consoleContainer">
                    <div v-for="(log, index) in consoleLogs" :key="index" class="console-line" :class="getLogClass(log.type)">
                        <span style="opacity: 0.7;">[{{ log.time }}]</span> {{ log.message }}
                    </div>
                    <div v-if="consoleLogs.length === 0" class="console-line log-info">
                        å¾®ä¿¡è‡ªåŠ¨åŒ–å·¥å…·ï¼è¯·é€‰æ‹©ç”¨æˆ·å¹¶é…ç½®éªŒè¯æ¶ˆæ¯åå¼€å§‹æ‰¹é‡æ·»åŠ å¥½å‹...
                    </div>
                </div>

                <!-- æ“ä½œæ—¥å¿—è¡¨æ ¼ -->
                <div v-show="activeTab === 'logs'" style="height: 350px; overflow-y: auto;">
                    <el-table
                        :data="userLogs"
                        style="width: 100%;"
                        size="small"
                        stripe
                        :header-cell-style="{ background: '#f8fafc', color: '#374151', fontWeight: '500' }"
                    >
                        <el-table-column prop="wechat_id" label="å¾®ä¿¡å·" width="150" show-overflow-tooltip />
                        <el-table-column prop="verify_msg" label="éªŒè¯æ¶ˆæ¯" width="200" show-overflow-tooltip />
                        <el-table-column prop="add_time" label="æ·»åŠ æ—¶é—´" width="150">
                            <template #default="scope">
                                {{ formatTime(scope.row.add_time) }}
                            </template>
                        </el-table-column>
                        <el-table-column prop="status" label="çŠ¶æ€" width="100" align="center">
                            <template #default="scope">
                                <el-tag :type="scope.row.status === 1 ? 'success' : 'danger'" size="small">
                                    {{ scope.row.status === 1 ? 'æˆåŠŸ' : 'å¤±è´¥' }}
                                </el-tag>
                            </template>
                        </el-table-column>
                        <el-table-column prop="img_path" label="æˆªå›¾" width="100" align="center">
                            <template #default="scope">
                                <el-button v-if="scope.row.img_path" size="small" type="primary" link @click="viewScreenshot(scope.row.img_path)">
                                    æŸ¥çœ‹
                                </el-button>
                                <span v-else style="color: #9ca3af;">æ— </span>
                            </template>
                        </el-table-column>
                        <el-table-column prop="error_msg" label="é”™è¯¯ä¿¡æ¯" show-overflow-tooltip>
                            <template #default="scope">
                                <span v-if="scope.row.error_msg" style="color: #ef4444;">{{ scope.row.error_msg }}</span>
                                <span v-else style="color: #9ca3af;">-</span>
                            </template>
                        </el-table-column>
                    </el-table>

                    <div v-if="userLogs.length === 0" style="text-align: center; padding: 40px; color: #6b7280;">
                        <el-icon size="48" style="color: #d1d5db; margin-bottom: 12px;"><Document /></el-icon>
                        <p>æš‚æ— æ“ä½œè®°å½•</p>
                    </div>
                </div>
            </div>

            <!-- ç”¨æˆ·é€‰æ‹©å¼¹çª— -->
            <el-dialog
                v-model="showUserDialog"
                title="é€‰æ‹©ç”¨æˆ·"
                width="80%"
                :before-close="handleUserDialogClose"
            >
                <div style="margin-bottom: 16px;">
                    <el-button size="small" @click="selectAllUsersInDialog">å…¨é€‰</el-button>
                    <el-button size="small" @click="clearUserSelectionInDialog">æ¸…ç©º</el-button>
                    <el-button size="small" @click="loadUsers" :loading="loadingUsers">
                        <el-icon><Refresh /></el-icon>
                        åˆ·æ–°
                    </el-button>
                </div>

                <!-- æœç´¢å’Œç­›é€‰åŒºåŸŸ -->
                <div style="margin-bottom: 16px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                    <el-input
                        v-model="userSearchText"
                        placeholder="æœç´¢å¾®ä¿¡å·ã€ç­¾å..."
                        size="small"
                        style="width: 200px;"
                        clearable
                        @input="filterUsers"
                    >
                        <template #prefix>
                            <el-icon><Search /></el-icon>
                        </template>
                    </el-input>

                    <el-select
                        v-model="followerFilter"
                        placeholder="ç²‰ä¸æ•°ç­›é€‰"
                        size="small"
                        style="width: 120px;"
                        clearable
                        @change="filterUsers"
                    >
                        <el-option label="å…¨éƒ¨" value="" />
                        <el-option label="1000+" value="1000+" />
                        <el-option label="5000+" value="5000+" />
                        <el-option label="10000+" value="10000+" />
                    </el-select>

                    <el-tag type="info" size="small">
                        æ˜¾ç¤º {{ filteredUsers.length }} / {{ users.length }} æ¡
                    </el-tag>
                </div>

                <el-table
                    :data="filteredUsers"
                    style="width: 100%;"
                    @selection-change="handleSelectionChange"
                    size="default"
                    stripe
                    height="400"
                    :header-cell-style="{ background: '#f8fafc', color: '#374151', fontWeight: '600' }"
                    ref="userTable"
                >
                    <el-table-column type="selection" width="50" />
                    <el-table-column prop="unique_id" label="å¾®ä¿¡å·" width="150" show-overflow-tooltip sortable>
                        <template #default="scope">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="user-avatar-small">
                                    <el-icon><User /></el-icon>
                                </div>
                                <span style="font-weight: 500;">{{ scope.row.unique_id }}</span>
                            </div>
                        </template>
                    </el-table-column>
                    <el-table-column prop="intro" label="ä¸ªæ€§ç­¾å" show-overflow-tooltip>
                        <template #default="scope">
                            <span style="color: #64748b;">{{ scope.row.intro || 'æš‚æ— ç­¾å' }}</span>
                        </template>
                    </el-table-column>
                    <el-table-column prop="follower_count" label="ç²‰ä¸æ•°" width="100" align="center" sortable>
                        <template #default="scope">
                            <el-tag size="small" type="info">{{ formatFollowerCount(scope.row.follower_count) }}</el-tag>
                        </template>
                    </el-table-column>
                    <el-table-column label="çŠ¶æ€" width="80" align="center">
                        <template #default="scope">
                            <el-tag
                                size="small"
                                :type="isUserAdded(scope.row.unique_id) ? 'success' : 'info'"
                            >
                                {{ isUserAdded(scope.row.unique_id) ? 'å·²æ·»åŠ ' : 'æœªæ·»åŠ ' }}
                            </el-tag>
                        </template>
                    </el-table-column>
                </el-table>

                <template #footer>
                    <span class="dialog-footer">
                        <el-button @click="showUserDialog = false">å–æ¶ˆ</el-button>
                        <el-button type="primary" @click="confirmUserSelection">
                            ç¡®å®š (å·²é€‰ {{ selectedUsers.length }} äºº)
                        </el-button>
                    </span>
                </template>
            </el-dialog>

            <!-- å¸¸ç”¨è¯­é€‰æ‹©å¼¹çª— -->
            <el-dialog
                v-model="showPhraseDialog"
                title="é€‰æ‹©éªŒè¯æ¶ˆæ¯"
                width="60%"
                :before-close="handlePhraseDialogClose"
            >
                <div style="margin-bottom: 16px;">
                    <el-button size="small" @click="selectAllPhrases">å…¨é€‰</el-button>
                    <el-button size="small" @click="clearPhraseSelection">æ¸…ç©º</el-button>
                    <el-button size="small" @click="loadPhrases" :loading="loadingPhrases">
                        <el-icon><Refresh /></el-icon>
                        åˆ·æ–°
                    </el-button>
                </div>

                <div class="phrase-list" style="max-height: 400px; overflow-y: auto;">
                    <div
                        v-for="phrase in activePhrases"
                        :key="phrase.id"
                        class="phrase-item"
                        :class="{ 'selected': isPhraseSelected(phrase) }"
                    >
                        <el-checkbox
                            :model-value="isPhraseSelected(phrase)"
                            @change="() => togglePhraseSelection(phrase)"
                        />
                        <div class="phrase-content" @click="togglePhraseSelection(phrase)">{{ phrase.content }}</div>
                    </div>
                </div>

                <template #footer>
                    <span class="dialog-footer">
                        <el-button @click="showPhraseDialog = false">å–æ¶ˆ</el-button>
                        <el-button type="primary" @click="confirmPhraseSelection">
                            ç¡®å®š (å·²é€‰ {{ selectedPhrases.length }} æ¡)
                        </el-button>
                    </span>
                </template>
            </el-dialog>





        </div>
    </div>

    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Element Plus -->
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <!-- Element Plus Icons -->
    <script src="https://unpkg.com/@element-plus/icons-vue/dist/index.iife.js"></script>

    <script>
        const { createApp, ref, reactive, computed, nextTick, onMounted } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;

        const app = createApp({
            setup() {
                // æ•°æ®ç®¡ç†
                const users = ref([]);
                const selectedUsers = ref([]);
                const phrases = ref([]);
                const activePhrases = computed(() => phrases.value.filter(p => p.status === 1));

                // ç­›é€‰ç›¸å…³
                const userSearchText = ref('');
                const followerFilter = ref('');
                const filteredUsers = ref([]);
                const addedUserIds = ref(new Set()); // å·²æ·»åŠ çš„ç”¨æˆ·IDé›†åˆ

                // è¡¨å•æ•°æ®
                const selectedPhrase = ref('');
                const customMessage = ref('');

                // çŠ¶æ€ç®¡ç†
                const isProcessing = ref(false);
                const shouldStop = ref(false);
                let currentController = null; // ç”¨äºä¸­æ–­è¯·æ±‚
                const statusChecking = ref(false);
                const loadingUsers = ref(false);
                const loadingPhrases = ref(false);
                const consoleLogs = ref([]);
                const consoleContainer = ref(null);
                const showUserDialog = ref(false);
                const showPhraseDialog = ref(false);
                const selectedPhrases = ref([]);
                const userLogs = ref([]);
                const loadingLogs = ref(false);
                const activeTab = ref('console'); // 'console' æˆ– 'logs'
                const userTable = ref(null); // ç”¨æˆ·è¡¨æ ¼ref

                // å¾®ä¿¡çŠ¶æ€
                const wechatStatus = ref({
                    connected: false,
                    text: 'æœªè¿æ¥',
                    class: 'status-error'
                });

                // è·å–pywebview API - 
                const getPywebviewApi = () => {
                    if (window.pywebview && window.pywebview.api) {
                        return window.pywebview.api;
                    } else if (window.parent && window.parent.pywebview && window.parent.pywebview.api) {
                        return window.parent.pywebview.api;
                    } else if (window.top && window.top.pywebview && window.top.pywebview.api) {
                        return window.top.pywebview.api;
                    }
                    return null;
                };

                // æ·»åŠ æ§åˆ¶å°æ—¥å¿—
                const addLog = (message, type = 'info') => {
                    const time = new Date().toLocaleTimeString();
                    consoleLogs.value.push({
                        time,
                        message,
                        type
                    });

                    nextTick(() => {
                        scrollToBottom();
                    });
                };

                // æ»šåŠ¨åˆ°åº•éƒ¨
                const scrollToBottom = () => {
                    if (consoleContainer.value) {
                        consoleContainer.value.scrollTop = consoleContainer.value.scrollHeight;
                    }
                };

                // æ¸…ç©ºæ§åˆ¶å°
                const clearConsole = () => {
                    consoleLogs.value = [];
                    addLog('æ§åˆ¶å°å·²æ¸…ç©º', 'info');
                };

                // è·å–æ—¥å¿—æ ·å¼ç±»
                const getLogClass = (type) => {
                    const classMap = {
                        'info': 'log-info',
                        'warning': 'log-warning',
                        'error': 'log-error',
                        'success': 'log-success'
                    };
                    return classMap[type] || 'log-info';
                };

                // æ£€æŸ¥å¾®ä¿¡çŠ¶æ€
                const checkWechatStatus = async () => {
                    statusChecking.value = true;
                    addLog('æ­£åœ¨æ£€æŸ¥å¾®ä¿¡è¿æ¥çŠ¶æ€...', 'info');

                    try {
                        let api = getPywebviewApi();

                        // å¦‚æœAPIä¸å¯ç”¨ï¼Œç­‰å¾…å¹¶é‡è¯•å‡ æ¬¡
                        if (!api) {
                            addLog('ç­‰å¾…APIè¿æ¥...', 'info');
                            for (let i = 0; i < 5; i++) {
                                await new Promise(resolve => setTimeout(resolve, 500));
                                api = getPywebviewApi();
                                if (api) break;
                                addLog(`é‡è¯•è¿æ¥API... (${i + 1}/5)`, 'info');
                            }

                            if (!api) {
                                throw new Error('æ— æ³•è¿æ¥åˆ°åç«¯APIï¼Œè¯·ç¡®ä¿åº”ç”¨æ­£å¸¸è¿è¡Œ');
                            }
                        }

                        // è°ƒç”¨åç«¯æ£€æŸ¥å¾®ä¿¡çŠ¶æ€
                        const result = await api.check_wechat_status();

                        if (result && result.success) {
                            wechatStatus.value = {
                                connected: true,
                                text: 'å·²è¿æ¥',
                                class: 'status-ready'
                            };
                            addLog('âœ… å¾®ä¿¡è¿æ¥æ­£å¸¸', 'success');
                        } else {
                            wechatStatus.value = {
                                connected: false,
                                text: 'è¿æ¥å¤±è´¥',
                                class: 'status-error'
                            };
                            addLog('âŒ å¾®ä¿¡è¿æ¥å¤±è´¥ï¼š' + (result?.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                        }
                    } catch (error) {
                        console.error('æ£€æŸ¥å¾®ä¿¡çŠ¶æ€å¤±è´¥:', error);
                        wechatStatus.value = {
                            connected: false,
                            text: 'æ£€æŸ¥å¤±è´¥',
                            class: 'status-error'
                        };
                        addLog('âŒ æ£€æŸ¥å¾®ä¿¡çŠ¶æ€å¤±è´¥ï¼š' + error.message, 'error');
                    } finally {
                        statusChecking.value = false;
                    }
                };

                // ç­‰å¾…APIå°±ç»ªçš„é€šç”¨æ–¹æ³•
                const waitForApi = async () => {
                    let api = getPywebviewApi();
                    if (!api) {
                        for (let i = 0; i < 5; i++) {
                            await new Promise(resolve => setTimeout(resolve, 300));
                            api = getPywebviewApi();
                            if (api) break;
                        }
                        if (!api) {
                            throw new Error('æ— æ³•è¿æ¥åˆ°åç«¯APIï¼Œè¯·ç¡®ä¿åº”ç”¨æ­£å¸¸è¿è¡Œ');
                        }
                    }
                    return api;
                };

                // ç­›é€‰ç”¨æˆ·
                const filterUsers = () => {
                    let filtered = [...users.value];

                    // æ–‡æœ¬æœç´¢
                    if (userSearchText.value) {
                        const searchText = userSearchText.value.toLowerCase();
                        filtered = filtered.filter(user =>
                            (user.unique_id && user.unique_id.toLowerCase().includes(searchText)) ||
                            (user.intro && user.intro.toLowerCase().includes(searchText))
                        );
                    }

                    // ç²‰ä¸æ•°ç­›é€‰
                    if (followerFilter.value) {
                        const threshold = parseInt(followerFilter.value.replace('+', ''));
                        filtered = filtered.filter(user =>
                            user.follower_count && user.follower_count >= threshold
                        );
                    }

                    filteredUsers.value = filtered;
                };

                // æ ¼å¼åŒ–ç²‰ä¸æ•°æ˜¾ç¤º
                const formatFollowerCount = (count) => {
                    if (!count) return '0';
                    if (count >= 10000) return (count / 10000).toFixed(1) + 'w';
                    if (count >= 1000) return (count / 1000).toFixed(1) + 'k';
                    return count.toString();
                };

                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²æ·»åŠ 
                const isUserAdded = (wechatId) => {
                    return addedUserIds.value.has(wechatId);
                };

                // åŠ è½½ç”¨æˆ·æ•°æ®
                const loadUsers = async () => {
                    loadingUsers.value = true;
                    addLog('æ­£åœ¨åŠ è½½ç”¨æˆ·æ•°æ®...', 'info');
                    try {
                        const api = await waitForApi();

                        const result = await api.get_users();
                        if (result && result.success) {
                            users.value = result.data || [];
                            filterUsers(); // åº”ç”¨ç­›é€‰
                            addLog(`âœ… åŠ è½½äº† ${users.value.length} æ¡ç”¨æˆ·æ•°æ®`, 'success');
                        } else {
                            throw new Error(result?.message || 'è·å–ç”¨æˆ·æ•°æ®å¤±è´¥');
                        }
                    } catch (error) {
                        console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
                        addLog('âŒ åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥ï¼š' + error.message, 'error');
                        ElMessage.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥ï¼š' + error.message);
                    } finally {
                        loadingUsers.value = false;
                    }
                };

                // åŠ è½½å¸¸ç”¨è¯­
                const loadPhrases = async () => {
                    try {
                        const api = await waitForApi();

                        const result = await api.get_wechat_phrases();
                        if (result && result.success) {
                            phrases.value = result.data || [];
                        }
                    } catch (error) {
                        console.error('åŠ è½½å¸¸ç”¨è¯­å¤±è´¥:', error);
                    }
                };

                // å¤„ç†è¡¨æ ¼é€‰æ‹©å˜åŒ–
                const handleSelectionChange = (selection) => {
                    selectedUsers.value = selection;
                };

                // å¼¹çª—ä¸­çš„ç”¨æˆ·é€‰æ‹©æ–¹æ³•
                const selectAllUsersInDialog = () => {
                    selectedUsers.value = [...filteredUsers.value];
                    nextTick(() => {
                        // é€šè¿‡refæ“ä½œè¡¨æ ¼å…¨é€‰
                        if (userTable.value) {
                            userTable.value.toggleAllSelection();
                        }
                    });
                };

                const clearUserSelectionInDialog = () => {
                    selectedUsers.value = [];
                    nextTick(() => {
                        if (userTable.value) {
                            userTable.value.clearSelection();
                        }
                    });
                };

                const confirmUserSelection = () => {
                    showUserDialog.value = false;
                    addLog(`å·²é€‰æ‹© ${selectedUsers.value.length} ä¸ªç”¨æˆ·`, 'success');
                };

                const handleUserDialogClose = () => {
                    showUserDialog.value = false;
                };

                // å¸¸ç”¨è¯­é€‰æ‹©ç›¸å…³æ–¹æ³•
                const isPhraseSelected = (phrase) => {
                    return selectedPhrases.value.some(p => p.id === phrase.id);
                };

                const togglePhraseSelection = (phrase) => {
                    const index = selectedPhrases.value.findIndex(p => p.id === phrase.id);
                    if (index > -1) {
                        selectedPhrases.value.splice(index, 1);
                    } else {
                        selectedPhrases.value.push(phrase);
                    }
                };

                const selectAllPhrases = () => {
                    selectedPhrases.value = [...activePhrases.value];
                };

                const clearPhraseSelection = () => {
                    selectedPhrases.value = [];
                };

                const confirmPhraseSelection = () => {
                    showPhraseDialog.value = false;
                    addLog(`å·²é€‰æ‹© ${selectedPhrases.value.length} æ¡å¸¸ç”¨è¯­`, 'success');
                };

                const handlePhraseDialogClose = () => {
                    showPhraseDialog.value = false;
                };

                // å…¨é€‰ç”¨æˆ·
                const selectAllUsers = () => {
                    selectedUsers.value = [...users.value];
                };

                // æ¸…ç©ºé€‰æ‹©
                const clearSelection = () => {
                    selectedUsers.value = [];
                };

                // æ¸…ç©ºæ‰€æœ‰é€‰æ‹©
                const clearAllSelections = () => {
                    selectedUsers.value = [];
                    selectedPhrases.value = [];
                    customMessage.value = '';
                    addLog('å·²æ¸…ç©ºæ‰€æœ‰é€‰æ‹©', 'info');
                };

                // ç»ˆæ­¢æ“ä½œ
                const stopProcessing = async () => {
                    shouldStop.value = true;
                    addLog('âš ï¸ ç”¨æˆ·è¯·æ±‚ç»ˆæ­¢æ“ä½œ...', 'warning');
                    ElMessage.warning('æ­£åœ¨ç»ˆæ­¢æ“ä½œï¼Œè¯·ç¨å€™...');

                    // ä¸­æ–­å½“å‰çš„HTTPè¯·æ±‚
                    if (currentController) {
                        currentController.abort();
                        addLog('ğŸ›‘ å·²ä¸­æ–­å½“å‰è¯·æ±‚', 'warning');
                    }

                    try {
                        const api = await waitForApi();
                        await api.stop_processing();
                        addLog('âœ… ç»ˆæ­¢è¯·æ±‚å·²å‘é€åˆ°åç«¯', 'info');
                    } catch (error) {
                        addLog('âŒ å‘é€ç»ˆæ­¢è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
                    }

                    // å¼ºåˆ¶ç»“æŸå¤„ç†çŠ¶æ€
                    setTimeout(() => {
                        if (isProcessing.value) {
                            isProcessing.value = false;
                            shouldStop.value = false;
                            addLog('ğŸ”„ å·²å¼ºåˆ¶ç»“æŸå¤„ç†çŠ¶æ€', 'info');
                            ElMessage.success('æ“ä½œå·²ç»ˆæ­¢');
                        }
                    }, 2000);
                };

                // å¸¸ç”¨è¯­é€‰æ‹©å˜åŒ–
                const onPhraseChange = (value) => {
                    customMessage.value = value;
                };

                // æ·»åŠ å•ä¸ªå¥½å‹
                const addSingleFriend = async (user) => {
                    const verifyMsg = getRandomMessage();
                    if (!verifyMsg) {
                        ElMessage.warning('è¯·é€‰æ‹©éªŒè¯æ¶ˆæ¯æˆ–è¾“å…¥è‡ªå®šä¹‰æ¶ˆæ¯');
                        return;
                    }

                    isProcessing.value = true;
                    shouldStop.value = false;
                    addLog(`å¼€å§‹æ·»åŠ å¥½å‹ï¼š${user.unique_id}`, 'info');

                    try {
                        const api = await waitForApi();

                        const result = await api.add_wechat_friend({
                            wechat_id: user.unique_id,
                            verify_msg: verifyMsg,
                            remark_name: user.signature || user.unique_id
                        });

                        if (result && result.success) {
                            addLog(`âœ… æˆåŠŸæ·»åŠ å¥½å‹ï¼š${user.unique_id}`, 'success');
                            if (result.screenshot_path) {
                                addLog(`ğŸ“¸ æˆªå›¾å·²ä¿å­˜ï¼š${result.screenshot_path}`, 'info');
                            }
                            ElMessage.success('å¥½å‹ç”³è¯·å‘é€æˆåŠŸï¼');
                        } else if (result && result.user_not_found) {
                            addLog(`âš ï¸ æ— æ³•æ‰¾åˆ°ç”¨æˆ·ï¼š${user.unique_id}`, 'warning');
                            ElMessage.warning('æ— æ³•æ‰¾åˆ°è¯¥ç”¨æˆ·ï¼Œè¯·æ£€æŸ¥å¾®ä¿¡å·æ˜¯å¦æ­£ç¡®');
                        } else {
                            const errorMsg = result?.message || 'æ·»åŠ å¥½å‹å¤±è´¥';
                            addLog(`âŒ æ·»åŠ å¤±è´¥ï¼š${user.unique_id} - ${errorMsg}`, 'error');
                            ElMessage.error(errorMsg);
                        }

                        // åˆ·æ–°æ“ä½œæ—¥å¿—
                        loadUserLogs();

                    } catch (error) {
                        console.error('æ·»åŠ å¥½å‹å¤±è´¥:', error);
                        const errorMsg = 'æ·»åŠ å¥½å‹å¤±è´¥ï¼š' + error.message;
                        addLog(`âŒ ${errorMsg}`, 'error');
                        ElMessage.error(errorMsg);
                    } finally {
                        isProcessing.value = false;
                        shouldStop.value = false;
                    }
                };

                // è·å–éšæœºéªŒè¯æ¶ˆæ¯
                const getRandomMessage = () => {
                    if (customMessage.value) {
                        return customMessage.value;
                    }

                    if (selectedPhrases.value.length > 0) {
                        const randomIndex = Math.floor(Math.random() * selectedPhrases.value.length);
                        return selectedPhrases.value[randomIndex].content;
                    }

                    return null;
                };

                // æ‰¹é‡æ·»åŠ å¥½å‹
                const batchAddFriends = async () => {
                    if (selectedUsers.value.length === 0) {
                        ElMessage.warning('è¯·å…ˆé€‰æ‹©è¦æ·»åŠ çš„ç”¨æˆ·');
                        return;
                    }

                    if (selectedPhrases.value.length === 0 && !customMessage.value) {
                        ElMessage.warning('è¯·é€‰æ‹©éªŒè¯æ¶ˆæ¯æˆ–è¾“å…¥è‡ªå®šä¹‰æ¶ˆæ¯');
                        return;
                    }

                    // é‡ç½®ç»ˆæ­¢æ ‡å¿—
                    shouldStop.value = false;

                    try {
                        await ElMessageBox.confirm(
                            `ç¡®å®šè¦æ‰¹é‡æ·»åŠ  ${selectedUsers.value.length} ä¸ªå¥½å‹å—ï¼Ÿ`,
                            'ç¡®è®¤æ‰¹é‡æ·»åŠ ',
                            {
                                confirmButtonText: 'ç¡®å®šæ·»åŠ ',
                                cancelButtonText: 'å–æ¶ˆ',
                                type: 'info',
                            }
                        );
                    } catch {
                        return;
                    }

                    // åˆ›å»ºæ–°çš„AbortController
                    currentController = new AbortController();

                    isProcessing.value = true;
                    addLog(`å¼€å§‹æ‰¹é‡æ·»åŠ  ${selectedUsers.value.length} ä¸ªå¥½å‹...`, 'info');

                    let successCount = 0;
                    let failCount = 0;
                    let skipCount = 0;

                    try {
                        
                        const api = await waitForApi();

                        for (let i = 0; i < selectedUsers.value.length; i++) {
                            // æ£€æŸ¥æ˜¯å¦éœ€è¦ç»ˆæ­¢
                            if (shouldStop.value) {
                                addLog('ğŸ›‘ æ“ä½œå·²è¢«ç”¨æˆ·ç»ˆæ­¢', 'warning');
                                break;
                            }

                            const user = selectedUsers.value[i];
                            const message = getRandomMessage();

                            addLog(`[${i + 1}/${selectedUsers.value.length}] æ­£åœ¨æ·»åŠ ï¼š${user.unique_id}`, 'info');
                            addLog(`ä½¿ç”¨éªŒè¯æ¶ˆæ¯: ${message}`, 'info');

                            try {
                                // æ£€æŸ¥æ˜¯å¦è¢«ä¸­æ–­
                                if (currentController.signal.aborted) {
                                    addLog('ğŸ›‘ è¯·æ±‚å·²è¢«ä¸­æ–­', 'warning');
                                    break;
                                }
                                // è¯·æ±‚python
                                const result = await api.add_wechat_friend({
                                    wechat_id: user.unique_id,
                                    verify_msg: message,
                                    remark_name: user.signature || user.unique_id
                                });

                                if (result && result.success) {
                                    successCount++;
                                    addLog(`âœ… [${i + 1}/${selectedUsers.value.length}] æˆåŠŸï¼š${user.unique_id}`, 'success');
                                } else if (result && result.user_not_found) {
                                    // å¤„ç†ç”¨æˆ·ä¸å­˜åœ¨çš„æƒ…å†µ
                                    skipCount++;
                                    addLog(`âš ï¸ [${i + 1}/${selectedUsers.value.length}] æ— æ³•æ‰¾åˆ°ç”¨æˆ·ï¼Œè·³è¿‡ï¼š${user.unique_id}`, 'warning');
                                } else if (result && result.message) {
                                    // æ£€æŸ¥å…¶ä»–é”™è¯¯æƒ…å†µ
                                    if (result.message.includes('å·²ç»æ˜¯å¥½å‹') ||
                                        result.message.includes('å¥½å‹å…³ç³»å·²å­˜åœ¨')) {
                                        skipCount++;
                                        addLog(`âš ï¸ [${i + 1}/${selectedUsers.value.length}] å·²ç»æ˜¯å¥½å‹ï¼Œè·³è¿‡ï¼š${user.unique_id}`, 'warning');
                                    } else {
                                        failCount++;
                                        addLog(`âŒ [${i + 1}/${selectedUsers.value.length}] å¤±è´¥ï¼š${user.unique_id} - ${result.message}`, 'error');
                                    }
                                } else {
                                    failCount++;
                                    addLog(`âŒ [${i + 1}/${selectedUsers.value.length}] å¤±è´¥ï¼š${user.unique_id} - æœªçŸ¥é”™è¯¯`, 'error');
                                }

                                // æ£€æŸ¥æ˜¯å¦éœ€è¦ç»ˆæ­¢ï¼ˆåœ¨å»¶è¿Ÿå‰å†æ¬¡æ£€æŸ¥ï¼‰
                                if (shouldStop.value) {
                                    addLog('ğŸ›‘ æ“ä½œå·²è¢«ç”¨æˆ·ç»ˆæ­¢', 'warning');
                                    break;
                                }

                                // æ·»åŠ å»¶è¿Ÿé¿å…é¢‘ç‡è¿‡å¿«ï¼ˆæ³¨æ„ï¼šAPIå†…éƒ¨å·²ç»æœ‰10ç§’å»¶è¿Ÿï¼‰
                                if (i < selectedUsers.value.length - 1) {
                                    addLog('ç­‰å¾… 2 ç§’åç»§ç»­...', 'info');
                                    await new Promise(resolve => setTimeout(resolve, 2000));
                                }

                            } catch (error) {
                                failCount++;
                                addLog(`âŒ [${i + 1}/${selectedUsers.value.length}] å¼‚å¸¸ï¼š${user.unique_id} - ${error.message}`, 'error');

                                // æ£€æŸ¥æ˜¯å¦éœ€è¦ç»ˆæ­¢
                                if (shouldStop.value) {
                                    addLog('ğŸ›‘ æ“ä½œå·²è¢«ç”¨æˆ·ç»ˆæ­¢', 'warning');
                                    break;
                                }
                            }
                        }
                    } catch (error) {
                        addLog(`æ‰¹é‡æ·»åŠ å¤±è´¥: ${error.message}`, 'error');
                        ElMessage.error('æ‰¹é‡æ·»åŠ å¤±è´¥: ' + error.message);
                    }

                    isProcessing.value = false;
                    shouldStop.value = false;

                    if (shouldStop.value) {
                        addLog(`ğŸ›‘ æ“ä½œå·²ç»ˆæ­¢ï¼æˆåŠŸï¼š${successCount}ï¼Œå¤±è´¥ï¼š${failCount}ï¼Œè·³è¿‡ï¼š${skipCount}`, 'warning');
                        ElMessage.warning(`æ“ä½œå·²ç»ˆæ­¢ï¼æˆåŠŸï¼š${successCount}ï¼Œå¤±è´¥ï¼š${failCount}ï¼Œè·³è¿‡ï¼š${skipCount}`);
                    } else {
                        addLog(`ğŸ‰ æ‰¹é‡æ·»åŠ å®Œæˆï¼æˆåŠŸï¼š${successCount}ï¼Œå¤±è´¥ï¼š${failCount}ï¼Œè·³è¿‡ï¼š${skipCount}`, 'success');
                        ElMessage.success(`æ‰¹é‡æ·»åŠ å®Œæˆï¼æˆåŠŸï¼š${successCount}ï¼Œå¤±è´¥ï¼š${failCount}ï¼Œè·³è¿‡ï¼š${skipCount}`);
                    }

                    // åˆ·æ–°æ“ä½œæ—¥å¿—
                    loadUserLogs();

                    // æ¸…ç©ºé€‰æ‹©
                    selectedUsers.value = [];
                };

                // åŠ è½½ç”¨æˆ·æ—¥å¿—
                const loadUserLogs = async () => {
                    loadingLogs.value = true;
                    try {
                        const api = await waitForApi();
                        const result = await api.get_user_logs();
                        if (result && result.success) {
                            userLogs.value = result.data || [];
                            // æ›´æ–°å·²æ·»åŠ ç”¨æˆ·é›†åˆ
                            const addedIds = new Set();
                            userLogs.value.forEach(log => {
                                if (log.status === 1 && log.wechat_id) {
                                    addedIds.add(log.wechat_id);
                                }
                            });
                            addedUserIds.value = addedIds;
                            addLog(`âœ… åŠ è½½äº† ${userLogs.value.length} æ¡æ“ä½œæ—¥å¿—`, 'success');
                        }
                    } catch (error) {
                        console.error('åŠ è½½ç”¨æˆ·æ—¥å¿—å¤±è´¥:', error);
                        addLog('âŒ åŠ è½½ç”¨æˆ·æ—¥å¿—å¤±è´¥ï¼š' + error.message, 'error');
                    } finally {
                        loadingLogs.value = false;
                    }
                };

                // æ¸…ç©ºç”¨æˆ·æ—¥å¿—
                const clearUserLogs = async () => {
                    try {
                        await ElMessageBox.confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ“ä½œæ—¥å¿—å—ï¼Ÿ', 'ç¡®è®¤æ¸…ç©º', {
                            confirmButtonText: 'ç¡®å®š',
                            cancelButtonText: 'å–æ¶ˆ',
                            type: 'warning',
                        });

                        const api = await waitForApi();
                        const result = await api.clear_user_logs();
                        if (result && result.success) {
                            userLogs.value = [];
                            addLog('âœ… å·²æ¸…ç©ºæ‰€æœ‰æ“ä½œæ—¥å¿—', 'success');
                            ElMessage.success('æ“ä½œæ—¥å¿—å·²æ¸…ç©º');
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('æ¸…ç©ºç”¨æˆ·æ—¥å¿—å¤±è´¥:', error);
                            addLog('âŒ æ¸…ç©ºç”¨æˆ·æ—¥å¿—å¤±è´¥ï¼š' + error.message, 'error');
                        }
                    }
                };

                // æ ¼å¼åŒ–æ—¶é—´
                const formatTime = (timeStr) => {
                    if (!timeStr) return '-';
                    const date = new Date(timeStr);
                    return date.toLocaleString('zh-CN');
                };

                // æŸ¥çœ‹æˆªå›¾
                const viewScreenshot = (imgPath) => {
                    if (imgPath) {
                        // è¿™é‡Œå¯ä»¥å®ç°æˆªå›¾æŸ¥çœ‹åŠŸèƒ½
                        ElMessage.info('æˆªå›¾æŸ¥çœ‹åŠŸèƒ½å¾…å®ç°');
                    }
                };

                // ç»„ä»¶æŒ‚è½½æ—¶åˆå§‹åŒ–
                onMounted(() => {
                    addLog('å¾®ä¿¡è‡ªåŠ¨åŒ–å·¥å…·å·²å¯åŠ¨', 'success');
                    addLog('æ­£åœ¨åˆå§‹åŒ–æ•°æ®...', 'info');

                    // å»¶è¿ŸåŠ è½½ç¡®ä¿APIå°±ç»ª
                    setTimeout(() => {
                        loadUsers();
                        loadPhrases();
                        loadUserLogs();
                        checkWechatStatus();
                    }, 1000);

                    // åˆå§‹åŒ–ç­›é€‰æ•°æ®
                    filteredUsers.value = [...users.value];
                });

                return {
                    // æ•°æ®
                    users,
                    selectedUsers,
                    phrases,
                    activePhrases,
                    selectedPhrases,
                    filteredUsers,
                    userSearchText,
                    followerFilter,
                    addedUserIds,
                    userLogs,

                    // è¡¨å•æ•°æ®
                    selectedPhrase,
                    customMessage,

                    // çŠ¶æ€
                    isProcessing,
                    shouldStop,
                    statusChecking,
                    loadingUsers,
                    loadingPhrases,
                    loadingLogs,
                    wechatStatus,
                    showUserDialog,
                    showPhraseDialog,
                    activeTab,

                    // æ§åˆ¶å°
                    consoleLogs,
                    consoleContainer,

                    // æ–¹æ³•
                    loadUsers,
                    loadPhrases,
                    loadUserLogs,
                    clearUserLogs,
                    formatTime,
                    viewScreenshot,
                    handleSelectionChange,
                    selectAllUsersInDialog,
                    clearUserSelectionInDialog,
                    confirmUserSelection,
                    handleUserDialogClose,
                    isPhraseSelected,
                    togglePhraseSelection,
                    selectAllPhrases,
                    clearPhraseSelection,
                    confirmPhraseSelection,
                    handlePhraseDialogClose,
                    selectAllUsers,
                    clearSelection,
                    clearAllSelections,
                    stopProcessing,
                    onPhraseChange,
                    addSingleFriend,
                    batchAddFriends,
                    checkWechatStatus,
                    clearConsole,
                    scrollToBottom,
                    getLogClass,
                    // ç­›é€‰ç›¸å…³
                    filterUsers,
                    formatFollowerCount,
                    isUserAdded,
                    // refs
                    userTable
                };
            }
        });

        // æ³¨å†Œæ‰€æœ‰å›¾æ ‡
        Object.keys(ElementPlusIconsVue).forEach(key => {
            app.component(key, ElementPlusIconsVue[key]);
        });

        app.use(ElementPlus).mount('#app');
    </script>
</body>
</html>
