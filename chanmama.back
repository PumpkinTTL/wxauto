import requests 
import random 
import time 
from cmm import get_latest_token
from proxies_util import static_proxies,filter_https_proxies
baseUrl = 'https://api-service.chanmama.com/v1/author/detail/info?author_id='
import json
from cmm import extract_contact_code
# è·å–çœŸå®æ•°æ®

def getRealInfo(token,id,hasProxies=None):
     
        headers = {
        'origin': 'https://www.chanmama.com',
        'referer': 'https://www.chanmama.com/',
        'user-agent': 'Mozilla/5.0 (iPhone; CPU iPhone OS 16_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.5 Mobile/15E149 Safari/605.1',
        'x-client-hash': '4e75f486521cd94kejhrkuheukgerh71142b5dd4ad628f72f616c4',
        'x-client-id': 'kjiogjkerheheh',
        'x-client-version': '3',
        'x-encrypt-version': '4',
        'x-platform-id': '100000',
        'cookie': f'LOGIN-TOKEN-FORSNS={token}' if token else ''
    }
        # é“¾æ¥åœ°å€
        url = f"{baseUrl}{id}"
        if hasProxies:
            proxies = {
            "http": f"http://{hasProxies}",
            "https": f"http://{hasProxies}"
        }
            print('ä½¿ç”¨äº†ä»£ç†')
            try:
                res = requests.get(url, headers=headers, proxies=proxies, verify=False, timeout=5)
                try:
                    jsonData = res.json().get('data')
                except Exception as e:
                    errMsg = res.json().get('errMsg')
                    errCode = res.json().get('errCode')
                    print(f"âŒ ä¸å­˜åœ¨dataå¯èƒ½æ˜¯å¼‚åœ°ç™»å½•æˆ–é£æ§: {e}")
                    return {
                        'errCode':errCode,
                        'errMsg':errMsg,
                        'success':False,
                    
                    }
                # æˆåŠŸå“åº”æ•°æ®
                jsonData = res.json().get('data')
                # ç­¾å
                Signature = jsonData.get('signature')
                unique = jsonData.get('unique_id')
                return {
                    'signature':Signature,
                    'unique':unique,
                    'success':True,
                    'code': extract_contact_code(Signature) if extract_contact_code(Signature) else 'None'
                }
            except Exception as e:
                print(f"è¯·æ±‚å‘ç”Ÿå¼‚å¸¸å¯èƒ½æ˜¯ä»£ç†ä¸å¯ç”¨")
                res = False
        else:
            print('æ²¡æœ‰ä½¿ç”¨ä»£ç†')
            try:
                res = requests.get(url, headers=headers, verify=False, timeout=5)
                print(res.json())
            except Exception as e:
                print(f"æœªçŸ¥å¼‚å¸¸: {e}")
                res = False
            
        return res
# ä½¿ç”¨åŸç”Ÿipè¯·æ±‚
def defaultIPRequest():
    getRealInfo(get_latest_token(), "HyTis_zzQryI88eovWCFtB1NW-aPBspR")

def login():
    pass

   

if __name__ == "__main__":
    # è™šæ‹Ÿè‰å¦ˆå¦ˆ id åˆ—è¡¨
    datas = ['Te4oLu6PzddK8v0S_JURlE20CMuhagMW',
             'HyTis_zzQryI88eovWCFtB1NW-aPBspR',
             'VsVcTFNUhL-aDPQlN6FEPg','VsVcTFNUhL-aDPQlN6FEPg','VsVcTFNUhL-aDPQlN6FEPg',
             'VsVcTFNUhL-aDPQlN6FEPg','VsVcTFNUhL-aDPQlN6FEPg','VsVcTFNUhL-aDPQlN6FEPg',
             'VsVcTFNUhL-aDPQlN6FEPg','VsVcTFNUhL-aDPQlN6FEPg','VsVcTFNUhL-aDPQlN6FEPg',
             'VsVcTFNUhL-aDPQlN6FEPg','VsVcTFNUhL-aDPQlN6FEPg','VsVcTFNUhL-aDPQlN6FEPg',
             'VsVcTFNUhL-aDPQlN6FEPg','VsVcTFNUhL-aDPQlN6FEPg','VsVcTFNUhL-aDPQlN6FEPg']
    count = 0
    currentProxy = '147.28.240.214:9401'
    token = get_latest_token()
    needCount = 5
    print(f"ğŸ“Š æ­£åœ¨è¿‡æ»¤ä»£ç†æ± å¯ç”¨çŠ¶æ€...éœ€è¦{needCount}ä¸ªå¯ç”¨ä»£ç†")
    # é˜»å¡
    proxies = filter_https_proxies(static_proxies,needed_count=needCount)
    
    # proxies = [
    #     '147.28.240.215:443',
    #     '147.28.240.216:443',
    #     '147.28.240.217:443',
    #     '147.28.240.218:443',
    #     '147.28.240.214:9401',
    # ]
    # ç´¢å¼•clear
    index = 0
    # è®¡æ•°
    count=0
    # è®°å½•å½“å‰å¯ç”¨IP
    availableProxy = None
    for item in datas:
        result={}
        print(f"å½“å‰å¤„ç†:{item}")
        while availableProxy is not None and count<10:
            result = getRealInfo(token,item,availableProxy)
            
            if(result==False):
                print(f'å¤ç”¨å½“å‰ä»£ç†:{availableProxy}ä¸å¯ç”¨')
                availableProxy = None
                count = 0
                index+=1
                if index >= len(proxies):
                    print(f'å½“å‰ä½æ± ä¸­æœ€åä¸€ä¸ªip,åˆå§‹åŒ–å›åŸä½ç½®...')
                    index = 0
                break
            else:
                 count+=1
                 print(f'å¤ç”¨å½“å‰ä»£ç†:{availableProxy}å¯ç”¨,ä½¿ç”¨{count}æ¬¡') 
                 
            if count>=10:
                availableProxy = None
                count = 0
                index+=1
                if index >= len(proxies):
                    print(f'å½“å‰ä½æ± ä¸­æœ€åä¸€ä¸ªip,åˆå§‹åŒ–å›åŸä½ç½®...')
                    index = 0
                print(f'å·²å¤ç”¨10æ¬¡åˆ‡æ¢è‡³ä¸‹ä¸€ä¸ªip->:{proxies[index]}')
            break
           
         
        while True:
            # ä¸´æ—¶ä»£ç†
            _tmp = proxies[index]
            result = getRealInfo(token,item,_tmp)
            if(result==False):
                print(f'å½“å‰ä»£ç†:{_tmp}ä¸å¯ç”¨')
                index += 1
                if index >= len(proxies):
                    print(f'å½“å‰ä½æ± ä¸­æœ€åä¸€ä¸ªip,åˆå§‹åŒ–å›åŸä½ç½®...')
                    index = 0
                print(f'åˆ‡æ¢è‡³:{proxies[index]}')
                # å¾ªç¯å›æ¥
                if index >= len(proxies):
                    index = 0
                continue
            else:
                print(result)
                count+=1
                print(f'å½“å‰ä»£ç†:{_tmp}å¯ç”¨,ä½¿ç”¨{count}æ¬¡')
                availableProxy = _tmp
                break
        if(result.get('success')):
            print(f"æˆåŠŸè·å–æ•°æ®:")
        else:
            print(f"âŒ è¯·æ±‚å¤±è´¥: {result.get('errMsg')}-ç¨‹åºç»ˆæ­¢")
            # è§¦å‘é£æ§ä»¥åéšæ„è¯·æ±‚ä¸€ä¸ªæ¥å£è®©ç›®æ ‡æœåŠ¡å™¨ä¿å­˜ç›´è¿IP
            defaultIPRequest()
            break
       
