#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
å®Œæ•´ä»»åŠ¡ç®¡ç†ç³»ç»Ÿæ¼”ç¤ºè„šæœ¬
å±•ç¤ºä»ç›´æ’­æé†’ã€è‡ªåŠ¨è·Ÿæ’­åˆ°ä»»åŠ¡æ—¥å¿—ç®¡ç†çš„å®Œæ•´æµç¨‹
"""

import sys
import os
import time
from datetime import datetime, timedelta

# æ·»åŠ å½“å‰ç›®å½•åˆ°è·¯å¾„
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

def demo_complete_workflow():
    """æ¼”ç¤ºå®Œæ•´çš„ä»»åŠ¡ç®¡ç†å·¥ä½œæµç¨‹"""
    print("ğŸš€ å®Œæ•´ä»»åŠ¡ç®¡ç†ç³»ç»Ÿæ¼”ç¤º")
    print("=" * 60)
    
    try:
        # 1. åˆå§‹åŒ–ç³»ç»Ÿ
        print("\nğŸ”§ æ­¥éª¤1: åˆå§‹åŒ–ä»»åŠ¡ç®¡ç†ç³»ç»Ÿ")
        from task_manager import get_task_manager
        from apis import API
        
        task_manager = get_task_manager()
        if not task_manager.is_running:
            task_manager.start()
        
        api = API()
        print("âœ… ä»»åŠ¡ç®¡ç†å™¨å·²å¯åŠ¨")
        
        # 2. åˆ›å»ºç›´æ’­æé†’ä»»åŠ¡
        print("\nâ° æ­¥éª¤2: åˆ›å»ºç›´æ’­æé†’ä»»åŠ¡")
        
        # è®¾ç½®5åˆ†é’Ÿåçš„æé†’
        reminder_time = datetime.now() + timedelta(minutes=5)
        
        success = task_manager.add_live_reminder(
            room_id=70,
            run_time=reminder_time,
            remark="æ¼”ç¤ºç›´æ’­æé†’ - 5åˆ†é’Ÿåè‡ªåŠ¨è·Ÿæ’­"
        )
        
        if success:
            print(f"âœ… ç›´æ’­æé†’å·²è®¾ç½®: {reminder_time.strftime('%H:%M:%S')}")
            print("ğŸ’¡ æé†’å€’è®¡æ—¶ç»“æŸåå°†è‡ªåŠ¨åˆ›å»ºè·Ÿæ’­ä»»åŠ¡")
        
        # 3. ç«‹å³åˆ›å»ºè·Ÿæ’­ä»»åŠ¡
        print("\nğŸ¯ æ­¥éª¤3: åˆ›å»ºç«‹å³è·Ÿæ’­ä»»åŠ¡")
        
        follow_success = task_manager.add_immediate_follow_task(
            room_ids=[70],
            room_names=["å‚åŠç‰™è†å·¥å‚åº—"],
            remark="æ¼”ç¤ºç«‹å³è·Ÿæ’­ä»»åŠ¡"
        )
        
        if follow_success:
            print("âœ… ç«‹å³è·Ÿæ’­ä»»åŠ¡å·²åˆ›å»º")
        
        # 4. åˆ›å»ºæµ‹è¯•è·Ÿæ’­ä»»åŠ¡
        print("\nğŸ§ª æ­¥éª¤4: åˆ›å»ºæµ‹è¯•è·Ÿæ’­ä»»åŠ¡ï¼ˆä»…æµ‹è¯•ï¼Œä¸å®é™…å‘é€ï¼‰")
        
        test_follow_data = [
            {"id": 70, "name": "å‚åŠç‰™è†å·¥å‚åº—", "platform": "wechat"}
        ]
        
        test_result = api.start_test_follow(test_follow_data)
        if test_result.get('success'):
            print("âœ… æµ‹è¯•è·Ÿæ’­ä»»åŠ¡å·²åˆ›å»º")
            print("ğŸ’¡ å°†è¿›å…¥ç›´æ’­é—´æµ‹è¯•æ‰€æœ‰è¯æœ¯ï¼Œæ¯7ç§’åˆ‡æ¢ä¸€æ¬¡")
        
        # 5. ç­‰å¾…ä»»åŠ¡æ‰§è¡Œ
        print("\nâ³ æ­¥éª¤5: ç­‰å¾…ä»»åŠ¡æ‰§è¡Œï¼ˆ10ç§’ï¼‰")
        for i in range(10):
            print(f"ç­‰å¾…ä¸­... {10-i} ç§’", end='\r')
            time.sleep(1)
        print()
        
        # 6. æŸ¥çœ‹ä»»åŠ¡çŠ¶æ€
        print("\nğŸ“Š æ­¥éª¤6: æŸ¥çœ‹ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€")
        
        task_list_result = api.get_task_list()
        if task_list_result.get('success'):
            tasks = task_list_result.get('data', [])
            active_tasks = [task for task in tasks if task.get('status') == 1]
            
            print(f"ğŸ“‹ å½“å‰æ´»è·ƒä»»åŠ¡: {len(active_tasks)} ä¸ª")
            
            for task in active_tasks[-5:]:  # æ˜¾ç¤ºæœ€æ–°çš„5ä¸ªä»»åŠ¡
                print(f"   - {task.get('task_type')} | {task.get('remark', 'æ— å¤‡æ³¨')} | {task.get('create_time')}")
        
        # 7. æŸ¥çœ‹ä»»åŠ¡æ—¥å¿—
        print("\nğŸ“ æ­¥éª¤7: æŸ¥çœ‹ä»»åŠ¡æ‰§è¡Œæ—¥å¿—")
        
        log_result = api.get_task_logs(10)
        if log_result.get('success'):
            logs = log_result.get('data', [])
            
            print(f"ğŸ“„ æœ€è¿‘ä»»åŠ¡æ—¥å¿—: {len(logs)} æ¡")
            
            for log in logs[-5:]:  # æ˜¾ç¤ºæœ€æ–°çš„5æ¡æ—¥å¿—
                status_text = "âœ… æˆåŠŸ" if log.get('status') == 1 else "âŒ å¤±è´¥"
                print(f"   {status_text} | {log.get('message', 'æ— æ¶ˆæ¯')} | {log.get('execution_time')}")
        
        # 8. æ¼”ç¤ºä»»åŠ¡å¤±æ•ˆåŠŸèƒ½
        print("\nâŒ æ­¥éª¤8: æ¼”ç¤ºä»»åŠ¡å¤±æ•ˆåŠŸèƒ½")
        
        if active_tasks:
            # é€‰æ‹©ç¬¬ä¸€ä¸ªä»»åŠ¡è¿›è¡Œå¤±æ•ˆ
            task_to_invalidate = active_tasks[0]
            task_id = task_to_invalidate.get('task_id')
            
            invalidate_result = api.invalidate_task(task_id)
            if invalidate_result.get('success'):
                print(f"âœ… ä»»åŠ¡å·²å¤±æ•ˆ: {task_id}")
                print("ğŸ’¡ ç”¨æˆ·å¯ä»¥æ‰‹åŠ¨ä½¿ä¸éœ€è¦çš„ä»»åŠ¡å¤±æ•ˆ")
        
        # 9. åŠŸèƒ½æ€»ç»“
        print("\nğŸ¯ æ­¥éª¤9: ç³»ç»ŸåŠŸèƒ½æ€»ç»“")
        
        print("âœ… å®Œæ•´ä»»åŠ¡ç®¡ç†ç³»ç»Ÿå·²æ¼”ç¤ºå®Œæˆï¼")
        print("\nğŸ“Œ æ ¸å¿ƒåŠŸèƒ½:")
        print("   1. âœ… ç›´æ’­æé†’ â†’ è‡ªåŠ¨è·Ÿæ’­é“¾è·¯")
        print("   2. âœ… ç«‹å³è·Ÿæ’­ä»»åŠ¡")
        print("   3. âœ… æµ‹è¯•è·Ÿæ’­ï¼ˆè¯æœ¯æµ‹è¯•ï¼Œä¸å®é™…å‘é€ï¼‰")
        print("   4. âœ… ä»»åŠ¡çŠ¶æ€æ£€æŸ¥ï¼ˆé˜²æ­¢é‡å¤æ‰§è¡Œï¼‰")
        print("   5. âœ… è¯¦ç»†ä»»åŠ¡æ—¥å¿—è®°å½•")
        print("   6. âœ… ç”¨æˆ·æ‰‹åŠ¨å¤±æ•ˆä»»åŠ¡")
        print("   7. âœ… é‡è¯•æœºåˆ¶ï¼ˆå¤±è´¥è‡ªåŠ¨é‡è¯•ï¼‰")
        print("   8. âœ… å¯è§†åŒ–ç•Œé¢ï¼ˆå‰ç«¯ç®¡ç†ï¼‰")
        
        print("\nğŸ’¡ æ”¹è¿›çš„åŠŸèƒ½:")
        print("   - ğŸ”§ ä¿®å¤äº†liveEndå‡½æ•°é€»è¾‘é”™è¯¯")
        print("   - ğŸ“ å¢å¼ºäº†å¤±è´¥åŸå› è®°å½•ï¼ˆå¾®ä¿¡çŠ¶æ€ã€ç½‘ç»œã€ç›´æ’­é—´åç§°ç­‰ï¼‰")
        print("   - ğŸ¯ å®ç°äº†è¯æœ¯æµ‹è¯•åŠŸèƒ½ï¼ˆ7ç§’é—´éš”åˆ‡æ¢ï¼‰")
        print("   - ğŸ—„ï¸ åˆ›å»ºäº†task_logè¡¨è¿›è¡Œæ—¥å¿—ç®¡ç†")
        print("   - ğŸ–¥ï¸ æ·»åŠ äº†ä»»åŠ¡ç®¡ç†å¯è§†åŒ–ç•Œé¢")
        
        return True
        
    except Exception as e:
        print(f"âŒ æ¼”ç¤ºè¿‡ç¨‹å‡ºç°å¼‚å¸¸: {str(e)}")
        return False

def show_system_architecture():
    """å±•ç¤ºç³»ç»Ÿæ¶æ„"""
    print("\nğŸ—ï¸ ç³»ç»Ÿæ¶æ„å›¾")
    print("=" * 60)
    print("""
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   å‰ç«¯ç•Œé¢      â”‚    â”‚   APIæ¥å£å±‚     â”‚    â”‚   ä»»åŠ¡ç®¡ç†å™¨    â”‚
    â”‚  (Vue + El)     â”‚â—„â”€â”€â–ºâ”‚  (Flask)        â”‚â—„â”€â”€â–ºâ”‚ (APScheduler)   â”‚
    â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
    â”‚ â€¢ ä»»åŠ¡åˆ—è¡¨      â”‚    â”‚ â€¢ ä»»åŠ¡CRUD      â”‚    â”‚ â€¢ ä»»åŠ¡è°ƒåº¦      â”‚
    â”‚ â€¢ æ—¥å¿—æŸ¥çœ‹      â”‚    â”‚ â€¢ æ—¥å¿—æŸ¥è¯¢      â”‚    â”‚ â€¢ çŠ¶æ€ç®¡ç†      â”‚
    â”‚ â€¢ å¤±æ•ˆæ§åˆ¶      â”‚    â”‚ â€¢ çŠ¶æ€æ§åˆ¶      â”‚    â”‚ â€¢ é‡è¯•æœºåˆ¶      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                       â”‚                       â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   SQLiteæ•°æ®åº“  â”‚    â”‚   è·Ÿæ’­æ‰§è¡Œå™¨    â”‚    â”‚   é€šçŸ¥ç³»ç»Ÿ      â”‚
    â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
    â”‚ â€¢ tasksè¡¨       â”‚â—„â”€â”€â–ºâ”‚ â€¢ å¾®ä¿¡è‡ªåŠ¨åŒ–    â”‚â—„â”€â”€â–ºâ”‚ â€¢ æ¡Œé¢é€šçŸ¥      â”‚
    â”‚ â€¢ task_logè¡¨    â”‚    â”‚ â€¢ è¯æœ¯å‘é€      â”‚    â”‚ â€¢ çŠ¶æ€åé¦ˆ      â”‚
    â”‚ â€¢ çŠ¶æ€ç®¡ç†      â”‚    â”‚ â€¢ æµ‹è¯•æ¨¡å¼      â”‚    â”‚ â€¢ é”™è¯¯æç¤º      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    """)
    
    print("\nğŸ”„ ä»»åŠ¡æµç¨‹:")
    print("1. ç”¨æˆ·åˆ›å»ºç›´æ’­æé†’ â†’ 2. å€’è®¡æ—¶ç»“æŸè‡ªåŠ¨è§¦å‘è·Ÿæ’­")
    print("3. æ£€æŸ¥ä»»åŠ¡çŠ¶æ€ â†’ 4. æ‰§è¡Œè·Ÿæ’­/æµ‹è¯• â†’ 5. è®°å½•æ—¥å¿—")
    print("6. å¤±è´¥è‡ªåŠ¨é‡è¯• â†’ 7. ç”¨æˆ·å¯è§†åŒ–ç®¡ç†")

def main():
    """ä¸»å‡½æ•°"""
    print("ğŸŒŸ å®Œæ•´ä»»åŠ¡ç®¡ç†ç³»ç»Ÿæ¼”ç¤ºç¨‹åº")
    print("ğŸ“ å±•ç¤ºä»ç›´æ’­æé†’åˆ°è·Ÿæ’­æ‰§è¡Œçš„å®Œæ•´è‡ªåŠ¨åŒ–æµç¨‹")
    print()
    
    # æ˜¾ç¤ºç³»ç»Ÿæ¶æ„
    show_system_architecture()
    
    # æ‰§è¡Œå®Œæ•´æ¼”ç¤º
    if demo_complete_workflow():
        print("\nğŸ‰ æ¼”ç¤ºå®Œæˆï¼ç³»ç»Ÿè¿è¡Œæ­£å¸¸ï¼")
        print("\nğŸ“– ä½¿ç”¨æŒ‡å—:")
        print("   - æµè§ˆå™¨è®¿é—®: http://localhost:5000/follow_wechat")
        print("   - æŸ¥çœ‹ä»»åŠ¡ç®¡ç†å’Œæ—¥å¿—ç•Œé¢")
        print("   - åˆ›å»ºè·Ÿæ’­ä»»åŠ¡å’Œæµ‹è¯•ä»»åŠ¡")
        print("   - ç›‘æ§ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€")
        
        return True
    else:
        print("\nâš ï¸ æ¼”ç¤ºè¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ç³»ç»Ÿé…ç½®")
        return False

if __name__ == "__main__":
    main()