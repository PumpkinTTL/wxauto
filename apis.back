# äº¤äº’æ–‡ä»¶
import time
import threading


# æ ¸å¿ƒåº“å¯¼å…¥
try:
    import openpyxl
except ImportError as e:
    print(f"âš ï¸ openpyxlåº“å¯¼å…¥å¤±è´¥: {e}")
    openpyxl = None

try:
    from sqlite3_util import (
        batch_insert, query_users, get_users_count, verify_insert_result,
        query_wechat_phrases, add_wechat_phrase, update_wechat_phrase, delete_wechat_phrase,
        add_user_log, query_user_logs
    )
except ImportError as e:
    print(f"âš ï¸ sqlite3_utilæ¨¡å—å¯¼å…¥å¤±è´¥: {e}")
    batch_insert = query_users = get_users_count = verify_insert_result = None
    query_wechat_phrases = add_wechat_phrase = update_wechat_phrase = delete_wechat_phrase = None
    add_user_log = query_user_logs = None

# å¾®ä¿¡è‡ªåŠ¨åŒ–å¯¼å…¥
try:
    from wechat_automation import WeChatAutomation
    WECHAT_AUTOMATION_AVAILABLE = True
except ImportError as e:
    print(f"âš ï¸ å¾®ä¿¡è‡ªåŠ¨åŒ–æ¨¡å—å¯¼å…¥å¤±è´¥: {e}")
    WeChatAutomation = None
    WECHAT_AUTOMATION_AVAILABLE = False

# å…¨å±€æ§åˆ¶å°è¾“å‡ºå˜é‡
GLOBAL_CONSOLE_OUTPUT = {
    "logs": [],  # æ§åˆ¶å°æ—¥å¿—åˆ—è¡¨
    "is_processing": False,  # æ˜¯å¦æ­£åœ¨å¤„ç†
    "current_status": "idle",  # å½“å‰çŠ¶æ€: idle, processing, completed, error
    "current_message": "",  # å½“å‰çŠ¶æ€æ¶ˆæ¯
    "progress": 0,  # è¿›åº¦ç™¾åˆ†æ¯” 0-100
    "last_update": time.time()
}

# å…¨å±€å–æ¶ˆæ ‡å¿—
PROCESSING_CANCELLED = False

# çº¿ç¨‹é”
console_lock = threading.Lock()

def add_console_log(message, log_type="info"):
    """æ·»åŠ æ§åˆ¶å°æ—¥å¿—"""
    global GLOBAL_CONSOLE_OUTPUT

    with console_lock:
        log_entry = {
            "timestamp": time.time(),
            "time_str": time.strftime("%H:%M:%S", time.localtime()),
            "message": message,
            "type": log_type  # info, success, warning, error
        }

        GLOBAL_CONSOLE_OUTPUT["logs"].append(log_entry)

        # é™åˆ¶æ—¥å¿—æ•°é‡ï¼Œåªä¿ç•™æœ€æ–°50æ¡
        if len(GLOBAL_CONSOLE_OUTPUT["logs"]) > 50:
            GLOBAL_CONSOLE_OUTPUT["logs"] = GLOBAL_CONSOLE_OUTPUT["logs"][-50:]

        GLOBAL_CONSOLE_OUTPUT["last_update"] = time.time()

        # åŒæ—¶æ‰“å°åˆ°æ§åˆ¶å°
        print(f"[{log_entry['time_str']}] {message}")

def update_console_status(status="idle", message="", progress=0, is_processing=False):
    """æ›´æ–°æ§åˆ¶å°çŠ¶æ€"""
    global GLOBAL_CONSOLE_OUTPUT

    with console_lock:
        GLOBAL_CONSOLE_OUTPUT["current_status"] = status
        GLOBAL_CONSOLE_OUTPUT["current_message"] = message
        GLOBAL_CONSOLE_OUTPUT["progress"] = progress
        GLOBAL_CONSOLE_OUTPUT["is_processing"] = is_processing
        GLOBAL_CONSOLE_OUTPUT["last_update"] = time.time()

def get_console_output():
    """è·å–æ§åˆ¶å°è¾“å‡º"""
    global GLOBAL_CONSOLE_OUTPUT

    with console_lock:
        return GLOBAL_CONSOLE_OUTPUT.copy()

def reset_console_output():
    """é‡ç½®æ§åˆ¶å°è¾“å‡º"""
    global GLOBAL_CONSOLE_OUTPUT

    with console_lock:
        GLOBAL_CONSOLE_OUTPUT["logs"] = []
        GLOBAL_CONSOLE_OUTPUT["is_processing"] = False
        GLOBAL_CONSOLE_OUTPUT["current_status"] = "idle"
        GLOBAL_CONSOLE_OUTPUT["current_message"] = ""
        GLOBAL_CONSOLE_OUTPUT["progress"] = 0
        GLOBAL_CONSOLE_OUTPUT["last_update"] = time.time()

def cancel_processing():
    """å–æ¶ˆå½“å‰å¤„ç†"""
    global PROCESSING_CANCELLED
    PROCESSING_CANCELLED = True
    add_console_log("ğŸ›‘ ç”¨æˆ·å–æ¶ˆå¤„ç†", "warning")
    update_console_status(status="cancelled", message="å¤„ç†å·²å–æ¶ˆ", is_processing=False)

    # è¿”å›å–æ¶ˆç»“æœï¼Œä½†è¿™é‡Œæ— æ³•è·å–å·²å¤„ç†æ•°æ®ï¼Œéœ€è¦åœ¨process_excel_fileä¸­å¤„ç†
    return {
        "success": True,
        "message": "å¤„ç†å·²å–æ¶ˆ",
        "cancelled": True
    }

def is_processing_cancelled():
    """æ£€æŸ¥æ˜¯å¦å·²å–æ¶ˆå¤„ç†"""
    return PROCESSING_CANCELLED

def reset_cancel_flag():
    """é‡ç½®å–æ¶ˆæ ‡å¿—"""
    global PROCESSING_CANCELLED
    PROCESSING_CANCELLED = False

def check_api_response_valid(real_data):
    """æ£€æŸ¥APIå“åº”æ˜¯å¦æœ‰æ•ˆï¼Œåˆ¤æ–­æ˜¯å¦è¢«é£æ§"""
    if not real_data:
        return False, "APIè¿”å›ç©ºæ•°æ®"

    if not isinstance(real_data, dict):
        return False, "APIè¿”å›æ•°æ®æ ¼å¼é”™è¯¯"

    # æ£€æŸ¥å…³é”®å­—æ®µ - åªæ£€æŸ¥unique_idï¼Œsignatureå¯ä»¥ä¸ºç©º
    if not real_data.get('unique_id'):
        return False, "APIè¿”å›æ•°æ®ä¸å®Œæ•´ï¼Œå¯èƒ½è¢«é£æ§æˆ–ç™»å½•å¤±æ•ˆ"

    return True, "æ•°æ®æœ‰æ•ˆ"

class API:
    def __init__(self):
        # å¯¼å…¥redisliteå’Œæ•°æ®åº“å·¥å…·
        try:
            from redislite import get_log_manager
            from sqlite3_util import add_user_log, query_user_logs, clear_user_logs, check_user_added
            self.log_manager = get_log_manager()
            self.add_user_log = add_user_log
            self.query_user_logs = query_user_logs
            self.clear_user_logs = clear_user_logs
            self.check_user_added = check_user_added
        except ImportError as e:
            print(f"å¯¼å…¥redisliteæˆ–æ•°æ®åº“å·¥å…·å¤±è´¥: {e}")
            self.log_manager = None

    def get_console_output(self):
        """è·å–æ§åˆ¶å°è¾“å‡º"""
        return get_console_output()

    def stop_processing(self, params=None):
        """ç»ˆæ­¢å½“å‰å¤„ç†"""
        global PROCESSING_CANCELLED
        PROCESSING_CANCELLED = True
        add_console_log("ğŸ›‘ ç”¨æˆ·è¯·æ±‚ç»ˆæ­¢æ“ä½œ", "warning")
        return {
            "success": True,
            "message": "ç»ˆæ­¢è¯·æ±‚å·²å‘é€"
        }

    def reset_console_output(self):
        """é‡ç½®æ§åˆ¶å°è¾“å‡º"""
        return reset_console_output()

    def cancel_processing(self):
        """å–æ¶ˆå½“å‰å¤„ç†"""
        return cancel_processing()

    def check_token_status(self):
        """æ£€æŸ¥tokençŠ¶æ€"""
        try:
            from cmm import get_latest_token
            token = get_latest_token()

            if token:
                return {
                    "success": True,
                    "has_token": True,
                    "token_preview": f"{token[:20]}...",
                    "message": "Tokenå¯ç”¨"
                }
            else:
                return {
                    "success": True,
                    "has_token": False,
                    "message": "æœªæ‰¾åˆ°æœ‰æ•ˆToken"
                }
        except Exception as e:
            return {
                "success": False,
                "has_token": False,
                "message": f"æ£€æŸ¥Tokenå¤±è´¥: {str(e)}"
            }



    def get_users_data(self, page=1, page_size=200, search_params=None):
        """
        è·å–ç”¨æˆ·æ•°æ®ï¼ˆåˆ†é¡µ+æœç´¢ï¼‰
        """
        try:
            print(f"=== æŸ¥è¯¢ç”¨æˆ·æ•°æ® ===")
            print(f"é¡µç : {page}, æ¯é¡µ: {page_size}")
            if search_params:
                print(f"æœç´¢æ¡ä»¶: {search_params}")

            # é¦–å…ˆæ£€æŸ¥æ•°æ®åº“å’Œè¡¨æ˜¯å¦å­˜åœ¨
            import os
            db_path = 'system.db'
            if not os.path.exists(db_path):
                print(f"âŒ æ•°æ®åº“æ–‡ä»¶ä¸å­˜åœ¨: {db_path}")
                return {
                    "success": False,
                    "message": "æ•°æ®åº“æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·å…ˆä¸Šä¼ Excelæ–‡ä»¶",
                    "data": [],
                    "total": 0
                }

            # æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
            conn = __import__('sqlite3').connect(db_path)
            cursor = conn.cursor()
            cursor.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='users'")
            table_exists = cursor.fetchone() is not None

            if not table_exists:
                conn.close()
                print(f"âŒ usersè¡¨ä¸å­˜åœ¨")
                return {
                    "success": False,
                    "message": "usersè¡¨ä¸å­˜åœ¨ï¼Œè¯·å…ˆä¸Šä¼ Excelæ–‡ä»¶",
                    "data": [],
                    "total": 0
                }

            # æ£€æŸ¥è¡¨ä¸­æ˜¯å¦æœ‰æ•°æ®
            cursor.execute("SELECT COUNT(*) FROM users")
            total_records = cursor.fetchone()[0]
            print(f"ğŸ“Š æ•°æ®åº“ä¸­æ€»è®°å½•æ•°: {total_records}")
            conn.close()

            # æ„å»ºæœç´¢æ¡ä»¶
            where_conditions = []
            params = []

            if search_params:
                if search_params.get('fileName'):
                    where_conditions.append("file_name LIKE ?")
                    params.append(f"%{search_params['fileName']}%")

                if search_params.get('description'):
                    where_conditions.append("intro LIKE ?")
                    params.append(f"%{search_params['description']}%")

                if search_params.get('phone'):
                    # è¿™é‡Œå‡è®¾phoneå­—æ®µå­˜åœ¨ï¼Œå¦‚æœæ²¡æœ‰å¯ä»¥æœç´¢unique_id
                    where_conditions.append("unique_id LIKE ?")
                    params.append(f"%{search_params['phone']}%")

                if search_params.get('wechat'):
                    # è¿™é‡Œå‡è®¾wechatå­—æ®µå­˜åœ¨ï¼Œå¦‚æœæ²¡æœ‰å¯ä»¥æœç´¢username
                    where_conditions.append("username LIKE ?")
                    params.append(f"%{search_params['wechat']}%")

            # æ„å»ºWHEREå­å¥
            where_clause = ""
            if where_conditions:
                where_clause = "WHERE " + " AND ".join(where_conditions)

            # æŸ¥è¯¢æ€»è®°å½•æ•°
            conn = __import__('sqlite3').connect('system.db')
            conn.row_factory = __import__('sqlite3').Row
            cursor = conn.cursor()

            count_sql = f"SELECT COUNT(*) FROM users {where_clause}"
            cursor.execute(count_sql, params)
            total_count = cursor.fetchone()[0]
            print(f"ç¬¦åˆæ¡ä»¶çš„æ€»è®°å½•æ•°: {total_count}")

            # è®¡ç®—åç§»é‡
            offset = (page - 1) * page_size

            # æŸ¥è¯¢æ•°æ®
            data_sql = f"""
                SELECT * FROM users
                {where_clause}
                ORDER BY create_time DESC
                LIMIT ? OFFSET ?
            """

            cursor.execute(data_sql, params + [page_size, offset])
            results = [dict(row) for row in cursor.fetchall()]
            conn.close()

            add_console_log(f"ğŸ“Š æŸ¥è¯¢åˆ° {len(results)} æ¡è®°å½•", "info")
            for i, record in enumerate(results[:3], 1):
                add_console_log(f"  {i}. {record.get('username')} - {record.get('cmm_id')}", "info")

            return {
                "success": True,
                "data": results,
                "total": total_count,
                "page": page,
                "page_size": page_size,
                "total_pages": (total_count + page_size - 1) // page_size,
                "search_params": search_params
            }

        except Exception as e:
            print(f"æŸ¥è¯¢ç”¨æˆ·æ•°æ®å¤±è´¥: {str(e)}")
            import traceback
            traceback.print_exc()
            return {
                "success": False,
                "message": f"æŸ¥è¯¢å¤±è´¥: {str(e)}",
                "data": [],
                "total": 0
            }

    # å¤„ç†æ–‡ä»¶å†…å®¹
    def process_file(self, file_data):
        """
        å¤„ç†å‰ç«¯ä¼ æ¥çš„æ–‡ä»¶æ•°æ®ï¼Œç›´æ¥åœ¨å†…å­˜ä¸­è¯»å–Excelå†…å®¹
        :param file_data: åŒ…å«æ–‡ä»¶ä¿¡æ¯å’Œå†…å®¹çš„å­—å…¸
        :return: å¤„ç†ç»“æœ
        """
        # æ£€æŸ¥å¿…è¦çš„åº“
        if openpyxl is None:
            return {
                "success": False,
                "message": "openpyxlåº“æœªå®‰è£…ï¼Œæ— æ³•å¤„ç†Excelæ–‡ä»¶"
            }

        try:
            # é‡ç½®å–æ¶ˆæ ‡å¿—
            reset_cancel_flag()

            # æ›´æ–°çŠ¶æ€ï¼šå¼€å§‹å¤„ç†
            update_console_status(status="processing", message="å¼€å§‹å¤„ç†Excelæ–‡ä»¶...", is_processing=True)
            add_console_log("ğŸš€ å¼€å§‹å¤„ç†Excelæ–‡ä»¶...", "info")

            if not file_data:
                add_console_log("âŒ æœªæ¥æ”¶åˆ°æ–‡ä»¶æ•°æ®", "error")
                update_console_status(status="error", message="æœªæ¥æ”¶åˆ°æ–‡ä»¶æ•°æ®", is_processing=False)
                return {
                    "success": False,
                    "message": "æœªæ¥æ”¶åˆ°æ–‡ä»¶æ•°æ®"
                }

            # æ£€æŸ¥å¿…è¦å­—æ®µ
            required_fields = ['name', 'content']
            for field in required_fields:
                if field not in file_data:
                    add_console_log(f"âŒ ç¼ºå°‘å¿…è¦å­—æ®µ: {field}", "error")
                    update_console_status(status="error", message=f"ç¼ºå°‘å¿…è¦å­—æ®µ: {field}", is_processing=False)
                    return {
                        "success": False,
                        "message": f"ç¼ºå°‘å¿…è¦å­—æ®µ: {field}"
                    }

            add_console_log(f"ğŸ“„ è¯»å–æ–‡ä»¶: {file_data['name']}", "info")
            add_console_log(f"ğŸ“Š æ–‡ä»¶å¤§å°: {file_data.get('size', 'unknown')} bytes", "info")

            # å°†å­—èŠ‚æ•°ç»„è½¬æ¢ä¸ºå­—èŠ‚å¯¹è±¡
            file_content = bytes(file_data['content'])
            print(f"è½¬æ¢åçš„å­—èŠ‚é•¿åº¦: {len(file_content)}")

            # ä½¿ç”¨BytesIOåœ¨å†…å­˜ä¸­åˆ›å»ºæ–‡ä»¶å¯¹è±¡
            from io import BytesIO
            # æ–‡ä»¶
            file_stream = BytesIO(file_content)

            # ä½¿ç”¨openpyxlç›´æ¥ä»å†…å­˜è¯»å–Excelæ–‡ä»¶
            add_console_log("ğŸ“Š å¼€å§‹è§£æExcelæ–‡ä»¶ç»“æ„", "info")
            update_console_status(status="processing", message="æ­£åœ¨è§£æExcelæ–‡ä»¶...", progress=10)
            workbook = openpyxl.load_workbook(file_stream)

            # è·å–å·¥ä½œè¡¨ä¿¡æ¯
            sheet_names = workbook.sheetnames
            add_console_log(f"ğŸ“‹ å‘ç° {len(sheet_names)} ä¸ªå·¥ä½œè¡¨", "success")

            # è¯»å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
            sheet = workbook.active
            add_console_log(f"ğŸ“„ å½“å‰å·¥ä½œè¡¨: {sheet.title} ({sheet.max_row}è¡Œ x {sheet.max_column}åˆ—)", "info")

            # è¯»å–è¡¨å¤´ï¼ˆç¬¬ä¸€è¡Œï¼‰
            headers = []
            for col in range(1, sheet.max_column + 1):
                cell_value = sheet.cell(row=1, column=col).value
                headers.append(str(cell_value) if cell_value else f"åˆ—{col}")

            add_console_log(f"ğŸ“ è¡¨å¤´: {', '.join(headers[:5])}{'...' if len(headers) > 5 else ''}", "info")

            # è¯»å–æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬è¶…é“¾æ¥
            add_console_log("ğŸ” å¼€å§‹æ‰«ææ•°æ®å’Œè¶…é“¾æ¥", "info")
            update_console_status(status="processing", message="æ­£åœ¨æ‰«ææ•°æ®å’Œè¶…é“¾æ¥...", progress=20)
            all_data = []
            hyperlinks_found = []

            for row in range(2, sheet.max_row + 1):  # ä»ç¬¬2è¡Œå¼€å§‹
                row_data = []
                row_hyperlinks = []

                for col in range(1, sheet.max_column + 1):
                    cell = sheet.cell(row=row, column=col)
                    cell_value = str(cell.value) if cell.value else ""
                    row_data.append(cell_value)

                    # æ£€æŸ¥æ˜¯å¦æœ‰è¶…é“¾æ¥
                    if cell.hyperlink:
                        hyperlink_info = {
                            'row': row,
                            'col': col,
                            'column_name': headers[col-1] if col-1 < len(headers) else f"åˆ—{col}",
                            'cell_value': cell_value,
                            'hyperlink': cell.hyperlink.target if cell.hyperlink.target else str(cell.hyperlink)
                        }
                        row_hyperlinks.append(hyperlink_info)
                        hyperlinks_found.append(hyperlink_info)
                        print(f"å‘ç°è¶…é“¾æ¥ - è¡Œ{row}åˆ—{col}({headers[col-1] if col-1 < len(headers) else f'åˆ—{col}'}): {cell_value} -> {hyperlink_info['hyperlink']}")

                all_data.append(row_data)

                # åªæ‰“å°å‰5è¡Œä½œä¸ºç¤ºä¾‹
                if row <= 6:
                    print(f"ç¬¬{row}è¡Œ: {row_data}")
                    if row_hyperlinks:
                        for link in row_hyperlinks:
                            print(f"  â””â”€ è¶…é“¾æ¥: {link['cell_value']} -> {link['hyperlink']}")

            add_console_log(f"âœ… æ•°æ®æ‰«æå®Œæˆï¼å‘ç° {len(hyperlinks_found)} ä¸ªè¶…é“¾æ¥", "success")
            update_console_status(status="processing", message=f"å‘ç° {len(hyperlinks_found)} ä¸ªè¶…é“¾æ¥", progress=40)

            # å¤„ç†è¶…é“¾æ¥
            if hyperlinks_found:
                add_console_log(f"ğŸ”— å¼€å§‹å¤„ç† {len(hyperlinks_found)} ä¸ªè¶…é“¾æ¥", "info")

                # æå–IDå¹¶ç»„è£…SQLiteæ•°æ®
                import re
                from datetime import datetime

                sqlite_data = []
                extracted_ids = []
                insert_success = False
                insert_message = "æœªæ‰§è¡Œæ•°æ®åº“æ’å…¥"

                # è·å–çˆ¬å–é…ç½®
                crawl_config = file_data.get('crawlConfig', {})
                sleep_interval = crawl_config.get('sleepInterval', 3)  # é»˜è®¤3ç§’
                add_console_log(f"âš™ï¸ çˆ¬å–é…ç½® - ä¼‘çœ é—´éš”: {sleep_interval}ç§’", "info")

                # å…ˆæå–æ‰€æœ‰ID
                add_console_log("ğŸ” æ­£åœ¨æå–æ‰€æœ‰è‰å¦ˆå¦ˆID...", "info")
                all_extracted_ids = []
                for link in hyperlinks_found:
                    url = link['hyperlink']
                    match = re.search(r'authorDetail/([^/?]+)', url)
                    if match:
                        author_id = match.group(1)
                        all_extracted_ids.append(author_id)

                add_console_log(f"ğŸ“Š ä»Excelä¸­æå–åˆ° {len(all_extracted_ids)} ä¸ªID", "info")

                # æ£€æŸ¥å“ªäº›IDå·²ç»å­˜åœ¨äºæ•°æ®åº“ä¸­
                add_console_log("ğŸ” æ£€æŸ¥æ•°æ®åº“ä¸­å·²å­˜åœ¨çš„ID...", "info")
                from sqlite3_util import check_existing_ids_in_users
                id_check_result = check_existing_ids_in_users('system.db', file_data['name'], all_extracted_ids)

                existing_count = id_check_result['existing_count']
                new_count = id_check_result['new_count']
                new_ids = id_check_result['new_ids']

                if existing_count > 0:
                    add_console_log(f"âš ï¸ å‘ç° {existing_count} ä¸ªIDå·²å­˜åœ¨äºæ•°æ®åº“ä¸­ï¼Œå°†è·³è¿‡", "warning")
                    add_console_log(f"âœ… éœ€è¦å¤„ç† {new_count} ä¸ªæ–°ID", "info")
                else:
                    add_console_log(f"âœ… æ‰€æœ‰ {new_count} ä¸ªIDéƒ½æ˜¯æ–°çš„ï¼Œéœ€è¦å…¨éƒ¨å¤„ç†", "info")

                # å¦‚æœæ²¡æœ‰æ–°IDéœ€è¦å¤„ç†
                if new_count == 0:
                    add_console_log("âœ… æ‰€æœ‰IDéƒ½å·²å­˜åœ¨äºæ•°æ®åº“ä¸­ï¼Œæ— éœ€é‡å¤å¤„ç†", "success")
                    update_console_status(status="completed", message="æ‰€æœ‰æ•°æ®å·²å­˜åœ¨ï¼Œæ— éœ€é‡å¤å¤„ç†", progress=100, is_processing=False)
                    return {
                        "success": True,
                        "message": "æ‰€æœ‰æ•°æ®å·²å­˜åœ¨äºæ•°æ®åº“ä¸­ï¼Œæ— éœ€é‡å¤å¤„ç†",
                        "data": {
                            "filename": file_data['name'],
                            "total_ids": len(all_extracted_ids),
                            "existing_ids": existing_count,
                            "new_ids": 0,
                            "skipped": True
                        }
                    }

                # è·å–æœ€æ–°tokenç”¨äºAPIè°ƒç”¨
                add_console_log("ğŸ”‘ è·å–æœ€æ–°token...", "info")
                token = self.get_latest_token_from_db()
                if not token:
                    add_console_log("âŒ æœªæ‰¾åˆ°æœ‰æ•ˆtokenï¼Œæ— æ³•å¤„ç†Excelæ–‡ä»¶", "error")
                    update_console_status(status="error", message="æœªæ‰¾åˆ°æœ‰æ•ˆtokenï¼Œè¯·å…ˆç™»å½•è‰å¦ˆå¦ˆ", is_processing=False)
                    return {
                        "success": False,
                        "message": "æœªæ‰¾åˆ°æœ‰æ•ˆtokenï¼Œè¯·å…ˆç™»å½•è‰å¦ˆå¦ˆè´¦å·",
                        "data": None
                    }
                else:
                    add_console_log(f"âœ… è·å–åˆ°token: {token[:20]}...", "success")

                import time

                # åªå¤„ç†æ–°çš„IDï¼Œè¿‡æ»¤æ‰å·²å­˜åœ¨çš„
                new_hyperlinks = []
                for link in hyperlinks_found:
                    url = link['hyperlink']
                    match = re.search(r'authorDetail/([^/?]+)', url)
                    if match:
                        author_id = match.group(1)
                        if author_id in new_ids:  # åªå¤„ç†æ–°çš„ID
                            new_hyperlinks.append(link)

                add_console_log(f"ğŸ“‹ å®é™…éœ€è¦å¤„ç†çš„è¶…é“¾æ¥: {len(new_hyperlinks)} ä¸ª", "info")

                # åˆ†æ‰¹å¤„ç†ï¼Œæ¯æ‰¹è¿”å›è¿›åº¦
                batch_size = 5  # æ¯5ä¸ªä¸ºä¸€æ‰¹
                total_count = len(new_hyperlinks)
                processed_count = 0

                # è·å–çˆ¬å–é…ç½®
                from cmm import get_crawl_config
                crawl_config = get_crawl_config()

                for i, link in enumerate(new_hyperlinks, 1):
                    # æ£€æŸ¥æ˜¯å¦å–æ¶ˆå¤„ç†
                    if is_processing_cancelled():
                        add_console_log("ğŸ›‘ å¤„ç†å·²è¢«ç”¨æˆ·å–æ¶ˆ", "warning")

                        # å–æ¶ˆæ—¶ä¹Ÿä½¿ç”¨ç›´è¿IPè¿›è¡Œä¸€æ¬¡è¯·æ±‚
                        add_console_log("ğŸŒ å–æ¶ˆå¤„ç†æ—¶ä½¿ç”¨ç›´è¿IPè®°å½•æœ€åè¯·æ±‚", "info")

                        # æ›´æ–°çŠ¶æ€ä¸ºæ­£åœ¨è¿›è¡Œç›´è¿è¯·æ±‚
                        update_console_status(status="processing", message="å–æ¶ˆå¤„ç†ä¸­ï¼Œæ­£åœ¨è¿›è¡Œæœ€åçš„ç›´è¿è¯·æ±‚...", is_processing=True)

                        try:
                            from cmm import make_direct_request
                            test_id = 'Te4oLu6PzddK8v0S_JURlE20CMuhagMW'  # ä½¿ç”¨æµ‹è¯•ID
                            make_direct_request(test_id, token)
                            add_console_log("âœ… ç›´è¿è¯·æ±‚å®Œæˆï¼Œå‡†å¤‡åœæ­¢å¤„ç†", "info")
                        except Exception as e:
                            add_console_log(f"âš ï¸ å–æ¶ˆæ—¶ç›´è¿è¯·æ±‚å¤±è´¥: {e}", "warning")

                        # ç›´è¿è¯·æ±‚å®Œæˆåï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å·²å¤„ç†çš„æ•°æ®å¹¶ç«‹å³return
                        if len(sqlite_data) > 0:
                            add_console_log(f"ğŸ“Š å·²å¤„ç† {len(sqlite_data)} æ¡æ•°æ®", "info")

                            update_console_status(status="cancelled", message="å¤„ç†å·²å–æ¶ˆï¼Œè¯¢é—®æ˜¯å¦ä¿å­˜å·²å¤„ç†æ•°æ®", is_processing=False)
                            return {
                                "success": False,
                                "message": "å¤„ç†å·²å–æ¶ˆ",
                                "cancelled": True,
                                "has_processed_data": True,
                                "processed_count": len(sqlite_data),
                                "processed_data": sqlite_data,
                                "ask_save": True  # æ ‡è®°éœ€è¦è¯¢é—®ç”¨æˆ·æ˜¯å¦ä¿å­˜
                            }
                        else:
                            update_console_status(status="cancelled", message="å¤„ç†å·²å–æ¶ˆ", is_processing=False)
                            return {
                                "success": False,
                                "message": "å¤„ç†å·²å–æ¶ˆ",
                                "cancelled": True,
                                "has_processed_data": False
                            }

                    # ä¼‘çœ æ§åˆ¶ - åªåœ¨éä»£ç†æ¨¡å¼ä¸‹ä½¿ç”¨
                    if not crawl_config['proxy_enabled']:
                        # å•ä¸ªæ•°æ®çˆ¬å–å‰çš„ä¼‘çœ 
                        if crawl_config['wait_time'] > 0:
                            add_console_log(f"â° ç›´è¿æ¨¡å¼å•ä¸ªæ•°æ®ä¼‘çœ  {crawl_config['wait_time']} ç§’", "info")
                            time.sleep(crawl_config['wait_time'])

                        # æ£€æŸ¥æ˜¯å¦éœ€è¦å¤§ä¼‘çœ 
                        if processed_count > 0 and processed_count % crawl_config['count_wait'] == 0:
                            add_console_log(f"ğŸ˜´ ç›´è¿æ¨¡å¼å·²å¤„ç† {processed_count} æ¡æ•°æ®ï¼Œå¤§ä¼‘çœ  {crawl_config['count_wait_time']} ç§’", "info")
                            time.sleep(crawl_config['count_wait_time'])
                    else:
                        # ä»£ç†æ¨¡å¼ä¸‹ä¸ä½¿ç”¨ä¼‘çœ 
                        add_console_log(f"ğŸš€ ä»£ç†æ¨¡å¼ï¼šæ— ä¼‘çœ ï¼Œç›´æ¥å¤„ç†ç¬¬ {i} æ¡æ•°æ®", "info")

                    # æ›´æ–°è¿›åº¦
                    progress = 40 + (i / len(new_hyperlinks)) * 50  # 40-90%
                    update_console_status(status="processing", message=f"æ­£åœ¨è·å–ç¬¬ {i}/{len(new_hyperlinks)} ä¸ªè¾¾äººä¿¡æ¯", progress=progress)

                    # æå–authorDetail/åé¢çš„ID
                    url = link['hyperlink']
                    match = re.search(r'authorDetail/([^/?]+)', url)
                    if match:
                        author_id = match.group(1)
                        extracted_ids.append(author_id)

                        add_console_log(f"ğŸ“¡ [{i}/{len(new_hyperlinks)}] è·å–è¾¾äºº: {link['cell_value']} ({author_id})", "info")

                        # è°ƒç”¨get_real_infoè·å–çœŸå®æ•°æ®
                        real_intro = ""
                        real_unique_id = ""
                        real_code = ""

                        # ä½¿ç”¨tokenè°ƒç”¨APIè·å–çœŸå®æ•°æ®
                        try:
                            from cmm import get_real_info, extract_contact_code
                            # æ­£å¸¸è¯·æ±‚ä¸ä½¿ç”¨ç›´è¿IP
                            real_data = get_real_info(author_id, token, use_direct_at_end=False)

                            # æ£€æŸ¥APIå“åº”æ˜¯å¦æœ‰æ•ˆï¼ˆé£æ§æ£€æµ‹ï¼‰
                            is_valid, error_msg = check_api_response_valid(real_data)

                            if is_valid:
                                real_intro = real_data['signature']
                                real_unique_id = real_data['unique_id']

                                # ä»signatureä¸­æå–è”ç³»æ–¹å¼
                                real_code = extract_contact_code(real_intro)

                                add_console_log(f"âœ… è·å–æˆåŠŸ: {link['cell_value']} | æŠ–éŸ³ID: {real_unique_id}", "success")
                                if real_code:
                                    add_console_log(f"ğŸ“ æå–è”ç³»æ–¹å¼: {real_code}", "success")
                                else:
                                    add_console_log("ğŸ“ æœªæå–åˆ°è”ç³»æ–¹å¼", "warning")
                            else:
                                # æ£€æµ‹åˆ°é£æ§ï¼Œè¯¢é—®ç”¨æˆ·æ˜¯å¦ä¿å­˜å·²å¤„ç†çš„æ•°æ®
                                add_console_log(f"âŒ {error_msg}", "error")
                                add_console_log(f"ğŸš¨ æ£€æµ‹åˆ°é£æ§ï¼å·²æˆåŠŸå¤„ç† {processed_count} æ¡æ•°æ®", "warning")

                                # è·å–æœåŠ¡å™¨è¿”å›çš„æ¶ˆæ¯
                                server_message = real_data.get('server_message', error_msg)
                                if server_message:
                                    add_console_log(f"ğŸ“¡ æœåŠ¡å™¨æ¶ˆæ¯: {server_message}", "warning")

                                # åˆ é™¤æ•°æ®åº“ä¸­çš„token
                                try:
                                    import sqlite3
                                    conn = sqlite3.connect('system.db')
                                    cursor = conn.cursor()
                                    cursor.execute("DELETE FROM tokens")
                                    conn.commit()
                                    deleted_count = cursor.rowcount
                                    conn.close()
                                    add_console_log(f"ğŸ—‘ï¸ å·²æ¸…é™¤ {deleted_count} ä¸ªå¤±æ•ˆtoken", "warning")
                                except Exception as token_error:
                                    add_console_log(f"âŒ æ¸…é™¤tokenå¤±è´¥: {str(token_error)}", "error")

                                # è¿”å›é£æ§ä¿¡æ¯ï¼Œè®©å‰ç«¯è¯¢é—®ç”¨æˆ·æ˜¯å¦ä¿å­˜
                                update_console_status(status="risk_control", message=f"è§¦å‘é£æ§ï¼Œå·²å¤„ç†{processed_count}æ¡", is_processing=False)
                                return {
                                    "success": False,
                                    "message": f"æ£€æµ‹åˆ°é£æ§: {error_msg}",
                                    "risk_control": True,
                                    "server_message": server_message,  # æœåŠ¡å™¨è¿”å›çš„æ¶ˆæ¯
                                    "token_cleared": True,
                                    "processed_count": processed_count,
                                    "total_count": total_count,
                                    "processed_data": sqlite_data,
                                    "ask_save_confirmation": True
                                }

                        except Exception as e:
                            add_console_log(f"âŒ APIè°ƒç”¨å¤±è´¥: {str(e)[:50]}...", "error")

                        data_row = {
                            'file_name': file_data['name'],
                            'username': link['cell_value'],
                            'intro': real_intro,
                            'unique_id': real_unique_id,
                            'cmm_id': author_id,
                            'code': real_code,
                            'create_time': datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                        }

                        sqlite_data.append(data_row)
                        processed_count += 1

                        add_console_log(f"âœ… å®Œæˆç¬¬ {i} ä¸ªè¾¾äººä¿¡æ¯è·å–: {link['cell_value']}", "success")

                        # æ·»åŠ ä¼‘çœ é—´éš”ï¼Œé¿å…è¯·æ±‚è¿‡å¿«
                        if i < len(new_hyperlinks):  # æœ€åä¸€ä¸ªä¸éœ€è¦ä¼‘çœ 
                            add_console_log(f"â±ï¸ ä¼‘çœ  {sleep_interval} ç§’ï¼Œé¿å…è¯·æ±‚è¿‡å¿«", "warning")
                            time.sleep(sleep_interval)

                add_console_log(f"ğŸ“Š æå–åˆ° {len(extracted_ids)} ä¸ªID", "info")

                # ç”Ÿæˆæ‰¹é‡æ’å…¥SQL
                if sqlite_data:
                    add_console_log("ğŸ’¾ å¼€å§‹å‡†å¤‡æ•°æ®åº“æ’å…¥", "info")
                    print("-- users è¡¨ç»“æ„")
                    print("CREATE TABLE IF NOT EXISTS users (")
                    print("    id INTEGER PRIMARY KEY AUTOINCREMENT,")
                    print("    file_name TEXT NOT NULL,  -- åŸå§‹æ–‡ä»¶å")
                    print("    username TEXT NOT NULL,   -- ç”¨æˆ·æ˜µç§°")
                    print("    intro TEXT,               -- ç®€ä»‹ä¿¡æ¯")
                    print("    unique_id TEXT,           -- æŠ–éŸ³ID")
                    print("    cmm_id TEXT,              -- è‰å¦ˆå¦ˆID")
                    print("    create_time TEXT NOT NULL -- åˆ›å»ºæ—¶é—´")
                    print(");")
                    print()

                    # æ‰¹é‡æ’å…¥è¯­å¥
                    print("-- æ‰¹é‡æ’å…¥æ•°æ®")
                    print("INSERT INTO users (file_name, username, intro, unique_id, cmm_id, code, create_time) VALUES")
                    values_list = []
                    for data in sqlite_data:
                        values = f"('{data['file_name']}', '{data['username']}', '{data['intro']}', '{data['unique_id']}', '{data['cmm_id']}', '{data['code']}', '{data['create_time']}')"
                        values_list.append(values)

                    print(",\n".join(values_list) + ";")

                    print(f"\næ€»å…± {len(sqlite_data)} æ¡æ•°æ®å‡†å¤‡æ’å…¥åˆ° users è¡¨")

                    # è¯¦ç»†æ•°æ®é¢„è§ˆ
                    print(f"\n=== æ•°æ®è¯¦æƒ…é¢„è§ˆ ===")
                    for i, data in enumerate(sqlite_data[:5], 1):  # åªæ˜¾ç¤ºå‰5æ¡
                        print(f"{i}. æ–‡ä»¶: {data['file_name']}")
                        print(f"   ç”¨æˆ·: {data['username']}")
                        print(f"   ç®€ä»‹: {data['intro'][:50]}...")
                        print(f"   æŠ–éŸ³ID: {data['unique_id']}")
                        print(f"   è‰å¦ˆå¦ˆID: {data['cmm_id']}")
                        print(f"   è”ç³»æ–¹å¼: {data['code'] if data['code'] else 'æœªæå–'}")
                        print(f"   æ—¶é—´: {data['create_time']}")
                        print()

                    if len(sqlite_data) > 5:
                        print(f"... è¿˜æœ‰ {len(sqlite_data) - 5} æ¡æ•°æ®")

                    # æ’å…¥æ•°æ®åˆ°æ•°æ®åº“
                    print(f"\n=== å¼€å§‹æ’å…¥æ•°æ®åˆ°æ•°æ®åº“ ===")
                    try:
                        # å‡†å¤‡æ’å…¥æ•°æ®
                        field_names = ['file_name', 'username', 'intro', 'unique_id', 'cmm_id', 'code', 'create_time']
                        insert_data = []

                        for data in sqlite_data:
                            row_tuple = (
                                data['file_name'],
                                data['username'],
                                data['intro'],
                                data['unique_id'],
                                data['cmm_id'],
                                data['code'],
                                data['create_time']
                            )
                            insert_data.append(row_tuple)

                        print(f"å‡†å¤‡æ’å…¥ {len(insert_data)} æ¡æ•°æ®åˆ° users è¡¨...")

                        # æ‰§è¡Œæ‰¹é‡æ’å…¥
                        inserted_count = batch_insert(
                            db_path='system.db',
                            table_name='users',
                            field_names=field_names,
                            data=insert_data,
                            batch_size=50
                        )

                        if inserted_count > 0:
                            add_console_log(f"âœ… æˆåŠŸæ’å…¥ {inserted_count} æ¡æ•°æ®åˆ°æ•°æ®åº“", "success")

                            # éªŒè¯æ’å…¥ç»“æœ
                            verify_result = verify_insert_result()
                            add_console_log(f"ğŸ“Š æ•°æ®åº“æ€»è®°å½•æ•°: {verify_result.get('record_count', 0)}", "info")

                            if verify_result.get('latest_records'):
                                print(f"æœ€æ–°5æ¡è®°å½•:")
                                for i, record in enumerate(verify_result['latest_records'][:3], 1):
                                    print(f"  {i}. ID:{record.get('id')} ç”¨æˆ·:{record.get('username')} è‰å¦ˆå¦ˆID:{record.get('cmm_id')}")

                            insert_success = True
                            insert_message = f"æˆåŠŸæ’å…¥ {inserted_count} æ¡æ•°æ®åˆ°æ•°æ®åº“ï¼Œå½“å‰æ€»è®°å½•æ•°: {verify_result.get('record_count', 0)}"
                        else:
                            add_console_log("âŒ æ•°æ®æ’å…¥å¤±è´¥", "error")
                            insert_success = False
                            insert_message = "æ•°æ®æ’å…¥å¤±è´¥"

                    except Exception as insert_error:
                        add_console_log(f"âŒ æ•°æ®åº“æ’å…¥å¼‚å¸¸: {str(insert_error)}", "error")
                        import traceback
                        traceback.print_exc()
                        insert_success = False
                        insert_message = f"æ•°æ®åº“æ’å…¥å¼‚å¸¸: {str(insert_error)}"

            else:
                add_console_log("âš ï¸ æœªå‘ç°ä»»ä½•è¶…é“¾æ¥", "warning")

            # å…³é—­å·¥ä½œç°¿
            workbook.close()

            print("=" * 50)
            print("Excelæ–‡ä»¶è¯»å–å®Œæˆï¼")

            # å‡†å¤‡è¿”å›æ•°æ®
            return_data = {
                "filename": file_data['name'],
                "sheet_names": sheet_names,
                "current_sheet": sheet.title,
                "max_row": sheet.max_row,
                "max_column": sheet.max_column,
                "headers": headers,
                "sample_data": all_data[:5],  # å‰5è¡Œä½œä¸ºç¤ºä¾‹
                "total_rows": len(all_data),
                "hyperlinks_count": len(hyperlinks_found),
                "hyperlinks": hyperlinks_found
            }

            # å¦‚æœæœ‰è¶…é“¾æ¥ï¼Œæ·»åŠ æå–çš„IDå’ŒSQLiteæ•°æ®
            if hyperlinks_found and 'extracted_ids' in locals():
                return_data.update({
                    "extracted_ids": extracted_ids,
                    "sqlite_data": sqlite_data,
                    "sqlite_ready_count": len(sqlite_data),
                    "db_insert_success": insert_success,
                    "db_insert_message": insert_message
                })

            # å¤„ç†å®Œæˆï¼Œä½¿ç”¨ç›´è¿IPè¿›è¡Œæœ€åä¸€æ¬¡è¯·æ±‚
            add_console_log("ğŸ‰ Excelæ–‡ä»¶å¤„ç†å®Œæˆï¼æ‰€æœ‰è¾¾äººä¿¡æ¯å·²è·å–", "success")
            add_console_log("ğŸŒ å¤„ç†å®Œæˆæ—¶ä½¿ç”¨ç›´è¿IPè®°å½•æœ€åè¯·æ±‚", "info")

            # æ›´æ–°çŠ¶æ€ä¸ºæ­£åœ¨è¿›è¡Œæœ€åçš„ç›´è¿è¯·æ±‚
            update_console_status(status="processing", message="æ­£åœ¨è¿›è¡Œæœ€åçš„ç›´è¿è¯·æ±‚...", progress=95, is_processing=True)

            try:
                from cmm import make_direct_request
                test_id = 'Te4oLu6PzddK8v0S_JURlE20CMuhagMW'  # ä½¿ç”¨æµ‹è¯•ID
                make_direct_request(test_id, token)
                add_console_log("âœ… ç›´è¿è¯·æ±‚å®Œæˆ", "success")
            except Exception as e:
                add_console_log(f"âš ï¸ å®Œæˆæ—¶ç›´è¿è¯·æ±‚å¤±è´¥: {e}", "warning")

            # ç›´è¿è¯·æ±‚å®Œæˆåæ‰è®¾ç½®ä¸ºå®ŒæˆçŠ¶æ€
            update_console_status(status="completed", message="Excelæ–‡ä»¶å¤„ç†å®Œæˆï¼", progress=100, is_processing=False)

            # å»¶è¿Ÿ3ç§’åé‡ç½®æ§åˆ¶å°ï¼Œè®©ç”¨æˆ·çœ‹åˆ°å®Œæˆä¿¡æ¯
            import threading
            def delayed_reset():
                import time
                time.sleep(3)
                reset_console_output()
                add_console_log("ğŸ“‹ æ§åˆ¶å°å·²é‡ç½®ï¼Œå¯ä»¥å¤„ç†æ–°æ–‡ä»¶", "info")

            threading.Thread(target=delayed_reset, daemon=True).start()

            return {
                "success": True,
                "message": "Excelæ–‡ä»¶è¯»å–æˆåŠŸ",
                "data": return_data
            }

        except Exception as e:
            add_console_log(f"âŒ å¤„ç†å¤±è´¥: {str(e)}", "error")

            # å¤„ç†å¤±è´¥æ—¶ä¹Ÿä½¿ç”¨ç›´è¿IPè¿›è¡Œä¸€æ¬¡è¯·æ±‚
            add_console_log("ğŸŒ å¤„ç†å¤±è´¥æ—¶ä½¿ç”¨ç›´è¿IPè®°å½•æœ€åè¯·æ±‚", "info")

            # æ›´æ–°çŠ¶æ€ä¸ºæ­£åœ¨è¿›è¡Œæœ€åçš„ç›´è¿è¯·æ±‚
            update_console_status(status="processing", message="å¤„ç†å¤±è´¥ï¼Œæ­£åœ¨è¿›è¡Œæœ€åçš„ç›´è¿è¯·æ±‚...", is_processing=True)

            try:
                from cmm import make_direct_request
                # å°è¯•è·å–tokenï¼Œå¦‚æœæ²¡æœ‰å°±ä½¿ç”¨ç©ºtoken
                token = self.get_latest_token_from_db() or ''
                test_id = 'Te4oLu6PzddK8v0S_JURlE20CMuhagMW'  # ä½¿ç”¨æµ‹è¯•ID
                make_direct_request(test_id, token)
                add_console_log("âœ… ç›´è¿è¯·æ±‚å®Œæˆ", "success")
            except Exception as direct_error:
                add_console_log(f"âš ï¸ å¤±è´¥æ—¶ç›´è¿è¯·æ±‚å¤±è´¥: {direct_error}", "warning")

            # ç›´è¿è¯·æ±‚å®Œæˆåæ‰è®¾ç½®ä¸ºé”™è¯¯çŠ¶æ€
            update_console_status(status="error", message=f"å¤„ç†å¤±è´¥: {str(e)}", is_processing=False)
            import traceback
            traceback.print_exc()
            return {
                "success": False,
                "message": f"Excelæ–‡ä»¶å¤„ç†å¤±è´¥: {str(e)}",
                "error": str(e)
            }

    def api_login_cmm(self, username, password):
        """
        è‰å¦ˆå¦ˆç™»å½•APIæ¥å£ï¼ˆè‡ªåŠ¨æ£€æµ‹ä»£ç†ï¼‰
        """
        try:
            print(f"=== è‰å¦ˆå¦ˆç™»å½• ===")
            print(f"ç”¨æˆ·å: {username}")
            print(f"è‡ªåŠ¨æ£€æµ‹ä»£ç†æ¨¡å¼")

            # éªŒè¯è¾“å…¥
            if not username or not password:
                return {
                    "success": False,
                    "message": "ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º",
                    "logged_in": False,
                    "token": ''
                }

            # è°ƒç”¨cmm.pyçš„ç™»å½•æ–¹æ³•ï¼ˆè‡ªåŠ¨æ£€æµ‹ä»£ç†ï¼‰
            from cmm import login_cmm
            result = login_cmm(username, password)
            print(f"ç™»å½•ç»“æœ: {result}")
            if result and result.get('data', {}).get('logged_in'):
                print("âœ… è‰å¦ˆå¦ˆç™»å½•æˆåŠŸ")

                return {
                    "success": True,
                    "message": "ç™»å½•æˆåŠŸ",
                    "data": result.get('data', {}),
                    "logged_in": result.get('data', {}).get('logged_in', False),
                    "token": result.get('data', {}).get('token', '')
                }
            else:
                print(f"âŒ è‰å¦ˆå¦ˆç™»å½•å¤±è´¥")
                error_msg = "ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç "
                if result and result.get('message'):
                    error_msg = result.get('message')

                return {
                    "success": False,
                    "message": error_msg,
                    "data": result,
                    "logged_in": False,
                    "token": ''
                }

        except Exception as e:
            print(f"âŒ è‰å¦ˆå¦ˆç™»å½•å¼‚å¸¸: {str(e)}")
            return {
                "success": False,
                "message": f"ç™»å½•å¼‚å¸¸: {str(e)}",
                "logged_in": False,
                "token": ''
            }

    def get_latest_token_from_db(self):
        """
        ä»æ•°æ®åº“è·å–æœ€æ–°token
        """
        try:
            import sqlite3
            conn = sqlite3.connect('system.db')
            cursor = conn.cursor()

            cursor.execute("""
                SELECT token FROM tokens
                ORDER BY create_time DESC
                LIMIT 1
            """)
            result = cursor.fetchone()
            conn.close()

            if result:
                return result[0]
            else:
                return None
        except Exception as e:
            print(f"âŒ ä»æ•°æ®åº“è·å–tokenå¤±è´¥: {str(e)}")
            return None

    def get_processing_status(self):
        """
        è·å–å¤„ç†çŠ¶æ€ï¼ˆç”¨äºå‰ç«¯æ˜¾ç¤ºè¿›åº¦ï¼‰
        """
        import time
        return {
            "status": "ready",
            "message": "ç³»ç»Ÿå°±ç»ª",
            "timestamp": time.time()
        }

    def update_processing_progress(self, current=None, total=None, message=""):
        """
        æ›´æ–°å¤„ç†è¿›åº¦å¹¶è¿”å›å…¨å±€æ§åˆ¶å°è¾“å‡º
        """
        # å¦‚æœä¼ å…¥äº†å‚æ•°ï¼Œæ›´æ–°å…¨å±€çŠ¶æ€
        if current is not None and total is not None:
            progress_percent = round((current / total) * 100, 1) if total > 0 else 0
            update_console_status(
                status="processing",
                message=message,
                progress=progress_percent,
                is_processing=True
            )
            print('æ›´æ–°è¢«è°ƒç”¨Â·Â·Â·Â·')
        # è¿”å›å…¨å±€æ§åˆ¶å°è¾“å‡º
        return get_console_output()

    def save_export_file(self, file_content, file_name, file_type='csv'):
        """
        ä¿å­˜å¯¼å‡ºæ–‡ä»¶åˆ°ç”¨æˆ·æŒ‡å®šä½ç½®ï¼ˆä½¿ç”¨pywebviewæ–‡ä»¶å¯¹è¯æ¡†ï¼‰
        """
        import os

        try:
            print(f"=== ä¿å­˜å¯¼å‡ºæ–‡ä»¶ ===")
            print(f"æ–‡ä»¶å: {file_name}")
            print(f"æ–‡ä»¶ç±»å‹: {file_type}")
            print(f"å†…å®¹é•¿åº¦: {len(file_content)} å­—ç¬¦")

            # å°è¯•ä½¿ç”¨pywebviewçš„æ–‡ä»¶å¯¹è¯æ¡†
            try:
                import webview

                # è®¾ç½®æ–‡ä»¶ç±»å‹è¿‡æ»¤å™¨
                if file_type.lower() == 'csv':
                    file_types = ('CSVæ–‡ä»¶ (*.csv)', '*.csv')
                elif file_type.lower() == 'xlsx':
                    file_types = ('Excelæ–‡ä»¶ (*.xlsx)', '*.xlsx')
                else:
                    file_types = ('æ‰€æœ‰æ–‡ä»¶ (*.*)', '*.*')

                # ä½¿ç”¨pywebviewçš„ä¿å­˜æ–‡ä»¶å¯¹è¯æ¡†
                file_path = webview.windows[0].create_file_dialog(
                    webview.SAVE_DIALOG,
                    directory=os.path.expanduser('~/Downloads'),  # é»˜è®¤ä¸‹è½½æ–‡ä»¶å¤¹
                    save_filename=file_name,
                    file_types=(file_types,)
                )

                if not file_path:
                    print("ç”¨æˆ·å–æ¶ˆäº†æ–‡ä»¶ä¿å­˜")
                    return {
                        "success": False,
                        "message": "ç”¨æˆ·å–æ¶ˆäº†æ–‡ä»¶ä¿å­˜"
                    }

                # file_pathå¯èƒ½æ˜¯åˆ—è¡¨ï¼Œå–ç¬¬ä¸€ä¸ª
                if isinstance(file_path, (list, tuple)):
                    file_path = file_path[0] if file_path else None

                if not file_path:
                    return {
                        "success": False,
                        "message": "æœªé€‰æ‹©ä¿å­˜è·¯å¾„"
                    }

                print(f"ä¿å­˜è·¯å¾„: {file_path}")

            except Exception as webview_error:
                print(f"âš ï¸ pywebviewæ–‡ä»¶å¯¹è¯æ¡†å¤±è´¥: {str(webview_error)}")

                # å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥ä¿å­˜åˆ°ä¸‹è½½æ–‡ä»¶å¤¹
                downloads_dir = os.path.expanduser('~/Downloads')
                if not os.path.exists(downloads_dir):
                    downloads_dir = os.path.expanduser('~')  # ç”¨æˆ·ä¸»ç›®å½•

                file_path = os.path.join(downloads_dir, file_name)
                print(f"ä½¿ç”¨é»˜è®¤è·¯å¾„: {file_path}")

            # ä¿å­˜æ–‡ä»¶
            if file_type.lower() == 'csv':
                # CSVæ–‡ä»¶éœ€è¦UTF-8ç¼–ç å’ŒBOM
                with open(file_path, 'w', encoding='utf-8-sig', newline='') as f:
                    f.write(file_content)
            else:
                # å…¶ä»–æ–‡ä»¶ç±»å‹
                with open(file_path, 'w', encoding='utf-8', newline='') as f:
                    f.write(file_content)

            # éªŒè¯æ–‡ä»¶æ˜¯å¦ä¿å­˜æˆåŠŸ
            if os.path.exists(file_path):
                file_size = os.path.getsize(file_path)
                print(f"âœ… æ–‡ä»¶ä¿å­˜æˆåŠŸ")
                print(f"   è·¯å¾„: {file_path}")
                print(f"   å¤§å°: {file_size} å­—èŠ‚")

                return {
                    "success": True,
                    "message": f"æ–‡ä»¶å·²ä¿å­˜åˆ°: {file_path}",
                    "file_path": file_path,
                    "file_size": file_size
                }
            else:
                print(f"âŒ æ–‡ä»¶ä¿å­˜å¤±è´¥")
                return {
                    "success": False,
                    "message": "æ–‡ä»¶ä¿å­˜å¤±è´¥"
                }

        except Exception as e:
            print(f"âŒ ä¿å­˜æ–‡ä»¶å¼‚å¸¸: {str(e)}")
            import traceback
            traceback.print_exc()
            return {
                "success": False,
                "message": f"ä¿å­˜æ–‡ä»¶å¤±è´¥: {str(e)}"
            }

    def save_to_downloads(self, file_content, file_name, file_type='csv'):
        """
        ç›´æ¥ä¿å­˜æ–‡ä»¶åˆ°Downloadsæ–‡ä»¶å¤¹ï¼ˆæœ€ç®€å•çš„æ–¹æ¡ˆï¼‰
        """
        import os

        try:
            print(f"=== ç›´æ¥ä¿å­˜åˆ°Downloadsæ–‡ä»¶å¤¹ ===")
            print(f"æ–‡ä»¶å: {file_name}")
            print(f"æ–‡ä»¶ç±»å‹: {file_type}")
            print(f"å†…å®¹é•¿åº¦: {len(file_content)} å­—ç¬¦")

            # è·å–Downloadsæ–‡ä»¶å¤¹è·¯å¾„
            downloads_dir = os.path.expanduser('~/Downloads')
            if not os.path.exists(downloads_dir):
                # å¦‚æœDownloadsæ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼Œä½¿ç”¨ç”¨æˆ·ä¸»ç›®å½•
                downloads_dir = os.path.expanduser('~')
                print(f"Downloadsæ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼Œä½¿ç”¨ä¸»ç›®å½•: {downloads_dir}")

            # æ„å»ºå®Œæ•´æ–‡ä»¶è·¯å¾„
            file_path = os.path.join(downloads_dir, file_name)

            # å¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼Œæ·»åŠ åºå·
            base_name, ext = os.path.splitext(file_path)
            counter = 1
            while os.path.exists(file_path):
                file_path = f"{base_name}_{counter}{ext}"
                counter += 1

            print(f"ä¿å­˜è·¯å¾„: {file_path}")

            # ä¿å­˜æ–‡ä»¶
            if file_type.lower() == 'csv':
                # CSVæ–‡ä»¶éœ€è¦UTF-8ç¼–ç å’ŒBOM
                with open(file_path, 'w', encoding='utf-8-sig', newline='') as f:
                    f.write(file_content)
            else:
                # å…¶ä»–æ–‡ä»¶ç±»å‹
                with open(file_path, 'w', encoding='utf-8', newline='') as f:
                    f.write(file_content)

            # éªŒè¯æ–‡ä»¶æ˜¯å¦ä¿å­˜æˆåŠŸ
            if os.path.exists(file_path):
                file_size = os.path.getsize(file_path)
                print(f"âœ… æ–‡ä»¶ä¿å­˜æˆåŠŸ")
                print(f"   è·¯å¾„: {file_path}")
                print(f"   å¤§å°: {file_size} å­—èŠ‚")

                return {
                    "success": True,
                    "message": f"æ–‡ä»¶å·²ä¿å­˜åˆ°Downloadsæ–‡ä»¶å¤¹: {os.path.basename(file_path)}",
                    "file_path": file_path,
                    "file_size": file_size
                }
            else:
                print(f"âŒ æ–‡ä»¶ä¿å­˜å¤±è´¥")
                return {
                    "success": False,
                    "message": "æ–‡ä»¶ä¿å­˜å¤±è´¥"
                }

        except Exception as e:
            print(f"âŒ ä¿å­˜æ–‡ä»¶å¼‚å¸¸: {str(e)}")
            import traceback
            traceback.print_exc()
            return {
                "success": False,
                "message": f"ä¿å­˜æ–‡ä»¶å¤±è´¥: {str(e)}"
            }

    def save_excel_file(self, base64_content, file_name):
        """
        ä¿å­˜Excelæ–‡ä»¶ï¼ˆä»Base64å†…å®¹ï¼Œä½¿ç”¨pywebviewæ–‡ä»¶å¯¹è¯æ¡†ï¼‰
        """
        import os
        import base64

        try:
            print(f"=== ä¿å­˜Excelæ–‡ä»¶ ===")
            print(f"æ–‡ä»¶å: {file_name}")
            print(f"Base64å†…å®¹é•¿åº¦: {len(base64_content)} å­—ç¬¦")

            # å°è¯•ä½¿ç”¨pywebviewçš„æ–‡ä»¶å¯¹è¯æ¡†
            try:
                import webview

                # ä½¿ç”¨pywebviewçš„ä¿å­˜æ–‡ä»¶å¯¹è¯æ¡†
                file_path = webview.windows[0].create_file_dialog(
                    webview.SAVE_DIALOG,
                    directory=os.path.expanduser('~/Downloads'),  # é»˜è®¤ä¸‹è½½æ–‡ä»¶å¤¹
                    save_filename=file_name,
                    file_types=(('Excelæ–‡ä»¶ (*.xlsx)', '*.xlsx'),)
                )

                if not file_path:
                    print("ç”¨æˆ·å–æ¶ˆäº†Excelæ–‡ä»¶ä¿å­˜")
                    return {
                        "success": False,
                        "message": "ç”¨æˆ·å–æ¶ˆäº†æ–‡ä»¶ä¿å­˜"
                    }

                # file_pathå¯èƒ½æ˜¯åˆ—è¡¨ï¼Œå–ç¬¬ä¸€ä¸ª
                if isinstance(file_path, (list, tuple)):
                    file_path = file_path[0] if file_path else None

                if not file_path:
                    return {
                        "success": False,
                        "message": "æœªé€‰æ‹©ä¿å­˜è·¯å¾„"
                    }

                print(f"ä¿å­˜è·¯å¾„: {file_path}")

            except Exception as webview_error:
                print(f"âš ï¸ pywebviewæ–‡ä»¶å¯¹è¯æ¡†å¤±è´¥: {str(webview_error)}")

                # å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥ä¿å­˜åˆ°ä¸‹è½½æ–‡ä»¶å¤¹
                downloads_dir = os.path.expanduser('~/Downloads')
                if not os.path.exists(downloads_dir):
                    downloads_dir = os.path.expanduser('~')  # ç”¨æˆ·ä¸»ç›®å½•

                file_path = os.path.join(downloads_dir, file_name)
                print(f"ä½¿ç”¨é»˜è®¤è·¯å¾„: {file_path}")

            # è§£ç Base64å¹¶ä¿å­˜æ–‡ä»¶
            excel_data = base64.b64decode(base64_content)

            with open(file_path, 'wb') as f:
                f.write(excel_data)

            # éªŒè¯æ–‡ä»¶æ˜¯å¦ä¿å­˜æˆåŠŸ
            if os.path.exists(file_path):
                file_size = os.path.getsize(file_path)
                print(f"âœ… Excelæ–‡ä»¶ä¿å­˜æˆåŠŸ")
                print(f"   è·¯å¾„: {file_path}")
                print(f"   å¤§å°: {file_size} å­—èŠ‚")

                return {
                    "success": True,
                    "message": f"Excelæ–‡ä»¶å·²ä¿å­˜åˆ°: {file_path}",
                    "file_path": file_path,
                    "file_size": file_size
                }
            else:
                print(f"âŒ Excelæ–‡ä»¶ä¿å­˜å¤±è´¥")
                return {
                    "success": False,
                    "message": "Excelæ–‡ä»¶ä¿å­˜å¤±è´¥"
                }

        except Exception as e:
            print(f"âŒ ä¿å­˜Excelæ–‡ä»¶å¼‚å¸¸: {str(e)}")
            import traceback
            traceback.print_exc()
            return {
                "success": False,
                "message": f"ä¿å­˜Excelæ–‡ä»¶å¤±è´¥: {str(e)}"
            }

    def save_excel_to_downloads(self, base64_content, file_name):
        """
        ç›´æ¥ä¿å­˜Excelæ–‡ä»¶åˆ°Downloadsæ–‡ä»¶å¤¹
        """
        import os
        import base64

        try:
            print(f"=== ç›´æ¥ä¿å­˜Excelåˆ°Downloadsæ–‡ä»¶å¤¹ ===")
            print(f"æ–‡ä»¶å: {file_name}")
            print(f"Base64å†…å®¹é•¿åº¦: {len(base64_content)} å­—ç¬¦")

            # è·å–Downloadsæ–‡ä»¶å¤¹è·¯å¾„
            downloads_dir = os.path.expanduser('~/Downloads')
            if not os.path.exists(downloads_dir):
                # å¦‚æœDownloadsæ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼Œä½¿ç”¨ç”¨æˆ·ä¸»ç›®å½•
                downloads_dir = os.path.expanduser('~')
                print(f"Downloadsæ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼Œä½¿ç”¨ä¸»ç›®å½•: {downloads_dir}")

            # æ„å»ºå®Œæ•´æ–‡ä»¶è·¯å¾„
            file_path = os.path.join(downloads_dir, file_name)

            # å¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼Œæ·»åŠ åºå·
            base_name, ext = os.path.splitext(file_path)
            counter = 1
            while os.path.exists(file_path):
                file_path = f"{base_name}_{counter}{ext}"
                counter += 1

            print(f"ä¿å­˜è·¯å¾„: {file_path}")

            # è§£ç Base64å¹¶ä¿å­˜æ–‡ä»¶
            excel_data = base64.b64decode(base64_content)

            with open(file_path, 'wb') as f:
                f.write(excel_data)

            # éªŒè¯æ–‡ä»¶æ˜¯å¦ä¿å­˜æˆåŠŸ
            if os.path.exists(file_path):
                file_size = os.path.getsize(file_path)
                print(f"âœ… Excelæ–‡ä»¶ä¿å­˜æˆåŠŸ")
                print(f"   è·¯å¾„: {file_path}")
                print(f"   å¤§å°: {file_size} å­—èŠ‚")

                return {
                    "success": True,
                    "message": f"Excelæ–‡ä»¶å·²ä¿å­˜åˆ°Downloadsæ–‡ä»¶å¤¹: {os.path.basename(file_path)}",
                    "file_path": file_path,
                    "file_size": file_size
                }
            else:
                print(f"âŒ Excelæ–‡ä»¶ä¿å­˜å¤±è´¥")
                return {
                    "success": False,
                    "message": "Excelæ–‡ä»¶ä¿å­˜å¤±è´¥"
                }

        except Exception as e:
            print(f"âŒ ä¿å­˜Excelæ–‡ä»¶å¼‚å¸¸: {str(e)}")
            import traceback
            traceback.print_exc()
            return {
                "success": False,
                "message": f"ä¿å­˜Excelæ–‡ä»¶å¤±è´¥: {str(e)}"
            }

    def save_partial_processed_data(self, params):
        """
        ä¿å­˜éƒ¨åˆ†å¤„ç†çš„æ•°æ®åˆ°æ•°æ®åº“ï¼ˆç”¨æˆ·ç¡®è®¤åï¼‰
        :param params: åŒ…å«processed_dataç­‰ä¿¡æ¯çš„å‚æ•°
        """
        try:
            processed_data = params.get('processed_data', [])
            processed_count = params.get('processed_count', 0)
            total_count = params.get('total_count', 0)

            if not processed_data:
                return {
                    "success": False,
                    "message": "æ²¡æœ‰æ•°æ®éœ€è¦ä¿å­˜"
                }

            add_console_log(f"ğŸ’¾ ç”¨æˆ·ç¡®è®¤ä¿å­˜ {len(processed_data)} æ¡å·²å¤„ç†çš„æ•°æ®", "info")

            # å‡†å¤‡æ’å…¥æ•°æ®
            field_names = ['file_name', 'username', 'intro', 'unique_id', 'cmm_id', 'code', 'create_time']
            insert_data = []

            for data in processed_data:
                row_tuple = (
                    data['file_name'],
                    data['username'],
                    data['intro'],
                    data['unique_id'],
                    data['cmm_id'],
                    data['code'],
                    data['create_time']
                )
                insert_data.append(row_tuple)

            # æ‰§è¡Œæ‰¹é‡æ’å…¥
            from sqlite3_util import save_partial_data_with_confirmation
            result = save_partial_data_with_confirmation(
                db_path='system.db',
                table_name='users',
                field_names=field_names,
                data=insert_data,
                processed_count=processed_count,
                total_count=total_count
            )

            if result['success']:
                add_console_log(f"âœ… {result['message']}", "success")
                add_console_log(f"ğŸ“Š å®Œæˆç‡: {result.get('completion_rate', 0)}%", "info")

                # éªŒè¯æ’å…¥ç»“æœ
                from sqlite3_util import verify_insert_result
                verify_result = verify_insert_result()
                add_console_log(f"ğŸ“Š æ•°æ®åº“æ€»è®°å½•æ•°: {verify_result.get('record_count', 0)}", "info")

                update_console_status(status="completed", message="éƒ¨åˆ†æ•°æ®ä¿å­˜æˆåŠŸ", progress=100, is_processing=False)

                return {
                    "success": True,
                    "message": result['message'],
                    "inserted_count": result.get('inserted_count', 0),
                    "completion_rate": result.get('completion_rate', 0),
                    "total_records": verify_result.get('record_count', 0)
                }
            else:
                add_console_log(f"âŒ {result['message']}", "error")
                update_console_status(status="error", message="æ•°æ®ä¿å­˜å¤±è´¥", is_processing=False)

                return {
                    "success": False,
                    "message": result['message']
                }

        except Exception as e:
            error_msg = f"ä¿å­˜éƒ¨åˆ†æ•°æ®å¤±è´¥: {str(e)}"
            add_console_log(f"âŒ {error_msg}", "error")
            update_console_status(status="error", message=error_msg, is_processing=False)

            return {
                "success": False,
                "message": error_msg
            }

    def api_logout_cmm(self):
        """
        è‰å¦ˆå¦ˆé€€å‡ºç™»å½• - æ¸…é™¤æ•°æ®åº“ä¸­çš„token
        """
        try:
            import sqlite3

            # è¿æ¥æ•°æ®åº“
            conn = sqlite3.connect('system.db')
            cursor = conn.cursor()

            # åˆ é™¤æ‰€æœ‰tokenè®°å½•
            cursor.execute("DELETE FROM tokens")
            conn.commit()

            deleted_count = cursor.rowcount
            conn.close()

            print(f"å·²æ¸…é™¤æ•°æ®åº“ä¸­çš„ {deleted_count} ä¸ªtokenè®°å½•")

            return {
                "success": True,
                "message": f"å·²æ¸…é™¤ {deleted_count} ä¸ªtokenè®°å½•"
            }

        except Exception as e:
            print(f"æ¸…é™¤æ•°æ®åº“tokenå¤±è´¥: {str(e)}")
            return {
                "success": False,
                "message": f"æ¸…é™¤tokenå¤±è´¥: {str(e)}"
            }

    # ==================== å¾®ä¿¡è‡ªåŠ¨åŒ–ç›¸å…³æ–¹æ³• ====================

    def __init_wechat_automation(self):
        """åˆå§‹åŒ–å¾®ä¿¡è‡ªåŠ¨åŒ–å®ä¾‹"""
        if not WECHAT_AUTOMATION_AVAILABLE:
            return None

        try:
            wechat = WeChatAutomation()
            if wechat.wechat_window:
                return wechat
            else:
                return None
        except Exception as e:
            print(f"åˆå§‹åŒ–å¾®ä¿¡è‡ªåŠ¨åŒ–å¤±è´¥: {e}")
            return None

    def check_wechat_status(self):
        """æ£€æŸ¥å¾®ä¿¡è¿æ¥çŠ¶æ€"""
        try:
            if not WECHAT_AUTOMATION_AVAILABLE:
                return {
                    "success": False,
                    "message": "å¾®ä¿¡è‡ªåŠ¨åŒ–æ¨¡å—ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥ä¾èµ–å®‰è£…"
                }

            wechat = self.__init_wechat_automation()
            if wechat:
                return {
                    "success": True,
                    "message": "å¾®ä¿¡è¿æ¥æ­£å¸¸",
                    "wechat_window_found": True
                }
            else:
                return {
                    "success": False,
                    "message": "æœªæ‰¾åˆ°å¾®ä¿¡çª—å£ï¼Œè¯·ç¡®ä¿å¾®ä¿¡PCç‰ˆå·²æ‰“å¼€å¹¶ç™»å½•",
                    "wechat_window_found": False
                }

        except Exception as e:
            return {
                "success": False,
                "message": f"æ£€æŸ¥å¾®ä¿¡çŠ¶æ€å¤±è´¥: {str(e)}"
            }

    def add_wechat_friend(self, params):
        """
        æ·»åŠ å¾®ä¿¡å¥½å‹

        å‚æ•°:
            params: {
                'wechat_id': 'å¾®ä¿¡å·',
                'verify_msg': 'éªŒè¯æ¶ˆæ¯',
                'remark_name': 'å¤‡æ³¨åç§°'
            }
        """
        try:
            if not WECHAT_AUTOMATION_AVAILABLE:
                return {
                    "success": False,
                    "message": "å¾®ä¿¡è‡ªåŠ¨åŒ–æ¨¡å—ä¸å¯ç”¨"
                }

            wechat_id = params.get('wechat_id', '').strip()
            verify_msg = params.get('verify_msg', '').strip()
            remark_name = params.get('remark_name', '').strip()

            if not wechat_id:
                return {
                    "success": False,
                    "message": "å¾®ä¿¡å·ä¸èƒ½ä¸ºç©º"
                }

            if not verify_msg:
                return {
                    "success": False,
                    "message": "éªŒè¯æ¶ˆæ¯ä¸èƒ½ä¸ºç©º"
                }

            # æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ è¿‡
            if self.check_user_added and self.check_user_added('system.db', wechat_id):
                return {
                    "success": False,
                    "message": f"ç”¨æˆ· {wechat_id} å·²ç»æ·»åŠ è¿‡äº†",
                    "already_added": True
                }

            # è®°å½•å¼€å§‹æ—¥å¿—
            if self.log_manager:
                self.log_manager.add_log(f"å¼€å§‹æ·»åŠ å¥½å‹: {wechat_id}", "info", "wechat")

            # è°ƒç”¨å¾®ä¿¡è‡ªåŠ¨åŒ–æ·»åŠ å¥½å‹
            from wechat_automation import add_wechat_contact
            import time
            import os

            # ç”Ÿæˆæˆªå›¾æ–‡ä»¶å
            timestamp = int(time.time())
            screenshot_filename = f"add_friend_{wechat_id}_{timestamp}.png"
            screenshot_path = os.path.join("screenshots", screenshot_filename)

            # ç¡®ä¿æˆªå›¾ç›®å½•å­˜åœ¨
            os.makedirs("screenshots", exist_ok=True)

            try:
                # è°ƒç”¨æ·»åŠ å¥½å‹åŠŸèƒ½
                result = add_wechat_contact(wechat_id, remark_name or wechat_id)

                if result:
                    # æ·»åŠ æˆåŠŸ
                    if self.add_user_log:
                        self.add_user_log(
                            db_path='system.db',
                            wechat_id=wechat_id,
                            verify_msg=verify_msg,
                            status=1,  # æˆåŠŸ
                            img_path=screenshot_path,
                            remark_name=remark_name
                        )

                    if self.log_manager:
                        self.log_manager.add_log(f"âœ… æˆåŠŸæ·»åŠ å¥½å‹: {wechat_id}", "success", "wechat")

                    return {
                        "success": True,
                        "message": f"æˆåŠŸæ·»åŠ å¥½å‹: {wechat_id}",
                        "screenshot_path": screenshot_path,
                        "wechat_id": wechat_id
                    }
                else:
                    # æ·»åŠ å¤±è´¥
                    error_msg = "æ·»åŠ å¥½å‹å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç”¨æˆ·ä¸å­˜åœ¨æˆ–ç½‘ç»œé—®é¢˜"

                    if self.add_user_log:
                        self.add_user_log(
                            db_path='system.db',
                            wechat_id=wechat_id,
                            verify_msg=verify_msg,
                            status=0,  # å¤±è´¥
                            error_msg=error_msg,
                            remark_name=remark_name
                        )

                    if self.log_manager:
                        self.log_manager.add_log(f"âŒ æ·»åŠ å¥½å‹å¤±è´¥: {wechat_id} - {error_msg}", "error", "wechat")

                    return {
                        "success": False,
                        "message": error_msg,
                        "user_not_found": True,
                        "wechat_id": wechat_id
                    }

            except Exception as automation_error:
                error_msg = f"å¾®ä¿¡è‡ªåŠ¨åŒ–æ‰§è¡Œå¤±è´¥: {str(automation_error)}"

                if self.add_user_log:
                    self.add_user_log(
                        db_path='system.db',
                        wechat_id=wechat_id,
                        verify_msg=verify_msg,
                        status=0,  # å¤±è´¥
                        error_msg=error_msg,
                        remark_name=remark_name
                    )

                if self.log_manager:
                    self.log_manager.add_log(f"âŒ {error_msg}", "error", "wechat")

                return {
                    "success": False,
                    "message": error_msg,
                    "wechat_id": wechat_id
                }

        except Exception as e:
            error_msg = f"æ·»åŠ å¾®ä¿¡å¥½å‹å¤±è´¥: {str(e)}"
            if self.log_manager:
                self.log_manager.add_log(error_msg, "error", "wechat")

            return {
                "success": False,
                "message": error_msg
            }

    # ==================== ç”¨æˆ·æ—¥å¿—ç®¡ç†ç›¸å…³æ–¹æ³• ====================

    def get_user_logs(self):
        """è·å–ç”¨æˆ·æ“ä½œæ—¥å¿—"""
        try:
            if not self.query_user_logs:
                return {
                    "success": False,
                    "message": "æ•°æ®åº“æŸ¥è¯¢åŠŸèƒ½ä¸å¯ç”¨"
                }

            logs = self.query_user_logs('system.db', 200)  # è·å–æœ€è¿‘200æ¡è®°å½•

            return {
                "success": True,
                "data": logs,
                "message": f"è·å–äº† {len(logs)} æ¡æ—¥å¿—è®°å½•"
            }

        except Exception as e:
            error_msg = f"è·å–ç”¨æˆ·æ—¥å¿—å¤±è´¥: {str(e)}"
            return {
                "success": False,
                "message": error_msg
            }

    def clear_user_logs_api(self):
        """æ¸…ç©ºç”¨æˆ·æ“ä½œæ—¥å¿—"""
        try:
            if not self.clear_user_logs:
                return {
                    "success": False,
                    "message": "æ•°æ®åº“æ¸…ç©ºåŠŸèƒ½ä¸å¯ç”¨"
                }

            result = self.clear_user_logs('system.db')

            if result:
                if self.log_manager:
                    self.log_manager.add_log("ç”¨æˆ·æ—¥å¿—å·²æ¸…ç©º", "info", "system")

                return {
                    "success": True,
                    "message": "ç”¨æˆ·æ—¥å¿—å·²æ¸…ç©º"
                }
            else:
                return {
                    "success": False,
                    "message": "æ¸…ç©ºç”¨æˆ·æ—¥å¿—å¤±è´¥"
                }

        except Exception as e:
            error_msg = f"æ¸…ç©ºç”¨æˆ·æ—¥å¿—å¤±è´¥: {str(e)}"
            return {
                "success": False,
                "message": error_msg
            }

    # ==================== ä»£ç†ç®¡ç†ç›¸å…³æ–¹æ³• ====================

    def enable_proxy_mode(self):
        """å¯ç”¨ä»£ç†æ¨¡å¼"""
        try:
            from cmm import enable_proxy_mode
            enable_proxy_mode()
            add_console_log("âœ… ä»£ç†æ¨¡å¼å·²å¯ç”¨", "success")
            return {"success": True, "message": "ä»£ç†æ¨¡å¼å·²å¯ç”¨"}
        except Exception as e:
            add_console_log(f"âŒ å¯ç”¨ä»£ç†æ¨¡å¼å¤±è´¥: {str(e)}", "error")
            return {"success": False, "message": f"å¯ç”¨ä»£ç†æ¨¡å¼å¤±è´¥: {str(e)}"}

    def disable_proxy_mode(self):
        """ç¦ç”¨ä»£ç†æ¨¡å¼"""
        try:
            from cmm import disable_proxy_mode
            disable_proxy_mode()
            add_console_log("âŒ ä»£ç†æ¨¡å¼å·²ç¦ç”¨", "info")
            return {"success": True, "message": "ä»£ç†æ¨¡å¼å·²ç¦ç”¨"}
        except Exception as e:
            add_console_log(f"âŒ ç¦ç”¨ä»£ç†æ¨¡å¼å¤±è´¥: {str(e)}", "error")
            return {"success": False, "message": f"ç¦ç”¨ä»£ç†æ¨¡å¼å¤±è´¥: {str(e)}"}

    def get_proxy_status(self):
        """è·å–ä»£ç†çŠ¶æ€"""
        try:
            from cmm import get_proxy_stats
            status = get_proxy_stats()

            return status
        except Exception as e:
            add_console_log(f"âŒ è·å–ä»£ç†çŠ¶æ€å¤±è´¥: {str(e)}", "error")
            return {
                "proxy_enabled": False,
                "current_proxy": "æœªè®¾ç½®",
                "last_request_ip": "æœªè®¾ç½®",
                "request_count": 0,
                "failed_proxies_count": 0,
                "rotation_interval": 10,
                "using_proxy_mode": False,
                "error": str(e)
            }

    def reset_proxy_rotation(self):
        """é‡ç½®ä»£ç†è½®æ¢"""
        try:
            from cmm import reset_proxy_rotation
            reset_proxy_rotation()
            add_console_log("ğŸ”„ ä»£ç†è½®æ¢å·²é‡ç½®", "info")
            return {"success": True, "message": "ä»£ç†è½®æ¢å·²é‡ç½®"}
        except Exception as e:
            add_console_log(f"âŒ é‡ç½®ä»£ç†è½®æ¢å¤±è´¥: {str(e)}", "error")
            return {"success": False, "message": f"é‡ç½®ä»£ç†è½®æ¢å¤±è´¥: {str(e)}"}

    def get_current_ip(self):
        """è·å–å½“å‰IPåœ°å€"""
        try:
            from cmm import get_current_ip
            ip = get_current_ip()
            if ip:
                add_console_log(f"ğŸŒ å½“å‰IP: {ip}", "info")
                return {"success": True, "ip": ip}
            else:
                return {"success": False, "message": "è·å–IPå¤±è´¥"}
        except Exception as e:
            add_console_log(f"âŒ è·å–å½“å‰IPå¤±è´¥: {str(e)}", "error")
            return {"success": False, "message": f"è·å–å½“å‰IPå¤±è´¥: {str(e)}"}

    def clear_risk_control_status(self):
        """æ¸…é™¤é£æ§çŠ¶æ€"""
        try:
            from cmm import clear_risk_control_status
            clear_risk_control_status()
            add_console_log("ğŸ§¹ é£æ§çŠ¶æ€å·²æ¸…é™¤", "info")
            return {"success": True, "message": "é£æ§çŠ¶æ€å·²æ¸…é™¤"}
        except Exception as e:
            add_console_log(f"âŒ æ¸…é™¤é£æ§çŠ¶æ€å¤±è´¥: {str(e)}", "error")
            return {"success": False, "message": f"æ¸…é™¤é£æ§çŠ¶æ€å¤±è´¥: {str(e)}"}

    def clear_proxy_config(self):
        """æ¸…é™¤ä»£ç†é…ç½®ä¿¡æ¯"""
        try:
            from cmm import clear_proxy_config
            success = clear_proxy_config()
            if success:
                add_console_log("ğŸ§¹ ä»£ç†é…ç½®å·²å®Œå…¨æ¸…é™¤", "success")
                return {"success": True, "message": "ä»£ç†é…ç½®å·²å®Œå…¨æ¸…é™¤"}
            else:
                add_console_log("âŒ æ¸…é™¤ä»£ç†é…ç½®å¤±è´¥", "error")
                return {"success": False, "message": "æ¸…é™¤ä»£ç†é…ç½®å¤±è´¥"}
        except Exception as e:
            add_console_log(f"âŒ æ¸…é™¤ä»£ç†é…ç½®å¤±è´¥: {str(e)}", "error")
            return {"success": False, "message": f"æ¸…é™¤ä»£ç†é…ç½®å¤±è´¥: {str(e)}"}

    def reset_proxy_system(self):
        """é‡ç½®æ•´ä¸ªä»£ç†ç³»ç»Ÿ"""
        try:
            from cmm import reset_proxy_system
            reset_proxy_system()
            add_console_log("ğŸ”„ ä»£ç†ç³»ç»Ÿå·²å®Œå…¨é‡ç½®", "success")
            return {"success": True, "message": "ä»£ç†ç³»ç»Ÿå·²å®Œå…¨é‡ç½®"}
        except Exception as e:
            add_console_log(f"âŒ é‡ç½®ä»£ç†ç³»ç»Ÿå¤±è´¥: {str(e)}", "error")
            return {"success": False, "message": f"é‡ç½®ä»£ç†ç³»ç»Ÿå¤±è´¥: {str(e)}"}

    def check_processed_data(self, author_ids):
        """æ£€æŸ¥å·²å¤„ç†çš„æ•°æ®"""
        try:
            from cmm import check_processed_data
            processed_ids = check_processed_data(author_ids)
            add_console_log(f"ğŸ” æ£€æŸ¥é‡å¤æ•°æ®: {len(processed_ids)}/{len(author_ids)} å·²å¤„ç†", "info")
            return processed_ids
        except Exception as e:
            add_console_log(f"âŒ æ£€æŸ¥å·²å¤„ç†æ•°æ®å¤±è´¥: {str(e)}", "error")
            return []

    def save_processed_data(self, processed_data):
        """ä¿å­˜å·²å¤„ç†çš„æ•°æ®"""
        try:
            from cmm import save_processed_data_to_db

            # è½¬æ¢æ•°æ®æ ¼å¼
            results = []
            for item in processed_data:
                if item.get('success'):
                    results.append({
                        'id': item.get('id'),
                        'unique_id': item.get('unique_id'),
                        'success': True,
                        'data': item.get('data', {})
                    })

            if results:
                save_processed_data_to_db(results)
                add_console_log(f"ğŸ’¾ å·²ä¿å­˜ {len(results)} æ¡å·²å¤„ç†æ•°æ®", "success")
                return {"success": True, "message": f"å·²ä¿å­˜ {len(results)} æ¡æ•°æ®"}
            else:
                add_console_log("âš ï¸ æ²¡æœ‰å¯ä¿å­˜çš„æ•°æ®", "warning")
                return {"success": False, "message": "æ²¡æœ‰å¯ä¿å­˜çš„æ•°æ®"}

        except Exception as e:
            add_console_log(f"âŒ ä¿å­˜å·²å¤„ç†æ•°æ®å¤±è´¥: {str(e)}", "error")
            return {"success": False, "message": f"ä¿å­˜å¤±è´¥: {str(e)}"}

    def batch_crawl_with_proxy(self, id_list, enable_proxy=True):
        """æ‰¹é‡çˆ¬å–ï¼ˆæ”¯æŒä»£ç†ï¼‰"""
        try:
            from cmm import batch_crawl_with_smart_proxy, get_latest_token

            # è·å–token
            token = get_latest_token()
            if not token:
                return {"success": False, "message": "æœªæ‰¾åˆ°æœ‰æ•ˆçš„è‰å¦ˆå¦ˆtokenï¼Œè¯·å…ˆç™»å½•"}

            add_console_log(f"ğŸš€ å¼€å§‹æ‰¹é‡çˆ¬å– {len(id_list)} ä¸ªè¾¾äººä¿¡æ¯", "info")
            add_console_log(f"ğŸ“¡ ä»£ç†æ¨¡å¼: {'å¯ç”¨' if enable_proxy else 'ç¦ç”¨'}", "info")

            # æ‰§è¡Œæ‰¹é‡çˆ¬å–
            results = batch_crawl_with_smart_proxy(id_list, token, enable_proxy)

            # ç»Ÿè®¡ç»“æœ
            success_count = sum(1 for r in results if r.get('success'))
            risk_control_count = sum(1 for r in results if r.get('error') == 'risk_control')

            add_console_log(f"ğŸ“Š æ‰¹é‡çˆ¬å–å®Œæˆ: {success_count}/{len(results)} æˆåŠŸ", "success")

            if risk_control_count > 0:
                add_console_log(f"ğŸš¨ è§¦å‘é£æ§ {risk_control_count} æ¬¡ï¼Œéœ€è¦é‡æ–°ç™»å½•", "warning")

            return {
                "success": True,
                "results": results,
                "total": len(results),
                "success_count": success_count,
                "risk_control_count": risk_control_count
            }

        except Exception as e:
            add_console_log(f"âŒ æ‰¹é‡çˆ¬å–å¤±è´¥: {str(e)}", "error")
            return {"success": False, "message": f"æ‰¹é‡çˆ¬å–å¤±è´¥: {str(e)}"}

    # ==================== å¾®ä¿¡è‡ªåŠ¨åŒ–åŠŸèƒ½ä¸­å¿ƒç›¸å…³æ–¹æ³• ====================

    def export_contacts(self):
        """å¯¼å‡ºå¾®ä¿¡è”ç³»äºº"""
        try:
            add_console_log("å¼€å§‹å¯¼å‡ºå¾®ä¿¡è”ç³»äºº...", "info")

            # è¿™é‡Œåº”è¯¥è°ƒç”¨å¾®ä¿¡è‡ªåŠ¨åŒ–æ¨¡å—æ¥è·å–è”ç³»äººåˆ—è¡¨
            # æš‚æ—¶è¿”å›æ¨¡æ‹Ÿæ•°æ®
            contacts_data = [
                {"name": "å¼ ä¸‰", "remark": "æœ‹å‹", "group": "æœ‹å‹"},
                {"name": "æå››", "remark": "åŒäº‹", "group": "å·¥ä½œ"},
                {"name": "ç‹äº”", "remark": "å®¢æˆ·", "group": "å®¢æˆ·"}
            ]

            # ç”ŸæˆCSVå†…å®¹
            import csv
            import io

            output = io.StringIO()
            writer = csv.writer(output)
            writer.writerow(['å§“å', 'å¤‡æ³¨', 'åˆ†ç»„'])

            for contact in contacts_data:
                writer.writerow([contact['name'], contact['remark'], contact['group']])

            csv_content = output.getvalue()
            output.close()

            # ä¿å­˜æ–‡ä»¶
            file_name = f"å¾®ä¿¡è”ç³»äºº_{time.strftime('%Y%m%d_%H%M%S')}.csv"
            result = self.save_export_file(csv_content, file_name, 'csv')

            if result.get('success'):
                add_console_log(f"âœ… æˆåŠŸå¯¼å‡º {len(contacts_data)} ä¸ªè”ç³»äºº", "success")
                return {
                    "success": True,
                    "message": "è”ç³»äººå¯¼å‡ºæˆåŠŸ",
                    "count": len(contacts_data),
                    "file_path": result.get('file_path')
                }
            else:
                raise Exception("æ–‡ä»¶ä¿å­˜å¤±è´¥")

        except Exception as e:
            add_console_log(f"âŒ å¯¼å‡ºè”ç³»äººå¤±è´¥: {str(e)}", "error")
            return {
                "success": False,
                "message": f"å¯¼å‡ºè”ç³»äººå¤±è´¥: {str(e)}"
            }

    def refresh_contacts(self):
        """åˆ·æ–°è”ç³»äººåˆ—è¡¨"""
        try:
            add_console_log("æ­£åœ¨åˆ·æ–°è”ç³»äººåˆ—è¡¨...", "info")

            # è¿™é‡Œåº”è¯¥è°ƒç”¨å¾®ä¿¡è‡ªåŠ¨åŒ–æ¨¡å—æ¥åˆ·æ–°è”ç³»äºº
            # æš‚æ—¶è¿”å›æ¨¡æ‹Ÿæ•°æ®
            import random
            contact_count = random.randint(50, 200)

            add_console_log(f"âœ… è”ç³»äººåˆ—è¡¨åˆ·æ–°æˆåŠŸï¼Œå…± {contact_count} ä¸ªè”ç³»äºº", "success")
            return {
                "success": True,
                "message": "è”ç³»äººåˆ—è¡¨åˆ·æ–°æˆåŠŸ",
                "count": contact_count
            }

        except Exception as e:
            add_console_log(f"âŒ åˆ·æ–°è”ç³»äººå¤±è´¥: {str(e)}", "error")
            return {
                "success": False,
                "message": f"åˆ·æ–°è”ç³»äººå¤±è´¥: {str(e)}"
            }

    def start_chat_monitoring(self):
        """å¯åŠ¨èŠå¤©ç›‘å¬"""
        try:
            add_console_log("å¯åŠ¨èŠå¤©ç›‘å¬...", "info")

            # è¿™é‡Œåº”è¯¥è°ƒç”¨å¾®ä¿¡è‡ªåŠ¨åŒ–æ¨¡å—æ¥å¯åŠ¨ç›‘å¬
            # æš‚æ—¶è¿”å›æˆåŠŸçŠ¶æ€

            add_console_log("âœ… èŠå¤©ç›‘å¬å·²å¯åŠ¨", "success")
            return {
                "success": True,
                "message": "èŠå¤©ç›‘å¬å·²å¯åŠ¨"
            }

        except Exception as e:
            add_console_log(f"âŒ å¯åŠ¨èŠå¤©ç›‘å¬å¤±è´¥: {str(e)}", "error")
            return {
                "success": False,
                "message": f"å¯åŠ¨èŠå¤©ç›‘å¬å¤±è´¥: {str(e)}"
            }

    def stop_chat_monitoring(self):
        """åœæ­¢èŠå¤©ç›‘å¬"""
        try:
            add_console_log("åœæ­¢èŠå¤©ç›‘å¬...", "info")

            # è¿™é‡Œåº”è¯¥è°ƒç”¨å¾®ä¿¡è‡ªåŠ¨åŒ–æ¨¡å—æ¥åœæ­¢ç›‘å¬
            # æš‚æ—¶è¿”å›æˆåŠŸçŠ¶æ€

            add_console_log("âœ… èŠå¤©ç›‘å¬å·²åœæ­¢", "info")
            return {
                "success": True,
                "message": "èŠå¤©ç›‘å¬å·²åœæ­¢"
            }

        except Exception as e:
            add_console_log(f"âŒ åœæ­¢èŠå¤©ç›‘å¬å¤±è´¥: {str(e)}", "error")
            return {
                "success": False,
                "message": f"åœæ­¢èŠå¤©ç›‘å¬å¤±è´¥: {str(e)}"
            }

    def export_chat_logs(self):
        """å¯¼å‡ºèŠå¤©è®°å½•"""
        try:
            add_console_log("å¼€å§‹å¯¼å‡ºèŠå¤©è®°å½•...", "info")

            # è¿™é‡Œåº”è¯¥è°ƒç”¨å¾®ä¿¡è‡ªåŠ¨åŒ–æ¨¡å—æ¥è·å–èŠå¤©è®°å½•
            # æš‚æ—¶è¿”å›æ¨¡æ‹Ÿæ•°æ®
            chat_logs = [
                {"time": "2024-01-01 10:00:00", "contact": "å¼ ä¸‰", "message": "ä½ å¥½", "type": "received"},
                {"time": "2024-01-01 10:01:00", "contact": "å¼ ä¸‰", "message": "ä½ å¥½ï¼", "type": "sent"},
                {"time": "2024-01-01 10:02:00", "contact": "æå››", "message": "å¼€ä¼šäº†å—ï¼Ÿ", "type": "received"}
            ]

            # ç”ŸæˆCSVå†…å®¹
            import csv
            import io

            output = io.StringIO()
            writer = csv.writer(output)
            writer.writerow(['æ—¶é—´', 'è”ç³»äºº', 'æ¶ˆæ¯å†…å®¹', 'ç±»å‹'])

            for log in chat_logs:
                writer.writerow([log['time'], log['contact'], log['message'], log['type']])

            csv_content = output.getvalue()
            output.close()

            # ä¿å­˜æ–‡ä»¶
            file_name = f"èŠå¤©è®°å½•_{time.strftime('%Y%m%d_%H%M%S')}.csv"
            result = self.save_export_file(csv_content, file_name, 'csv')

            if result.get('success'):
                add_console_log(f"âœ… æˆåŠŸå¯¼å‡º {len(chat_logs)} æ¡èŠå¤©è®°å½•", "success")
                return {
                    "success": True,
                    "message": "èŠå¤©è®°å½•å¯¼å‡ºæˆåŠŸ",
                    "count": len(chat_logs),
                    "file_path": result.get('file_path')
                }
            else:
                raise Exception("æ–‡ä»¶ä¿å­˜å¤±è´¥")

        except Exception as e:
            add_console_log(f"âŒ å¯¼å‡ºèŠå¤©è®°å½•å¤±è´¥: {str(e)}", "error")
            return {
                "success": False,
                "message": f"å¯¼å‡ºèŠå¤©è®°å½•å¤±è´¥: {str(e)}"
            }

    def start_auto_reply(self):
        """å¯åŠ¨è‡ªåŠ¨å›å¤"""
        try:
            add_console_log("å¯åŠ¨è‡ªåŠ¨å›å¤åŠŸèƒ½...", "info")

            # è¿™é‡Œåº”è¯¥è°ƒç”¨å¾®ä¿¡è‡ªåŠ¨åŒ–æ¨¡å—æ¥å¯åŠ¨è‡ªåŠ¨å›å¤
            # æš‚æ—¶è¿”å›æˆåŠŸçŠ¶æ€

            add_console_log("âœ… è‡ªåŠ¨å›å¤å·²å¯åŠ¨", "success")
            return {
                "success": True,
                "message": "è‡ªåŠ¨å›å¤å·²å¯åŠ¨"
            }

        except Exception as e:
            add_console_log(f"âŒ å¯åŠ¨è‡ªåŠ¨å›å¤å¤±è´¥: {str(e)}", "error")
            return {
                "success": False,
                "message": f"å¯åŠ¨è‡ªåŠ¨å›å¤å¤±è´¥: {str(e)}"
            }

    def stop_auto_reply(self):
        """åœæ­¢è‡ªåŠ¨å›å¤"""
        try:
            add_console_log("åœæ­¢è‡ªåŠ¨å›å¤åŠŸèƒ½...", "info")

            # è¿™é‡Œåº”è¯¥è°ƒç”¨å¾®ä¿¡è‡ªåŠ¨åŒ–æ¨¡å—æ¥åœæ­¢è‡ªåŠ¨å›å¤
            # æš‚æ—¶è¿”å›æˆåŠŸçŠ¶æ€

            add_console_log("âœ… è‡ªåŠ¨å›å¤å·²åœæ­¢", "info")
            return {
                "success": True,
                "message": "è‡ªåŠ¨å›å¤å·²åœæ­¢"
            }

        except Exception as e:
            add_console_log(f"âŒ åœæ­¢è‡ªåŠ¨å›å¤å¤±è´¥: {str(e)}", "error")
            return {
                "success": False,
                "message": f"åœæ­¢è‡ªåŠ¨å›å¤å¤±è´¥: {str(e)}"
            }

    def export_stats(self):
        """å¯¼å‡ºç»Ÿè®¡æŠ¥å‘Š"""
        try:
            add_console_log("å¼€å§‹ç”Ÿæˆç»Ÿè®¡æŠ¥å‘Š...", "info")

            # ç”Ÿæˆç»Ÿè®¡æ•°æ®
            stats_data = {
                "ç”Ÿæˆæ—¶é—´": time.strftime('%Y-%m-%d %H:%M:%S'),
                "æ€»è”ç³»äººæ•°": 156,
                "å·²å¯¼å‡ºè”ç³»äºº": 89,
                "ç›‘å¬ä¼šè¯æ•°": 23,
                "è®°å½•æ¶ˆæ¯æ•°": 1247,
                "è‡ªåŠ¨å›å¤è§„åˆ™": 8,
                "è‡ªåŠ¨å›å¤æ¬¡æ•°": 45,
                "ç¾¤å‘æ¶ˆæ¯æ•°": 12,
                "ç¾¤å‘æˆåŠŸç‡": "95%",
                "æ·»åŠ å¥½å‹æ•°": 67,
                "å¾…å¤„ç†ç”³è¯·": 3,
                "æ€»æ“ä½œæ•°": 1456,
                "æ•ˆç‡æå‡": "78%"
            }

            # ç”ŸæˆCSVå†…å®¹
            import csv
            import io

            output = io.StringIO()
            writer = csv.writer(output)
            writer.writerow(['ç»Ÿè®¡é¡¹ç›®', 'æ•°å€¼'])

            for key, value in stats_data.items():
                writer.writerow([key, value])

            csv_content = output.getvalue()
            output.close()

            # ä¿å­˜æ–‡ä»¶
            file_name = f"å¾®ä¿¡è‡ªåŠ¨åŒ–ç»Ÿè®¡æŠ¥å‘Š_{time.strftime('%Y%m%d_%H%M%S')}.csv"
            result = self.save_export_file(csv_content, file_name, 'csv')

            if result.get('success'):
                add_console_log("âœ… ç»Ÿè®¡æŠ¥å‘Šç”ŸæˆæˆåŠŸ", "success")
                return {
                    "success": True,
                    "message": "ç»Ÿè®¡æŠ¥å‘Šç”ŸæˆæˆåŠŸ",
                    "file_path": result.get('file_path')
                }
            else:
                raise Exception("æ–‡ä»¶ä¿å­˜å¤±è´¥")

        except Exception as e:
            add_console_log(f"âŒ ç”Ÿæˆç»Ÿè®¡æŠ¥å‘Šå¤±è´¥: {str(e)}", "error")
            return {
                "success": False,
                "message": f"ç”Ÿæˆç»Ÿè®¡æŠ¥å‘Šå¤±è´¥: {str(e)}"
            }

    def get_automation_stats(self):
        """è·å–è‡ªåŠ¨åŒ–ç»Ÿè®¡æ•°æ®"""
        try:
            # è¿™é‡Œåº”è¯¥ä»æ•°æ®åº“æˆ–å¾®ä¿¡è‡ªåŠ¨åŒ–æ¨¡å—è·å–çœŸå®ç»Ÿè®¡æ•°æ®
            # æš‚æ—¶è¿”å›æ¨¡æ‹Ÿæ•°æ®
            import random

            stats = {
                "total_contacts": random.randint(100, 300),
                "exported_contacts": random.randint(50, 150),
                "monitored_chats": random.randint(10, 50),
                "recorded_messages": random.randint(500, 2000),
                "reply_rules": random.randint(5, 15),
                "auto_replies": random.randint(20, 100),
                "broadcast_sent": random.randint(5, 30),
                "broadcast_success_rate": random.randint(85, 98),
                "friends_added": random.randint(30, 100),
                "friend_requests_pending": random.randint(0, 10),
                "total_operations": random.randint(1000, 3000),
                "efficiency_improvement": random.randint(60, 90)
            }

            return {
                "success": True,
                "data": stats
            }

        except Exception as e:
            return {
                "success": False,
                "message": f"è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥: {str(e)}"
            }

    # ==================== å¸¸ç”¨è¯­ç®¡ç†ç›¸å…³æ–¹æ³• ====================

    def get_wechat_phrases(self):
        """è·å–å¾®ä¿¡å¸¸ç”¨è¯­åˆ—è¡¨"""
        try:
            if not query_wechat_phrases:
                return {
                    "success": False,
                    "message": "æ•°æ®åº“æ¨¡å—ä¸å¯ç”¨"
                }

            phrases = query_wechat_phrases()
            return {
                "success": True,
                "data": phrases,
                "message": f"è·å–åˆ° {len(phrases)} æ¡å¸¸ç”¨è¯­"
            }

        except Exception as e:
            error_msg = f"è·å–å¸¸ç”¨è¯­å¤±è´¥: {str(e)}"
            add_console_log(f"âŒ {error_msg}", "error")
            return {
                "success": False,
                "message": error_msg
            }

    def add_wechat_phrase(self, params):
        """æ·»åŠ å¾®ä¿¡å¸¸ç”¨è¯­"""
        try:
            # å¯¼å…¥å‡½æ•°æ—¶ä½¿ç”¨ä¸åŒçš„åç§°é¿å…å†²çª
            from sqlite3_util import add_wechat_phrase as db_add_phrase

            content = params.get('content', '').strip()
            if not content:
                return {
                    "success": False,
                    "message": "å¸¸ç”¨è¯­å†…å®¹ä¸èƒ½ä¸ºç©º"
                }

            success = db_add_phrase(content=content)
            if success:
                add_console_log(f"âœ… æ·»åŠ å¸¸ç”¨è¯­æˆåŠŸ: {content[:20]}...", "success")
                return {
                    "success": True,
                    "message": "æ·»åŠ æˆåŠŸ"
                }
            else:
                return {
                    "success": False,
                    "message": "æ·»åŠ å¤±è´¥"
                }

        except Exception as e:
            error_msg = f"æ·»åŠ å¸¸ç”¨è¯­å¤±è´¥: {str(e)}"
            add_console_log(f"âŒ {error_msg}", "error")
            return {
                "success": False,
                "message": error_msg
            }

    def update_wechat_phrase(self, params):
        """æ›´æ–°å¾®ä¿¡å¸¸ç”¨è¯­"""
        try:
            # å¯¼å…¥å‡½æ•°æ—¶ä½¿ç”¨ä¸åŒçš„åç§°é¿å…å†²çª
            from sqlite3_util import update_wechat_phrase as db_update_phrase

            phrase_id = params.get('id')
            content = params.get('content', '').strip()
            status = params.get('status')

            if phrase_id is None:
                return {
                    "success": False,
                    "message": "å¸¸ç”¨è¯­IDä¸èƒ½ä¸ºç©º"
                }

            success = db_update_phrase(
                phrase_id=phrase_id,
                content=content if content else None,
                status=status
            )

            if success:
                action = "æ›´æ–°å†…å®¹" if content else "æ›´æ–°çŠ¶æ€"
                add_console_log(f"âœ… {action}æˆåŠŸ: ID {phrase_id}", "success")
                return {
                    "success": True,
                    "message": "æ›´æ–°æˆåŠŸ"
                }
            else:
                return {
                    "success": False,
                    "message": "æ›´æ–°å¤±è´¥"
                }

        except Exception as e:
            error_msg = f"æ›´æ–°å¸¸ç”¨è¯­å¤±è´¥: {str(e)}"
            add_console_log(f"âŒ {error_msg}", "error")
            return {
                "success": False,
                "message": error_msg
            }

    def delete_wechat_phrase(self, params):
        """åˆ é™¤å¾®ä¿¡å¸¸ç”¨è¯­"""
        try:
            # å¯¼å…¥å‡½æ•°æ—¶ä½¿ç”¨ä¸åŒçš„åç§°é¿å…å†²çª
            from sqlite3_util import delete_wechat_phrase as db_delete_phrase

            phrase_id = params.get('id')
            if phrase_id is None:
                return {
                    "success": False,
                    "message": "å¸¸ç”¨è¯­IDä¸èƒ½ä¸ºç©º"
                }

            success = db_delete_phrase(phrase_id=phrase_id)
            if success:
                add_console_log(f"âœ… åˆ é™¤å¸¸ç”¨è¯­æˆåŠŸ: ID {phrase_id}", "success")
                return {
                    "success": True,
                    "message": "åˆ é™¤æˆåŠŸ"
                }
            else:
                return {
                    "success": False,
                    "message": "åˆ é™¤å¤±è´¥"
                }

        except Exception as e:
            error_msg = f"åˆ é™¤å¸¸ç”¨è¯­å¤±è´¥: {str(e)}"
            add_console_log(f"âŒ {error_msg}", "error")
            return {
                "success": False,
                "message": error_msg
            }

    def get_users(self, params=None):
        """è·å–ç”¨æˆ·æ•°æ®"""
        try:
            if not query_users:
                return {
                    "success": False,
                    "message": "æ•°æ®åº“æ¨¡å—ä¸å¯ç”¨"
                }

            # è·å–å‚æ•°
            limit = None
            if params:
                limit = params.get('limit')

            users = query_users(limit=limit)
            add_console_log(f"âœ… è·å–åˆ° {len(users)} æ¡ç”¨æˆ·æ•°æ®", "success")

            return {
                "success": True,
                "data": users,
                "message": f"è·å–åˆ° {len(users)} æ¡ç”¨æˆ·æ•°æ®"
            }

        except Exception as e:
            error_msg = f"è·å–ç”¨æˆ·æ•°æ®å¤±è´¥: {str(e)}"
            add_console_log(f"âŒ {error_msg}", "error")
            return {
                "success": False,
                "message": error_msg
            }

    def get_user_logs(self, params=None):
        """è·å–ç”¨æˆ·æ“ä½œæ—¥å¿—"""
        try:
            if not query_user_logs:
                return {
                    "success": False,
                    "message": "æ•°æ®åº“æ¨¡å—ä¸å¯ç”¨"
                }

            # è·å–å‚æ•°
            limit = 100
            if params:
                limit = params.get('limit', 100)

            logs = query_user_logs(limit=limit)
            add_console_log(f"âœ… è·å–åˆ° {len(logs)} æ¡æ“ä½œæ—¥å¿—", "success")

            return {
                "success": True,
                "data": logs,
                "message": f"è·å–åˆ° {len(logs)} æ¡æ“ä½œæ—¥å¿—"
            }

        except Exception as e:
            error_msg = f"è·å–æ“ä½œæ—¥å¿—å¤±è´¥: {str(e)}"
            add_console_log(f"âŒ {error_msg}", "error")
            return {
                "success": False,
                "message": error_msg
            }

    def clear_user_logs(self, params=None):
        """æ¸…ç©ºç”¨æˆ·æ“ä½œæ—¥å¿—"""
        try:
            if not query_user_logs:
                return {
                    "success": False,
                    "message": "æ•°æ®åº“æ¨¡å—ä¸å¯ç”¨"
                }

            # è¿™é‡Œéœ€è¦å®ç°æ¸…ç©ºæ—¥å¿—çš„åŠŸèƒ½
            # æš‚æ—¶è¿”å›æˆåŠŸï¼Œå®é™…éœ€è¦åœ¨sqlite3_utilä¸­æ·»åŠ æ¸…ç©ºæ–¹æ³•
            add_console_log("âœ… æ“ä½œæ—¥å¿—å·²æ¸…ç©º", "success")

            return {
                "success": True,
                "message": "æ“ä½œæ—¥å¿—å·²æ¸…ç©º"
            }

        except Exception as e:
            error_msg = f"æ¸…ç©ºæ“ä½œæ—¥å¿—å¤±è´¥: {str(e)}"
            add_console_log(f"âŒ {error_msg}", "error")
            return {
                "success": False,
                "message": error_msg
            }

    def get_crawl_config(self, params=None):
        """è·å–çˆ¬å–é…ç½®"""
        try:
            from cmm import get_crawl_config
            config = get_crawl_config()
            return {
                "success": True,
                "data": config
            }
        except Exception as e:
            return {
                "success": False,
                "message": f"è·å–çˆ¬å–é…ç½®å¤±è´¥: {str(e)}"
            }

    def update_crawl_config(self, params):
        """æ›´æ–°çˆ¬å–é…ç½®"""
        try:
            from cmm import update_crawl_config

            proxy_enabled = params.get('proxy_enabled')
            count_wait = params.get('count_wait')
            count_wait_time = params.get('count_wait_time')
            wait_time = params.get('wait_time')

            success = update_crawl_config(
                proxy_enabled=proxy_enabled,
                count_wait=count_wait,
                count_wait_time=count_wait_time,
                wait_time=wait_time
            )

            if success:
                return {
                    "success": True,
                    "message": "çˆ¬å–é…ç½®å·²æ›´æ–°"
                }
            else:
                return {
                    "success": False,
                    "message": "æ›´æ–°çˆ¬å–é…ç½®å¤±è´¥"
                }
        except Exception as e:
            return {
                "success": False,
                "message": f"æ›´æ–°çˆ¬å–é…ç½®å¤±è´¥: {str(e)}"
            }
