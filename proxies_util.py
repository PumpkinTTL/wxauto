import requests
from typing import List


static_proxies = [
    '147.28.240.215:443',
    '147.28.240.218:443',
    '147.28.240.214:9401',
    '147.28.240.216:443',
    '147.28.240.217:443',
    '147.28.240.215:9401',
    '147.28.240.214:443',
    '147.28.240.217:9401',
    '47.91.121.127:80',
    '8.213.195.191:30000',
    '47.251.87.74:1036',
    '8.220.204.215:5060',
    '8.211.200.183:4006',
    '8.212.168.170:2080',
    '47.116.181.146:6379',
    '47.119.22.156:34567',
    '47.91.89.3:8080',
    '47.250.51.110:8081',
    '47.91.120.190:3129',
    '8.211.200.183:8080',
    '8.213.129.15:9091',
    '8.212.165.164:5005',
    '47.122.62.83:18080',
    '47.122.57.58:9999',
    '47.92.152.43:808',
    '8.130.36.163:9080',
    '8.213.134.213:10000',
    '8.138.82.6:8008',
    '47.119.22.92:8443',
    '47.90.167.27:102',
    '8.213.222.247:4002',
    '8.213.197.208:34567',
    '47.238.130.212:8888',
    '47.122.5.165:999',
    '47.109.83.196:8888',
    '8.213.129.20:88',
    '47.238.134.126:8443',
    '47.76.144.139:8443',
    '47.91.110.148:10001',
    '8.211.194.85:31433',
    '120.26.52.35:1081',
    '8.220.204.92:1088',
    '39.102.209.121:3128',
    '8.215.3.250:87',
    '149.129.255.179:4002',
    '8.212.165.164:5004',
    '101.200.158.109:8080',
    '47.116.181.146:3128',
    '39.102.210.176:8008',
    '106.14.91.83:8080',
    '8.221.139.222:4145',
    '47.122.65.254:9080',
    '8.213.129.15:10001',
    '47.116.126.57:9098',
    '205.178.144.208:8447',
    '182.160.16.163:20002',
    '47.251.87.74:2380',
    '47.122.65.32:8443',
    '8.213.129.20:8058',
    '8.211.194.78:80',
    '47.90.149.238:111',
    '47.119.22.92:8085',
    '47.252.11.233:20',
    '47.238.60.156:8008',
    '47.122.56.158:8080',
    '47.252.11.233:84',
    '106.14.91.83:3128',
    '47.113.203.122:20201',
    '47.104.27.165:8080',
    '8.215.3.250:443',
    '39.104.57.33:8080',
    '49.0.253.51:90',
    '39.104.69.76:8800',
    '47.91.109.17:3128',
    '47.116.181.146:8800',
    '47.238.130.212:80',
    '8.215.12.103:8445',
    '120.26.52.35:80',
    '8.221.139.222:3128',
    '8.213.128.6:8009',
    '8.211.49.86:2000',
    '8.212.168.170:1234',
    '47.253.214.60:1604',
    '47.122.31.238:3333',
    '47.250.11.111:102',
    '8.219.229.53:20',
    '39.102.211.162:8081',
    '47.92.219.102:8090',
    '8.215.15.163:8443',
    '47.238.60.156:2526',
    '47.252.18.37:8834',
    '18.204.69.227:8080',
    '47.121.182.36:6379',
    '8.221.141.88:5006',
    '47.108.159.113:9080',
    '47.254.36.213:3128',
    '8.213.128.90:4444',
    '39.102.213.50:10000',
    '47.109.83.196:8443',
    '47.89.159.212:3129',
    '47.237.113.119:3128',
    '47.250.51.110:10',
    '47.91.121.127:8080',
    '205.178.137.234:8447',
    '47.122.65.254:8081',
    '47.74.46.81:37777',
    '47.122.31.59:80',
    '149.129.226.9:5060',
    '8.137.38.48:8081',
    '47.109.46.223:8060',
    '47.91.120.190:1025',
    '47.251.87.199:1081',
    '8.213.197.208:9091',
    '47.91.29.151:8443',
    '8.213.215.187:3129',
    '8.211.51.115:1081',
    '8.220.204.215:1080',
    '47.119.19.221:8080',
    '8.211.194.85:9098',
    '8.213.129.15:8084',
    '8.212.165.164:10000',
    '8.215.15.163:50',
    '8.220.141.8:89',
    '8.209.96.245:1099',
    '39.101.65.228:8800',
    '120.25.189.254:8081',
    '8.213.134.213:1080',
    '165.225.72.38:11719',
    '47.109.83.196:3128',
    '47.92.219.102:8080',
    '47.252.18.37:1081',
    '8.211.194.78:8443',
    '47.122.62.83:8080',
    '47.121.183.107:7890',
    '47.252.18.37:45',
    '8.212.168.170:10000',
    '47.116.126.57:8081',
    '39.104.23.154:8443',
    '8.211.49.86:3129',
    '47.113.219.226:1081',
    '47.105.122.72:3128',
    '39.102.210.176:6379',
    '8.137.38.48:8008',
    '8.220.141.8:10000',
    '47.238.60.156:6379',
    '8.221.139.222:1029',
    '8.220.136.174:2000',
    '8.211.194.85:8443',
    '47.252.18.37:9098',
    '8.211.49.86:20002',
    '36.111.205.239:6666',
    '47.238.60.156:8888',
    '8.213.129.15:312',
    '47.122.60.157:8008',
    '47.122.31.238:5800',
    '121.43.154.123:1081',
    '39.102.208.149:8080',
    '47.251.87.74:5060',
    '8.220.204.215:18080',
    '39.101.65.228:20002',
    '47.250.155.254:3128',
    '114.215.127.92:8081',
    '39.102.208.236:9098',
    '8.221.139.222:8026',
    '39.102.210.176:8081',
    '47.252.18.37:20',
    '39.102.209.121:3129',
    '47.91.107.139:9999',
    '47.119.22.92:9080',
    '156.244.11.6:111',
    '47.116.181.146:8080',
    '47.89.159.212:8443',
    '39.102.209.128:8081',
    '8.221.139.222:443',
    '47.104.198.111:3128',
    '47.122.56.158:8081',
    '121.40.115.140:5001',
    '149.129.226.9:8443',
    '8.211.195.173:1080',
    '47.91.29.151:6379',
    '47.108.159.113:8443',
    '47.238.134.126:999',
    '39.102.209.121:10002',
    '120.79.7.173:8085',
    '121.43.154.123:8443',
    '39.104.57.33:80',
    '8.221.139.222:8085',
    '8.220.141.8:8081',
    '8.211.49.86:8008',
    '8.213.129.20:56',
    '8.211.194.78:1080',
    '39.102.213.50:10002',
    '47.250.51.110:8080',
    '8.221.141.88:3129',
    '47.122.64.36:80',
    '8.221.139.222:8080',
    '8.212.165.164:41890',
    '47.250.159.65:8080',
    '8.211.49.86:80',
    '47.91.95.174:9002',
    '8.213.134.213:8081',
    '47.119.22.92:3128',
    '8.212.151.166:8008',
    '8.210.17.35:8004',
    '8.213.128.6:81',
    '106.14.91.83:100',
    '114.215.127.92:8080',
    '8.211.195.173:80',
    '205.178.137.251:8443',
    '8.211.195.139:8008',
    '120.26.104.146:9080',
    '39.102.208.149:9999',
    '8.220.141.8:3128',
    '8.221.139.222:800',
    '47.119.20.8:9098',
    '8.213.222.157:4000',
    '8.213.197.208:8123',
    '8.220.204.215:8889',
    '47.121.182.36:8008',
    '110.238.111.229:83',
    '8.213.128.6:800',
    '8.213.128.90:77',
    '8.213.222.157:100',
    '47.76.144.139:8008',
    '8.220.141.8:8047',
    '8.215.12.103:8888',
    '8.213.197.208:8889',
    '121.43.154.123:8008',
    '47.122.56.158:80',
    '47.119.164.33:9080',
    '8.211.200.183:8081',
    '47.74.46.81:8080',
    '156.244.0.116:45554',
    '8.211.49.86:8080',
    '8.210.17.35:8443',
    '39.102.211.162:80',
    '39.102.214.208:8081',
    '8.219.229.53:176',
    '156.146.59.25:9002',
    '47.116.181.146:9443'
]

def get_https():
    url = "https://proxy.scdn.io/api/get_proxy.php?protocol=https&count=20"
    response = requests.get(url)
    proxy_list = response.json().get('data', {}).get('proxies', [])
    print(proxy_list)
    return proxy_list



def filter_https_proxies(proxy_list, needed_count=20, timeout=4):
    test_url = "https://httpbin.org/ip"
    headers = {
        "User-Agent": "Mozilla/5.0"
    }

    https_proxies = []

    for proxy in proxy_list:
        # 检查是否取消处理
        try:
            from apis import is_processing_cancelled
            if is_processing_cancelled():
                print("🛑 检测到取消标志，停止代理过滤")
                return https_proxies  # 返回已找到的代理
        except:
            pass  # 如果导入失败，继续执行

        proxies = {
            "http": f"http://{proxy}",
            "https": f"http://{proxy}",
        }

        try:
            print(f"⏳ 正在测试代理: {proxy}")
            response = requests.get(
                test_url,
                headers=headers,
                proxies=proxies,
                timeout=timeout,
                verify=False
            )

            if response.status_code == 200:
                ip_info = response.json()
                print(f"✅ 可用: {proxy}，返回 IP: {ip_info}")
                https_proxies.append(proxy)

                # ✅ 找到足够的可用代理就立即返回
                if len(https_proxies) >= needed_count:
                    print(f"🎯 已找到足够可用代理（{needed_count}个），提前返回")
                    return https_proxies

            else:
                print(f"⚠️ 状态码异常 - {proxy} : {response.status_code}")

        except Exception as e:
            print(f"❌ 不可用: {proxy} - 错误: {e}")

    print(f"\n📊 所有代理测试完成 ✅ 可用数量：{len(https_proxies)} / {len(proxy_list)}")
    return https_proxies
if __name__ == "__main__":
    # proxy_list = get_https()
    https_proxies = filter_https_proxies(static_proxies)
    